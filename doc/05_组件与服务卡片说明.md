# 05 组件与服务卡片说明

> 汇总自：`WIDGET_E2E_VERIFICATION.md`、`桌面卡片功能完整实现文档.md`。

本文件归纳 HarmonyOS 服务卡片（Widget）相关的实现与验证要点，既包括天气卡片，也包含拼图游戏卡片的通用经验。

---

## 一、Weather Widget 端到端实现要点

### 1.1 2×2 天气卡片

- 核心展示信息：
  - 城市名称、温度、天气描述；
  - 对应天气图标、更新时间；
  - 简洁的 2×2 布局与玻璃态背景。
- 设计与实现细节：
  - 通过 `@LocalStorageProp` 绑定卡片数据；
  - 使用 `getWeatherIcon()` 提供完备的图标映射与兜底；
  - `getGradientColors()` 根据 `themeKey` 设置渐变背景；
  - 保证文字层级清晰（主温度、城市名、描述等）。

### 1.2 4×4 扩展天气卡片

- 在 2×2 基础上新增内容：
  - 湿度、风速等指标；
  - 未来 3 小时逐小时预报（时间、温度、图标）；
  - 刷新按钮（触发表单事件，驱动数据刷新）。
- UI 设计：
  - 保持玻璃态风格与主题色一致；
  - 通过合理分区避免信息过载；
  - 支持小屏幕上合理的内容收缩。

### 1.3 测试与验证（WIDGET_E2E_VERIFICATION）

- 手动测试点包括：
  - 添加 2×2 / 4×4 卡片后，数据是否正常展示；
  - 天气主题、渐变背景与图标是否与主应用一致；
  - 手动 / 自动刷新后，更新时间与预报数据是否同步；
  - 过期状态（如数据陈旧）是否有明显标记。

---

## 二、拼图游戏桌面卡片实现经验

> 虽然该文档来自拼图游戏项目，但其服务卡片架构和数据同步策略对天气卡片同样有参考价值。

### 2.1 功能需求与状态管理

- 无游戏状态：
  - 显示「开始新游戏」按钮，点击跳转到主题选择页。
- 游戏进行中：
  - 展示模式（交换 / 滑动）、难度（3×3、4×4、5×5）、步数、用时；
  - 提供「继续」与「主题」两个操作入口。
- 实时更新：
  - 游戏中按 Home 键立即更新卡片进度；
  - 应用关闭后重启，卡片仍应显示最新状态；
  - 游戏完成或应用销毁后恢复为「开始新游戏」。

### 2.2 关键技术挑战与解决

- 跨进程数据共享：
  - 服务卡片运行在 `FormAbility` 进程，游戏在 `UIAbility` 进程；
  - 采用 **AppStorage + Preferences 双重保存**，保证卡片和应用都能读写。
- 数据同步时序：
  - `EntryAbility.onBackground()` 可能先于游戏页面保存状态；
  - 通过「实时保存策略」：每次操作（如移动方块）立即写入 AppStorage。
- 卡片 ID 管理：
  - 使用全局 Preferences 存储所有卡片 ID；
  - 确保在应用 / 卡片生命周期内能正确找到需要更新的实例。
- 应用销毁后的数据清理：
  - 引入定时刷新与时间戳过期检测，防止展示陈旧数据。

---

## 三、通用设计原则与建议

- **状态单一事实来源**：对外只暴露一份「标准化的卡片数据」，通过本地存储和跨进程机制同步。
- **展示与逻辑解耦**：卡片 UI 组件尽量只关心布局与样式，业务逻辑放在仓库或辅助类中完成。
- **降级与兜底**：
  - 网络不可用、数据缺失时要有兜底文本或占位图；
  - 避免空白卡片或异常崩溃。
- **调试与监控**：
  - 为关键生命周期（创建、更新、删除）添加日志；
  - 在天气项目中，可复用主应用的调试体系来观测卡片刷新行为。


<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>图3-11 "访问受控资源"时序图</title>
  <style>
    body {
      margin: 0;
      padding: 40px;
      background: #ffffff;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #000;
      text-align: center;
    }

    .controls {
      margin-bottom: 20px;
    }

    button {
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #000;
      color: #000;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
      transition: background 0.2s;
    }

    button:hover {
      background: #f0f0f0;
    }

    svg {
      background: #ffffff;
      border: 1px solid #eee;
    }

    /* Strict Academic Style */
    .lifeline-head rect {
      fill: #ffffff;
      stroke: #000000;
      stroke-width: 1px;
    }

    .lifeline-head text {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 12px;
      font-weight: bold;
      fill: #000000;
      text-anchor: middle;
    }

    .lifeline-line {
      stroke: #000000;
      stroke-width: 1px;
      stroke-dasharray: 5, 5;
    }

    .activation {
      fill: #ffffff;
      stroke: #000000;
      stroke-width: 1px;
    }

    .message-line {
      fill: none;
      stroke: #000000;
      stroke-width: 1px;
    }

    .message-text {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 11px;
      fill: #000000;
      text-anchor: middle;
      background-color: #fff;
      padding: 2px;
    }
  </style>
</head>

<body>
  <h1>图 3-11 "访问受控资源"时序图</h1>
  <div class="controls">
    <button onclick="exportPng('seqmap', 'fig-3-11-sequence')">导出 PNG (x4)</button>
  </div>

  <svg id="seqmap" width="900" height="700" viewBox="0 0 900 700" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <marker id="arrow-filled" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"
        markerUnits="strokeWidth">
        <path d="M0,0 L0,6 L9,3 z" fill="#000" />
      </marker>
      <marker id="arrow-open" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"
        markerUnits="strokeWidth">
        <path d="M0,0 L0,6 L9,3" fill="none" stroke="#000" />
      </marker>
    </defs>

    <!-- Lifelines -->
    <!-- 1. User -->
    <g transform="translate(100, 50)">
      <g class="lifeline-head">
        <rect x="-40" y="0" width="80" height="30"></rect>
        <text x="0" y="20">User</text>
      </g>
      <line class="lifeline-line" x1="0" y1="30" x2="0" y2="650" />
    </g>

    <!-- 2. MenuHandler -->
    <g transform="translate(250, 50)">
      <g class="lifeline-head">
        <rect x="-50" y="0" width="100" height="30"></rect>
        <text x="0" y="20">:MenuHandler</text>
      </g>
      <line class="lifeline-line" x1="0" y1="30" x2="0" y2="650" />
      <!-- Activation -->
      <rect class="activation" x="-5" y="100" width="10" height="520"></rect>
    </g>

    <!-- 3. AuthService -->
    <g transform="translate(450, 50)">
      <g class="lifeline-head">
        <rect x="-50" y="0" width="100" height="30"></rect>
        <text x="0" y="20">:AuthService</text>
      </g>
      <line class="lifeline-line" x1="0" y1="30" x2="0" y2="650" />
      <!-- Activation -->
      <rect class="activation" x="-5" y="140" width="10" height="350"></rect>
    </g>

    <!-- 4. AuditLogger -->
    <g transform="translate(650, 50)">
      <g class="lifeline-head">
        <rect x="-50" y="0" width="100" height="30"></rect>
        <text x="0" y="20">:AuditLogger</text>
      </g>
      <line class="lifeline-line" x1="0" y1="30" x2="0" y2="650" />
      <!-- Activation -->
      <rect class="activation" x="-5" y="420" width="10" height="50"></rect>
    </g>

    <!-- 5. Database -->
    <g transform="translate(800, 50)">
      <g class="lifeline-head">
        <rect x="-40" y="0" width="80" height="30"></rect>
        <text x="0" y="20">Database</text>
      </g>
      <line class="lifeline-line" x1="0" y1="30" x2="0" y2="650" />
    </g>


    <!-- Messages -->

    <!-- 1. Request -->
    <!-- Moved down to y=100 to avoid overlap with lifeline header -->
    <line class="message-line" x1="100" y1="100" x2="245" y2="100" marker-end="url(#arrow-filled)" />
    <text class="message-text" x="175" y="95">1. 输入操作指令</text>

    <!-- 2. checkPermission -->
    <line class="message-line" x1="255" y1="140" x2="445" y2="140" marker-end="url(#arrow-filled)" />
    <text class="message-text" x="350" y="135">2. checkPermission(code)</text>

    <!-- 3. getUserPermissions -->
    <line class="message-line" x1="455" y1="180" x2="800" y2="180" marker-end="url(#arrow-filled)" />
    <text class="message-text" x="625" y="175">3. SELECT permissions...</text>

    <!-- 4. Return Permissions -->
    <line class="message-line" x1="800" y1="220" x2="455" y2="220" stroke-dasharray="5,5"
      marker-end="url(#arrow-open)" />
    <text class="message-text" x="625" y="215">4. Permission Set</text>

    <!-- 5. Validate (Self) -->
    <!-- Increased loop size for clarity -->
    <path class="message-line" d="M 455 250 L 495 250 L 495 290 L 455 290" marker-end="url(#arrow-filled)" />
    <text class="message-text" x="520" y="275">5. 校验逻辑</text>

    <!-- Alt: Success -->
    <rect x="60" y="310" width="820" height="250" fill="none" stroke="#000" stroke-dasharray="5,2"></rect>
    <path d="M 60 310 L 130 310 L 130 330 L 60 330" fill="#fff" stroke="#000" stroke-dasharray="5,2" />
    <text x="95" y="325" style="font-size:11px; font-weight:bold; text-anchor:middle">alt</text>
    <text x="150" y="325" style="font-size:11px;">[Has Permission]</text>

    <!-- 6. Execute Business -->
    <line class="message-line" x1="455" y1="360" x2="255" y2="360" stroke-dasharray="5,5"
      marker-end="url(#arrow-open)" />
    <text class="message-text" x="350" y="355">6. 允许执行</text>

    <!-- Divider -->
    <line x1="60" y1="390" x2="880" y2="390" stroke="#000" stroke-dasharray="5,2" />
    <text x="150" y="405" style="font-size:11px;">[No Permission]</text>

    <!-- 7. Log Audit -->
    <line class="message-line" x1="455" y1="440" x2="645" y2="440" marker-end="url(#arrow-filled)" />
    <text class="message-text" x="550" y="435">7. logFail(...)</text>

    <!-- 8. Throw Exception -->
    <line class="message-line" x1="455" y1="480" x2="255" y2="480" stroke-dasharray="5,5"
      marker-end="url(#arrow-open)" />
    <text class="message-text" x="350" y="475">8. Throw PermissionDeniedException</text>

    <!-- 9. Show Error -->
    <line class="message-line" x1="245" y1="580" x2="100" y2="580" stroke-dasharray="5,5"
      marker-end="url(#arrow-open)" />
    <text class="message-text" x="175" y="575">9. 显示错误信息</text>

  </svg>

  <script>
    function exportPng(svgId, name) {
      const svg = document.getElementById(svgId);
      if (!svg) {
        alert('未找到SVG元素');
        return;
      }

      try {
        // Get SVG dimensions
        const viewBox = svg.viewBox.baseVal;
        const width = viewBox && viewBox.width ? viewBox.width : 900;
        const height = viewBox && viewBox.height ? viewBox.height : 700;
        const scale = 4; // x4 resolution

        // Create canvas
        const canvas = document.createElement("canvas");
        canvas.width = width * scale;
        canvas.height = height * scale;
        const ctx = canvas.getContext("2d");

        // White background
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Get SVG data using XMLSerializer
        const serializer = new XMLSerializer();
        let svgString = serializer.serializeToString(svg);

        // Add XML namespace if not present
        if (!svgString.includes('xmlns="http://www.w3.org/2000/svg"')) {
          svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
        }

        // Embed all styles inline to SVG string
        const styles = document.styleSheets;
        let styleText = '<style>';
        for (let i = 0; i < styles.length; i++) {
          try {
            const rules = styles[i].cssRules || styles[i].rules;
            for (let j = 0; j < rules.length; j++) {
              styleText += rules[j].cssText + ' ';
            }
          } catch (e) {
            // Skip external stylesheets due to CORS
          }
        }
        styleText += '</style>';

        // Insert style into SVG
        svgString = svgString.replace('</defs>', styleText + '</defs>');
        if (!svgString.includes('</defs>')) {
          svgString = svgString.replace('<svg', '<svg><defs>' + styleText + '</defs>');
        }

        // Create blob and load image
        const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const img = new Image();

        img.onload = function () {
          // Draw SVG image on canvas with scaling
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          // Convert canvas to blob and download
          canvas.toBlob(function (pngBlob) {
            const link = document.createElement('a');
            link.download = (name || 'diagram') + '.png';
            link.href = URL.createObjectURL(pngBlob);
            link.click();

            // Cleanup
            URL.revokeObjectURL(url);
            URL.revokeObjectURL(link.href);
          }, 'image/png');
        };

        img.onerror = function (e) {
          console.error('Image load error:', e);
          console.log('SVG String:', svgString);
          alert('图像加载失败，请检查浏览器控制台');
          URL.revokeObjectURL(url);
        };

        img.src = url;

      } catch (error) {
        console.error('Export error:', error);
        alert('导出过程出错: ' + error.message);
      }
    }
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>图3-1 设计思想思维导图</title>
    <style>
        body {
            margin: 0;
            padding: 40px;
            background: #ffffff;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #000;
            text-align: center;
        }

        .controls {
            margin-bottom: 20px;
        }

        button {
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #000;
            color: #000;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: background 0.2s;
        }

        button:hover {
            background: #f0f0f0;
        }

        svg {
            background: #ffffff;
            border: 1px solid #eee;
            /* Light border for display only */
        }

        /* Strict Academic Style */
        .node rect {
            fill: #ffffff;
            stroke: #000000;
            stroke-width: 1px;
        }

        .node text {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 12px;
            fill: #000000;
        }

        .node.root rect {
            stroke-width: 1.5px;
        }

        .node.root text {
            font-weight: bold;
            font-size: 14px;
        }

        .edge {
            fill: none;
            stroke: #000000;
            stroke-width: 1px;
        }
    </style>
</head>

<body>
    <h1>图 3-1 设计思想思维导图</h1>
    <div class="controls">
        <button onclick="exportPng('mindmap', 'fig-3-1-design-mindmap')">导出 PNG (x4)</button>
    </div>

    <svg id="mindmap" width="1000" height="600" viewBox="0 0 1000 600" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <!-- No markers needed for standard mindmap lines usually, but can add if requested -->
        </defs>

        <!-- Root Node -->
        <g class="node root" transform="translate(50, 280)">
            <rect x="0" y="-25" width="180" height="50"></rect>
            <text x="90" y="5" text-anchor="middle">基于角色的访问控制系统</text>
        </g>

        <!-- Level 1 Nodes -->
        <!-- 1. 背景与动机 -->
        <g class="node" transform="translate(300, 80)">
            <rect x="0" y="-20" width="140" height="40"></rect>
            <text x="70" y="5" text-anchor="middle">背景与动机</text>
        </g>
        <!-- 2. 核心设计理念 -->
        <g class="node" transform="translate(300, 220)">
            <rect x="0" y="-20" width="140" height="40"></rect>
            <text x="70" y="5" text-anchor="middle">核心设计理念</text>
        </g>
        <!-- 3. 目标用户 -->
        <g class="node" transform="translate(300, 360)">
            <rect x="0" y="-20" width="140" height="40"></rect>
            <text x="70" y="5" text-anchor="middle">目标用户与场景</text>
        </g>
        <!-- 4. 技术选型 -->
        <g class="node" transform="translate(300, 500)">
            <rect x="0" y="-20" width="140" height="40"></rect>
            <text x="70" y="5" text-anchor="middle">技术选型与路径</text>
        </g>

        <!-- Edges from Root to L1 -->
        <path class="edge" d="M 230 280 C 265 280, 265 80, 300 80" />
        <path class="edge" d="M 230 280 C 265 280, 265 220, 300 220" />
        <path class="edge" d="M 230 280 C 265 280, 265 360, 300 360" />
        <path class="edge" d="M 230 280 C 265 280, 265 500, 300 500" />

        <!-- Level 2 Nodes -->
        <!-- 1.1 -->
        <g class="node" transform="translate(500, 50)">
            <rect x="0" y="-15" width="160" height="30"></rect>
            <text x="80" y="5" text-anchor="middle">命令行环境安全需求</text>
        </g>
        <path class="edge" d="M 440 80 C 470 80, 470 50, 500 50" />
        <!-- 1.2 -->
        <g class="node" transform="translate(500, 110)">
            <rect x="0" y="-15" width="160" height="30"></rect>
            <text x="80" y="5" text-anchor="middle">统一权限模型</text>
        </g>
        <path class="edge" d="M 440 80 C 470 80, 470 110, 500 110" />

        <!-- 2.1 -->
        <g class="node" transform="translate(500, 190)">
            <rect x="0" y="-15" width="160" height="30"></rect>
            <text x="80" y="5" text-anchor="middle">RBAC 模型抽象</text>
        </g>
        <path class="edge" d="M 440 220 C 470 220, 470 190, 500 190" />
        <!-- 2.2 -->
        <g class="node" transform="translate(500, 250)">
            <rect x="0" y="-15" width="160" height="30"></rect>
            <text x="80" y="5" text-anchor="middle">装饰器模式校验</text>
        </g>
        <path class="edge" d="M 440 220 C 470 220, 470 250, 500 250" />

        <!-- 3.1 -->
        <g class="node" transform="translate(500, 330)">
            <rect x="0" y="-15" width="160" height="30"></rect>
            <text x="80" y="5" text-anchor="middle">管理员/审计员/用户</text>
        </g>
        <path class="edge" d="M 440 360 C 470 360, 470 330, 500 330" />
        <!-- 3.2 -->
        <g class="node" transform="translate(500, 390)">
            <rect x="0" y="-15" width="160" height="30"></rect>
            <text x="80" y="5" text-anchor="middle">命令行菜单操作</text>
        </g>
        <path class="edge" d="M 440 360 C 470 360, 470 390, 500 390" />

        <!-- 4.1 -->
        <g class="node" transform="translate(500, 470)">
            <rect x="0" y="-15" width="160" height="30"></rect>
            <text x="80" y="5" text-anchor="middle">Java SE + MySQL</text>
        </g>
        <path class="edge" d="M 440 500 C 470 500, 470 470, 500 470" />
        <!-- 4.2 -->
        <g class="node" transform="translate(500, 530)">
            <rect x="0" y="-15" width="160" height="30"></rect>
            <text x="80" y="5" text-anchor="middle">Log4j2 审计日志</text>
        </g>
        <path class="edge" d="M 440 500 C 470 500, 470 530, 500 530" />

        <!-- Level 3 (Examples) -->
        <g class="node" transform="translate(700, 250)">
            <rect x="0" y="-15" width="180" height="30"></rect>
            <text x="90" y="5" text-anchor="middle">AOP / Proxy 思想</text>
        </g>
        <path class="edge" d="M 660 250 C 680 250, 680 250, 700 250" />

        <g class="node" transform="translate(700, 530)">
            <rect x="0" y="-15" width="180" height="30"></rect>
            <text x="90" y="5" text-anchor="middle">CLI → Service → DAO</text>
        </g>
        <path class="edge" d="M 660 530 C 680 530, 680 530, 700 530" />

    </svg>

    <script>
        function exportPng(svgId, name) {
            const svg = document.getElementById(svgId);
            if (!svg) {
                alert('未找到SVG元素');
                return;
            }

            try {
                // Get SVG dimensions
                const viewBox = svg.viewBox.baseVal;
                const width = viewBox && viewBox.width ? viewBox.width : 1000;
                const height = viewBox && viewBox.height ? viewBox.height : 600;
                const scale = 4; // x4 resolution

                // Create canvas
                const canvas = document.createElement("canvas");
                canvas.width = width * scale;
                canvas.height = height * scale;
                const ctx = canvas.getContext("2d");

                // White background
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Get SVG data using XMLSerializer
                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(svg);

                // Add XML namespace if not present
                if (!svgString.includes('xmlns="http://www.w3.org/2000/svg"')) {
                    svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }

                // Embed all styles inline to SVG string
                const styles = document.styleSheets;
                let styleText = '<style>';
                for (let i = 0; i < styles.length; i++) {
                    try {
                        const rules = styles[i].cssRules || styles[i].rules;
                        for (let j = 0; j < rules.length; j++) {
                            styleText += rules[j].cssText + ' ';
                        }
                    } catch (e) {
                        // Skip external stylesheets due to CORS
                    }
                }
                styleText += '</style>';

                // Insert style into SVG
                svgString = svgString.replace('</defs>', styleText + '</defs>');
                if (!svgString.includes('</defs>')) {
                    svgString = svgString.replace('<svg', '<svg><defs>' + styleText + '</defs>');
                }

                // Create blob and load image
                const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const img = new Image();

                img.onload = function () {
                    // Draw SVG image on canvas with scaling
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Convert canvas to blob and download
                    canvas.toBlob(function (pngBlob) {
                        const link = document.createElement('a');
                        link.download = (name || 'diagram') + '.png';
                        link.href = URL.createObjectURL(pngBlob);
                        link.click();

                        // Cleanup
                        URL.revokeObjectURL(url);
                        URL.revokeObjectURL(link.href);
                    }, 'image/png');
                };

                img.onerror = function (e) {
                    console.error('Image load error:', e);
                    console.log('SVG String:', svgString);
                    alert('图像加载失败，请检查浏览器控制台');
                    URL.revokeObjectURL(url);
                };

                img.src = url;

            } catch (error) {
                console.error('Export error:', error);
                alert('导出过程出错: ' + error.message);
            }
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>图3-7 系统三层架构图</title>
    <style>
        body {
            margin: 0;
            padding: 40px;
            background: #ffffff;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #000;
            text-align: center;
        }

        .controls {
            margin-bottom: 20px;
        }

        button {
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #000;
            color: #000;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: background 0.2s;
        }

        button:hover {
            background: #f0f0f0;
        }

        svg {
            background: #ffffff;
            border: 1px solid #eee;
        }

        /* Strict Academic Style */
        .node rect {
            fill: #ffffff;
            stroke: #000000;
            stroke-width: 1px;
        }

        .node text {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 12px;
            fill: #000000;
        }

        .layer-label {
            font-weight: bold;
            font-size: 14px;
            text-anchor: start;
        }

        .edge {
            fill: none;
            stroke: #000000;
            stroke-width: 1px;
        }
    </style>
</head>

<body>
    <h1>图 3-7 系统三层架构图</h1>
    <div class="controls">
        <button onclick="exportPng('archmap', 'fig-3-7-layer-architecture')">导出 PNG (x4)</button>
    </div>

    <svg id="archmap" width="800" height="600" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"
                markerUnits="strokeWidth">
                <path d="M0,0 L0,6 L9,3 z" fill="#000" />
            </marker>
        </defs>

        <!-- Layer 1: CLI Presentation -->
        <g class="layer" transform="translate(100, 50)">
            <rect x="0" y="0" width="600" height="80" fill="none" stroke="#000" stroke-dasharray="5,5"></rect>
            <text x="10" y="-10" class="layer-label">表现层 (CLI Presentation Layer)</text>

            <g class="node" transform="translate(50, 20)">
                <rect x="0" y="0" width="120" height="40"></rect>
                <text x="60" y="25" text-anchor="middle">MainApp</text>
            </g>
            <g class="node" transform="translate(200, 20)">
                <rect x="0" y="0" width="120" height="40"></rect>
                <text x="60" y="25" text-anchor="middle">MenuHandler</text>
            </g>
            <g class="node" transform="translate(350, 20)">
                <rect x="0" y="0" width="120" height="40"></rect>
                <text x="60" y="25" text-anchor="middle">InputUtil</text>
            </g>
        </g>

        <!-- Arrow Down -->
        <line class="edge" x1="400" y1="130" x2="400" y2="160" marker-end="url(#arrow)" />

        <!-- Layer 2: Service & Decorator -->
        <g class="layer" transform="translate(100, 160)">
            <rect x="0" y="0" width="600" height="140" fill="none" stroke="#000" stroke-dasharray="5,5"></rect>
            <text x="10" y="-10" class="layer-label">业务逻辑层 (Service Layer)</text>

            <!-- Decorators -->
            <g class="node" transform="translate(50, 20)">
                <rect x="0" y="0" width="500" height="40" fill="#f9f9f9"></rect>
                <text x="250" y="25" text-anchor="middle">Auth*ServiceDecorator (权限校验 / 审计日志)</text>
            </g>

            <!-- Services -->
            <g class="node" transform="translate(50, 80)">
                <rect x="0" y="0" width="110" height="40"></rect>
                <text x="55" y="25" text-anchor="middle">UserService</text>
            </g>
            <g class="node" transform="translate(180, 80)">
                <rect x="0" y="0" width="110" height="40"></rect>
                <text x="55" y="25" text-anchor="middle">RoleService</text>
            </g>
            <g class="node" transform="translate(310, 80)">
                <rect x="0" y="0" width="110" height="40"></rect>
                <text x="55" y="25" text-anchor="middle">PermService</text>
            </g>
            <g class="node" transform="translate(440, 80)">
                <rect x="0" y="0" width="110" height="40"></rect>
                <text x="55" y="25" text-anchor="middle">AuthService</text>
            </g>

            <!-- Inner connection -->
            <line class="edge" x1="300" y1="60" x2="300" y2="80" marker-end="url(#arrow)" />
        </g>

        <!-- Arrow Down -->
        <line class="edge" x1="400" y1="300" x2="400" y2="330" marker-end="url(#arrow)" />

        <!-- Layer 3: DAO -->
        <g class="layer" transform="translate(100, 330)">
            <rect x="0" y="0" width="600" height="80" fill="none" stroke="#000" stroke-dasharray="5,5"></rect>
            <text x="10" y="-10" class="layer-label">数据访问层 (DAO Layer)</text>

            <g class="node" transform="translate(50, 20)">
                <rect x="0" y="0" width="110" height="40"></rect>
                <text x="55" y="25" text-anchor="middle">UserDao</text>
            </g>
            <g class="node" transform="translate(180, 20)">
                <rect x="0" y="0" width="110" height="40"></rect>
                <text x="55" y="25" text-anchor="middle">RoleDao</text>
            </g>
            <g class="node" transform="translate(310, 20)">
                <rect x="0" y="0" width="110" height="40"></rect>
                <text x="55" y="25" text-anchor="middle">PermDao</text>
            </g>
            <g class="node" transform="translate(440, 20)">
                <rect x="0" y="0" width="110" height="40"></rect>
                <text x="55" y="25" text-anchor="middle">DBUtil</text>
            </g>
        </g>

        <!-- Arrow Down -->
        <line class="edge" x1="400" y1="410" x2="400" y2="440" marker-end="url(#arrow)" />

        <!-- Layer 4: Database -->
        <g class="layer" transform="translate(100, 440)">
            <rect x="0" y="0" width="600" height="80" fill="none" stroke="#000" stroke-dasharray="5,5"></rect>
            <text x="10" y="-10" class="layer-label">数据存储层 (Data Layer)</text>

            <g class="node" transform="translate(200, 20)">
                <rect x="0" y="0" width="200" height="40" rx="10"></rect>
                <text x="100" y="25" text-anchor="middle">MySQL Database</text>
            </g>
        </g>

    </svg>

    <script>
        function exportPng(svgId, name) {
            const svg = document.getElementById(svgId);
            if (!svg) {
                alert('未找到SVG元素');
                return;
            }

            try {
                // Get SVG dimensions
                const viewBox = svg.viewBox.baseVal;
                const width = viewBox && viewBox.width ? viewBox.width : 800;
                const height = viewBox && viewBox.height ? viewBox.height : 600;
                const scale = 4; // x4 resolution

                // Create canvas
                const canvas = document.createElement("canvas");
                canvas.width = width * scale;
                canvas.height = height * scale;
                const ctx = canvas.getContext("2d");

                // White background
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Get SVG data using XMLSerializer
                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(svg);

                // Add XML namespace if not present
                if (!svgString.includes('xmlns="http://www.w3.org/2000/svg"')) {
                    svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }

                // Embed all styles inline to SVG string
                const styles = document.styleSheets;
                let styleText = '<style>';
                for (let i = 0; i < styles.length; i++) {
                    try {
                        const rules = styles[i].cssRules || styles[i].rules;
                        for (let j = 0; j < rules.length; j++) {
                            styleText += rules[j].cssText + ' ';
                        }
                    } catch (e) {
                        // Skip external stylesheets due to CORS
                    }
                }
                styleText += '</style>';

                // Insert style into SVG
                svgString = svgString.replace('</defs>', styleText + '</defs>');
                if (!svgString.includes('</defs>')) {
                    svgString = svgString.replace('<svg', '<svg><defs>' + styleText + '</defs>');
                }

                // Create blob and load image
                const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const img = new Image();

                img.onload = function () {
                    // Draw SVG image on canvas with scaling
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Convert canvas to blob and download
                    canvas.toBlob(function (pngBlob) {
                        const link = document.createElement('a');
                        link.download = (name || 'diagram') + '.png';
                        link.href = URL.createObjectURL(pngBlob);
                        link.click();

                        // Cleanup
                        URL.revokeObjectURL(url);
                        URL.revokeObjectURL(link.href);
                    }, 'image/png');
                };

                img.onerror = function (e) {
                    console.error('Image load error:', e);
                    console.log('SVG String:', svgString);
                    alert('图像加载失败，请检查浏览器控制台');
                    URL.revokeObjectURL(url);
                };

                img.src = url;

            } catch (error) {
                console.error('Export error:', error);
                alert('导出过程出错: ' + error.message);
            }
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>图3-10 "访问受控资源"主流程图</title>
  <style>
    body {
      margin: 0;
      padding: 40px;
      background: #ffffff;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #000;
      text-align: center;
    }

    .controls {
      margin-bottom: 20px;
    }

    button {
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #000;
      color: #000;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
      transition: background 0.2s;
    }

    button:hover {
      background: #f0f0f0;
    }

    svg {
      background: #ffffff;
      border: 1px solid #eee;
    }

    /* Strict Academic Style */
    .node rect,
    .node polygon,
    .node ellipse {
      fill: #ffffff;
      stroke: #000000;
      stroke-width: 1px;
    }

    .node text {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 12px;
      fill: #000000;
      text-anchor: middle;
    }

    .edge {
      fill: none;
      stroke: #000000;
      stroke-width: 1px;
    }

    .edge-label {
      font-size: 11px;
      fill: #000;
      background-color: #fff;
      padding: 2px;
    }
  </style>
</head>

<body>
  <h1>图 3-10 "访问受控资源"主流程图</h1>
  <div class="controls">
    <button onclick="exportPng('flowchart', 'fig-3-10-main-flow')">导出 PNG (x4)</button>
  </div>

  <svg id="flowchart" width="700" height="850" viewBox="0 0 700 850" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
        <path d="M0,0 L0,6 L9,3 z" fill="#000" />
      </marker>
    </defs>

    <!-- Start -->
    <g class="node" transform="translate(350, 40)">
      <rect x="-60" y="-20" width="120" height="40" rx="20" ry="20"></rect>
      <text x="0" y="5">开始</text>
    </g>
    <line class="edge" x1="350" y1="60" x2="350" y2="90" marker-end="url(#arrow)" />

    <!-- Step 1: User Input -->
    <g class="node" transform="translate(350, 110)">
      <rect x="-80" y="-20" width="160" height="40"></rect>
      <text x="0" y="5">用户请求资源/操作</text>
    </g>
    <line class="edge" x1="350" y1="130" x2="350" y2="160" marker-end="url(#arrow)" />

    <!-- Decision: Is Logged In? -->
    <g class="node" transform="translate(350, 200)">
      <polygon points="0,-35 70,0 0,35 -70,0"></polygon>
      <text x="0" y="5">是否已登录?</text>
    </g>

    <!-- No -> Prompt Login -> End -->
    <line class="edge" x1="420" y1="200" x2="550" y2="200" marker-end="url(#arrow)" />
    <text x="450" y="195" class="edge-label">否</text>

    <g class="node" transform="translate(550, 200)">
      <rect x="-60" y="-20" width="120" height="40"></rect>
      <text x="0" y="5">提示需登录</text>
    </g>
    <!-- Path to End -->
    <line class="edge" x1="550" y1="220" x2="550" y2="780" />
    <line class="edge" x1="550" y1="780" x2="410" y2="780" marker-end="url(#arrow)" />

    <!-- Yes -> Check Permission -->
    <line class="edge" x1="350" y1="235" x2="350" y2="270" marker-end="url(#arrow)" />
    <text x="355" y="255" class="edge-label">是</text>

    <!-- Step 2: Check Permission -->
    <g class="node" transform="translate(350, 290)">
      <rect x="-80" y="-20" width="160" height="40"></rect>
      <text x="0" y="5">检查用户权限</text>
    </g>
    <line class="edge" x1="350" y1="310" x2="350" y2="350" marker-end="url(#arrow)" />

    <!-- Decision: Has Permission? -->
    <g class="node" transform="translate(350, 390)">
      <polygon points="0,-35 70,0 0,35 -70,0"></polygon>
      <text x="0" y="5">是否有权限?</text>
    </g>

    <!-- No -> Audit Fail -> Exception -> End -->
    <line class="edge" x1="280" y1="390" x2="150" y2="390" marker-end="url(#arrow)" />
    <text x="200" y="385" class="edge-label">否</text>

    <g class="node" transform="translate(150, 390)">
      <rect x="-60" y="-20" width="120" height="40"></rect>
      <text x="0" y="5">记录审计失败</text>
    </g>
    <line class="edge" x1="150" y1="410" x2="150" y2="450" marker-end="url(#arrow)" />

    <g class="node" transform="translate(150, 470)">
      <rect x="-60" y="-20" width="120" height="40"></rect>
      <text x="0" y="5">抛出异常/提示</text>
    </g>
    <!-- Path to End -->
    <line class="edge" x1="150" y1="490" x2="150" y2="780" />
    <line class="edge" x1="150" y1="780" x2="290" y2="780" marker-end="url(#arrow)" />

    <!-- Yes -> Execute -->
    <line class="edge" x1="350" y1="425" x2="350" y2="460" marker-end="url(#arrow)" />
    <text x="355" y="445" class="edge-label">是</text>

    <!-- Step 3: Execute Business Logic -->
    <g class="node" transform="translate(350, 480)">
      <rect x="-80" y="-20" width="160" height="40"></rect>
      <text x="0" y="5">执行业务逻辑</text>
    </g>
    <line class="edge" x1="350" y1="500" x2="350" y2="540" marker-end="url(#arrow)" />

    <!-- Step 4: Audit Success -->
    <g class="node" transform="translate(350, 560)">
      <rect x="-80" y="-20" width="160" height="40"></rect>
      <text x="0" y="5">记录审计成功</text>
    </g>
    <line class="edge" x1="350" y1="580" x2="350" y2="620" marker-end="url(#arrow)" />

    <!-- Step 5: Return Result -->
    <g class="node" transform="translate(350, 640)">
      <rect x="-80" y="-20" width="160" height="40"></rect>
      <text x="0" y="5">返回结果</text>
    </g>
    <line class="edge" x1="350" y1="660" x2="350" y2="760" marker-end="url(#arrow)" />

    <!-- End -->
    <g class="node" transform="translate(350, 780)">
      <rect x="-60" y="-20" width="120" height="40" rx="20" ry="20"></rect>
      <text x="0" y="5">结束</text>
    </g>

  </svg>

  <script>
    function exportPng(svgId, name) {
      const svg = document.getElementById(svgId);
      if (!svg) {
        alert('未找到SVG元素');
        return;
      }

      try {
        // Get SVG dimensions
        const viewBox = svg.viewBox.baseVal;
        const width = viewBox && viewBox.width ? viewBox.width : 700;
        const height = viewBox && viewBox.height ? viewBox.height : 850;
        const scale = 4; // x4 resolution

        // Create canvas
        const canvas = document.createElement("canvas");
        canvas.width = width * scale;
        canvas.height = height * scale;
        const ctx = canvas.getContext("2d");

        // White background
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Get SVG data using XMLSerializer
        const serializer = new XMLSerializer();
        let svgString = serializer.serializeToString(svg);

        // Add XML namespace if not present
        if (!svgString.includes('xmlns="http://www.w3.org/2000/svg"')) {
          svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
        }

        // Embed all styles inline to SVG string
        const styles = document.styleSheets;
        let styleText = '<style>';
        for (let i = 0; i < styles.length; i++) {
          try {
            const rules = styles[i].cssRules || styles[i].rules;
            for (let j = 0; j < rules.length; j++) {
              styleText += rules[j].cssText + ' ';
            }
          } catch (e) {
            // Skip external stylesheets due to CORS
          }
        }
        styleText += '</style>';

        // Insert style into SVG
        svgString = svgString.replace('</defs>', styleText + '</defs>');
        if (!svgString.includes('</defs>')) {
          svgString = svgString.replace('<svg', '<svg><defs>' + styleText + '</defs>');
        }

        // Create blob and load image
        const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const img = new Image();

        img.onload = function () {
          // Draw SVG image on canvas with scaling
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          // Convert canvas to blob and download
          canvas.toBlob(function (pngBlob) {
            const link = document.createElement('a');
            link.download = (name || 'diagram') + '.png';
            link.href = URL.createObjectURL(pngBlob);
            link.click();

            // Cleanup
            URL.revokeObjectURL(url);
            URL.revokeObjectURL(link.href);
          }, 'image/png');
        };

        img.onerror = function (e) {
          console.error('Image load error:', e);
          console.log('SVG String:', svgString);
          alert('图像加载失败，请检查浏览器控制台');
          URL.revokeObjectURL(url);
        };

        img.src = url;

      } catch (error) {
        console.error('Export error:', error);
        alert('导出过程出错: ' + error.message);
      }
    }
  </script>
</body>

</html>
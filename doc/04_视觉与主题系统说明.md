# 04 视觉与主题系统说明

> 汇总自：`BACKGROUND_VIDEO_SWITCHING_LOGIC.md`、`CHANGELOG_VISUAL_RESOURCES.md`、`CHART_OPTIMIZATION_REPORT.md`、`FEATURE_IMPLEMENTATION_REPORT.md`、`NIGHT_MODE_IMPLEMENTATION.md`、`THEME_KEY_LOGIC_EXPLANATION.md`、`VIDEO_THEME_COMPLETE_CHECK_REPORT.md`、`VIDEO_LOADING_FIX_REPORT.md`、`DEBUG_IMPLEMENTATION_GUIDE.md` 等。

本文件从**背景视频 / 动画、主题键与夜间模式、趋势图与调试工具**三个维度，归纳整个视觉与主题系统的设计与实现。

---

## 一、背景视频与动画系统

### 1.1 基础映射逻辑（BACKGROUND_VIDEO_SWITCHING_LOGIC）

- 核心思路：**天气条件 + 时间段 → 主题键 → 具体资源**。
- 天气服务层（如 `QWeatherService.mapWeatherText()`）只负责返回基础 `themeKey`：
  - 文本含「晴」→ `sunny`
  - 含「云 / 阴」→ 也归为 `sunny`（偏暖色调）
  - 含「雨」→ `rainy`
  - 含「雪」→ `snow`
  - 含「雷」→ 归为 `rainy`
- 若无法匹配，默认使用 `sunny` 主题，以保证有兜底视觉。

### 1.2 主题键分层（THEME_KEY_LOGIC_EXPLANATION）

- 基础主题键：`sunny` / `rainy` / `snow`。
- 最终主题键：`{weather}_{time}`，例如：
  - `sunny_day` / `sunny_night`
  - `rainy_day` / `rainy_night`
  - `snow_day` / `snow_night`
- `WeatherHomePage.isNightTime()` 会基于城市时区偏移计算当地小时数：
  - 18:00–06:00 判定为夜间，其余为白天；
  - 最终主题键由「基础 themeKey + 是否夜间」拼接而成。

### 1.3 BackgroundMode 与多级兜底

- 通过枚举 `BackgroundMode` 区分三种模式：
  - `VIDEO`：视频组件播放背景视频；
  - `ANIMATED_IMAGE`：高帧 WebP 动画；
  - `GRADIENT`：静态渐变背景。
- `AtmosphereBackground` 组件内部：
  - 根据当前模式选择渲染 Video / AnimatedImage / Gradient；
  - 统一叠加半透明遮罩，保证文字可读性；
  - 提供性能检测与资源健康检查的调试日志。

### 1.4 功能验证与问题修复（FEATURE_IMPLEMENTATION_REPORT、VIDEO_LOADING_FIX_REPORT 等）

- 发现的问题：
  - 默认背景模式错误地设置为渐变，导致看不到视频 / 动画；
  - 性能检测逻辑过于保守，提前把模式降级；
  - 资源健康检查被跳过或过早短路。
- 已完成的修复：
  - 默认模式改为 `VIDEO`，确保示例中视频优先生效；
  - 优化性能检测逻辑，在演示环境中尽量保持视频模式；
  - 强制启用资源健康检查，并在日志中输出具体检查结果；
  - 对视频加载失败情况补充错误日志与降级路径。

---

## 二、主题管理与夜间模式

### 2.1 ThemeManager 架构（NIGHT_MODE_IMPLEMENTATION）

- 提供统一的主题管理入口，支持三种模式：
  - `AUTO`：按时间自动切换；
  - `LIGHT`：强制浅色；
  - `DARK`：强制深色。
- 主题配置（`ThemeConfig`）包含：
  - 主色 / 背景色 / 卡片色；
  - 文本主色、次要色、提示色；
  - 阴影色、强调色、错误/成功/警告色；
  - 图表主色与卡片透明度等。

### 2.2 时间感知切换

- 自动模式下的时间规则（可根据需求调整）：
  - 06:00–18:00 → 浅色模式；
  - 18:00–06:00 → 深色模式。
- 实现要点：
  - 每分钟检测一次切换条件或在关键场景触发检查；
  - 主题切换时使用 300ms 过渡动画，避免闪烁；
  - 后续可扩展为跟随系统主题模式。

### 2.3 视觉资源与夜景主题（CHANGELOG_VISUAL_RESOURCES）

- 在主题常量中增加夜景主题：
  - 如 `sunny_night`、`rainy_night`、`snow_night`；
  - 增加 `lottieResource`、`isNightMode` 等字段。
- 引入资源健康检查与统一资源管理器：
  - `ResourceHealthChecker`：检查视频 / WebP / Lottie 文件存在性；
  - `ResourceManager`：对外提供资源状态查询与降级策略；
  - `ResourceStatusOverlay`：用于开发期查看资源状态。

---

## 三、趋势图与调试工具

### 3.1 趋势图三级兜底策略（CHART_OPTIMIZATION_REPORT）

- 按照官方指导，将趋势图实现拆分为三重保障：
  1. 优先使用图表组件；
  2. 无图表组件时使用 `List + Stack` 组合模拟图形；
  3. 再不行则使用简化文本 / 指标展示。
- 对性能与流畅度进行专项优化：
  - 减少重绘、复用布局和数据；
  - 对滚动与刷新行为进行压测与调优。

### 3.2 调试系统（DEBUG_IMPLEMENTATION_GUIDE）

- 调试组件：
  - `DebugLogger`：统一日志收集与格式化；
  - `LogViewer`：实时查看日志的 UI 面板；
  - `FeatureChecker`：检查各功能开关与运行状态；
  - 多个调试覆盖层（性能监控、资源状态、数据库检查器、主题调试面板等）。
- 典型调试入口：
  - 左上角背景模式切换按钮（视频 / 动画 / 渐变）；
  - 右上角日志查看器与状态面板；
  - 右侧调试覆盖层展示性能与资源信息。

### 3.3 视频主题全链路检查（VIDEO_THEME_COMPLETE_CHECK_REPORT）

- 从「城市天气 → 主题键 → 资源选择 → 实际渲染」全链路验证：
  - 不同天气 / 时段应正确映射到对应视频；
  - 时区变化时背景切换符合预期；
  - 资源缺失或加载失败时自动降级且有明确日志提示。

---

## 四、小结与实践建议

- 视觉系统的关键特征：
  - 所有天气与时间相关的展示都通过 `themeKey` 统一驱动；
  - 背景渲染有完整的多级兜底与性能自适应；
  - 调试与监控能力内置于组件之中，方便定位问题。
- 实践建议：
  - 在引入新主题或资源时，优先更新 `ThemeConstants` 与资源元数据配置；
  - 为新资源补充健康检查与调试覆盖层支持；
  - 保持主题 / 资源 / 调试 三者之间的契约清晰，避免散落逻辑。


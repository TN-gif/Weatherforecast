import { DebugLogger, LogData } from '../../common/utils/DebugLogger';
import { BackgroundMode } from '../../common/constants/ThemeConstants';

@Component
export struct AtmosphereBackground {
  @StorageProp('backgroundMode') backgroundMode: BackgroundMode = BackgroundMode.VIDEO;
  @StorageProp('themeKey') @Watch('onThemeChange') themeKey: string = 'sunny_day';
  
  @State private videoPrepared: boolean = false;
  
  private logger: DebugLogger = DebugLogger.getInstance();
  
  // è§†é¢‘èµ„æºè·¯å¾„
  private videoSource?: string;

  aboutToAppear(): void {
    const initData: LogData = {
      'themeKey': this.themeKey,
      'backgroundMode': String(this.backgroundMode)
    };
    this.logger.lifecycle('AtmosphereBackground', 'aboutToAppear å¼€å§‹', initData);
    
    // å¼ºåˆ¶è®¾ç½®ä¸ºVIDEOæ¨¡å¼
    this.backgroundMode = BackgroundMode.VIDEO;
    this.updateVideoSource();
    
    this.logger.lifecycle('AtmosphereBackground', 'aboutToAppear å®Œæˆ');
  }

  aboutToRender(): void {
    this.updateVideoSource();
  }

  private updateVideoSource(): void {
    this.videoSource = `weather/${this.themeKey}.mp4`;
    
    const assetData: LogData = {
      'themeKey': this.themeKey,
      'videoSource': this.videoSource
    };
    this.logger.info('AtmosphereBackground', 'ğŸ“ è§†é¢‘èµ„æºè·¯å¾„', assetData);
  }

  private onThemeChange(): void {
    const logData: LogData = {
      'newTheme': this.themeKey
    };
    this.logger.info('AtmosphereBackground', 'ğŸ¨ ä¸»é¢˜å˜æ›´', logData);
    this.videoPrepared = false;
    this.updateVideoSource();
  }

  build() {
    Stack() {
      // åªæ¸²æŸ“è§†é¢‘èƒŒæ™¯ï¼Œä¸å…è®¸ä»»ä½•é™çº§
      this.renderVideoBackground();
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  private renderVideoBackground(): void {
    if (this.videoSource) {
      Video({ src: $rawfile(this.videoSource) })
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)
        .autoPlay(true)
        .loop(true)
        .muted(true)
        .controls(false)
        .onError((error) => {
          const errorData: LogData = {
            'videoSource': this.videoSource || '',
            'themeKey': this.themeKey,
            'errorInfo': error ? JSON.stringify(error) : 'Unknown error'
          };
          this.logger.error('AtmosphereBackground', 'âŒ è§†é¢‘åŠ è½½é”™è¯¯', new Error('Video load failed'));
          this.logger.info('AtmosphereBackground', 'ğŸ“Š è§†é¢‘é”™è¯¯è¯¦æƒ…', errorData);
        })
        .onPrepared((event) => {
          const preparedData: LogData = {
            'videoSource': this.videoSource || '',
            'themeKey': this.themeKey,
            'duration': event?.duration || 0
          };
          this.videoPrepared = true;
          this.logger.info('AtmosphereBackground', 'âœ… è§†é¢‘å‡†å¤‡å®Œæˆ', preparedData);
          console.info('[AtmosphereBackground] è§†é¢‘å‡†å¤‡å®Œæˆ');
        })
        .onStart(() => {
          this.logger.info('AtmosphereBackground', 'â–¶ï¸ è§†é¢‘å¼€å§‹æ’­æ”¾');
          console.info('[AtmosphereBackground] è§†é¢‘å¼€å§‹æ’­æ”¾');
        })
        .onFinish(() => {
          this.logger.info('AtmosphereBackground', 'âœ… è§†é¢‘æ’­æ”¾å®Œæˆ');
        })
    }
  }
}

import { DebugLogger, LogData } from '../../common/utils/DebugLogger';
import { BackgroundMode, ThemeConstants } from '../../common/constants/ThemeConstants';

@Component
export struct AtmosphereBackground {
  @StorageProp('backgroundMode') backgroundMode: BackgroundMode = BackgroundMode.VIDEO;
  @StorageProp('themeKey') @Watch('onThemeChange') themeKey: string = 'sunny_day';
  
  @State private videoPrepared: boolean = false;
  @State private retryCount: number = 0;
  @State private currentVideoSource: string = '';
  @State private nextVideoSource: string = '';
  @State private isTransitioning: boolean = false;
  
  private logger: DebugLogger = DebugLogger.getInstance();
  
  // è§†é¢‘èµ„æºè·¯å¾„
  @State private videoSource: string = '';
  // è§†é¢‘æ§åˆ¶å™¨ - ç”¨äºæ€§èƒ½ä¼˜åŒ–
  private videoController: VideoController = new VideoController();

  aboutToAppear(): void {
    const initData: LogData = {
      'themeKey': this.themeKey,
      'backgroundMode': String(this.backgroundMode)
    };
    this.logger.lifecycle('AtmosphereBackground', 'aboutToAppear å¼€å§‹', initData);
    
    // å¼ºåˆ¶è®¾ç½®ä¸ºVIDEOæ¨¡å¼
    this.backgroundMode = BackgroundMode.VIDEO;
    this.updateVideoSource();
    this.currentVideoSource = this.videoSource;
    
    this.logger.lifecycle('AtmosphereBackground', 'aboutToAppear å®Œæˆ');
  }

  private updateVideoSource(): void {
    // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ ThemeConstants è·å–æ­£ç¡®çš„è§†é¢‘è·¯å¾„
    const theme = ThemeConstants.getTheme(this.themeKey);
    let rawPath = theme.videoResource || 'rawfile/weather/sunny_day.mp4';
    
    // ç§»é™¤ 'rawfile/' å‰ç¼€ï¼Œå› ä¸º $rawfile() ä¼šè‡ªåŠ¨æ·»åŠ 
    if (rawPath.startsWith('rawfile/')) {
      rawPath = rawPath.substring(8); // ç§»é™¤ 'rawfile/'
    }
    
    this.videoSource = rawPath;
    this.retryCount = 0; // Reset retry count on theme change
    
    const assetData: LogData = {
      'themeKey': this.themeKey,
      'videoSource': this.videoSource,
      'fullPath': `rawfile/${this.videoSource}`
    };
    this.logger.info('AtmosphereBackground', 'ğŸ“ è§†é¢‘èµ„æºè·¯å¾„', assetData);
  }

  private onThemeChange(): void {
    const logData: LogData = {
      'newTheme': this.themeKey
    };
    this.logger.info('AtmosphereBackground', 'ğŸ¨ ä¸»é¢˜å˜æ›´', logData);
    
    // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šåªæœ‰å½“è§†é¢‘æºçœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°
    const oldSource = this.videoSource;
    this.updateVideoSource();
    
    if (oldSource !== this.videoSource) {
      this.videoPrepared = false;
      this.currentVideoSource = this.videoSource;
    }
  }

  build() {
    Stack() {
      // åªæ¸²æŸ“è§†é¢‘èƒŒæ™¯ï¼Œä¸å…è®¸ä»»ä½•é™çº§
      this.renderVideoBackground();
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black) // å…œåº•èƒŒæ™¯è‰²ï¼Œé˜²æ­¢è§†é¢‘åŠ è½½å‰çš„ç™½å±
  }

  @Builder
  private renderVideoBackground(): void {
    // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨è§†é¢‘æ§åˆ¶å™¨ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡å»º
    Video({ 
      src: $rawfile(this.currentVideoSource),
      controller: this.videoController
    })
      .width('100%')
      .height('100%')
      .objectFit(ImageFit.Cover)
      .autoPlay(true)
      .loop(true)
      .muted(true)
      .controls(false)
      // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ç¨³å®šçš„keyï¼Œé¿å…é¢‘ç¹é‡å»º
      .key(`video_main_${this.currentVideoSource}`)
      .onError((error) => {
        const errorData: LogData = {
          'videoSource': this.currentVideoSource,
          'themeKey': this.themeKey,
          'errorInfo': error ? JSON.stringify(error) : 'Unknown error',
          'retryCount': this.retryCount
        };
        this.logger.error('AtmosphereBackground', 'âŒ è§†é¢‘åŠ è½½é”™è¯¯', new Error('Video load failed'));
        this.logger.info('AtmosphereBackground', 'ğŸ“Š è§†é¢‘é”™è¯¯è¯¦æƒ…', errorData);
        
        // ç®€å•çš„é‡è¯•é€»è¾‘
        if (this.retryCount < 3) {
           this.retryCount++;
           console.info(`[AtmosphereBackground] Retrying video load... (${this.retryCount}/3)`);
           // å»¶è¿Ÿé‡è¯•ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
           setTimeout(() => {
             this.currentVideoSource = this.videoSource;
           }, 500);
        }
      })
      .onPrepared((event) => {
        const preparedData: LogData = {
          'videoSource': this.currentVideoSource,
          'themeKey': this.themeKey,
          'duration': event?.duration || 0
        };
        this.videoPrepared = true;
        this.logger.info('AtmosphereBackground', 'âœ… è§†é¢‘å‡†å¤‡å®Œæˆ', preparedData);
        console.info('[AtmosphereBackground] è§†é¢‘å‡†å¤‡å®Œæˆ');
      })
      .onStart(() => {
        this.logger.info('AtmosphereBackground', 'â–¶ï¸ è§†é¢‘å¼€å§‹æ’­æ”¾');
        console.info('[AtmosphereBackground] è§†é¢‘å¼€å§‹æ’­æ”¾');
      })
      .onFinish(() => {
        this.logger.info('AtmosphereBackground', 'âœ… è§†é¢‘æ’­æ”¾å®Œæˆ');
      })
  }
}

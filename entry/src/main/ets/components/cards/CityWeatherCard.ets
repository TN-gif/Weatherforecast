// ============================================================================
// Imports
// ============================================================================
import { CityWeatherState } from '../../viewmodel/WeatherController';
import { FormatHelper } from '../../common/utils/FormatHelper';
import { CityRepository } from '../../data/repository/CityRepository';
import { DesignSystem } from '../../common/theme/DesignSystem';

// ============================================================================
// åŸå¸‚å¤©æ°”å¡ç‰‡ç»„ä»¶
// ============================================================================

/**
 * åŸå¸‚å¤©æ°”å¡ç‰‡ç»„ä»¶
 * 
 * ç”¨äºåœ¨ä¸»é¡µé¢å±•ç¤ºå•ä¸ªåŸå¸‚çš„å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŸå¸‚åç§°ã€å¤©æ°”æè¿°ã€
 * å½“å‰æ¸©åº¦ã€ä½“æ„Ÿæ¸©åº¦ã€ç©ºæ°”è´¨é‡ä»¥åŠå½“æ—¥æœ€é«˜æœ€ä½æ¸©åº¦ã€‚
 * 
 * ä½¿ç”¨åœºæ™¯ï¼š
 * - ä¸»é¡µé¢çš„åŸå¸‚å¤©æ°”è½®æ’­å¡ç‰‡
 * - åŸå¸‚ç®¡ç†é¡µé¢çš„å¤©æ°”é¢„è§ˆ
 * 
 * @component
 * @param cityState - åŸå¸‚å¤©æ°”çŠ¶æ€æ•°æ®ï¼ŒåŒ…å«åŸå¸‚ä¿¡æ¯å’Œå¤©æ°”å¿«ç…§
 * @param isActive - æ˜¯å¦ä¸ºå½“å‰æ¿€æ´»çš„å¡ç‰‡ï¼ˆç”¨äºåŠ¨ç”»å’Œäº¤äº’ï¼‰
 */
@Component
export struct CityWeatherCard {
  // ============================================================================
  // ç»„ä»¶å±æ€§
  // ============================================================================
  
  /** åŸå¸‚å¤©æ°”çŠ¶æ€æ•°æ® */
  @Prop cityState: CityWeatherState = new CityWeatherState(CityRepository.createDefaultCity(), null, false, '');
  
  /** æ˜¯å¦ä¸ºå½“å‰æ¿€æ´»çš„å¡ç‰‡ */
  @Prop isActive: boolean = false;
  
  /** å¤œé—´æ¨¡å¼æ ‡å¿—ï¼ˆå½±å“æ–‡æœ¬é¢œè‰²ï¼‰ */
  @StorageProp('isNightMode') isNightMode: boolean = true;

  // ============================================================================
  // ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
  // ============================================================================
  
  aboutToAppear(): void {
    console.info(`[CityWeatherCard] ğŸ“Š ç»„ä»¶åˆ›å»º: ${this.cityState?.city?.name}, hasSnapshot=${!!this.cityState?.snapshot}`);
    if (this.cityState?.snapshot) {
      console.info(`[CityWeatherCard] ğŸŒ¡ï¸ æ¸©åº¦: ${this.cityState.snapshot.current.temperatureC}Â°C, å¤©æ°”: ${this.cityState.snapshot.current.condition.description}`);
    }
  }

  // ============================================================================
  // ä¸»æ„å»ºæ–¹æ³•
  // ============================================================================
  
  build() {
    Column() {
      this.renderCityName()
      this.renderLocationDetail()
      this.renderDescription()
      this.renderSummaryLine()
      this.renderMainTemperature()
      this.renderHighLowTemp()
    }
    .width('100%')
    .padding({ 
      top: DesignSystem.SPACING_L, 
      left: DesignSystem.SPACING_M, 
      right: DesignSystem.SPACING_M,
      bottom: DesignSystem.SPACING_M 
    })
  }

  // ============================================================================
  // UI æ¸²æŸ“æ–¹æ³•ç»„
  // ============================================================================
  
  /**
   * æ¸²æŸ“åŸå¸‚åç§°ï¼ˆå¤§å­—éƒ¨åˆ† - ç®€æ´æ˜¾ç¤ºï¼‰
   * åªæ˜¾ç¤ºåŸå¸‚åç§°çš„ä¸»è¦éƒ¨åˆ†ï¼Œä¸åŒ…å«è¡Œæ”¿åŒºåˆ’
   */
  @Builder
  private renderCityName() {
    Text(this.getCityNameSimple())
      .fontSize(32)
      .fontWeight(DesignSystem.FONT_WEIGHT_SEMIBOLD)
      .fontFamily(DesignSystem.FONT_FAMILY_PRIMARY)
      .fontColor(this.getTextColor('primary'))
      .textAlign(TextAlign.Center)
      .width('100%')
      .textShadow(this.getTextShadow('normal'))
  }

  /**
   * æ¸²æŸ“åœ°ç†ä½ç½®è¯¦æƒ…ï¼ˆå°å­—éƒ¨åˆ† - è¯¦ç»†æ˜¾ç¤ºï¼‰
   * æ˜¾ç¤ºå®Œæ•´çš„è¡Œæ”¿åŒºåˆ’ä¿¡æ¯ï¼Œå¦‚"æ²³åŒ—çœ å”å±±å¸‚"
   */
  @Builder
  private renderLocationDetail() {
    if (this.getLocationDetail()) {
      Text(this.getLocationDetail())
        .fontSize(14)
        .fontWeight(DesignSystem.FONT_WEIGHT_REGULAR)
        .fontFamily(DesignSystem.FONT_FAMILY_PRIMARY)
        .fontColor(this.getTextColor('secondary'))
        .opacity(0.85)
        .margin({ top: 4 })
        .textAlign(TextAlign.Center)
        .width('100%')
        .textShadow(this.getTextShadow('normal'))
    }
  }

  /**
   * æ¸²æŸ“å¤©æ°”æè¿°
   */
  @Builder
  private renderDescription() {
    Text(this.getDescription())
      .fontSize(18)
      .fontWeight(DesignSystem.FONT_WEIGHT_REGULAR)
      .fontFamily(DesignSystem.FONT_FAMILY_PRIMARY)
      .fontColor(this.getTextColor('primary'))
      .opacity(0.9)
      .margin({ top: DesignSystem.SPACING_XS })
      .textAlign(TextAlign.Center)
      .width('100%')
      .textShadow(this.getTextShadow('normal'))
  }

  /**
   * æ¸²æŸ“æ‘˜è¦è¡Œï¼ˆä½“æ„Ÿæ¸©åº¦å’Œç©ºæ°”è´¨é‡ï¼‰
   */
  @Builder
  private renderSummaryLine() {
    if (this.cityState.snapshot) {
      Row({ space: DesignSystem.SPACING_S }) {
        Text(`ä½“æ„Ÿ ${FormatHelper.formatTemperature(this.cityState.snapshot.current.feelsLikeC)}`)
          .fontSize(14)
          .fontWeight(DesignSystem.FONT_WEIGHT_REGULAR)
          .fontFamily(DesignSystem.FONT_FAMILY_PRIMARY)
          .fontColor(this.getTextColor('secondary'))

        Text('Â·')
          .fontSize(14)
          .fontColor(this.getTextColor('tertiary'))

        Text(`ç©ºæ°” ${FormatHelper.formatAqi(this.cityState.snapshot.current.aqi)}`)
          .fontSize(14)
          .fontWeight(DesignSystem.FONT_WEIGHT_REGULAR)
          .fontFamily(DesignSystem.FONT_FAMILY_PRIMARY)
          .fontColor(this.getTextColor('secondary'))
      }
      .justifyContent(FlexAlign.Center)
      .width('100%')
      .margin({ top: DesignSystem.SPACING_S })
    }
  }

  /**
   * æ¸²æŸ“ä¸»æ¸©åº¦æ˜¾ç¤º
   */
  @Builder
  private renderMainTemperature() {
    Text(this.getTemperatureText())
      .fontSize(110)
      .fontWeight(DesignSystem.FONT_WEIGHT_LIGHT)
      .fontFamily(DesignSystem.FONT_FAMILY_PRIMARY)
      .fontColor(this.getTextColor('primary'))
      .height(120)
      .letterSpacing(-2)
      .margin({ top: DesignSystem.SPACING_S })
      .textAlign(TextAlign.Center)
      .width('100%')
      .textShadow(this.getTextShadow('large'))
  }

  /**
   * æ¸²æŸ“æœ€é«˜æœ€ä½æ¸©åº¦
   */
  @Builder
  private renderHighLowTemp() {
    if (this.cityState.snapshot && this.cityState.snapshot.daily.length > 0) {
      Text(`æœ€é«˜ ${FormatHelper.formatTemperature(this.cityState.snapshot.daily[0].maxTempC)} æœ€ä½ ${FormatHelper.formatTemperature(this.cityState.snapshot.daily[0].minTempC)}`)
        .fontSize(16)
        .fontWeight(DesignSystem.FONT_WEIGHT_MEDIUM)
        .fontFamily(DesignSystem.FONT_FAMILY_PRIMARY)
        .fontColor(this.getTextColor('primary'))
        .margin({ top: DesignSystem.SPACING_S })
        .textAlign(TextAlign.Center)
        .width('100%')
        .textShadow(this.getTextShadow('normal'))
    }
  }

  // ============================================================================
  // æ ·å¼è®¡ç®—æ–¹æ³•ç»„
  // ============================================================================
  
  /**
   * è·å–æ–‡æœ¬é¢œè‰²
   * 
   * æ ¹æ®å¤œé—´æ¨¡å¼å’Œé¢œè‰²çº§åˆ«è¿”å›å¯¹åº”çš„æ–‡æœ¬é¢œè‰²ã€‚
   * 
   * @param level é¢œè‰²çº§åˆ«ï¼ˆ'primary' | 'secondary' | 'tertiary'ï¼‰
   * @returns é¢œè‰²å­—ç¬¦ä¸²
   */
  private getTextColor(level: string): string {
    if (this.isNightMode) {
      if (level === 'primary') return DesignSystem.COLOR_TEXT_PRIMARY;
      if (level === 'secondary') return DesignSystem.COLOR_TEXT_SECONDARY;
      return DesignSystem.COLOR_TEXT_TERTIARY;
    } else {
      if (level === 'primary') return DesignSystem.COLOR_TEXT_PRIMARY_DAY;
      if (level === 'secondary') return DesignSystem.COLOR_TEXT_SECONDARY_DAY;
      return DesignSystem.COLOR_TEXT_TERTIARY_DAY;
    }
  }

  /**
   * è·å–æ–‡æœ¬é˜´å½±æ ·å¼
   * 
   * ç»Ÿä¸€çš„é˜´å½±è®¡ç®—æ–¹æ³•ï¼Œæ ¹æ®æ–‡æœ¬ç±»å‹è¿”å›å¯¹åº”çš„é˜´å½±é…ç½®ã€‚
   * ç™½å¤©å’Œå¤œé—´éƒ½ä½¿ç”¨æ·±è‰²é˜´å½±ï¼Œå› ä¸ºæ–‡å­—éƒ½æ˜¯ç™½è‰²ã€‚
   * 
   * @param shadowType é˜´å½±ç±»å‹ï¼ˆ'large' ç”¨äºä¸»æ¸©åº¦æ˜¾ç¤ºï¼Œ'normal' ç”¨äºæ™®é€šæ–‡æœ¬ï¼‰
   * @returns é˜´å½±é…ç½®å¯¹è±¡
   */
  private getTextShadow(shadowType: 'large' | 'normal' = 'normal'): ShadowOptions {
    if (shadowType === 'large') {
      // å¤§æ¸©åº¦æ•°å­—ä½¿ç”¨æ›´æ˜æ˜¾çš„é˜´å½±
      return { radius: 10, color: 'rgba(0, 0, 0, 0.4)', offsetX: 0, offsetY: 2 };
    } else {
      // æ™®é€šæ–‡æœ¬ä½¿ç”¨æ ‡å‡†é˜´å½±
      return { radius: 6, color: 'rgba(0, 0, 0, 0.35)', offsetX: 0, offsetY: 1 };
    }
  }

  // ============================================================================
  // æ•°æ®å¤„ç†æ–¹æ³•ç»„
  // ============================================================================
  
  /**
   * è·å–ç®€å•åŸå¸‚åç§°ï¼ˆç”¨äºå¤§å­—æ˜¾ç¤ºï¼‰
   * 
   * åªè¿”å›åŸå¸‚åç§°çš„ä¸»è¦éƒ¨åˆ†ï¼Œä¸åŒ…å«è¡Œæ”¿åŒºåˆ’ä¿¡æ¯ã€‚
   * ä¾‹å¦‚ï¼š
   * - "å”å±±, æ²³åŒ—çœ" â†’ "å”å±±"
   * - "è·¯å—åŒº, å”å±±å¸‚, æ²³åŒ—çœ" â†’ "è·¯å—åŒº"
   * - "åŒ—äº¬, ä¸­å›½" â†’ "åŒ—äº¬"
   * 
   * @returns ç®€æ´çš„åŸå¸‚åç§°
   */
  private getCityNameSimple(): string {
    const name: string = this.cityState.city.name;
    
    // å¦‚æœæ²¡æœ‰é€—å·ï¼Œç›´æ¥è¿”å›
    if (!name.includes(',')) {
      return name;
    }
    
    // åˆ†å‰²åŸå¸‚åç§°ï¼Œåªè¿”å›ç¬¬ä¸€éƒ¨åˆ†
    const parts = name.split(',').map(part => part.trim());
    return parts[0];
  }

  /**
   * è·å–åœ°ç†ä½ç½®è¯¦æƒ…ï¼ˆç”¨äºå°å­—æ˜¾ç¤ºï¼‰
   * 
   * è¿”å›å®Œæ•´çš„è¡Œæ”¿åŒºåˆ’ä¿¡æ¯ï¼Œä¸åŒ…å«åŸå¸‚åç§°æœ¬èº«ã€‚
   * ä¾‹å¦‚ï¼š
   * - "å”å±±, æ²³åŒ—çœ" â†’ "æ²³åŒ—çœ"
   * - "è·¯å—åŒº, å”å±±å¸‚, æ²³åŒ—çœ" â†’ "æ²³åŒ—çœ å”å±±å¸‚"
   * - "åŒ—äº¬, ä¸­å›½" â†’ nullï¼ˆä¸æ˜¾ç¤ºå›½å®¶ï¼‰
   * - "Manhattan, New York, United States" â†’ "New York, United States"
   * 
   * @returns åœ°ç†ä½ç½®è¯¦æƒ…å­—ç¬¦ä¸²ï¼Œå¦‚æœæ²¡æœ‰é¢å¤–ä¿¡æ¯åˆ™è¿”å› null
   */
  private getLocationDetail(): string | null {
    const name: string = this.cityState.city.name;
    
    // å¦‚æœæ²¡æœ‰é€—å·ï¼Œæ²¡æœ‰é¢å¤–ä¿¡æ¯
    if (!name.includes(',')) {
      return null;
    }
    
    // åˆ†å‰²åŸå¸‚åç§°
    const parts = name.split(',').map(part => part.trim());
    
    // å¦‚æœåªæœ‰2éƒ¨åˆ†
    if (parts.length === 2) {
      // å¦‚æœç¬¬äºŒéƒ¨åˆ†æ˜¯"ä¸­å›½"æˆ–"China"ï¼Œä¸æ˜¾ç¤ºï¼ˆé¿å…å†—ä½™ï¼‰
      if (parts[1] === 'ä¸­å›½' || parts[1] === 'China') {
        return null;
      }
      // å¦åˆ™æ˜¾ç¤ºç¬¬äºŒéƒ¨åˆ†ï¼ˆå¦‚å›½å®¶åï¼‰
      return parts[1];
    }
    
    // å¦‚æœæœ‰3éƒ¨åˆ†ï¼ˆå¦‚"è·¯å—åŒº, å”å±±å¸‚, æ²³åŒ—çœ"ï¼‰
    if (parts.length === 3) {
      // å¯¹äºä¸­å›½åŸå¸‚ï¼Œæ˜¾ç¤º"çœ å¸‚"çš„æ ¼å¼
      if (this.cityState.city.country === 'ä¸­å›½' || this.cityState.city.country === 'China') {
        return `${parts[2]} ${parts[1]}`;
      }
      // å¯¹äºå›½é™…åŸå¸‚ï¼Œæ˜¾ç¤º"å·/çœ, å›½å®¶"
      return `${parts[1]}, ${parts[2]}`;
    }
    
    // å¦‚æœæœ‰æ›´å¤šéƒ¨åˆ†ï¼Œæ˜¾ç¤ºåé¢çš„éƒ¨åˆ†
    return parts.slice(1).join(', ');
  }

  /**
   * è·å–å¤©æ°”æè¿°
   * 
   * @returns å¤©æ°”æè¿°æ–‡æœ¬ï¼Œæ— æ•°æ®æ—¶è¿”å› '--'
   */
  private getDescription(): string {
    return this.cityState.snapshot !== null
      ? this.cityState.snapshot.current.condition.description
      : '--';
  }

  /**
   * è·å–æ¸©åº¦æ–‡æœ¬
   * 
   * @returns æ ¼å¼åŒ–çš„æ¸©åº¦æ–‡æœ¬ï¼ˆå¦‚ "25Â°"ï¼‰ï¼Œæ— æ•°æ®æ—¶è¿”å› '--'
   */
  private getTemperatureText(): string {
    return this.cityState.snapshot !== null
      ? `${Math.round(this.cityState.snapshot.current.temperatureC)}Â°`
      : '--';
  }
}

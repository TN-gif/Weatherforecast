import http from '@ohos.net.http';
import { Coordinates } from '../models/WeatherModels';

/**
 * æ—¶åŒºæœåŠ¡
 * ç”¨äºæ ¹æ®åŸå¸‚ç»çº¬åº¦è·å–æ—¶åŒºåç§»é‡
 */
export class TimeZoneService {
  private static instance: TimeZoneService;
  private readonly timeoutMs: number = 10000;

  private constructor() {}

  static getInstance(): TimeZoneService {
    if (!TimeZoneService.instance) {
      TimeZoneService.instance = new TimeZoneService();
    }
    return TimeZoneService.instance;
  }

  /**
   * æ ¹æ®ç»çº¬åº¦è·å–æ—¶åŒºåç§»é‡ï¼ˆåˆ†é’Ÿï¼‰
   * @param coords ç»çº¬åº¦åæ ‡
   * @returns æ—¶åŒºåç§»é‡ï¼ˆåˆ†é’Ÿï¼‰ï¼Œç›¸å¯¹äºUTCã€‚ä¾‹å¦‚ï¼šUTC+8 = 480, UTC-5 = -300
   */
  async getTimezoneOffset(coords: Coordinates): Promise<number> {
    try {
      console.info(`[TimeZoneService] ğŸŒ è·å–æ—¶åŒº: lat=${coords.latitude}, lon=${coords.longitude}`);
      
      // TODO: é›†æˆå®é™…çš„æ—¶åŒºAPI
      // é€‰é¡¹1: TimeZoneDB API
      // é€‰é¡¹2: Google Time Zone API
      // é€‰é¡¹3: å’Œé£å¤©æ°”APIï¼ˆå¦‚æœæ”¯æŒï¼‰
      
      // ä¸´æ—¶æ–¹æ¡ˆï¼šæ ¹æ®ç»åº¦ç²—ç•¥ä¼°ç®—æ—¶åŒº
      const estimatedOffset = this.estimateTimezoneByLongitude(coords.longitude);
      console.info(`[TimeZoneService] â° ä¼°ç®—æ—¶åŒºåç§»: ${estimatedOffset}åˆ†é’Ÿ (UTC${estimatedOffset >= 0 ? '+' : ''}${estimatedOffset / 60})`);
      
      return estimatedOffset;
    } catch (error) {
      console.error(`[TimeZoneService] âŒ è·å–æ—¶åŒºå¤±è´¥: ${error}`);
      // å¤±è´¥æ—¶è¿”å›UTC+8ï¼ˆä¸­å›½æ ‡å‡†æ—¶é—´ï¼‰ä½œä¸ºé»˜è®¤å€¼
      return 480;
    }
  }

  /**
   * ä¸´æ—¶æ–¹æ¡ˆï¼šæ ¹æ®ç»åº¦ç²—ç•¥ä¼°ç®—æ—¶åŒº
   * æ³¨æ„ï¼šè¿™åªæ˜¯ç²—ç•¥ä¼°ç®—ï¼Œä¸è€ƒè™‘å¤ä»¤æ—¶å’Œç‰¹æ®Šæ—¶åŒº
   * @param longitude ç»åº¦
   * @returns æ—¶åŒºåç§»é‡ï¼ˆåˆ†é’Ÿï¼‰
   */
  private estimateTimezoneByLongitude(longitude: number): number {
    // åœ°çƒæ¯15åº¦ç»åº¦å¯¹åº”1å°æ—¶æ—¶å·®
    // ç»åº¦0åº¦ä¸ºUTC+0ï¼ˆæ ¼æ—å¨æ²»ï¼‰
    const hours = Math.round(longitude / 15);
    return hours * 60;
  }

  /**
   * ä½¿ç”¨ TimeZoneDB API è·å–æ—¶åŒºï¼ˆéœ€è¦API Keyï¼‰
   * APIæ–‡æ¡£: https://timezonedb.com/api
   */
  private async fetchFromTimeZoneDB(coords: Coordinates, apiKey: string): Promise<number> {
    const url = `https://api.timezonedb.com/v2.1/get-time-zone?key=${apiKey}&format=json&by=position&lat=${coords.latitude}&lng=${coords.longitude}`;
    
    const httpRequest = http.createHttp();
    try {
      const response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: this.timeoutMs,
        readTimeout: this.timeoutMs
      });

      if (response.responseCode !== 200) {
        throw new Error(`HTTP ${response.responseCode}`);
      }

      const data = JSON.parse(response.result as string);
      
      if (data.status === 'OK') {
        // gmtOffset æ˜¯ç§’æ•°ï¼Œéœ€è¦è½¬æ¢ä¸ºåˆ†é’Ÿ
        const offsetMinutes = Math.round(data.gmtOffset / 60);
        console.info(`[TimeZoneService] âœ… TimeZoneDBè¿”å›æ—¶åŒº: ${data.zoneName}, åç§»: ${offsetMinutes}åˆ†é’Ÿ`);
        return offsetMinutes;
      } else {
        throw new Error(`TimeZoneDB API error: ${data.message}`);
      }
    } finally {
      httpRequest.destroy();
    }
  }

  /**
   * ä½¿ç”¨ Google Time Zone API è·å–æ—¶åŒºï¼ˆéœ€è¦API Keyï¼‰
   * APIæ–‡æ¡£: https://developers.google.com/maps/documentation/timezone/overview
   */
  private async fetchFromGoogleTimeZone(coords: Coordinates, apiKey: string): Promise<number> {
    const timestamp = Math.floor(Date.now() / 1000);
    const url = `https://maps.googleapis.com/maps/api/timezone/json?location=${coords.latitude},${coords.longitude}&timestamp=${timestamp}&key=${apiKey}`;
    
    const httpRequest = http.createHttp();
    try {
      const response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: this.timeoutMs,
        readTimeout: this.timeoutMs
      });

      if (response.responseCode !== 200) {
        throw new Error(`HTTP ${response.responseCode}`);
      }

      const data = JSON.parse(response.result as string);
      
      if (data.status === 'OK') {
        // rawOffset + dstOffset = æ€»åç§»é‡ï¼ˆç§’ï¼‰
        const totalOffsetSeconds = data.rawOffset + data.dstOffset;
        const offsetMinutes = Math.round(totalOffsetSeconds / 60);
        console.info(`[TimeZoneService] âœ… Googleè¿”å›æ—¶åŒº: ${data.timeZoneId}, åç§»: ${offsetMinutes}åˆ†é’Ÿ`);
        return offsetMinutes;
      } else {
        throw new Error(`Google Time Zone API error: ${data.status}`);
      }
    } finally {
      httpRequest.destroy();
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶åŒºåç§»é‡ä¸ºå¯è¯»å­—ç¬¦ä¸²
   * @param offsetMinutes æ—¶åŒºåç§»é‡ï¼ˆåˆ†é’Ÿï¼‰
   * @returns æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "UTC+8:00", "UTC-5:30"
   */
  static formatTimezoneOffset(offsetMinutes: number): string {
    const sign = offsetMinutes >= 0 ? '+' : '-';
    const absMinutes = Math.abs(offsetMinutes);
    const hours = Math.floor(absMinutes / 60);
    const minutes = absMinutes % 60;
    return `UTC${sign}${hours}:${minutes.toString().padStart(2, '0')}`;
  }
}

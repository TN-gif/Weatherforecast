import http from '@ohos.net.http';
import { Coordinates } from '../models/WeatherModels';
import { WeatherApiConstants } from '../../common/constants/WeatherApiConstants';
import { OpenMeteoGeoService, OpenMeteoGeoResult } from './OpenMeteoGeoService';

// å’Œé£åŸå¸‚æœç´¢ä½ç½®é¡¹ - å¯¼å‡ºä¾›CitySearchServiceä½¿ç”¨
export interface QWeatherLocationItem {
  name: string;
  id: string;
  lat: string;
  lon: string;
  adm2: string;
  adm1: string;
  country: string;
  tz: string;
  utcOffset: string;
  isDst: string;
  type: string;
  rank: string;
  fxLink: string;
}

// å’Œé£åŸå¸‚æœç´¢å“åº”
interface QWeatherCitySearchResult {
  code: string;
  location: QWeatherLocationItem[];
}

// å’Œé£é€†åœ°ç†ç¼–ç ä½ç½®é¡¹
interface QWeatherReverseLocationItem {
  name: string;
  id: string;
  lat: string;
  lon: string;
  adm2: string;
  adm1: string;
  country: string;
}

// å’Œé£é€†åœ°ç†ç¼–ç å“åº”
interface QWeatherReverseGeoResult {
  code: string;
  location: QWeatherReverseLocationItem[];
}

// Open-Meteoåœ°ç†ç¼–ç ç»“æœé¡¹ - å¯¼å‡ºä¾›CitySearchServiceä½¿ç”¨
export { OpenMeteoGeoResult } from './OpenMeteoGeoService';

// æœç´¢ç»“æœåŒ…è£… - å¯¼å‡ºä¾›CitySearchServiceä½¿ç”¨
export interface SearchResultWrapper {
  source: string;
  data: QWeatherCitySearchResult | OpenMeteoGeoResult[];
}

/**
 * å’Œé£å¤©æ°”åœ°ç†æœåŠ¡ - åŸå¸‚æœç´¢å’Œé€†åœ°ç†ç¼–ç 
 */
export class QWeatherGeoService {
  private readonly baseUrl: string;
  private readonly apiKey: string;
  private readonly timeoutMs: number = 10000;

  constructor(baseUrl: string, apiKey: string) {
    // ä½¿ç”¨é…ç½®çš„baseUrl + /geo/v2è·¯å¾„
    this.baseUrl = `${baseUrl}/geo/v2`;
    this.apiKey = apiKey;
  }

  async searchCities(keyword: string): Promise<QWeatherCitySearchResult | null> {
    if (!keyword || keyword.trim().length < 2) {
      return null;
    }

    const httpRequest = http.createHttp();
    try {
      const url = `${this.baseUrl}/city/lookup?location=${encodeURIComponent(keyword.trim())}&key=${this.apiKey}&lang=zh`;
      console.info(`[QWeatherGeoService] ğŸ” å‘èµ·åŸå¸‚æœç´¢: ${url}`);
      const startTime = Date.now();

      const response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: this.timeoutMs,
        readTimeout: this.timeoutMs
      });
      
      const duration = Date.now() - startTime;
      console.debug(`[QWeatherGeoService] â±ï¸ æœç´¢è€—æ—¶: ${duration}ms, çŠ¶æ€ç : ${response.responseCode}`);

      if (response.responseCode !== 200) {
        console.error(`[QWeatherGeoService] âŒ æœç´¢è¯·æ±‚å¤±è´¥: ${response.responseCode}`);
        return null;
      }

      const data = JSON.parse(response.result as string) as QWeatherCitySearchResult;
      
      if (data.code === '200') {
        console.info(`[QWeatherGeoService] âœ… æœç´¢æˆåŠŸï¼Œæ‰¾åˆ° ${data.location?.length || 0} ä¸ªç»“æœ`);
        return data;
      } else {
        console.warn(`[QWeatherGeoService] âš ï¸ æœç´¢APIè¿”å›ä¸šåŠ¡é”™è¯¯ç : ${data.code}`);
        return null;
      }
    } catch (error) {
      console.error(`[QWeatherGeoService] âŒ æœç´¢å¼‚å¸¸:`, error);
      return null;
    } finally {
      httpRequest.destroy();
    }
  }

  async reverseGeocode(coordinates: Coordinates): Promise<string | null> {
    const httpRequest = http.createHttp();
    try {
      const location = `${coordinates.longitude},${coordinates.latitude}`;
      const url = `${this.baseUrl}/city/lookup?location=${location}&key=${this.apiKey}&lang=zh`;
      console.info(`[QWeatherGeoService] ğŸ—ºï¸ å‘èµ·é€†åœ°ç†ç¼–ç : ${url}`);
      const startTime = Date.now();

      const response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: this.timeoutMs,
        readTimeout: this.timeoutMs
      });

      const duration = Date.now() - startTime;
      console.debug(`[QWeatherGeoService] â±ï¸ é€†ç¼–ç è€—æ—¶: ${duration}ms, çŠ¶æ€ç : ${response.responseCode}`);

      if (response.responseCode !== 200) {
        console.error(`[QWeatherGeoService] âŒ é€†ç¼–ç è¯·æ±‚å¤±è´¥: ${response.responseCode}`);
        return null;
      }

      const data = JSON.parse(response.result as string) as QWeatherReverseGeoResult;
      
      if (data.code === '200' && data.location && data.location.length > 0) {
        const result = data.location[0];
        
        // ğŸ”§ æ”¹è¿›ï¼šæ„å»ºæ›´ç²¾å‡†çš„åŸå¸‚åç§°æ˜¾ç¤º
        let cityName = result.name;
        
        // å¯¹äºä¸­å›½åŸå¸‚ï¼Œæ˜¾ç¤ºå®Œæ•´çš„è¡Œæ”¿åŒºåˆ’
        if (result.country === 'ä¸­å›½' || result.country === 'China') {
          if (result.adm2 && result.adm2 !== result.name) {
            // å¦‚æœæœ‰å¸‚çº§ä¿¡æ¯ä¸”ä¸åŸå¸‚åä¸åŒï¼Œæ˜¾ç¤º"åŸå¸‚å, å¸‚çº§, çœçº§"
            if (result.adm1 && result.adm1 !== result.adm2) {
              cityName = `${result.name}, ${result.adm2}, ${result.adm1}`;
            } else {
              cityName = `${result.name}, ${result.adm2}`;
            }
          } else if (result.adm1 && result.adm1 !== result.name) {
            // å¦‚æœåªæœ‰çœçº§ä¿¡æ¯ï¼Œæ˜¾ç¤º"åŸå¸‚å, çœçº§"
            cityName = `${result.name}, ${result.adm1}`;
          }
        } else {
          // å¯¹äºå›½é™…åŸå¸‚ï¼Œæ˜¾ç¤º"åŸå¸‚å, å›½å®¶"
          if (result.adm1 && result.adm1 !== result.name) {
            cityName = `${result.name}, ${result.adm1}, ${result.country}`;
          } else {
            cityName = `${result.name}, ${result.country}`;
          }
        }
        
        console.info(`[QWeatherGeoService] âœ… é€†ç¼–ç æˆåŠŸ: ${cityName}`);
        return cityName;
      } else {
        console.warn(`[QWeatherGeoService] âš ï¸ é€†ç¼–ç APIè¿”å›ä¸šåŠ¡é”™è¯¯ç : ${data.code}`);
        return null;
      }
    } catch (error) {
      console.error(`[QWeatherGeoService] âŒ é€†ç¼–ç å¼‚å¸¸:`, error);
      return null;
    } finally {
      httpRequest.destroy();
    }
  }
}



/**
 * åœ°ç†æœåŠ¡è·¯ç”±å™¨ - æ™ºèƒ½é€‰æ‹©å’Œé£æˆ–OpenWeather
 */
export class GeoServiceRouter {
  private qweatherGeo: QWeatherGeoService;
  private openMeteoGeo: OpenMeteoGeoService;

  constructor() {
    this.qweatherGeo = new QWeatherGeoService(
      WeatherApiConstants.QWEATHER_CONFIG.baseUrl,
      WeatherApiConstants.QWEATHER_CONFIG.apiKey
    );
    this.openMeteoGeo = new OpenMeteoGeoService();
  }

  async searchCities(keyword: string): Promise<SearchResultWrapper | null> {
    console.info(`[GeoServiceRouter] ========== å¼€å§‹æœç´¢åŸå¸‚: "${keyword}" ==========`);
    const startTime = Date.now();

    // ä¼˜å…ˆä½¿ç”¨å’Œé£å¤©æ°”
    try {
      console.info('[GeoServiceRouter] 1ï¸âƒ£ å°è¯•ä½¿ç”¨å’Œé£å¤©æ°”æœç´¢...');
      const qweatherResult = await this.qweatherGeo.searchCities(keyword);
      if (qweatherResult && qweatherResult.location && qweatherResult.location.length > 0) {
        console.info(`[GeoServiceRouter] âœ… å’Œé£æœç´¢æˆåŠŸï¼Œæ‰¾åˆ° ${qweatherResult.location.length} ä¸ªç»“æœ`);
        const wrapper: SearchResultWrapper = { 
          source: 'qweather', 
          data: qweatherResult 
        };
        console.info(`[GeoServiceRouter] â±ï¸ æœç´¢æ€»è€—æ—¶: ${Date.now() - startTime}ms`);
        return wrapper;
      }
      console.warn('[GeoServiceRouter] âš ï¸ å’Œé£æœç´¢æ— ç»“æœï¼Œå‡†å¤‡é™çº§');
    } catch (error) {
      console.warn(`[GeoServiceRouter] âš ï¸ å’Œé£æœç´¢å¤±è´¥ï¼Œé™çº§åˆ°OpenWeather:`, error);
    }

    // é™çº§åˆ°Open-Meteo
    try {
      console.info('[GeoServiceRouter] 2ï¸âƒ£ é™çº§å°è¯•ä½¿ç”¨Open-Meteoæœç´¢...');
      const openMeteoResult = await this.openMeteoGeo.searchCities(keyword);
      if (openMeteoResult && openMeteoResult.length > 0) {
        console.info(`[GeoServiceRouter] âœ… Open-Meteoæœç´¢æˆåŠŸï¼Œæ‰¾åˆ° ${openMeteoResult.length} ä¸ªç»“æœ`);
        const wrapper: SearchResultWrapper = { 
          source: 'openmeteo', 
          data: openMeteoResult 
        };
        console.info(`[GeoServiceRouter] â±ï¸ æœç´¢æ€»è€—æ—¶: ${Date.now() - startTime}ms`);
        return wrapper;
      }
      console.warn('[GeoServiceRouter] âš ï¸ Open-Meteoæœç´¢æ— ç»“æœ');
    } catch (error) {
      console.error(`[GeoServiceRouter] âŒ Open-Meteoæœç´¢å¤±è´¥:`, error);
    }

    console.warn(`[GeoServiceRouter] âŒ æ‰€æœ‰æ•°æ®æºæœç´¢å‡å¤±è´¥ï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
    return null;
  }

  async reverseGeocode(coordinates: Coordinates): Promise<string | null> {
    console.info(`[GeoServiceRouter] ========== å¼€å§‹é€†åœ°ç†ç¼–ç  ==========`);
    console.info(`[GeoServiceRouter] ğŸ“ åæ ‡: ${coordinates.latitude}, ${coordinates.longitude}`);
    const startTime = Date.now();

    if (this.isInChina(coordinates)) {
      console.info(`[GeoServiceRouter] ğŸ‡¨ğŸ‡³ åˆ¤å®šä¸ºä¸­å›½åŒºåŸŸï¼Œä¼˜å…ˆä½¿ç”¨å’Œé£å¤©æ°”`);
      
      // ç­–ç•¥ï¼šå’Œé£ -> OpenWeather
      const result = await this.qweatherGeo.reverseGeocode(coordinates);
      if (result) {
        console.info(`[GeoServiceRouter] âœ… å’Œé£é€†ç¼–ç æˆåŠŸï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
        return result;
      }
      
      console.warn(`[GeoServiceRouter] âš ï¸ å’Œé£å¤±è´¥ï¼Œé™çº§åˆ°Open-Meteo`);
      const fallbackResult = await this.openMeteoGeo.reverseGeocode(coordinates);
      if (fallbackResult) {
        console.info(`[GeoServiceRouter] âœ… Open-Meteoé€†ç¼–ç æˆåŠŸï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
        return fallbackResult;
      }
    } else {
      console.info(`[GeoServiceRouter] ğŸŒ åˆ¤å®šä¸ºå›½é™…åŒºåŸŸï¼Œä¼˜å…ˆä½¿ç”¨Open-Meteo`);
      
      // ç­–ç•¥ï¼šOpen-Meteo -> å’Œé£
      // æ³¨æ„ï¼šOpen-Meteoç›®å‰ä¸ç›´æ¥æ”¯æŒé€†åœ°ç†ç¼–ç ï¼Œè¿™é‡Œå¯èƒ½ä¼šè¿”å›nullï¼Œä»è€Œè§¦å‘LocationServiceçš„é™çº§
      const result = await this.openMeteoGeo.reverseGeocode(coordinates);
      if (result) {
        console.info(`[GeoServiceRouter] âœ… Open-Meteoé€†ç¼–ç æˆåŠŸï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
        return result;
      }
      
      console.warn(`[GeoServiceRouter] âš ï¸ Open-Meteoå¤±è´¥(æˆ–ä¸æ”¯æŒ)ï¼Œé™çº§åˆ°å’Œé£`);
      const fallbackResult = await this.qweatherGeo.reverseGeocode(coordinates);
      if (fallbackResult) {
        console.info(`[GeoServiceRouter] âœ… å’Œé£é€†ç¼–ç æˆåŠŸï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
        return fallbackResult;
      }
    }
    
    console.error(`[GeoServiceRouter] âŒ æ‰€æœ‰é€†åœ°ç†ç¼–ç æœåŠ¡å‡å¤±è´¥ï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
    return null;
  }

  private isInChina(coordinates: Coordinates): boolean {
    const lat = coordinates.latitude;
    const lon = coordinates.longitude;
    
    return (lat >= 3.86 && lat <= 53.56 && lon >= 73.50 && lon <= 135.09) ||
           (lat >= 22.15 && lat <= 22.56 && lon >= 113.83 && lon <= 114.41) ||
           (lat >= 22.11 && lat <= 22.22 && lon >= 113.52 && lon <= 113.60) ||
           (lat >= 21.90 && lat <= 25.30 && lon >= 119.50 && lon <= 122.00);
  }
}

import { WeatherController, CityWeatherState } from '../../viewmodel/WeatherController';

export type RefreshCallback = (states: CityWeatherState[]) => void;

export class BackgroundRefreshService {
  private static instance: BackgroundRefreshService;
  private refreshIntervalId: number = -1;
  private controller: WeatherController | null = null;
  private refreshCallback: RefreshCallback | null = null;
  private isRefreshing: boolean = false;
  private refreshCount: number = 0;
  private readonly REFRESH_INTERVAL_MS: number = 5 * 60 * 1000; // 5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡

  private constructor() {
    console.info('[BackgroundRefreshService] ğŸ—ï¸ åå°åˆ·æ–°æœåŠ¡å®ä¾‹åˆ›å»º');
  }

  static getInstance(): BackgroundRefreshService {
    if (!BackgroundRefreshService.instance) {
      BackgroundRefreshService.instance = new BackgroundRefreshService();
    }
    return BackgroundRefreshService.instance;
  }

  setController(controller: WeatherController, callback: RefreshCallback): void {
    this.controller = controller;
    this.refreshCallback = callback;
    console.info('[BackgroundRefreshService] âœ… æ§åˆ¶å™¨å’Œå›è°ƒå·²è®¾ç½®');
  }

  startAutoRefresh(): void {
    if (this.refreshIntervalId !== -1) {
      console.warn('[BackgroundRefreshService] âš ï¸ è‡ªåŠ¨åˆ·æ–°å·²åœ¨è¿è¡Œä¸­');
      return;
    }

    console.info('[BackgroundRefreshService] ğŸ”„ å¯åŠ¨åå°è‡ªåŠ¨åˆ·æ–°æœåŠ¡');
    console.info(`[BackgroundRefreshService] â±ï¸ åˆ·æ–°é—´éš”: ${this.REFRESH_INTERVAL_MS / 1000}ç§’ (${this.REFRESH_INTERVAL_MS / 60000}åˆ†é’Ÿ)`);

    this.refreshIntervalId = setInterval(() => {
      this.performBackgroundRefresh();
    }, this.REFRESH_INTERVAL_MS);

    console.info('[BackgroundRefreshService] âœ… åå°è‡ªåŠ¨åˆ·æ–°æœåŠ¡å·²å¯åŠ¨');
  }

  stopAutoRefresh(): void {
    if (this.refreshIntervalId === -1) {
      console.warn('[BackgroundRefreshService] âš ï¸ è‡ªåŠ¨åˆ·æ–°æœªè¿è¡Œ');
      return;
    }

    console.info('[BackgroundRefreshService] ğŸ›‘ åœæ­¢åå°è‡ªåŠ¨åˆ·æ–°æœåŠ¡');
    console.info(`[BackgroundRefreshService] ğŸ“Š æœ¬æ¬¡è¿è¡ŒæœŸé—´å…±æ‰§è¡Œäº† ${this.refreshCount} æ¬¡åå°åˆ·æ–°`);
    clearInterval(this.refreshIntervalId);
    this.refreshIntervalId = -1;
    this.refreshCount = 0;
    console.info('[BackgroundRefreshService] âœ… åå°è‡ªåŠ¨åˆ·æ–°æœåŠ¡å·²åœæ­¢');
  }

  private async performBackgroundRefresh(): Promise<void> {
    console.info(`[BackgroundRefreshService] â° å®šæ—¶å™¨è§¦å‘ï¼Œå‡†å¤‡æ‰§è¡Œç¬¬ ${this.refreshCount + 1} æ¬¡åå°åˆ·æ–°`);
    
    if (this.isRefreshing) {
      console.debug('[BackgroundRefreshService] â¸ï¸ ä¸Šä¸€æ¬¡åˆ·æ–°å°šæœªå®Œæˆï¼Œè·³è¿‡æœ¬æ¬¡åˆ·æ–°');
      return;
    }

    if (!this.controller) {
      console.warn('[BackgroundRefreshService] âš ï¸ æ§åˆ¶å™¨æœªè®¾ç½®ï¼Œæ— æ³•æ‰§è¡Œåˆ·æ–°');
      return;
    }

    try {
      this.isRefreshing = true;
      this.refreshCount++;
      const startTime = Date.now();
      console.info(`[BackgroundRefreshService] ğŸ”„ å¼€å§‹ç¬¬ ${this.refreshCount} æ¬¡åå°åˆ·æ–°å¤©æ°”æ•°æ®...`);
      console.info(`[BackgroundRefreshService] â° å¼€å§‹æ—¶é—´: ${new Date().toISOString()}`);

      // åå°åˆ·æ–°ä¸æ›´æ–°GPSå®šä½ï¼Œåªåˆ·æ–°å¤©æ°”æ•°æ®
      const states = await this.controller.loadAll(false);

      const duration = Date.now() - startTime;
      console.info(`[BackgroundRefreshService] âœ… ç¬¬ ${this.refreshCount} æ¬¡åå°åˆ·æ–°å®Œæˆï¼Œè€—æ—¶: ${duration}ms`);
      console.info(`[BackgroundRefreshService] ğŸ“Š è·å–åˆ° ${states.length} ä¸ªåŸå¸‚çš„å¤©æ°”æ•°æ®`);

      // é€šçŸ¥UIæ›´æ–°
      if (this.refreshCallback) {
        const validStates = states.filter(state => state && state.city && state.city.id);
        this.refreshCallback(validStates);
        console.info(`[BackgroundRefreshService] ğŸ“¢ å·²é€šçŸ¥UIæ›´æ–°ï¼Œæœ‰æ•ˆçŠ¶æ€æ•°: ${validStates.length}`);
      }
    } catch (error) {
      console.error(`[BackgroundRefreshService] âŒ ç¬¬ ${this.refreshCount} æ¬¡åå°åˆ·æ–°å¤±è´¥:`, error);
      console.error('[BackgroundRefreshService] âŒ é”™è¯¯è¯¦æƒ…:', (error as Error).message);
    } finally {
      this.isRefreshing = false;
      console.info(`[BackgroundRefreshService] ğŸ“Š åå°åˆ·æ–°çŠ¶æ€é‡ç½®: isRefreshing=${this.isRefreshing}`);
    }
  }

  isRunning(): boolean {
    return this.refreshIntervalId !== -1;
  }

  getRefreshCount(): number {
    return this.refreshCount;
  }
}

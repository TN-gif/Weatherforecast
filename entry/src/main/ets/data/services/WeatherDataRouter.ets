import { Coordinates, WeatherSnapshot } from '../models/WeatherModels';
import { OpenMeteoService } from './OpenMeteoService';
import { QWeatherService } from './QWeatherService';

// åœ°ç†è¾¹ç•Œæ¥å£
interface GeoBounds {
  latMin: number;
  latMax: number;
  lonMin: number;
  lonMax: number;
}

/**
 * å¤©æ°”æ•°æ®è·¯ç”±å™¨
 * æ ¹æ®åœ°ç†ä½ç½®æ™ºèƒ½é€‰æ‹©æœ€ä½³æ•°æ®æº
 */
export class WeatherDataRouter {
  private openMeteoService: OpenMeteoService;
  private qweatherService: QWeatherService;

  constructor(openMeteoService: OpenMeteoService, qweatherService: QWeatherService) {
    this.openMeteoService = openMeteoService;
    this.qweatherService = qweatherService;
  }

  /**
   * è·å–å¤©æ°”æ•°æ®ï¼ˆè‡ªåŠ¨è·¯ç”±ï¼‰
   * @param cityId åŸå¸‚ID
   * @param coordinates åŸå¸‚åæ ‡
   * @param timezoneOffsetMinutes åŸå¸‚æ—¶åŒºåç§»é‡ï¼ˆåˆ†é’Ÿï¼‰ï¼Œå¯é€‰
   */
  async fetchWeather(cityId: string, coordinates: Coordinates, timezoneOffsetMinutes?: number): Promise<WeatherSnapshot> {
    console.info(`[WeatherDataRouter] ========== å¼€å§‹å¤©æ°”æ•°æ®è·¯ç”± ==========`);
    console.info(`[WeatherDataRouter] ğŸ“ ç›®æ ‡åæ ‡: ${coordinates.latitude.toFixed(4)}, ${coordinates.longitude.toFixed(4)}`);
    if (timezoneOffsetMinutes !== undefined) {
      console.info(`[WeatherDataRouter] ğŸ•’ æ—¶åŒºåç§»: ${timezoneOffsetMinutes}åˆ†é’Ÿ`);
    }
    const startTime = Date.now();

    let snapshot: WeatherSnapshot;
    if (this.isInChina(coordinates)) {
      console.info(`[WeatherDataRouter] ğŸ‡¨ğŸ‡³ åˆ¤å®šä¸ºä¸­å›½åŒºåŸŸï¼Œè·¯ç”±è‡³å’Œé£å¤©æ°”æœåŠ¡`);
      try {
        snapshot = await this.qweatherService.fetchWeather(cityId, coordinates, timezoneOffsetMinutes);
        console.info(`[WeatherDataRouter] âœ… å’Œé£å¤©æ°”æ•°æ®è·å–æˆåŠŸ`);
      } catch (error) {
        console.error(`[WeatherDataRouter] âŒ å’Œé£å¤©æ°”æœåŠ¡å¼‚å¸¸:`, error);
        throw error instanceof Error ? error : new Error(String(error));
      }
    } else {
      console.info(`[WeatherDataRouter] ğŸŒ åˆ¤å®šä¸ºå›½é™…åŒºåŸŸï¼Œè·¯ç”±è‡³Open-MeteoæœåŠ¡`);
      try {
        snapshot = await this.openMeteoService.fetchWeather(cityId, coordinates, timezoneOffsetMinutes);
        console.info(`[WeatherDataRouter] âœ… Open-Meteoæ•°æ®è·å–æˆåŠŸ`);
      } catch (error) {
        console.error(`[WeatherDataRouter] âŒ Open-MeteoæœåŠ¡å¼‚å¸¸:`, error);
        throw error instanceof Error ? error : new Error(String(error));
      }
    }
    
    console.info(`[WeatherDataRouter] â±ï¸ æ•°æ®è·¯ç”±å®Œæˆï¼Œæ€»è€—æ—¶: ${Date.now() - startTime}ms`);
    return snapshot;
  }

  /**
   * åˆ¤æ–­åæ ‡æ˜¯å¦åœ¨ä¸­å›½å¢ƒå†…
   * åŒ…å«ä¸­å›½å¤§é™†ã€é¦™æ¸¯ã€æ¾³é—¨ã€å°æ¹¾
   */
  private isInChina(coordinates: Coordinates): boolean {
    const lat = coordinates.latitude;
    const lon = coordinates.longitude;

    // ä¸­å›½å¤§é™†è¾¹ç•Œï¼ˆåŒ…å«å—æµ·è¯¸å²›ï¼‰
    const mainlandBounds: GeoBounds = {
      latMin: 3.86,
      latMax: 53.56,
      lonMin: 73.50,
      lonMax: 135.09
    };

    // é¦™æ¸¯è¾¹ç•Œ
    const hongKongBounds: GeoBounds = {
      latMin: 22.15,
      latMax: 22.56,
      lonMin: 113.83,
      lonMax: 114.41
    };

    // æ¾³é—¨è¾¹ç•Œ
    const macauBounds: GeoBounds = {
      latMin: 22.11,
      latMax: 22.22,
      lonMin: 113.52,
      lonMax: 113.60
    };

    // å°æ¹¾è¾¹ç•Œ
    const taiwanBounds: GeoBounds = {
      latMin: 21.90,
      latMax: 25.30,
      lonMin: 119.50,
      lonMax: 122.00
    };

    // æ£€æŸ¥æ˜¯å¦åœ¨ä»»ä¸€åŒºåŸŸå†…
    const inMainland = this.isInBounds(lat, lon, mainlandBounds);
    const inHongKong = this.isInBounds(lat, lon, hongKongBounds);
    const inMacau = this.isInBounds(lat, lon, macauBounds);
    const inTaiwan = this.isInBounds(lat, lon, taiwanBounds);

    const result = inMainland || inHongKong || inMacau || inTaiwan;
    
    if (result) {
      const region = inHongKong ? 'é¦™æ¸¯' : inMacau ? 'æ¾³é—¨' : inTaiwan ? 'å°æ¹¾' : 'ä¸­å›½å¤§é™†';
      console.info(`[WeatherDataRouter] ä½ç½®åˆ¤å®š: ${region}`);
    }

    return result;
  }

  /**
   * æ£€æŸ¥åæ ‡æ˜¯å¦åœ¨æŒ‡å®šè¾¹ç•Œå†…
   */
  private isInBounds(lat: number, lon: number, bounds: GeoBounds): boolean {
    return lat >= bounds.latMin
      && lat <= bounds.latMax
      && lon >= bounds.lonMin
      && lon <= bounds.lonMax;
  }

  /**
   * è·å–å½“å‰ä½¿ç”¨çš„æ•°æ®æºåç§°ï¼ˆç”¨äºè°ƒè¯•ï¼‰
   */
  getDataSourceName(coordinates: Coordinates): string {
    return this.isInChina(coordinates) ? 'QWeather (å’Œé£å¤©æ°”)' : 'Open-Meteo';
  }
}

import http from '@ohos.net.http';
import { City, CitySource, Coordinates } from '../models/WeatherModels';
import { GeoServiceRouter, QWeatherLocationItem, OpenMeteoGeoResult } from './GeoServiceRouter';

export interface CitySearchResult {
  id: string;
  name: string;
  country: string;
  state?: string;
  coordinates: Coordinates;
  timezone?: string;  // æ—¶åŒºåç§°ï¼Œå¦‚ "Asia/Shanghai"
  utcOffset?: string;  // UTCåç§»ï¼Œå¦‚ "+08:00"
}

// å®šä¹‰æ•°æ®åŒ…è£…æ¥å£
interface SearchDataWrapper {
  source: string;
  data: QWeatherCitySearchData | OpenMeteoGeoResult[];
}

interface QWeatherCitySearchData {
  code: string;
  location: QWeatherLocationItem[];
}

export class CitySearchService {
  private static instance: CitySearchService | null = null;
  private readonly geoRouter: GeoServiceRouter = new GeoServiceRouter();
  private existingCityIds: Set<string> = new Set();

  private constructor() {}

  static getInstance(): CitySearchService {
    if (CitySearchService.instance === null) {
      CitySearchService.instance = new CitySearchService();
    }
    return CitySearchService.instance;
  }

  setExistingCities(cityIds: string[]): void {
    this.existingCityIds = new Set(cityIds);
  }

  async searchCities(keyword: string): Promise<CitySearchResult[]> {
    if (!keyword || keyword.trim().length < 2) {
      return [];
    }

    console.info(`[CitySearchService] ========== å¼€å§‹æœç´¢åŸå¸‚: "${keyword}" ==========`);
    const startTime = Date.now();
    
    try {
      console.info('[CitySearchService] ğŸ“¡ è°ƒç”¨GeoRouterè¿›è¡Œæœç´¢...');
      const routerResult = await this.geoRouter.searchCities(keyword);
      
      if (!routerResult) {
        console.warn(`[CitySearchService] âš ï¸ æœç´¢æ— ç»“æœï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
        return [];
      }

      const source = routerResult.source;
      const data = routerResult.data;
      console.info(`[CitySearchService] âœ… è·å–åˆ°æœç´¢æ•°æ®ï¼Œæ¥æº: ${source}`);

      let results: CitySearchResult[] = [];
      
      if (source === 'qweather') {
        // å’Œé£å¤©æ°”æ•°æ®æ ¼å¼
        console.debug('[CitySearchService] ğŸ”„ è§£æå’Œé£å¤©æ°”æ•°æ®...');
        const qweatherData = data as QWeatherCitySearchData;
        results = qweatherData.location
          .filter((item: QWeatherLocationItem) => {
            const isValid = this.isValidQWeatherResult(item);
            if (!isValid) console.warn(`[CitySearchService] âš ï¸ å¿½ç•¥æ— æ•ˆçš„å’Œé£æ•°æ®é¡¹: ${JSON.stringify(item)}`);
            return isValid;
          })
          .map((item: QWeatherLocationItem) => this.mapQWeatherToSearchResult(item));
      } else {
        // Open-Meteoæ•°æ®æ ¼å¼
        console.debug('[CitySearchService] ğŸ”„ è§£æOpen-Meteoæ•°æ®...');
        const openMeteoData = data as OpenMeteoGeoResult[];
        results = openMeteoData
          .filter((item: OpenMeteoGeoResult) => {
             const isValid = this.isValidOpenMeteoResult(item);
             if (!isValid) console.warn(`[CitySearchService] âš ï¸ å¿½ç•¥æ— æ•ˆçš„Open-Meteoæ•°æ®é¡¹: ${JSON.stringify(item)}`);
             return isValid;
          })
          .map((item: OpenMeteoGeoResult) => this.mapOpenMeteoToSearchResult(item));
      }

      // è¿‡æ»¤å·²å­˜åœ¨åŸå¸‚
      const initialCount = results.length;
      results = results.filter((result: CitySearchResult) => {
        const exists = this.existingCityIds.has(result.id);
        if (exists) {
          console.debug(`[CitySearchService] ğŸš« è¿‡æ»¤å·²å­˜åœ¨åŸå¸‚: ${result.name} (${result.id})`);
        }
        return !exists;
      });

      console.info(`[CitySearchService] âœ… æœç´¢å®Œæˆï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
      console.info(`[CitySearchService] ğŸ“Š ç»“æœç»Ÿè®¡: åŸå§‹=${initialCount}, è¿‡æ»¤å=${results.length}`);
      
      return results;

    } catch (error) {
      console.error(`[CitySearchService] âŒ æœç´¢å¼‚å¸¸ï¼Œè€—æ—¶: ${Date.now() - startTime}ms:`, error);
      return [];
    }
  }

  private isValidQWeatherResult(item: QWeatherLocationItem): boolean {
    return item && 
           typeof item.name === 'string' &&
           typeof item.country === 'string' &&
           typeof item.lat === 'string' &&
           typeof item.lon === 'string';
  }

  private isValidOpenMeteoResult(item: OpenMeteoGeoResult): boolean {
    return item && 
           typeof item.name === 'string' && 
           typeof item.country === 'string' &&
           typeof item.latitude === 'number' && 
           typeof item.longitude === 'number';
  }

  private mapQWeatherToSearchResult(item: QWeatherLocationItem): CitySearchResult {
    const coordinates: Coordinates = {
      latitude: parseFloat(item.lat),
      longitude: parseFloat(item.lon)
    };

    const id = `qw_${item.id}`;
    
    // ğŸ”§ æ”¹è¿›ï¼šæ„å»ºæ›´ç²¾å‡†çš„åŸå¸‚åç§°æ˜¾ç¤º
    // ä¼˜å…ˆçº§ï¼šadm2ï¼ˆå¸‚çº§ï¼‰ > adm1ï¼ˆçœçº§ï¼‰ > countryï¼ˆå›½å®¶ï¼‰
    let displayName = item.name;
    
    // å¯¹äºä¸­å›½åŸå¸‚ï¼Œæ˜¾ç¤ºå®Œæ•´çš„è¡Œæ”¿åŒºåˆ’
    if (item.country === 'ä¸­å›½' || item.country === 'China') {
      if (item.adm2 && item.adm2 !== item.name) {
        // å¦‚æœæœ‰å¸‚çº§ä¿¡æ¯ä¸”ä¸åŸå¸‚åä¸åŒï¼Œæ˜¾ç¤º"åŸå¸‚å, å¸‚çº§, çœçº§"
        // ä¾‹å¦‚ï¼š"è·¯å—åŒº, å”å±±å¸‚, æ²³åŒ—çœ"
        if (item.adm1 && item.adm1 !== item.adm2) {
          displayName = `${item.name}, ${item.adm2}, ${item.adm1}`;
        } else {
          displayName = `${item.name}, ${item.adm2}`;
        }
      } else if (item.adm1 && item.adm1 !== item.name) {
        // å¦‚æœåªæœ‰çœçº§ä¿¡æ¯ï¼Œæ˜¾ç¤º"åŸå¸‚å, çœçº§"
        // ä¾‹å¦‚ï¼š"å”å±±, æ²³åŒ—çœ"
        displayName = `${item.name}, ${item.adm1}`;
      }
    } else {
      // å¯¹äºå›½é™…åŸå¸‚ï¼Œæ˜¾ç¤º"åŸå¸‚å, å›½å®¶"
      if (item.adm1 && item.adm1 !== item.name) {
        displayName = `${item.name}, ${item.adm1}, ${item.country}`;
      } else {
        displayName = `${item.name}, ${item.country}`;
      }
    }

    // ğŸ”§ æ–°å¢ï¼šä¿å­˜æ—¶åŒºä¿¡æ¯åˆ°æœç´¢ç»“æœ
    const result: CitySearchResult = {
      id: id,
      name: displayName,  // ä½¿ç”¨æ„å»ºå¥½çš„å®Œæ•´æ˜¾ç¤ºåç§°
      country: item.country,
      state: item.adm1 || undefined,
      coordinates: coordinates,
      timezone: item.tz,  // æ—¶åŒºåç§°ï¼Œå¦‚ "Asia/Shanghai"
      utcOffset: item.utcOffset  // UTCåç§»ï¼Œå¦‚ "+08:00"
    };
    return result;
  }

  private mapOpenMeteoToSearchResult(item: OpenMeteoGeoResult): CitySearchResult {
    const coordinates: Coordinates = {
      latitude: item.latitude,
      longitude: item.longitude
    };

    const id = `om_${item.id}`;
    const country: string = item.country ?? 'Unknown';

    const result: CitySearchResult = {
      id: id,
      name: item.name, // OpenMeteo names are usually English/local, might need better handling if Chinese is preferred
      country: country,
      state: item.admin1 || undefined,
      coordinates: coordinates
    };
    return result;
  }

  convertToCity(searchResult: CitySearchResult): City {
    console.info(`[CitySearchService] ğŸ—ï¸ å°†æœç´¢ç»“æœè½¬æ¢ä¸ºåŸå¸‚å¯¹è±¡: ${searchResult.name}`);
    
    // ğŸ”§ æ”¹è¿›ï¼šç›´æ¥ä½¿ç”¨å·²ç»æ„å»ºå¥½çš„å®Œæ•´æ˜¾ç¤ºåç§°
    const displayName = searchResult.name;

    const theme = this.getThemeForLocation(searchResult.coordinates);
    
    // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨å’Œé£å¤©æ°”APIè¿”å›çš„å®é™…æ—¶åŒºæ•°æ®
    let timezoneOffset: number;
    if (searchResult.utcOffset) {
      // è§£æ UTC åç§»é‡ï¼Œå¦‚ "+08:00" â†’ 480åˆ†é’Ÿ
      timezoneOffset = this.parseUtcOffset(searchResult.utcOffset);
      console.info(`[CitySearchService] âœ… ä½¿ç”¨APIè¿”å›çš„æ—¶åŒº: ${searchResult.timezone} (${searchResult.utcOffset}) = ${timezoneOffset}åˆ†é’Ÿ`);
    } else {
      // é™çº§æ–¹æ¡ˆï¼šæ ¹æ®ç»åº¦ä¼°ç®—
      timezoneOffset = this.getTimezoneOffset(searchResult.coordinates);
      console.warn(`[CitySearchService] âš ï¸ APIæœªè¿”å›æ—¶åŒºï¼Œä½¿ç”¨ç»åº¦ä¼°ç®—: ${timezoneOffset}åˆ†é’Ÿ`);
    }
    
    console.debug(`[CitySearchService] ğŸ¨ è‡ªåŠ¨åŒ¹é…ä¸»é¢˜: ${theme}`);

    const city = new City(
      searchResult.id,
      displayName,
      searchResult.country,
      searchResult.coordinates,
      CitySource.MANUAL,
      theme,
      timezoneOffset
    );
    
    console.info(`[CitySearchService] âœ… åŸå¸‚å¯¹è±¡åˆ›å»ºæˆåŠŸ: ID=${city.id}, æ˜¾ç¤ºåç§°=${displayName}, æ—¶åŒºåç§»=${timezoneOffset}åˆ†é’Ÿ`);
    return city;
  }

  /**
   * è§£æ UTC åç§»é‡å­—ç¬¦ä¸²ä¸ºåˆ†é’Ÿæ•°
   * @param utcOffset UTCåç§»é‡å­—ç¬¦ä¸²ï¼Œå¦‚ "+08:00", "-05:30"
   * @returns åç§»é‡ï¼ˆåˆ†é’Ÿï¼‰ï¼Œå¦‚ 480, -330
   */
  private parseUtcOffset(utcOffset: string): number {
    try {
      // ç§»é™¤ "UTC" å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
      const offset = utcOffset.replace('UTC', '').trim();
      
      // æ£€æŸ¥æ ¼å¼æ˜¯å¦æœ‰æ•ˆ
      if (!offset || offset.length < 3) {
        console.warn(`[CitySearchService] âš ï¸ æ— æ•ˆçš„UTCåç§»æ ¼å¼: ${utcOffset}ï¼Œä½¿ç”¨é»˜è®¤å€¼0`);
        return 0;
      }
      
      // è§£æç¬¦å·
      const sign = offset.startsWith('-') ? -1 : 1;
      
      // ç§»é™¤ç¬¦å·ï¼Œåˆ†å‰²å°æ—¶å’Œåˆ†é’Ÿ
      const parts = offset.replace(/[+-]/, '').split(':');
      const hours = parseInt(parts[0]) || 0;
      const minutes = parseInt(parts[1]) || 0;
      
      // éªŒè¯èŒƒå›´ï¼ˆUTC-12 åˆ° UTC+14ï¼‰
      const totalMinutes = sign * (hours * 60 + minutes);
      if (totalMinutes < -720 || totalMinutes > 840) {
        console.warn(`[CitySearchService] âš ï¸ UTCåç§»è¶…å‡ºæœ‰æ•ˆèŒƒå›´: ${totalMinutes}åˆ†é’Ÿï¼Œä½¿ç”¨é»˜è®¤å€¼0`);
        return 0;
      }
      
      return totalMinutes;
    } catch (error) {
      console.error(`[CitySearchService] âŒ è§£æUTCåç§»å¤±è´¥: ${utcOffset}, é”™è¯¯: ${error}`);
      return 0;
    }
  }

  private getThemeForLocation(coordinates: Coordinates): string {
    const latitude = Math.abs(coordinates.latitude);
    
    // ğŸ”§ ä¿®å¤ï¼šåªè¿”å›ThemeConstantsä¸­å­˜åœ¨çš„ä¸»é¢˜
    // å¯ç”¨ä¸»é¢˜ï¼šsunny, rainy, snowï¼ˆä¸åŒ…å«cloudyï¼‰
    if (latitude > 60) {
      return 'snow';  // é«˜çº¬åº¦åœ°åŒºï¼ˆæåœ°ï¼‰
    } else if (latitude > 40) {
      return 'sunny';  // ğŸ”§ ä¿®å¤ï¼šæ”¹ä¸ºsunnyï¼ˆåŸæ¥æ˜¯cloudyï¼Œä½†æ²¡æœ‰è¿™ä¸ªä¸»é¢˜ï¼‰
    } else if (latitude > 23.5) {
      return 'sunny';  // æ¸©å¸¦åœ°åŒº
    } else {
      return 'sunny';  // çƒ­å¸¦åœ°åŒº
    }
  }

  private getTimezoneOffset(coordinates: Coordinates): number {
    const longitude = coordinates.longitude;
    const offsetHours = Math.round(longitude / 15);
    return offsetHours * 60;
  }

  getSearchSuggestions(): string[] {
    return [
      'åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'å—äº¬', 'æˆéƒ½', 'æ­¦æ±‰',
      'Beijing', 'Shanghai', 'Tokyo', 'Seoul', 'New York', 'London', 
      'Paris', 'Sydney', 'Singapore', 'Bangkok'
    ];
  }

  getPopularCities(): CitySearchResult[] {
    const popularList: CitySearchResult[] = [
      {
        id: 'popular_beijing',
        name: 'åŒ—äº¬',
        country: 'China',
        coordinates: { latitude: 39.9042, longitude: 116.4074 }
      },
      {
        id: 'popular_shanghai',
        name: 'ä¸Šæµ·',
        country: 'China',
        coordinates: { latitude: 31.2304, longitude: 121.4737 }
      },
      {
        id: 'popular_guangzhou',
        name: 'å¹¿å·',
        country: 'China',
        coordinates: { latitude: 23.1291, longitude: 113.2644 }
      },
      {
        id: 'popular_shenzhen',
        name: 'æ·±åœ³',
        country: 'China',
        coordinates: { latitude: 22.5431, longitude: 114.0579 }
      }
    ];
    return popularList;
  }
}

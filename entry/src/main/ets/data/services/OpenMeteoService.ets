import http from '@ohos.net.http';
import { WeatherSnapshot, CurrentWeather, DailyForecast, HourlyForecast, Coordinates } from '../models/WeatherModels';
import { WeatherApiConstants } from '../../common/constants/WeatherApiConstants';

// Open-Meteo API Response Interfaces
interface OpenMeteoCurrent {
  time: string;
  interval: number;
  temperature_2m: number;
  relative_humidity_2m: number;
  apparent_temperature: number;
  is_day: number;
  precipitation: number;
  rain: number;
  showers: number;
  snowfall: number;
  weather_code: number;
  cloud_cover: number;
  pressure_msl: number;
  surface_pressure: number;
  wind_speed_10m: number;
  wind_direction_10m: number;
  wind_gusts_10m: number;
}

interface OpenMeteoHourly {
  time: string[];
  temperature_2m: number[];
  relative_humidity_2m: number[];
  dew_point_2m: number[];
  apparent_temperature: number[];
  precipitation_probability: number[];
  precipitation: number[];
  weather_code: number[];
  pressure_msl: number[];
  surface_pressure: number[];
  cloud_cover: number[];
  visibility: number[];
  wind_speed_10m: number[];
  wind_direction_10m: number[];
  uv_index: number[];
}

interface OpenMeteoDaily {
  time: string[];
  weather_code: number[];
  temperature_2m_max: number[];
  temperature_2m_min: number[];
  apparent_temperature_max: number[];
  apparent_temperature_min: number[];
  sunrise: string[];
  sunset: string[];
  uv_index_max: number[];
  precipitation_sum: number[];
  rain_sum: number[];
  showers_sum: number[];
  snowfall_sum: number[];
  precipitation_hours: number[];
  precipitation_probability_max: number[];
  wind_speed_10m_max: number[];
  wind_gusts_10m_max: number[];
  wind_direction_10m_dominant: number[];
}

interface OpenMeteoResponse {
  latitude: number;
  longitude: number;
  generationtime_ms: number;
  utc_offset_seconds: number;
  timezone: string;
  timezone_abbreviation: string;
  elevation: number;
  current_units: Record<string, string>;
  current: OpenMeteoCurrent;
  hourly_units: Record<string, string>;
  hourly: OpenMeteoHourly;
  daily_units: Record<string, string>;
  daily: OpenMeteoDaily;
}

interface WmoWeatherCondition {
  text: string;
  icon: string;
  themeKey: string;
  description: string;
}

// Open-Meteo Air Quality API å“åº”æ¥å£
interface OpenMeteoAirQualityCurrent {
  time: string;
  us_aqi: number;  // ç¾å›½AQIæ ‡å‡†
  pm2_5?: number;
  pm10?: number;
}

interface OpenMeteoAirQualityResponse {
  latitude: number;
  longitude: number;
  current: OpenMeteoAirQualityCurrent;
}

export class OpenMeteoService {
  private readonly baseUrl: string = WeatherApiConstants.OPEN_METEO_CONFIG.baseUrl;
  private readonly timeoutMs: number = 15000;

  async fetchWeather(cityId: string, coordinates: Coordinates, timezoneOffsetMinutes?: number): Promise<WeatherSnapshot> {
    const httpRequest = http.createHttp();
    
    // æ„å»ºè¯·æ±‚URL
    // éœ€è¦çš„å‚æ•°:
    // current: temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,cloud_cover,pressure_msl,surface_pressure,wind_speed_10m,wind_direction_10m,wind_gusts_10m
    // hourly: temperature_2m,relative_humidity_2m,dew_point_2m,apparent_temperature,precipitation_probability,precipitation,weather_code,pressure_msl,surface_pressure,cloud_cover,visibility,wind_speed_10m,wind_direction_10m,uv_index
    // daily: weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,uv_index_max,precipitation_sum,rain_sum,showers_sum,snowfall_sum,precipitation_hours,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant
    // timezone: auto
    
    const params = [
      `latitude=${coordinates.latitude}`,
      `longitude=${coordinates.longitude}`,
      'current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,cloud_cover,pressure_msl,surface_pressure,wind_speed_10m,wind_direction_10m,wind_gusts_10m',
      'hourly=temperature_2m,relative_humidity_2m,dew_point_2m,apparent_temperature,precipitation_probability,precipitation,weather_code,pressure_msl,surface_pressure,cloud_cover,visibility,wind_speed_10m,wind_direction_10m,uv_index',
      'daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,uv_index_max,precipitation_sum,rain_sum,showers_sum,snowfall_sum,precipitation_hours,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant',
      'timezone=auto'
    ].join('&');

    const url = `${this.baseUrl}/forecast?${params}`;
    console.info(`[OpenMeteoService] ğŸ“¡ å‘èµ·å¤©æ°”è¯·æ±‚: ${url}`);

    try {
      const response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: this.timeoutMs,
        readTimeout: this.timeoutMs
      });

      if (response.responseCode !== 200) {
        throw new Error(`Open-Meteo API Error: ${response.responseCode}`);
      }

      const data = JSON.parse(response.result as string) as OpenMeteoResponse;
      
      // âœ… è°ƒç”¨ç©ºæ°”è´¨é‡API
      console.info(`[OpenMeteoService] ğŸŒ¬ï¸ è·å–ç©ºæ°”è´¨é‡æ•°æ®...`);
      const aqi = await this.fetchAirQuality(coordinates.latitude, coordinates.longitude);
      
      return this.mapToSnapshot(cityId, data, aqi, timezoneOffsetMinutes);
    } catch (error) {
      console.error(`[OpenMeteoService] âŒ è¯·æ±‚å¤±è´¥:`, error);
      throw error instanceof Error ? error : new Error(String(error));
    } finally {
      httpRequest.destroy();
    }
  }

  /**
   * è·å–ç©ºæ°”è´¨é‡æ•°æ®ï¼ˆå•ç‹¬çš„APIï¼‰
   */
  private async fetchAirQuality(lat: number, lon: number): Promise<number> {
    const airQualityUrl = 'https://air-quality-api.open-meteo.com/v1/air-quality';
    const params = [
      `latitude=${lat}`,
      `longitude=${lon}`,
      'current=us_aqi'
    ].join('&');
    
    const url = `${airQualityUrl}?${params}`;
    const httpRequest = http.createHttp();
    
    try {
      console.debug(`[OpenMeteoService] ğŸ“¤ è¯·æ±‚ç©ºæ°”è´¨é‡: ${url}`);
      const response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: this.timeoutMs,
        readTimeout: this.timeoutMs
      });
      
      if (response.responseCode !== 200) {
        console.warn(`[OpenMeteoService] âš ï¸ ç©ºæ°”è´¨é‡APIè¿”å›é”™è¯¯: ${response.responseCode}`);
        return 0;
      }
      
      const data = JSON.parse(response.result as string) as OpenMeteoAirQualityResponse;
      const aqiValue = Math.round(data.current.us_aqi || 0);
      console.info(`[OpenMeteoService] âœ… ç©ºæ°”è´¨é‡è·å–æˆåŠŸ: AQI=${aqiValue}`);
      return aqiValue;
    } catch (error) {
      console.error(`[OpenMeteoService] âŒ ç©ºæ°”è´¨é‡APIè°ƒç”¨å¤±è´¥:`, error);
      return 0;  // å¤±è´¥æ—¶è¿”å›0
    } finally {
      httpRequest.destroy();
    }
  }

  private mapToSnapshot(cityId: string, data: OpenMeteoResponse, aqi: number, timezoneOffsetMinutes?: number): WeatherSnapshot {
    const current = this.mapCurrentWeather(data.current, data.daily, data.hourly, aqi);
    const hourly = this.mapHourlyForecast(data.hourly);
    const daily = this.mapDailyForecast(data.daily);

    // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„æ—¶åŒºï¼Œå¦åˆ™ä½¿ç”¨APIè¿”å›çš„æ—¶åŒº
    const actualTimezoneOffset = timezoneOffsetMinutes !== undefined 
      ? timezoneOffsetMinutes 
      : Math.round(data.utc_offset_seconds / 60);
    
    console.info(`[OpenMeteoService] ğŸ•’ ä½¿ç”¨æ—¶åŒºåç§»: ${actualTimezoneOffset}åˆ†é’Ÿ`);

    return {
      cityId: cityId,
      lastUpdatedIso: new Date().toISOString(),
      timezoneOffsetMinutes: actualTimezoneOffset,
      current: current,
      hourly: hourly,
      daily: daily,
      advice: [], // Open-Meteo å…è´¹ç‰ˆä¸ç›´æ¥æä¾›ç”Ÿæ´»å»ºè®®
      alerts: [], // å…è´¹ç‰ˆæ— é¢„è­¦
      rainForecast: [], // å…è´¹ç‰ˆæ— åˆ†é’Ÿçº§é™é›¨
      dataSource: 'open-meteo'
    };
  }

  private mapCurrentWeather(current: OpenMeteoCurrent, daily: OpenMeteoDaily, hourly: OpenMeteoHourly, aqi: number): CurrentWeather {
    const condition = this.mapWmoCode(current.weather_code, current.is_day === 1);
    
    // è·å–å½“å¤©çš„æœ€é«˜/æœ€ä½æ¸©
    const maxTemp = daily.temperature_2m_max.length > 0 ? daily.temperature_2m_max[0] : current.temperature_2m;
    const minTemp = daily.temperature_2m_min.length > 0 ? daily.temperature_2m_min[0] : current.temperature_2m;
    const uvIndex = daily.uv_index_max.length > 0 ? daily.uv_index_max[0] : 0;
    
    // âœ… ä» hourly æ•°æ®ä¸­è·å–å½“å‰èƒ½è§åº¦ï¼ˆç¬¬ä¸€ä¸ªå°æ—¶çš„æ•°æ®ï¼‰
    let visibilityKm = 10; // é»˜è®¤å€¼
    if (hourly.visibility && hourly.visibility.length > 0) {
      visibilityKm = Math.round(hourly.visibility[0] / 1000);  // è½¬æ¢ä¸º km
      console.info(`[OpenMeteoService] âœ… èƒ½è§åº¦è·å–æˆåŠŸ: ${visibilityKm}km (åŸå§‹å€¼: ${hourly.visibility[0]}m)`);
    } else {
      console.warn(`[OpenMeteoService] âš ï¸ èƒ½è§åº¦æ•°æ®ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤å€¼10km`);
    }
    
    // âœ… ä»dailyæ•°æ®ä¸­æå–æ—¥å‡ºæ—¥è½æ—¶é—´ï¼Œå¹¶æ ¼å¼åŒ–ä¸º HH:mm
    let sunrise = '06:00';
    let sunset = '18:00';
    if (daily.sunrise && daily.sunrise.length > 0) {
      sunrise = this.extractTimeFromIso(daily.sunrise[0]);
      console.info(`[OpenMeteoService] âœ… æ—¥å‡ºæ—¶é—´: ${sunrise} (åŸå§‹: ${daily.sunrise[0]})`);
    }
    if (daily.sunset && daily.sunset.length > 0) {
      sunset = this.extractTimeFromIso(daily.sunset[0]);
      console.info(`[OpenMeteoService] âœ… æ—¥è½æ—¶é—´: ${sunset} (åŸå§‹: ${daily.sunset[0]})`);
    }

    const weather: CurrentWeather = {
      temperatureC: current.temperature_2m,
      feelsLikeC: current.apparent_temperature,
      condition: {
        description: condition.description,
        iconCode: condition.icon,
        themeKey: condition.themeKey,
        emotion: 'neutral' // Default emotion
      },
      humidity: current.relative_humidity_2m,
      windSpeedKph: current.wind_speed_10m,
      windDirection: String(current.wind_direction_10m),
      pressureHpa: current.pressure_msl,
      uvIndex: uvIndex,
      visibilityKm: visibilityKm,  // âœ… ä½¿ç”¨çœŸå®èƒ½è§åº¦æ•°æ®
      aqi: aqi,  // âœ… ä½¿ç”¨çœŸå®AQIæ•°æ®
      sunrise: sunrise,  // âœ… æ ¼å¼åŒ–åçš„æ—¥å‡ºæ—¶é—´ HH:mm
      sunset: sunset     // âœ… æ ¼å¼åŒ–åçš„æ—¥è½æ—¶é—´ HH:mm
    };
    return weather;
  }

  /**
   * ä»ISOæ ¼å¼æ—¶é—´å­—ç¬¦ä¸²ä¸­æå– HH:mm éƒ¨åˆ†
   * @param isoString ISOæ ¼å¼æ—¶é—´ï¼Œå¦‚ "2025-11-27T07:18:00"
   * @returns HH:mm æ ¼å¼ï¼Œå¦‚ "07:18"
   */
  private extractTimeFromIso(isoString: string): string {
    try {
      console.debug(`[OpenMeteoService] ğŸ” æå–æ—¶é—´ - è¾“å…¥: "${isoString}", ç±»å‹: ${typeof isoString}`);
      
      // æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºå­—ç¬¦ä¸²
      if (typeof isoString !== 'string') {
        console.error(`[OpenMeteoService] âŒ è¾“å…¥ä¸æ˜¯å­—ç¬¦ä¸²: ${isoString}`);
        return '--:--';
      }
      
      // æ£€æŸ¥æ˜¯å¦åŒ…å« 'T'
      if (!isoString.includes('T')) {
        console.error(`[OpenMeteoService] âŒ è¾“å…¥ä¸åŒ…å«'T': ${isoString}`);
        return '--:--';
      }
      
      // ISOæ ¼å¼: 2025-11-27T07:18:00 æˆ– 2025-11-27T07:18:00+00:00
      const parts = isoString.split('T');
      console.debug(`[OpenMeteoService] ğŸ” åˆ†å‰²ç»“æœ: parts.length=${parts.length}, parts[0]="${parts[0]}", parts[1]="${parts[1]}"`);
      
      const timePart = parts[1];  // "07:18:00" æˆ– "07:18:00+00:00"
      if (timePart && timePart.length >= 5) {
        const hhmm = timePart.substring(0, 5);  // "07:18"
        console.debug(`[OpenMeteoService] âœ… æå–æˆåŠŸ: "${hhmm}"`);
        return hhmm;
      }
      
      console.error(`[OpenMeteoService] âŒ timePartæ— æ•ˆ: "${timePart}"`);
      return '--:--';
    } catch (error) {
      console.error(`[OpenMeteoService] âŒ æ—¶é—´æ ¼å¼åŒ–å¤±è´¥: ${isoString}`, error);
      return '--:--';
    }
  }

  private mapHourlyForecast(hourly: OpenMeteoHourly): HourlyForecast[] {
    const forecasts: HourlyForecast[] = [];
    // åªå–æœªæ¥24å°æ—¶
    const limit = Math.min(hourly.time.length, 24);

    for (let i = 0; i < limit; i++) {
      const isDay = this.isDaytime(hourly.time[i]);
      const condition = this.mapWmoCode(hourly.weather_code[i], isDay);
      const forecast: HourlyForecast = {
        time: hourly.time[i],
        temperatureC: hourly.temperature_2m[i],
        precipitationProbability: hourly.precipitation_probability[i],
        iconCode: condition.icon,
        description: condition.description
      };
      forecasts.push(forecast);
    }
    return forecasts;
  }

  private mapDailyForecast(daily: OpenMeteoDaily): DailyForecast[] {
    const forecasts: DailyForecast[] = [];
    // å–7å¤©
    const limit = Math.min(daily.time.length, 7);

    for (let i = 0; i < limit; i++) {
      const condition = this.mapWmoCode(daily.weather_code[i], true);
      const forecast: DailyForecast = {
        date: daily.time[i],
        maxTempC: daily.temperature_2m_max[i],
        minTempC: daily.temperature_2m_min[i],
        iconCode: condition.icon,
        description: condition.description,
        precipitationProbability: daily.precipitation_probability_max[i]
      };
      forecasts.push(forecast);
    }
    return forecasts;
  }

  // è¾…åŠ©æ–¹æ³•ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºç™½å¤© (ç®€å•æ ¹æ®æ—¶é—´åˆ¤æ–­ï¼Œ6-18ç‚¹ä¸ºç™½å¤©)
  // æ›´ç²¾ç¡®çš„æ–¹æ³•æ˜¯ä½¿ç”¨ daily.sunrise å’Œ daily.sunsetï¼Œä½† hourly æ•°æ®ä¸­æ²¡æœ‰ç›´æ¥å¯¹åº”
  private isDaytime(timeStr: string): boolean {
    const hour = new Date(timeStr).getHours();
    return hour >= 6 && hour < 18;
  }

  /**
   * WMO Weather interpretation codes (WW)
   * Code	Description
   * 0	Clear sky
   * 1, 2, 3	Mainly clear, partly cloudy, and overcast
   * 45, 48	Fog and depositing rime fog
   * 51, 53, 55	Drizzle: Light, moderate, and dense intensity
   * 56, 57	Freezing Drizzle: Light and dense intensity
   * 61, 63, 65	Rain: Slight, moderate and heavy intensity
   * 66, 67	Freezing Rain: Light and heavy intensity
   * 71, 73, 75	Snow fall: Slight, moderate, and heavy intensity
   * 77	Snow grains
   * 80, 81, 82	Rain showers: Slight, moderate, and violent
   * 85, 86	Snow showers slight and heavy
   * 95 *	Thunderstorm: Slight or moderate
   * 96, 99 *	Thunderstorm with slight and heavy hail
   */
  private mapWmoCode(code: number, isDay: boolean): WmoWeatherCondition {
    const suffix = isDay ? 'd' : 'n';
    
    switch (code) {
      case 0:
        return { text: 'æ™´', icon: '100', themeKey: 'sunny', description: 'æ™´æœ—æ— äº‘' };
      case 1:
      case 2:
        return { text: 'å¤šäº‘', icon: '101', themeKey: 'sunny', description: 'å¤šäº‘' };
      case 3:
        return { text: 'é˜´', icon: '104', themeKey: 'sunny', description: 'é˜´å¤©' };  // ğŸ”§ ä¿®å¤ï¼šæ”¹ä¸ºsunny
      case 45:
      case 48:
        return { text: 'é›¾', icon: '501', themeKey: 'sunny', description: 'æœ‰é›¾' };  // ğŸ”§ ä¿®å¤ï¼šæ”¹ä¸ºsunny
      case 51:
      case 53:
      case 55:
        return { text: 'æ¯›æ¯›é›¨', icon: '300', themeKey: 'rainy', description: 'æ¯›æ¯›é›¨' };
      case 56:
      case 57:
        return { text: 'å†»é›¨', icon: '304', themeKey: 'rainy', description: 'å†»é›¨' };
      case 61:
        return { text: 'å°é›¨', icon: '305', themeKey: 'rainy', description: 'å°é›¨' };
      case 63:
        return { text: 'ä¸­é›¨', icon: '306', themeKey: 'rainy', description: 'ä¸­é›¨' };
      case 65:
        return { text: 'å¤§é›¨', icon: '307', themeKey: 'rainy', description: 'å¤§é›¨' };
      case 66:
      case 67:
        return { text: 'å†»é›¨', icon: '304', themeKey: 'rainy', description: 'å†»é›¨' };
      case 71:
        return { text: 'å°é›ª', icon: '400', themeKey: 'snow', description: 'å°é›ª' };
      case 73:
        return { text: 'ä¸­é›ª', icon: '401', themeKey: 'snow', description: 'ä¸­é›ª' };
      case 75:
        return { text: 'å¤§é›ª', icon: '402', themeKey: 'snow', description: 'å¤§é›ª' };
      case 77:
        return { text: 'é›ªç²’', icon: '403', themeKey: 'snow', description: 'é›ªç²’' };
      case 80:
      case 81:
      case 82:
        return { text: 'é˜µé›¨', icon: '300', themeKey: 'rainy', description: 'é˜µé›¨' };
      case 85:
      case 86:
        return { text: 'é˜µé›ª', icon: '400', themeKey: 'snow', description: 'é˜µé›ª' };
      case 95:
        return { text: 'é›·é˜µé›¨', icon: '302', themeKey: 'rainy', description: 'é›·é˜µé›¨' };
      case 96:
      case 99:
        return { text: 'é›·é˜µé›¨ä¼´æœ‰å†°é›¹', icon: '304', themeKey: 'rainy', description: 'é›·é›¨å†°é›¹' };
      default:
        return { text: 'æœªçŸ¥', icon: '999', themeKey: 'sunny', description: 'æœªçŸ¥å¤©æ°”' };
    }
  }
}

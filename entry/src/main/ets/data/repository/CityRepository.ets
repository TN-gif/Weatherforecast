import common from '@ohos.app.ability.common';
import { AppConstants } from '../../common/constants/AppConstants';
import { City, CitySource, Coordinates } from '../models/WeatherModels';
import { CityStorage } from '../storage/CityStorage';

export class CityRepository {
  private static instance: CityRepository;
  private storage: CityStorage = CityStorage.getInstance();
  private cities: City[] = [];

  private constructor() {
  }

  static getInstance(): CityRepository {
    if (!CityRepository.instance) {
      CityRepository.instance = new CityRepository();
    }
    return CityRepository.instance;
  }

  async init(context: common.UIAbilityContext): Promise<void> {
    console.info('[CityRepository] ========== åˆå§‹åŒ–åŸå¸‚ä»“åº“ ==========');
    await this.storage.init(context);
    const storedCities: City[] = await this.storage.loadCities();
    this.cities = storedCities;
    console.info(`[CityRepository] âœ… åŸå¸‚ä»“åº“åˆå§‹åŒ–å®Œæˆï¼ŒåŠ è½½äº† ${this.cities.length} ä¸ªåŸå¸‚`);
    this.cities.forEach((city, index) => {
      console.debug(`[CityRepository]   ${index + 1}. ${city.name} (${city.id})`);
    });
  }

  getCities(): City[] {
    return [...this.cities];
  }

  async addCity(city: City): Promise<void> {
    console.info(`[CityRepository] â• è¯·æ±‚æ·»åŠ åŸå¸‚: ${city.name} (${city.id})`);
    
    if (this.cities.length >= AppConstants.MAX_CITIES) {
      console.warn(`[CityRepository] âš ï¸ åŸå¸‚æ•°é‡å·²è¾¾ä¸Šé™ (${AppConstants.MAX_CITIES})ï¼Œæ— æ³•æ·»åŠ `);
      return;
    }
    
    const index: number = this.cities.findIndex((item: City) => item.id === city.id);
    if (index >= 0) {
      console.info(`[CityRepository] ğŸ”„ åŸå¸‚å·²å­˜åœ¨ï¼Œæ›´æ–°ä¿¡æ¯: ${city.name}`);
      this.cities[index] = city;
    } else {
      console.info(`[CityRepository] âœ… æ·»åŠ æ–°åŸå¸‚: ${city.name}`);
      this.cities.push(city);
    }
    await this.storage.saveCities(this.cities);
    console.debug(`[CityRepository] ğŸ’¾ åŸå¸‚åˆ—è¡¨å·²ä¿å­˜ï¼Œå½“å‰æ•°é‡: ${this.cities.length}`);
  }

  async updateCities(cities: City[]): Promise<void> {
    console.info(`[CityRepository] ğŸ”„ æ‰¹é‡æ›´æ–°åŸå¸‚åˆ—è¡¨ï¼Œæ•°é‡: ${cities.length}`);
    this.cities = [...cities];
    await this.storage.saveCities(this.cities);
    console.info('[CityRepository] âœ… åŸå¸‚åˆ—è¡¨æ‰¹é‡æ›´æ–°å®Œæˆå¹¶ä¿å­˜');
  }

  hasCity(cityId: string): boolean {
    return this.cities.some((city: City) => city.id === cityId);
  }

  async getAllCities(): Promise<City[]> {
    return [...this.cities];
  }

  async removeCity(cityId: string): Promise<void> {
    console.info(`[CityRepository] ğŸ—‘ï¸ è¯·æ±‚åˆ é™¤åŸå¸‚ID: ${cityId}`);
    const initialLength = this.cities.length;
    this.cities = this.cities.filter((city: City) => city.id !== cityId);
    
    if (this.cities.length < initialLength) {
      console.info(`[CityRepository] âœ… åŸå¸‚åˆ é™¤æˆåŠŸï¼Œå‰©ä½™æ•°é‡: ${this.cities.length}`);
      await this.storage.saveCities(this.cities);
    } else {
      console.warn(`[CityRepository] âš ï¸ æœªæ‰¾åˆ°è¦åˆ é™¤çš„åŸå¸‚ID: ${cityId}`);
    }
  }

  static createDefaultCity(): City {
    const coordinates: Coordinates = { latitude: 31.2304, longitude: 121.4737 };
    return new City(AppConstants.DEFAULT_CITY_ID, 'ä¸Šæµ·', AppConstants.DEFAULT_COUNTRY, coordinates, CitySource.MOCK, 'sunny', 480);
  }
}

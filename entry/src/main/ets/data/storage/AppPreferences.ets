import preferences from '@ohos.data.preferences';
import type common from '@ohos.app.ability.common';
import { AppConstants } from '../../common/constants/AppConstants';
import { BackgroundMode } from '../../common/constants/ThemeConstants';
import { ThemeMode } from '../../common/theme/ThemeManager';

export class AppPreferences {
  private prefs: preferences.Preferences | null = null;

  async init(context: common.UIAbilityContext): Promise<void> {
    if (this.prefs) {
      console.debug('[AppPreferences] âš ï¸ åå¥½è®¾ç½®å·²åˆå§‹åŒ–ï¼Œè·³è¿‡');
      return;
    }
    console.info('[AppPreferences] âš™ï¸ åˆå§‹åŒ–åå¥½è®¾ç½®...');
    this.prefs = await preferences.getPreferences(context, AppConstants.APP_SETTINGS_PREF);
    console.info('[AppPreferences] âœ… åå¥½è®¾ç½®åˆå§‹åŒ–æˆåŠŸ');
  }

  async setBackgroundMode(mode: BackgroundMode): Promise<void> {
    if (!this.prefs) return;
    console.info(`[AppPreferences] ğŸ’¾ ä¿å­˜èƒŒæ™¯æ¨¡å¼: ${mode}`);
    await this.prefs.put(AppConstants.BACKGROUND_MODE_KEY, mode);
    await this.prefs.flush();
  }

  async getBackgroundMode(): Promise<BackgroundMode> {
    if (!this.prefs) return BackgroundMode.GRADIENT;
    const value: preferences.ValueType = await this.prefs.get(
      AppConstants.BACKGROUND_MODE_KEY,
      AppConstants.DEFAULT_BACKGROUND_MODE
    );
    console.debug(`[AppPreferences] ğŸ“– è¯»å–èƒŒæ™¯æ¨¡å¼: ${value}`);
    return (value as string) as BackgroundMode;
  }

  async setAutoLocationEnabled(enabled: boolean): Promise<void> {
    if (!this.prefs) return;
    console.info(`[AppPreferences] ğŸ’¾ ä¿å­˜è‡ªåŠ¨å®šä½è®¾ç½®: ${enabled}`);
    await this.prefs.put(AppConstants.AUTO_LOCATION_KEY, enabled);
    await this.prefs.flush();
  }

  async isAutoLocationEnabled(): Promise<boolean> {
    if (!this.prefs) return true;
    const value: preferences.ValueType = await this.prefs.get(AppConstants.AUTO_LOCATION_KEY, true);
    console.debug(`[AppPreferences] ğŸ“– è¯»å–è‡ªåŠ¨å®šä½è®¾ç½®: ${value}`);
    return value as boolean;
  }

  async setThemeMode(mode: ThemeMode): Promise<void> {
    if (!this.prefs) return;
    console.info(`[AppPreferences] ğŸ’¾ ä¿å­˜ä¸»é¢˜æ¨¡å¼: ${mode}`);
    await this.prefs.put('theme_mode', mode);
    await this.prefs.flush();
  }

  async getThemeMode(): Promise<ThemeMode> {
    if (!this.prefs) return ThemeMode.AUTO;
    const value: preferences.ValueType = await this.prefs.get('theme_mode', ThemeMode.AUTO);
    console.debug(`[AppPreferences] ğŸ“– è¯»å–ä¸»é¢˜æ¨¡å¼: ${value}`);
    return value as ThemeMode;
  }

  async setShakeRefreshEnabled(enabled: boolean): Promise<void> {
    if (!this.prefs) return;
    console.info(`[AppPreferences] ğŸ’¾ ä¿å­˜æ‘‡ä¸€æ‘‡è®¾ç½®: ${enabled}`);
    await this.prefs.put('shake_refresh_enabled', enabled);
    await this.prefs.flush();
  }

  async isShakeRefreshEnabled(): Promise<boolean> {
    if (!this.prefs) return true;
    const value: preferences.ValueType = await this.prefs.get('shake_refresh_enabled', true);
    console.debug(`[AppPreferences] ğŸ“– è¯»å–æ‘‡ä¸€æ‘‡è®¾ç½®: ${value}`);
    return value as boolean;
  }

  async setNotificationEnabled(enabled: boolean): Promise<void> {
    if (!this.prefs) return;
    console.info(`[AppPreferences] ğŸ’¾ ä¿å­˜é€šçŸ¥è®¾ç½®: ${enabled}`);
    await this.prefs.put('notification_enabled', enabled);
    await this.prefs.flush();
  }

  async isNotificationEnabled(): Promise<boolean> {
    if (!this.prefs) return false;
    const value: preferences.ValueType = await this.prefs.get('notification_enabled', false);
    console.debug(`[AppPreferences] ğŸ“– è¯»å–é€šçŸ¥è®¾ç½®: ${value}`);
    return value as boolean;
  }
}

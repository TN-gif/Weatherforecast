import preferences from '@ohos.data.preferences';
import type common from '@ohos.app.ability.common';

/**
 * Widget å¤©æ°”æ•°æ®æ¥å£ï¼Œç”¨äºè·¨è¿›ç¨‹å…±äº«
 */
export interface WidgetWeatherData {
  cityName: string;
  temperature: number;
  temperatureUnit: string;
  condition: string;
  iconCode: string;
  themeKey: string;
  humidity: number;
  windSpeed: number;
  updateTime: string;
  timestamp: number;
  hourlyForecast: WidgetHourlyItem[];
}

/**
 * å°æ—¶é¢„æŠ¥é¡¹ï¼Œç”¨äº Widget æ˜¾ç¤º
 */
export interface WidgetHourlyItem {
  time: string;
  temperature: number;
  iconCode: string;
}

/**
 * Widget æ•°æ®å­˜å‚¨å¸¸é‡
 */
const WIDGET_PREF_NAME: string = 'aurora_weather_widget';
const WIDGET_DATA_KEY: string = 'widget_weather_data';
const FORM_IDS_KEY: string = 'widget_form_ids';

/**
 * WidgetDataStorage - å¤©æ°” Widget æ•°æ®å­˜å‚¨ç±»
 *
 * æœ¬ç±»æä¾›å¤©æ°”æ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨åŠŸèƒ½ã€‚
 * æ³¨æ„ï¼šä¸»åº”ç”¨å’Œå¡ç‰‡è¿›ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„ Preferences å­˜å‚¨
 * - ä¸»åº”ç”¨ä¿å­˜å¤©æ°”æ•°æ®åˆ° Preferences
 * - å¡ç‰‡è¿›ç¨‹ä» Preferences è¯»å–å¤©æ°”æ•°æ®
 * - form IDs ç”±å¡ç‰‡è¿›ç¨‹ç®¡ç†ï¼ˆä¸»åº”ç”¨æ— æ³•è®¿é—®ï¼‰
 *
 * Requirements: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3
 */
export class WidgetDataStorage {
  private static prefs: preferences.Preferences | null = null;

  /**
   * ä½¿ç”¨åº”ç”¨ä¸Šä¸‹æ–‡åˆå§‹åŒ– Preferences
   */
  private static async ensurePreferences(context: common.Context): Promise<preferences.Preferences> {
    // æ¯æ¬¡éƒ½é‡æ–°è·å– Preferencesï¼Œç¡®ä¿æ•°æ®æœ€æ–°
    console.info('[WidgetDataStorage] âš™ï¸ Initializing widget preferences...');
    const prefs = await preferences.getPreferences(context, WIDGET_PREF_NAME);
    console.info('[WidgetDataStorage] âœ… Widget preferences initialized');
    return prefs;
  }


  /**
   * ä¿å­˜å¤©æ°”æ•°æ®åˆ° Preferences ä¾› Widget è®¿é—®
   * åŒæ—¶å°†æ•°æ®æŒä¹…åŒ–åˆ° AppStorage å’Œ Preferences
   * 
   * @param context ç”¨äºè®¿é—® Preferences çš„åº”ç”¨ä¸Šä¸‹æ–‡
   * @param data è¦ä¿å­˜çš„å¤©æ°”æ•°æ®
   * Requirements: 6.1, 6.2
   */
  static async saveForWidget(context: common.Context, data: WidgetWeatherData): Promise<void> {
    try {
      console.info('[WidgetDataStorage] ğŸ’¾ Saving weather data for widget...');
      const prefs = await WidgetDataStorage.ensurePreferences(context);
      
      const jsonData = JSON.stringify(data);
      await prefs.put(WIDGET_DATA_KEY, jsonData);
      await prefs.flush();
      
      console.info(`[WidgetDataStorage] âœ… Weather data saved successfully for city: ${data.cityName}`);
    } catch (error) {
      console.error('[WidgetDataStorage] âŒ Failed to save weather data:', error);
      throw error instanceof Error ? error : new Error(String(error));
    }
  }

  /**
   * ä» Preferences åŠ è½½å¤©æ°”æ•°æ®
   * å¦‚æœæ•°æ®ä¸å­˜åœ¨æˆ–è§£æå¤±è´¥åˆ™è¿”å› null
   * 
   * @param context ç”¨äºè®¿é—® Preferences çš„åº”ç”¨ä¸Šä¸‹æ–‡
   * @returns å¤©æ°”æ•°æ®ï¼Œå¦‚æœä¸å¯ç”¨åˆ™è¿”å› null
   * Requirements: 6.2, 6.3, 6.4
   */
  static async loadForWidget(context: common.Context): Promise<WidgetWeatherData | null> {
    try {
      console.info('[WidgetDataStorage] ğŸ“– Loading weather data for widget...');
      const prefs = await WidgetDataStorage.ensurePreferences(context);
      
      const jsonData = await prefs.get(WIDGET_DATA_KEY, '') as string;
      
      if (!jsonData || jsonData.length === 0) {
        console.info('[WidgetDataStorage] âš ï¸ No weather data found in storage');
        return null;
      }
      
      const data = WidgetDataStorage.parseWeatherData(jsonData);
      if (data) {
        console.info(`[WidgetDataStorage] âœ… Weather data loaded for city: ${data.cityName}`);
      }
      return data;
    } catch (error) {
      console.error('[WidgetDataStorage] âŒ Failed to load weather data:', error);
      return null;
    }
  }

  /**
   * è§£æ JSON å­—ç¬¦ä¸²ä¸º WidgetWeatherData å¹¶è¿›è¡ŒéªŒè¯
   * å¯¹äºæ— æ•ˆæˆ–æ ¼å¼é”™è¯¯çš„ JSON è¿”å› nullï¼Œä¸æŠ›å‡ºå¼‚å¸¸
   * 
   * @param jsonData è¦è§£æçš„ JSON å­—ç¬¦ä¸²
   * @returns è§£æåçš„æ•°æ®ï¼Œå¦‚æœæ— æ•ˆåˆ™è¿”å› null
   * Requirements: 6.3
   */
  static parseWeatherData(jsonData: string): WidgetWeatherData | null {
    try {
      if (!jsonData || jsonData.trim().length === 0) {
        console.warn('[WidgetDataStorage] âš ï¸ Empty JSON data');
        return null;
      }
      
      // è§£æ JSON å¹¶ç›´æ¥è½¬æ¢ä¸º WidgetWeatherData
      // ArkTS å°†åœ¨è¿è¡Œæ—¶éªŒè¯ç»“æ„
      const parsed: WidgetWeatherData = JSON.parse(jsonData) as WidgetWeatherData;
      
      // è°ƒè¯•ï¼šè®°å½•è§£æåçš„æ•°æ®
      console.info(`[WidgetDataStorage] ğŸ“Š Parsed data - city: ${parsed.cityName}, temp: ${parsed.temperature}, humidity: ${parsed.humidity}, windSpeed: ${parsed.windSpeed}`);
      console.info(`[WidgetDataStorage] ğŸ“Š Hourly forecast count: ${parsed.hourlyForecast?.length ?? 0}`);
      
      // éªŒè¯å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨
      if (!parsed.cityName || !parsed.condition || !parsed.iconCode || !parsed.themeKey) {
        console.warn('[WidgetDataStorage] âš ï¸ Weather data validation failed - missing required fields');
        console.warn(`[WidgetDataStorage] cityName: ${parsed.cityName}, condition: ${parsed.condition}, iconCode: ${parsed.iconCode}, themeKey: ${parsed.themeKey}`);
        return null;
      }
      
      if (typeof parsed.temperature !== 'number' || typeof parsed.timestamp !== 'number') {
        console.warn('[WidgetDataStorage] âš ï¸ Weather data validation failed - invalid number fields');
        console.warn(`[WidgetDataStorage] temperature type: ${typeof parsed.temperature}, timestamp type: ${typeof parsed.timestamp}`);
        return null;
      }
      
      // ç¡®ä¿ hourlyForecast æ˜¯æ•°ç»„
      if (!parsed.hourlyForecast) {
        console.info('[WidgetDataStorage] âš ï¸ No hourly forecast, initializing empty array');
        parsed.hourlyForecast = [];
      }
      
      // ç¡®ä¿ humidity å’Œ windSpeed æœ‰é»˜è®¤å€¼ï¼ˆå¦‚æœæœªå®šä¹‰ï¼‰
      if (parsed.humidity === undefined || parsed.humidity === null) {
        console.info('[WidgetDataStorage] âš ï¸ Humidity undefined, setting to 0');
        parsed.humidity = 0;
      }
      if (parsed.windSpeed === undefined || parsed.windSpeed === null) {
        console.info('[WidgetDataStorage] âš ï¸ WindSpeed undefined, setting to 0');
        parsed.windSpeed = 0;
      }
      
      console.info(`[WidgetDataStorage] âœ… Data validation passed - humidity: ${parsed.humidity}%, windSpeed: ${parsed.windSpeed} km/h`);
      return parsed;
    } catch (error) {
      console.error('[WidgetDataStorage] âŒ JSON parse error:', error);
      return null;
    }
  }

  /**
   * ä¿å­˜è¡¨å• ID åˆ—è¡¨åˆ° Preferences
   * 
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡
   * @param formIds è¦ä¿å­˜çš„è¡¨å• ID æ•°ç»„
   * Requirements: 7.3
   */
  static async saveFormIds(context: common.Context, formIds: string[]): Promise<void> {
    try {
      console.info(`[WidgetDataStorage] ğŸ’¾ Saving ${formIds.length} form IDs...`);
      const prefs = await WidgetDataStorage.ensurePreferences(context);
      
      const jsonData = JSON.stringify(formIds);
      await prefs.put(FORM_IDS_KEY, jsonData);
      await prefs.flush();
      
      console.info('[WidgetDataStorage] âœ… Form IDs saved successfully');
    } catch (error) {
      console.error('[WidgetDataStorage] âŒ Failed to save form IDs:', error);
      throw error instanceof Error ? error : new Error(String(error));
    }
  }

  /**
   * ä» Preferences åŠ è½½è¡¨å• ID åˆ—è¡¨
   * 
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡
   * @returns è¡¨å• ID æ•°ç»„ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›ç©ºæ•°ç»„
   * Requirements: 7.3
   */
  static async loadFormIds(context: common.Context): Promise<string[]> {
    try {
      console.info('[WidgetDataStorage] ğŸ“– Loading form IDs...');
      const prefs = await WidgetDataStorage.ensurePreferences(context);
      
      const jsonData = await prefs.get(FORM_IDS_KEY, '[]') as string;
      
      const formIds = JSON.parse(jsonData) as string[];
      console.info(`[WidgetDataStorage] âœ… Loaded ${formIds.length} form IDs`);
      return formIds;
    } catch (error) {
      console.error('[WidgetDataStorage] âŒ Failed to load form IDs:', error);
      return [];
    }
  }


  /**
   * æ·»åŠ å•ä¸ªè¡¨å• ID åˆ°å­˜å‚¨
   * é˜²æ­¢é‡å¤ ID
   * 
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡
   * @param formId è¦æ·»åŠ çš„è¡¨å• ID
   * Requirements: 7.1
   */
  static async addFormId(context: common.Context, formId: string): Promise<void> {
    try {
      console.info(`[WidgetDataStorage] â• Adding form ID: ${formId}`);
      const formIds = await WidgetDataStorage.loadFormIds(context);
      
      // é˜²æ­¢é‡å¤
      if (!formIds.includes(formId)) {
        formIds.push(formId);
        await WidgetDataStorage.saveFormIds(context, formIds);
        console.info(`[WidgetDataStorage] âœ… Form ID added, total: ${formIds.length}`);
      } else {
        console.info('[WidgetDataStorage] âš ï¸ Form ID already exists, skipping');
      }
    } catch (error) {
      console.error('[WidgetDataStorage] âŒ Failed to add form ID:', error);
      throw error instanceof Error ? error : new Error(String(error));
    }
  }

  /**
   * ä»å­˜å‚¨ä¸­ç§»é™¤å•ä¸ªè¡¨å• ID
   * 
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡
   * @param formId è¦ç§»é™¤çš„è¡¨å• ID
   * Requirements: 7.2
   */
  static async removeFormId(context: common.Context, formId: string): Promise<void> {
    try {
      console.info(`[WidgetDataStorage] â– Removing form ID: ${formId}`);
      const formIds = await WidgetDataStorage.loadFormIds(context);
      
      const index = formIds.indexOf(formId);
      if (index !== -1) {
        formIds.splice(index, 1);
        await WidgetDataStorage.saveFormIds(context, formIds);
        console.info(`[WidgetDataStorage] âœ… Form ID removed, remaining: ${formIds.length}`);
      } else {
        console.info('[WidgetDataStorage] âš ï¸ Form ID not found, nothing to remove');
      }
    } catch (error) {
      console.error('[WidgetDataStorage] âŒ Failed to remove form ID:', error);
      throw error instanceof Error ? error : new Error(String(error));
    }
  }

  /**
   * æ¸…é™¤æ‰€æœ‰ Widget æ•°æ®ï¼ˆç”¨äºæµ‹è¯•/é‡ç½®ï¼‰
   * 
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡
   */
  static async clearAll(context: common.Context): Promise<void> {
    try {
      console.info('[WidgetDataStorage] ğŸ§¹ Clearing all widget data...');
      const prefs = await WidgetDataStorage.ensurePreferences(context);
      
      await prefs.delete(WIDGET_DATA_KEY);
      await prefs.delete(FORM_IDS_KEY);
      await prefs.flush();
      
      console.info('[WidgetDataStorage] âœ… All widget data cleared');
    } catch (error) {
      console.error('[WidgetDataStorage] âŒ Failed to clear widget data:', error);
      throw error instanceof Error ? error : new Error(String(error));
    }
  }

  /**
   * æ£€æŸ¥å­˜å‚¨ä¸­æ˜¯å¦å­˜åœ¨å¤©æ°”æ•°æ®
   * 
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡
   * @returns å¦‚æœæ•°æ®å­˜åœ¨åˆ™è¿”å› true
   */
  static async hasWeatherData(context: common.Context): Promise<boolean> {
    try {
      const prefs = await WidgetDataStorage.ensurePreferences(context);
      const jsonData = await prefs.get(WIDGET_DATA_KEY, '') as string;
      return jsonData.length > 0;
    } catch (error) {
      console.error('[WidgetDataStorage] âŒ Failed to check weather data:', error);
      return false;
    }
  }
}

import { AbilityConstant, ConfigurationConstant, UIAbility, Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window } from '@kit.ArkUI';
import { AppContextHolder } from '../common/di/AppContextHolder';

const DOMAIN = 0x0000;

export default class EntryAbility extends UIAbility {
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    try {
      this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'Failed to set colorMode. Cause: %{public}s', JSON.stringify(err));
    }
    AppContextHolder.setContext(this.context);
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onCreate');
    
    // æ£€æŸ¥æ˜¯å¦ä» Widget å¯åŠ¨
    this.handleWidgetLaunch(want);
  }
  
  onNewWant(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onNewWant');
    // å¤„ç†åº”ç”¨å·²è¿è¡Œæ—¶ä» Widget å¯åŠ¨çš„æƒ…å†µ
    this.handleWidgetLaunch(want);
  }
  
  /**
   * å¤„ç†ä» Widget å¯åŠ¨ - è®¾ç½®æ ‡å¿—ä»¥å¯¼èˆªåˆ° GPS åŸå¸‚
   */
  private handleWidgetLaunch(want: Want): void {
    const params = want.parameters;
    if (params) {
      const message = params['message'] as string;
      const forceGpsCity = params['forceGpsCity'] as string;
      
      hilog.info(DOMAIN, 'testTag', `[EntryAbility] ğŸ“± Launch params - message: ${message}, forceGpsCity: ${forceGpsCity}`);
      
      if (message === 'OpenFromWidget' && forceGpsCity === 'true') {
        // è®¾ç½® AppStorage æ ‡å¿—ä»¥å¼ºåˆ¶å¯¼èˆªåˆ° GPS åŸå¸‚ï¼ˆç´¢å¼• 0ï¼‰
        AppStorage.setOrCreate('forceGpsCityNavigation', true);
        hilog.info(DOMAIN, 'testTag', '[EntryAbility] ğŸ¯ Set forceGpsCityNavigation flag');
      }
    }
  }

  onDestroy(): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onDestroy');
  }

  onWindowStageCreate(windowStage: window.WindowStage): void {
    // ä¸»çª—å£å·²åˆ›å»ºï¼Œä¸ºæ­¤ Ability è®¾ç½®ä¸»é¡µé¢
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageCreate');

    windowStage.loadContent('pages/Index', (err) => {
      if (err.code) {
        hilog.error(DOMAIN, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err));
        return;
      }
      hilog.info(DOMAIN, 'testTag', 'Succeeded in loading the content.');
    });
  }

  onWindowStageDestroy(): void {
    // ä¸»çª—å£å·²é”€æ¯ï¼Œé‡Šæ”¾ UI ç›¸å…³èµ„æº
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageDestroy');
  }

  onForeground(): void {
    // Ability å·²è¿›å…¥å‰å°
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onForeground');
  }

  onBackground(): void {
    // Ability å·²è¿›å…¥åå°
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onBackground');
    // æ³¨æ„ï¼šå¡ç‰‡æ›´æ–°ç”± EntryFormAbility è´Ÿè´£
    // ä¸»åº”ç”¨å’Œå¡ç‰‡è¿›ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„ Preferences å­˜å‚¨ï¼Œæ— æ³•è·¨è¿›ç¨‹å…±äº« form IDs
    // å¡ç‰‡ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨æ›´æ–°ï¼š
    // 1. ç³»ç»Ÿå®šæ—¶æ›´æ–° (form_config.json ä¸­çš„ scheduledUpdateTime)
    // 2. ç”¨æˆ·ç‚¹å‡»å¡ç‰‡ä¸Šçš„åˆ·æ–°æŒ‰é’®
    // 3. å¡ç‰‡å¯è§æ€§å˜åŒ–æ—¶
  }
}

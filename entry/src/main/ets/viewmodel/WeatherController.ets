import common from '@ohos.app.ability.common';
import { City, CitySource, Coordinates, WeatherSnapshot } from '../data/models/WeatherModels';
import { CityRepository } from '../data/repository/CityRepository';
import { WeatherRepository } from '../data/repository/WeatherRepository';
import { LocationService } from '../data/services/LocationService';
import { AppPreferences } from '../data/storage/AppPreferences';

export class CityWeatherState {
  readonly city: City;
  readonly snapshot: WeatherSnapshot | null;
  readonly isLoading: boolean;
  readonly errorMessage: string;

  constructor(city: City, snapshot: WeatherSnapshot | null, isLoading: boolean, errorMessage: string) {
    this.city = city;
    this.snapshot = snapshot;
    this.isLoading = isLoading;
    this.errorMessage = errorMessage;
  }
}

export class WeatherController {
  private readonly cityRepository: CityRepository;
  private readonly weatherRepository: WeatherRepository;
  private readonly locationService: LocationService;
  private readonly preferences: AppPreferences;
  private initialized: boolean = false;

  constructor(
    cityRepository: CityRepository,
    weatherRepository: WeatherRepository,
    locationService: LocationService,
    preferences: AppPreferences
  ) {
    this.cityRepository = cityRepository;
    this.weatherRepository = weatherRepository;
    this.locationService = locationService;
    this.preferences = preferences;
  }

  async init(context: common.UIAbilityContext): Promise<void> {
    if (this.initialized) {
      console.info('[WeatherController] Already initialized, skipping');
      return;
    }
    
    console.info('[WeatherController] Starting initialization');
    
    try {
      // å¹¶è¡Œåˆå§‹åŒ–å­˜å‚¨ç»„ä»¶
      console.info('[WeatherController] Initializing storage components');
      await Promise.all([
        this.cityRepository.init(context),
        this.weatherRepository.init(context),
        this.preferences.init(context)
      ]);
      
      // åˆå§‹åŒ–ä½ç½®æœåŠ¡
      console.info('[WeatherController] Initializing location service');
      this.locationService.init(context);
      
      // ç¡®ä¿æœ‰åˆå§‹åŸå¸‚
      console.info('[WeatherController] Ensuring initial city');
      await this.ensureInitialCity();
      
      this.initialized = true;
      console.info('[WeatherController] Initialization completed successfully');
    } catch (error) {
      console.error('[WeatherController] Initialization failed:', error);
      throw new Error(`Controller initialization failed: ${(error as Error).message}`);
    }
  }

  getCityStates(): CityWeatherState[] {
    const cities: City[] = this.cityRepository.getCities();
    return cities.map(city => new CityWeatherState(city, null, false, ''));
  }

  async loadAll(forceRefresh: boolean): Promise<CityWeatherState[]> {
    console.info(`[WeatherController] ========== å¼€å§‹åŠ è½½æ‰€æœ‰åŸå¸‚å¤©æ°” ==========`);
    console.info(`[WeatherController] å¼ºåˆ¶åˆ·æ–°: ${forceRefresh}`);
    console.info(`[WeatherController] æ§åˆ¶å™¨åˆå§‹åŒ–çŠ¶æ€: ${this.initialized}`);
    
    const cities: City[] = this.cityRepository.getCities();
    console.info(`[WeatherController] æ‰¾åˆ° ${cities.length} ä¸ªåŸå¸‚éœ€è¦åŠ è½½`);
    
    if (cities.length === 0) {
      console.error('[WeatherController] âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åŸå¸‚æ•°æ®');
      console.error('[WeatherController] è¿™å¯èƒ½æ˜¯å› ä¸ºåŸå¸‚ä»“åº“æœªæ­£ç¡®åˆå§‹åŒ–');
      throw new Error('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åŸå¸‚æ•°æ®');
    }
    
    // æ‰“å°æ‰€æœ‰åŸå¸‚ä¿¡æ¯
    cities.forEach((city, index) => {
      console.info(`[WeatherController] åŸå¸‚${index + 1}: ${city.name} (${city.id}) - ${JSON.stringify(city.coordinates)}`);
    });
    
    const promises: Promise<CityWeatherState>[] = cities.map(async (city: City, index: number) => {
      try {
        console.info(`[WeatherController] å¼€å§‹åŠ è½½åŸå¸‚ ${index + 1}/${cities.length}: ${city.name}`);
        const loadStartTime = Date.now();
        const snapshot: WeatherSnapshot = await this.weatherRepository.loadWeather(city, forceRefresh);
        const loadTime = Date.now() - loadStartTime;
        console.info(`[WeatherController] âœ… åŸå¸‚ ${city.name} åŠ è½½æˆåŠŸï¼Œè€—æ—¶: ${loadTime}ms`);
        return new CityWeatherState(city, snapshot, false, '');
      } catch (error) {
        const err = error as Error;
        console.error(`[WeatherController] âŒ åŸå¸‚ ${city.name} åŠ è½½å¤±è´¥: ${err.message}`);
        return new CityWeatherState(city, null, false, `åŠ è½½å¤±è´¥: ${err.message}`);
      }
    });
    
    console.info(`[WeatherController] ç­‰å¾…æ‰€æœ‰åŸå¸‚åŠ è½½å®Œæˆ...`);
    const results = await Promise.all(promises);
    
    const successCount = results.filter(state => state.snapshot !== null).length;
    const failCount = results.length - successCount;
    console.info(`[WeatherController] ========== åŸå¸‚åŠ è½½å®Œæˆ ==========`);
    console.info(`[WeatherController] æˆåŠŸ: ${successCount}ä¸ª, å¤±è´¥: ${failCount}ä¸ª`);
    
    return results;
  }

  private async ensureInitialCity(): Promise<void> {
    console.info('[WeatherController] Checking for existing cities');
    const existing: City[] = this.cityRepository.getCities();
    if (existing.length > 0) {
      console.info(`[WeatherController] Found ${existing.length} existing cities`);
      return;
    }
    
    console.info('[WeatherController] No existing cities, creating initial city');
    const autoLocationEnabled: boolean = await this.preferences.isAutoLocationEnabled();
    
    if (autoLocationEnabled) {
      try {
        console.info('[WeatherController] ========== å¼€å§‹è‡ªåŠ¨å®šä½æµç¨‹ ==========');
        console.info('[WeatherController] ğŸ¯ è‡ªåŠ¨å®šä½å·²å¯ç”¨ï¼Œå¼€å§‹è·å–å½“å‰ä½ç½®');
        
        const coordinates: Coordinates = await this.locationService.getCurrentLocation();
        console.info(`[WeatherController] âœ… åæ ‡è·å–æˆåŠŸ: ${coordinates.latitude}, ${coordinates.longitude}`);
        
        console.info('[WeatherController] ğŸ—ºï¸ å¼€å§‹è§£æåŸå¸‚åç§°...');
        const cityName: string = await this.locationService.getCityNameFromCoordinates(coordinates);
        console.info(`[WeatherController] âœ… åŸå¸‚åç§°è§£ææˆåŠŸ: ${cityName}`);
        
        console.info('[WeatherController] ğŸ™ï¸ åˆ›å»ºè‡ªåŠ¨å®šä½åŸå¸‚...');
        const autoCity: City = this.createAutoCity(coordinates, cityName);
        console.info(`[WeatherController] ğŸ“ è‡ªåŠ¨åŸå¸‚ä¿¡æ¯: ID=${autoCity.id}, åç§°=${autoCity.name}, åæ ‡=${autoCity.coordinates.latitude},${autoCity.coordinates.longitude}`);
        
        await this.cityRepository.addCity(autoCity);
        console.info(`[WeatherController] âœ… è‡ªåŠ¨å®šä½åŸå¸‚æ·»åŠ æˆåŠŸ: ${cityName}`);
        console.info('[WeatherController] ========== è‡ªåŠ¨å®šä½æµç¨‹å®Œæˆ ==========');
        return;
      } catch (error) {
        console.error('[WeatherController] âŒ è‡ªåŠ¨å®šä½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°é»˜è®¤åŸå¸‚');
        console.error('[WeatherController] é”™è¯¯è¯¦æƒ…:', error);
      }
    } else {
      console.info('[WeatherController] ğŸš« è‡ªåŠ¨å®šä½å·²ç¦ç”¨ï¼Œä½¿ç”¨é»˜è®¤åŸå¸‚');
    }
    
    console.info('[WeatherController] Adding default city (Shanghai)');
    await this.cityRepository.updateCities([CityRepository.createDefaultCity()]);
    console.info('[WeatherController] Default city added successfully');
  }

  private createAutoCity(coordinates: Coordinates, cityName: string): City {
    const id: string = `auto_${Math.round(coordinates.latitude * 1000)}_${Math.round(coordinates.longitude * 1000)}`;
    return new City(id, cityName, 'Auto', coordinates, CitySource.AUTO, 'sunny', 0);
  }
}

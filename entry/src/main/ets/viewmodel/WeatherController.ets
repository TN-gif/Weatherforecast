import common from '@ohos.app.ability.common';
import { City, CitySource, Coordinates, WeatherSnapshot } from '../data/models/WeatherModels';
import { CityRepository } from '../data/repository/CityRepository';
import { WeatherRepository } from '../data/repository/WeatherRepository';
import { LocationService } from '../data/services/LocationService';
import { AppPreferences } from '../data/storage/AppPreferences';

export class CityWeatherState {
  readonly city: City;
  readonly snapshot: WeatherSnapshot | null;
  readonly isLoading: boolean;
  readonly errorMessage: string;

  constructor(city: City, snapshot: WeatherSnapshot | null, isLoading: boolean, errorMessage: string) {
    this.city = city;
    this.snapshot = snapshot;
    this.isLoading = isLoading;
    this.errorMessage = errorMessage;
  }
}

export class WeatherController {
  private readonly cityRepository: CityRepository;
  private readonly weatherRepository: WeatherRepository;
  private readonly locationService: LocationService;
  private readonly preferences: AppPreferences;
  private initialized: boolean = false;

  constructor(
    cityRepository: CityRepository,
    weatherRepository: WeatherRepository,
    locationService: LocationService,
    preferences: AppPreferences
  ) {
    this.cityRepository = cityRepository;
    this.weatherRepository = weatherRepository;
    this.locationService = locationService;
    this.preferences = preferences;
  }

  async init(context: common.UIAbilityContext): Promise<void> {
    if (this.initialized) {
      console.info('[WeatherController] âš ï¸ æ§åˆ¶å™¨å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
      return;
    }
    
    console.info('[WeatherController] ========== å¼€å§‹æ§åˆ¶å™¨åˆå§‹åŒ– ==========');
    const startTime = Date.now();
    
    try {
      // å¹¶è¡Œåˆå§‹åŒ–å­˜å‚¨ç»„ä»¶
      console.info('[WeatherController] ğŸ“¦ åˆå§‹åŒ–å­˜å‚¨ç»„ä»¶...');
      const storageStartTime = Date.now();
      await Promise.all([
        this.cityRepository.init(context),
        this.weatherRepository.init(context),
        this.preferences.init(context)
      ]);
      console.debug(`[WeatherController] âœ… å­˜å‚¨ç»„ä»¶åˆå§‹åŒ–å®Œæˆï¼Œè€—æ—¶: ${Date.now() - storageStartTime}ms`);
      
      // ğŸ”§ ä¿®å¤ï¼šæ›´æ–°æ‰€æœ‰ç°æœ‰åŸå¸‚çš„æ—¶åŒºæ•°æ®
      console.info('[WeatherController] ğŸ•’ æ£€æŸ¥å¹¶æ›´æ–°åŸå¸‚æ—¶åŒºæ•°æ®...');
      await this.updateCityTimezones();
      
      // åˆå§‹åŒ–ä½ç½®æœåŠ¡
      console.info('[WeatherController] ğŸ“ åˆå§‹åŒ–ä½ç½®æœåŠ¡...');
      this.locationService.init(context);
      
      // æ¯æ¬¡å¯åŠ¨éƒ½æ›´æ–°å®šä½
      console.info('[WeatherController] ğŸ¯ æ¯æ¬¡å¯åŠ¨éƒ½è¿›è¡ŒGPSå®šä½æ›´æ–°...');
      await this.updateAutoLocationCity();
      
      this.initialized = true;
      console.info(`[WeatherController] âœ… æ§åˆ¶å™¨åˆå§‹åŒ–æˆåŠŸï¼Œæ€»è€—æ—¶: ${Date.now() - startTime}ms`);
    } catch (error) {
      console.error('[WeatherController] âŒ åˆå§‹åŒ–å¤±è´¥:', error);
      throw new Error(`Controller initialization failed: ${(error as Error).message}`);
    }
  }

  /**
   * æ›´æ–°æ‰€æœ‰åŸå¸‚çš„æ—¶åŒºæ•°æ®
   * ç”¨äºä¿®å¤æ—§æ•°æ®ä¸­æ—¶åŒºä¸º0çš„é—®é¢˜
   */
  private async updateCityTimezones(): Promise<void> {
    const cities: City[] = this.cityRepository.getCities();
    let needUpdate = false;
    
    const updatedCities: City[] = cities.map((city: City) => {
      // å¦‚æœæ—¶åŒºä¸º0ï¼Œè¯´æ˜æ˜¯æ—§æ•°æ®ï¼Œéœ€è¦æ›´æ–°
      if (city.timeZoneOffsetMinutes === 0) {
        needUpdate = true;
        const newTimezone = this.estimateTimezone(city.coordinates);
        console.info(`[WeatherController] ğŸ”§ æ›´æ–°åŸå¸‚æ—¶åŒº: ${city.name}, 0 -> ${newTimezone}åˆ†é’Ÿ`);
        return new City(
          city.id,
          city.name,
          city.country,
          city.coordinates,
          city.source,
          city.videoTheme,
          newTimezone
        );
      }
      return city;
    });
    
    if (needUpdate) {
      await this.cityRepository.updateCities(updatedCities);
      console.info('[WeatherController] âœ… åŸå¸‚æ—¶åŒºæ•°æ®æ›´æ–°å®Œæˆ');
    } else {
      console.info('[WeatherController] âœ… æ‰€æœ‰åŸå¸‚æ—¶åŒºæ•°æ®æ­£å¸¸ï¼Œæ— éœ€æ›´æ–°');
    }
  }

  /**
   * æ ¹æ®ç»çº¬åº¦ä¼°ç®—æ—¶åŒº
   */
  private estimateTimezone(coordinates: Coordinates): number {
    // ä¸­å›½å¤§é™†ç»Ÿä¸€ä½¿ç”¨UTC+8ï¼ˆä¸œå…«åŒºï¼‰ï¼Œç»åº¦èŒƒå›´çº¦73Â°E-135Â°E
    if (coordinates.longitude >= 73 && coordinates.longitude <= 135 && 
        coordinates.latitude >= 18 && coordinates.latitude <= 54) {
      return 480; // UTC+8 = 480åˆ†é’Ÿ
    }
    
    // å…¶ä»–åœ°åŒºï¼ŒæŒ‰ç»åº¦ä¼°ç®—ï¼ˆæ¯15åº¦=1å°æ—¶ï¼‰
    return Math.round(coordinates.longitude / 15) * 60;
  }

  getCityStates(): CityWeatherState[] {
    const cities: City[] = this.cityRepository.getCities();
    return cities.map(city => new CityWeatherState(city, null, false, ''));
  }

  async loadAll(forceRefresh: boolean): Promise<CityWeatherState[]> {
    console.info(`[WeatherController] ========== å¼€å§‹åŠ è½½æ‰€æœ‰åŸå¸‚å¤©æ°” ==========`);
    console.info(`[WeatherController] ğŸ”„ å¼ºåˆ¶åˆ·æ–°: ${forceRefresh}`);
    console.debug(`[WeatherController] âš™ï¸ æ§åˆ¶å™¨çŠ¶æ€: initialized=${this.initialized}`);
    const loadStartTime = Date.now();
    
    // å¦‚æœæ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œå°è¯•æ›´æ–°GPSå®šä½ï¼ˆä½†ä¸é˜»å¡å¤©æ°”åŠ è½½ï¼‰
    if (forceRefresh) {
      console.info('[WeatherController] ğŸ¯ å¼ºåˆ¶åˆ·æ–°æ—¶å°è¯•æ›´æ–°GPSå®šä½ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰...');
      // ä½¿ç”¨å¼‚æ­¥æ–¹å¼æ›´æ–°å®šä½ï¼Œä¸ç­‰å¾…ç»“æœ
      this.updateAutoLocationCity().catch((error: Error) => {
        console.warn('[WeatherController] âš ï¸ GPSå®šä½æ›´æ–°å¤±è´¥ï¼ˆä¸å½±å“å¤©æ°”åŠ è½½ï¼‰:', error.message);
      });
    }
    
    // é‡æ–°è·å–åŸå¸‚åˆ—è¡¨ï¼ˆå¯èƒ½å·²è¢«å¼‚æ­¥æ›´æ–°ï¼‰
    const cities: City[] = this.cityRepository.getCities();
    console.info(`[WeatherController] ğŸ“‹ å¾…åŠ è½½åŸå¸‚åˆ—è¡¨ (${cities.length}ä¸ª):`);
    cities.forEach((city, index) => {
      console.info(`  ${index + 1}. ${city.name} [${city.id}] (${city.source})`);
    });
    
    if (cities.length === 0) {
      console.error('[WeatherController] âŒ åŸå¸‚åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•åŠ è½½å¤©æ°”');
      throw new Error('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åŸå¸‚æ•°æ®');
    }
    
    const startTime = Date.now();
    console.info(`[WeatherController] â³ å¼€å§‹å¹¶è¡ŒåŠ è½½ ${cities.length} ä¸ªåŸå¸‚çš„å¤©æ°”æ•°æ®...`);
    
    const promises: Promise<CityWeatherState>[] = cities.map(async (city: City, index: number) => {
      try {
        console.info(`[WeatherController] [${index + 1}/${cities.length}] â³ å¼€å§‹åŠ è½½: ${city.name}`);
        const cityStartTime = Date.now();
        
        // ä¸ºæ¯ä¸ªåŸå¸‚çš„å¤©æ°”åŠ è½½æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆ15ç§’ï¼‰
        const weatherPromise = this.weatherRepository.loadWeather(city, forceRefresh);
        const timeoutPromise = new Promise<WeatherSnapshot>((_, reject) => {
          setTimeout(() => reject(new Error('å¤©æ°”æ•°æ®åŠ è½½è¶…æ—¶')), 15000);
        });
        
        const snapshot: WeatherSnapshot = await Promise.race([weatherPromise, timeoutPromise]);
        
        const cityDuration = Date.now() - cityStartTime;
        console.info(`[WeatherController] [${index + 1}/${cities.length}] âœ… åŠ è½½æˆåŠŸ: ${city.name}, è€—æ—¶: ${cityDuration}ms`);
        return new CityWeatherState(city, snapshot, false, '');
      } catch (error) {
        const err = error as Error;
        console.error(`[WeatherController] [${index + 1}/${cities.length}] âŒ åŠ è½½å¤±è´¥: ${city.name}, é”™è¯¯: ${err.message}`);
        return new CityWeatherState(city, null, false, `åŠ è½½å¤±è´¥: ${err.message}`);
      }
    });
    
    console.info(`[WeatherController] â³ ç­‰å¾…æ‰€æœ‰åŸå¸‚åŠ è½½å®Œæˆ...`);
    const results = await Promise.all(promises);
    
    const successCount = results.filter(state => state.snapshot !== null).length;
    const failCount = results.length - successCount;
    const totalDuration = Date.now() - startTime;
    
    console.info(`[WeatherController] ========== æ‰¹é‡åŠ è½½å®Œæˆ ==========`);
    console.info(`[WeatherController] ğŸ“Š ç»Ÿè®¡: æ€»æ•°=${results.length}, æˆåŠŸ=${successCount}, å¤±è´¥=${failCount}, æ€»è€—æ—¶=${totalDuration}ms`);
    console.info(`[WeatherController] ğŸ“Š loadAllæ€»è€—æ—¶: ${Date.now() - loadStartTime}ms`);
    
    return results;
  }

  private async updateAutoLocationCity(): Promise<void> {
    console.info('[WeatherController] ========== æ›´æ–°è‡ªåŠ¨å®šä½åŸå¸‚ ==========');
    
    const autoLocationEnabled: boolean = await this.preferences.isAutoLocationEnabled();
    console.debug(`[WeatherController] è‡ªåŠ¨å®šä½å¼€å…³çŠ¶æ€: ${autoLocationEnabled}`);
    
    if (!autoLocationEnabled) {
      console.info('[WeatherController] ğŸš« è‡ªåŠ¨å®šä½å·²ç¦ç”¨ï¼Œè·³è¿‡å®šä½æ›´æ–°');
      await this.ensureDefaultCity();
      return;
    }
    
    try {
      console.info('[WeatherController] ğŸ“¡ è·å–å½“å‰GPSä½ç½®ï¼ˆè¶…æ—¶10ç§’ï¼‰...');
      
      // æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
      const locationPromise = this.locationService.getCurrentLocation();
      const timeoutPromise = new Promise<Coordinates>((_, reject) => {
        setTimeout(() => reject(new Error('GPSå®šä½è¶…æ—¶')), 10000);
      });
      
      const coordinates: Coordinates = await Promise.race([locationPromise, timeoutPromise]);
      console.info(`[WeatherController] âœ… åæ ‡è·å–æˆåŠŸ: ${coordinates.latitude.toFixed(4)}, ${coordinates.longitude.toFixed(4)}`);
      
      console.info('[WeatherController] ğŸ—ºï¸ è§£æåŸå¸‚åç§°ï¼ˆè¶…æ—¶5ç§’ï¼‰...');
      const cityNamePromise = this.locationService.getCityNameFromCoordinates(coordinates);
      const cityNameTimeoutPromise = new Promise<string>((_, reject) => {
        setTimeout(() => reject(new Error('åŸå¸‚åç§°è§£æè¶…æ—¶')), 5000);
      });
      
      const cityName: string = await Promise.race([cityNamePromise, cityNameTimeoutPromise]);
      console.info(`[WeatherController] âœ… åŸå¸‚åç§°è§£ææˆåŠŸ: ${cityName}`);
      
      console.info('[WeatherController] ğŸ—ï¸ åˆ›å»º/æ›´æ–°è‡ªåŠ¨å®šä½åŸå¸‚å¯¹è±¡...');
      const autoCity: City = this.createAutoCity(coordinates, cityName);
      
      // è·å–ç°æœ‰åŸå¸‚åˆ—è¡¨
      const existingCities: City[] = this.cityRepository.getCities();
      const nonAutoCities: City[] = existingCities.filter((city: City) => city.source !== CitySource.AUTO);
      
      // å°†è‡ªåŠ¨å®šä½åŸå¸‚æ”¾åœ¨ç¬¬ä¸€ä½
      const updatedCities: City[] = [autoCity, ...nonAutoCities];
      await this.cityRepository.updateCities(updatedCities);
      
      console.info(`[WeatherController] âœ… è‡ªåŠ¨å®šä½åŸå¸‚å·²æ›´æ–°: ${cityName}`);
      console.info('[WeatherController] ========== è‡ªåŠ¨å®šä½æ›´æ–°æˆåŠŸ ==========');
    } catch (error) {
      console.error('[WeatherController] âŒ è‡ªåŠ¨å®šä½å¤±è´¥ï¼Œç¡®ä¿æœ‰é»˜è®¤åŸå¸‚');
      console.error('[WeatherController] é”™è¯¯è¯¦æƒ…:', error);
      await this.ensureDefaultCity();
    }
  }

  private async ensureDefaultCity(): Promise<void> {
    console.info('[WeatherController] ğŸ” æ£€æŸ¥æ˜¯å¦å­˜åœ¨å·²ä¿å­˜åŸå¸‚...');
    const existing: City[] = this.cityRepository.getCities();
    if (existing.length > 0) {
      console.info(`[WeatherController] âœ… å‘ç° ${existing.length} ä¸ªå·²ä¿å­˜åŸå¸‚ï¼Œæ— éœ€æ·»åŠ é»˜è®¤åŸå¸‚`);
      return;
    }
    
    console.info('[WeatherController] ğŸ  æ·»åŠ é»˜è®¤åŸå¸‚ (ä¸Šæµ·)...');
    await this.cityRepository.updateCities([CityRepository.createDefaultCity()]);
    console.info('[WeatherController] âœ… é»˜è®¤åŸå¸‚æ·»åŠ æˆåŠŸ');
  }

  private createAutoCity(coordinates: Coordinates, cityName: string): City {
    const id: string = `auto_${Math.round(coordinates.latitude * 1000)}_${Math.round(coordinates.longitude * 1000)}`;
    
    // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ›´ç²¾ç¡®çš„æ—¶åŒºä¼°ç®—
    // ä¸­å›½å¤§é™†ç»Ÿä¸€ä½¿ç”¨UTC+8ï¼ˆä¸œå…«åŒºï¼‰ï¼Œç»åº¦èŒƒå›´çº¦73Â°E-135Â°E
    let estimatedTimezoneOffset: number;
    
    if (coordinates.longitude >= 73 && coordinates.longitude <= 135 && 
        coordinates.latitude >= 18 && coordinates.latitude <= 54) {
      // ä¸­å›½å¤§é™†èŒƒå›´ï¼Œç»Ÿä¸€ä½¿ç”¨UTC+8
      estimatedTimezoneOffset = 480; // UTC+8 = 480åˆ†é’Ÿ
      console.info(`[WeatherController] ğŸ•’ æ£€æµ‹åˆ°ä¸­å›½å¤§é™†åæ ‡ï¼Œä½¿ç”¨UTC+8æ—¶åŒº`);
    } else {
      // å…¶ä»–åœ°åŒºï¼ŒæŒ‰ç»åº¦ä¼°ç®—ï¼ˆæ¯15åº¦=1å°æ—¶ï¼‰
      estimatedTimezoneOffset = Math.round(coordinates.longitude / 15) * 60;
      console.info(`[WeatherController] ğŸ•’ éä¸­å›½å¤§é™†åæ ‡ï¼ŒæŒ‰ç»åº¦ä¼°ç®—æ—¶åŒº`);
    }
    
    console.info(`[WeatherController] ğŸ•’ è‡ªåŠ¨å®šä½åŸå¸‚æ—¶åŒº: ç»åº¦=${coordinates.longitude.toFixed(2)}, çº¬åº¦=${coordinates.latitude.toFixed(2)}, æ—¶åŒºåç§»=${estimatedTimezoneOffset}åˆ†é’Ÿ (UTC${estimatedTimezoneOffset >= 0 ? '+' : ''}${estimatedTimezoneOffset / 60})`);
    
    return new City(id, cityName, 'Auto', coordinates, CitySource.AUTO, 'sunny', estimatedTimezoneOffset);
  }
}

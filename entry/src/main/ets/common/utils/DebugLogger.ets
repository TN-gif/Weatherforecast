/**
 * è¯¦å°½çš„è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ
 * ç”¨äºè¯Šæ–­åŠŸèƒ½æ˜¾ç¤ºé—®é¢˜
 */

export enum LogLevel {
  DEBUG = 0,
  INFO = 1,
  WARN = 2,
  ERROR = 3
}

// ä½¿ç”¨ Record æ›¿ä»£æ¥å£ç´¢å¼•ç­¾å
export type LogData = Record<string, string | number | boolean | string[] | undefined>;

export class DebugLogger {
  private static instance: DebugLogger | null = null;
  private readonly TAG = '[AuroraWeather]';
  private logLevel: LogLevel = LogLevel.DEBUG;
  private logs: string[] = [];
  private maxLogs: number = 1000;

  static getInstance(): DebugLogger {
    if (DebugLogger.instance === null) {
      DebugLogger.instance = new DebugLogger();
    }
    return DebugLogger.instance;
  }

  private constructor() {
    console.info('[DebugLogger] ğŸš€ è°ƒè¯•æ—¥å¿—ç³»ç»Ÿå·²å¯åŠ¨');
  }

  private formatMessage(
    prefix: string, 
    component: string, 
    message: string, 
    data?: LogData
  ): string {
    const timestamp = new Date().toISOString();
    const dataStr = data ? ` | æ•°æ®: ${JSON.stringify(data)}` : '';
    return `[${timestamp}] [${prefix}] [${component}] ${message}${dataStr}`;
  }

  private addLog(formattedMessage: string): void {
    this.logs.push(formattedMessage);
    if (this.logs.length > this.maxLogs) {
      this.logs.shift();
    }
  }

  debug(component: string, message: string, data?: LogData): void {
    if (this.logLevel <= LogLevel.DEBUG) {
      const formatted = this.formatMessage('ğŸ” DEBUG', component, message, data);
      console.debug(formatted);
      this.addLog(formatted);
    }
  }

  info(component: string, message: string, data?: LogData): void {
    if (this.logLevel <= LogLevel.INFO) {
      const formatted = this.formatMessage('â„¹ï¸ INFO', component, message, data);
      console.info(formatted);
      this.addLog(formatted);
    }
  }

  warn(component: string, message: string, data?: LogData): void {
    if (this.logLevel <= LogLevel.WARN) {
      const formatted = this.formatMessage('âš ï¸ WARN', component, message, data);
      console.warn(formatted);
      this.addLog(formatted);
    }
  }

  error(component: string, message: string, error?: Error | string): void {
    if (this.logLevel <= LogLevel.ERROR) {
      let errorData: LogData;
      if (error instanceof Error) {
        errorData = { 
          'message': error.message, 
          'stack': error.stack ?? '' 
        };
      } else {
        errorData = { 
          'message': String(error) 
        };
      }
      const formatted = this.formatMessage('âŒ ERROR', component, message, errorData);
      console.error(formatted);
      this.addLog(formatted);
    }
  }

  // åŠŸèƒ½çŠ¶æ€æ£€æŸ¥ä¸“ç”¨æ–¹æ³•
  checkFeature(component: string, featureName: string, isAvailable: boolean, details?: LogData): void {
    const status = isAvailable ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨';
    const message = `åŠŸèƒ½æ£€æŸ¥: ${featureName} - ${status}`;
    this.info(component, message, details);
  }

  // ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ—¥å¿—
  lifecycle(component: string, message: string, data?: LogData): void {
    this.info(component, `ğŸ”„ ç”Ÿå‘½å‘¨æœŸ: ${message}`, data);
  }

  // ç”¨æˆ·äº¤äº’æ—¥å¿—
  userAction(component: string, action: string, data?: LogData): void {
    this.info(component, `ğŸ‘† ç”¨æˆ·æ“ä½œ: ${action}`, data);
  }

  // æ€§èƒ½ç›‘æ§æ—¥å¿—
  performance(component: string, message: string, duration: number, data?: LogData): void {
    const performanceData: LogData = { 'duration': duration };
    if (data) {
      const keys = Object.keys(data);
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        performanceData[key] = data[key];
      }
    }
    this.info(component, message, performanceData);
  }

  // è·å–æ‰€æœ‰æ—¥å¿—
  getAllLogs(): string[] {
    return [...this.logs];
  }

  // æ¸…ç©ºæ—¥å¿—
  clearLogs(): void {
    this.logs = [];
    this.info('DebugLogger', 'ğŸ§¹ æ—¥å¿—å·²æ¸…ç©º');
  }

  // å¯¼å‡ºæ—¥å¿—åˆ°å­—ç¬¦ä¸²
  exportLogs(): string {
    return this.logs.join('\n');
  }
}

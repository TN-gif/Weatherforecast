import { DesignSystem } from '../theme/DesignSystem';
import { ThemeConstants } from '../constants/ThemeConstants';
import type { WeatherSnapshot } from '../../data/models/WeatherModels';
import type { WidgetWeatherData, WidgetHourlyItem } from '../../data/storage/WidgetDataStorage';

/**
 * æ¸å˜è‰²è‰²æ ‡ç±»å‹ï¼Œç”¨äº Widget èƒŒæ™¯
 */
type GradientColorStop = [ResourceColor, number];

/**
 * å¯¼å‡º GradientColorStop ç±»å‹ä¾› Widget ç»„ä»¶ä½¿ç”¨
 */
export type { GradientColorStop };

/**
 * WidgetHelper - å¤©æ°” Widget å·¥å…·ç±»
 * 
 * æä¾›ä»¥ä¸‹è¾…åŠ©åŠŸèƒ½ï¼š
 * - ä¸»é¢˜åˆ°æ¸å˜è‰²çš„æ˜ å°„
 * - å›¾æ ‡ä»£ç åˆ°èµ„æºçš„æ˜ å°„
 * - æ—¶é—´æ ¼å¼åŒ–
 * - æ•°æ®è¿‡æœŸæ£€æµ‹
 * - WeatherSnapshot åˆ° WidgetWeatherData çš„è½¬æ¢
 * 
 * Requirements: 1.4, 3.4, 5.2, 8.3
 */
export class WidgetHelper {
  /**
   * æ•°æ®è¿‡æœŸé˜ˆå€¼ï¼ˆ30 åˆ†é’Ÿï¼Œå•ä½ï¼šæ¯«ç§’ï¼‰
   */
  private static readonly STALENESS_THRESHOLD_MS: number = 30 * 60 * 1000;

  /**
   * æ ¹æ®å¤©æ°”ä¸»é¢˜è·å– Widget èƒŒæ™¯æ¸å˜è‰²
   * è¿”å›è‡³å°‘åŒ…å« 2 ä¸ªè‰²æ ‡çš„æœ‰æ•ˆæ¸å˜è‰²æ•°ç»„
   * 
   * @param themeKey å¤©æ°”ä¸»é¢˜é”®ï¼ˆsunny, rainy, snow, sunny_night, rainy_night, snow_nightï¼‰
   * @returns æ¸å˜è‰²è‰²æ ‡æ•°ç»„ [é¢œè‰², ä½ç½®]
   * Requirements: 5.2
   */
  static getGradientByTheme(themeKey: string): GradientColorStop[] {
    const theme = ThemeConstants.getTheme(themeKey);
    const gradientColors = theme.gradientColors;
    
    // ç¡®ä¿è‡³å°‘æœ‰ 2 ä¸ªé¢œè‰²ä»¥å½¢æˆæœ‰æ•ˆæ¸å˜
    if (gradientColors.length >= 2) {
      return [
        [gradientColors[0], 0.0],
        [gradientColors[1], 1.0]
      ];
    }
    
    // å¦‚æœä¸»é¢˜é¢œè‰²ä¸è¶³ï¼Œå›é€€åˆ°é»˜è®¤æ™´å¤©æ¸å˜è‰²
    return [
      ['#87CEEB', 0.0],
      ['#4A90E2', 1.0]
    ];
  }

  /**
   * è·å–åŸºäºå¤©æ°”ä¸»é¢˜çš„æ¸å˜è‰²ï¼ˆWidget ä¸“ç”¨ç‰ˆæœ¬ï¼‰
   * æä¾›å®Œæ•´çš„ä¸»é¢˜åˆ°æ¸å˜è‰²æ˜ å°„ï¼ŒåŒ…æ‹¬æ—¥å¤œå˜ä½“
   * 
   * @param themeKey å¤©æ°”ä¸»é¢˜é”®ï¼ˆå¦‚ sunny, sunny_day, sunny_night, rainy, snow ç­‰ï¼‰
   * @returns æ¸å˜è‰²æ•°ç»„ï¼Œè‡³å°‘åŒ…å« 2 ä¸ªè‰²æ ‡
   * Requirements: 1.1, 1.3, 1.5
   */
  static getGradientColors(themeKey: string): GradientColorStop[] {
    // ä¸»é¢˜åˆ°æ¸å˜è‰²çš„å®Œæ•´æ˜ å°„è¡¨
    const gradientMap: Record<string, GradientColorStop[]> = {
      'sunny': [['#4A90E2', 0.0], ['#87CEEB', 1.0]],
      'sunny_day': [['#4A90E2', 0.0], ['#87CEEB', 1.0]],
      'sunny_night': [['#1a1a2e', 0.0], ['#16213e', 1.0]],
      'cloudy': [['#546E7A', 0.0], ['#78909C', 1.0]],
      'cloudy_day': [['#546E7A', 0.0], ['#78909C', 1.0]],
      'cloudy_night': [['#2C3E50', 0.0], ['#34495E', 1.0]],
      'rainy': [['#3D5A80', 0.0], ['#5C7A99', 1.0]],
      'rainy_day': [['#3D5A80', 0.0], ['#5C7A99', 1.0]],
      'rainy_night': [['#1B2838', 0.0], ['#2C3E50', 1.0]],
      'snow': [['#E8EEF2', 0.0], ['#B0BEC5', 1.0]],
      'snow_day': [['#E8EEF2', 0.0], ['#B0BEC5', 1.0]],
      'snow_night': [['#37474F', 0.0], ['#455A64', 1.0]],
      'fog': [['#90A4AE', 0.0], ['#B0BEC5', 1.0]],
      'haze': [['#8D6E63', 0.0], ['#A1887F', 1.0]],
      'storm': [['#263238', 0.0], ['#37474F', 1.0]]
    };

    const normalizedKey = themeKey.toLowerCase().trim();
    
    if (gradientMap[normalizedKey]) {
      return gradientMap[normalizedKey];
    }
    
    // å›é€€åˆ°æ™´å¤©æ¸å˜è‰²
    return [['#4A90E2', 0.0], ['#87CEEB', 1.0]];
  }

  /**
   * è·å–å¤©æ°”å›¾æ ‡èµ„æºï¼ˆWidget ä¸“ç”¨ç‰ˆæœ¬ï¼‰
   * ä¸ getIconResource åŠŸèƒ½ç›¸åŒï¼Œæä¾›åˆ«åä»¥ä¿æŒå‘åå…¼å®¹
   * 
   * @param iconCode å¤©æ°”å›¾æ ‡ä»£ç 
   * @returns å¤©æ°”å›¾æ ‡èµ„æº
   * Requirements: 1.1, 1.3, 1.5
   */
  static getWeatherIcon(iconCode: string): Resource {
    return WidgetHelper.getIconResource(iconCode);
  }

  /**
   * æ ¹æ®å¤©æ°”å›¾æ ‡ä»£ç è·å–å›¾æ ‡èµ„æº
   * æœªçŸ¥ä»£ç æ—¶å›é€€åˆ°å¤ªé˜³å›¾æ ‡
   * 
   * @param iconCode å¤©æ°”å›¾æ ‡ä»£ç å­—ç¬¦ä¸²
   * @returns å¤©æ°”å›¾æ ‡çš„ Resource å¯¹è±¡
   * Requirements: 1.4, 8.3
   */
  static getIconResource(iconCode: string): Resource {
    // å›¾æ ‡ä»£ç åˆ° DesignSystem å›¾æ ‡èµ„æºçš„æ˜ å°„
    // å›¾æ ‡ä»£ç é€šå¸¸éµå¾ªä»¥ä¸‹æ¨¡å¼ï¼šsun, cloudy, rain, snow ç­‰
    const iconMap: Record<string, Resource> = {
      'sun': DesignSystem.ICON_SUN,
      'sunny': DesignSystem.ICON_SUN,
      'clear': DesignSystem.ICON_SUN,
      'clear-day': DesignSystem.ICON_SUN,
      'clear-night': DesignSystem.ICON_MOON,
      'moon': DesignSystem.ICON_MOON,
      'cloudy': DesignSystem.ICON_CLOUDY,
      'cloud': DesignSystem.ICON_CLOUDY,
      'partly-cloudy': DesignSystem.ICON_CLOUDY,
      'partly-cloudy-day': DesignSystem.ICON_CLOUDY,
      'partly-cloudy-night': DesignSystem.ICON_CLOUD_MOON,
      'cloud-moon': DesignSystem.ICON_CLOUD_MOON,
      'overcast': DesignSystem.ICON_OVERCAST,
      'rain': DesignSystem.ICON_RAIN,
      'rainy': DesignSystem.ICON_RAIN,
      'drizzle': DesignSystem.ICON_DRIZZLE,
      'light-rain': DesignSystem.ICON_DRIZZLE,
      'heavy-rain': DesignSystem.ICON_RAIN,
      'storm': DesignSystem.ICON_STORM,
      'thunderstorm': DesignSystem.ICON_STORM,
      'snow': DesignSystem.ICON_SNOW,
      'snowy': DesignSystem.ICON_SNOW,
      'light-snow': DesignSystem.ICON_SNOW,
      'heavy-snow': DesignSystem.ICON_SNOW,
      'fog': DesignSystem.ICON_FOG,
      'foggy': DesignSystem.ICON_FOG,
      'mist': DesignSystem.ICON_FOG,
      'haze': DesignSystem.ICON_HAZE,
      'hazy': DesignSystem.ICON_HAZE,
      'wind': DesignSystem.ICON_WIND,
      'windy': DesignSystem.ICON_WIND
    };

    // å°†å›¾æ ‡ä»£ç è½¬æ¢ä¸ºå°å†™ä»¥è¿›è¡ŒåŒ¹é…
    const normalizedCode = iconCode.toLowerCase().trim();
    
    // é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
    if (iconMap[normalizedCode]) {
      return iconMap[normalizedCode];
    }
    
    // å°è¯•éƒ¨åˆ†åŒ¹é…ï¼ˆç”¨äºå¤åˆä»£ç ï¼‰
    for (const key of Object.keys(iconMap)) {
      if (normalizedCode.includes(key)) {
        return iconMap[key];
      }
    }
    
    // æœªçŸ¥ä»£ç æ—¶å›é€€åˆ°å¤ªé˜³å›¾æ ‡
    console.warn(`[WidgetHelper] æœªçŸ¥å›¾æ ‡ä»£ç : ${iconCode}ï¼Œä½¿ç”¨é»˜è®¤å¤ªé˜³å›¾æ ‡`);
    return DesignSystem.ICON_SUN;
  }


  /**
   * å°†æ—¶é—´æˆ³æ ¼å¼åŒ–ä¸ºå¯è¯»çš„æ›´æ–°æ—¶é—´å­—ç¬¦ä¸²
   * 
   * @param timestamp Unix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
   * @returns æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²ï¼Œå¦‚ "14:30 æ›´æ–°"
   * Requirements: 1.5
   */
  static formatUpdateTime(timestamp: number): string {
    if (!timestamp || timestamp <= 0) {
      return '--:-- æ›´æ–°';
    }
    
    const date = new Date(timestamp);
    const hours = date.getHours();
    const minutes = date.getMinutes();
    
    const hoursStr = hours < 10 ? `0${hours}` : `${hours}`;
    const minutesStr = minutes < 10 ? `0${minutes}` : `${minutes}`;
    
    return `${hoursStr}:${minutesStr} æ›´æ–°`;
  }

  /**
   * æ£€æŸ¥å¤©æ°”æ•°æ®æ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡ 30 åˆ†é’Ÿï¼‰
   * å½“ä¸”ä»…å½“æ—¶é—´æˆ³æ¯”å½“å‰æ—¶é—´æ—© 30 åˆ†é’Ÿä»¥ä¸Šæ—¶è¿”å› true
   * 
   * @param timestamp Unix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
   * @returns æ•°æ®è¿‡æœŸè¿”å› trueï¼Œå¦åˆ™è¿”å› false
   * Requirements: 3.4
   */
  static isDataStale(timestamp: number): boolean {
    if (!timestamp || timestamp <= 0) {
      return true;
    }
    
    const now = Date.now();
    const age = now - timestamp;
    
    return age > WidgetHelper.STALENESS_THRESHOLD_MS;
  }

  /**
   * å°† WeatherSnapshot è½¬æ¢ä¸º WidgetWeatherData
   * ç”ŸæˆåŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µä¸”å€¼éç©ºçš„å¯¹è±¡
   * 
   * @param snapshot ä¸»åº”ç”¨çš„å¤©æ°”å¿«ç…§
   * @param cityName è¦æ˜¾ç¤ºçš„åŸå¸‚åç§°
   * @returns å¯ç”¨äº Widget æ˜¾ç¤ºçš„ WidgetWeatherData å¯¹è±¡
   * Requirements: 1.1, 1.2, 1.3, 1.5
   */
  static convertToWidgetData(snapshot: WeatherSnapshot, cityName: string): WidgetWeatherData {
    const now = Date.now();
    
    console.info(`[WidgetHelper] ğŸ”„ Converting snapshot to widget data for city: ${cityName}`);
    console.info(`[WidgetHelper] ğŸ“Š Snapshot current - temp: ${snapshot.current.temperatureC}, humidity: ${snapshot.current.humidity}, windSpeed: ${snapshot.current.windSpeedKph}`);
    console.info(`[WidgetHelper] ğŸ“Š Snapshot hourly count: ${snapshot.hourly?.length ?? 0}`);
    
    // æå–å°æ—¶é¢„æŠ¥ï¼ˆæœ€å¤š 3 é¡¹ï¼‰
    const hourlyForecast: WidgetHourlyItem[] = [];
    const hourlyArray = snapshot.hourly ?? [];
    const hourlyCount = Math.min(hourlyArray.length, 3);
    
    for (let i = 0; i < hourlyCount; i++) {
      const hourly = hourlyArray[i];
      const item: WidgetHourlyItem = {
        time: WidgetHelper.extractTimeFromIso(hourly.time),
        temperature: Math.round(hourly.temperatureC),
        iconCode: hourly.iconCode || 'sun'
      };
      hourlyForecast.push(item);
      console.info(`[WidgetHelper] ğŸ“Š å°æ—¶é¢„æŠ¥[${i}]: ${item.time}, ${item.temperature}Â°, ${item.iconCode}`);
    }
    
    // æ„å»ºåŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µçš„ Widget æ•°æ®
    const humidity = snapshot.current.humidity !== undefined && snapshot.current.humidity !== null 
      ? snapshot.current.humidity 
      : 0;
    const windSpeed = snapshot.current.windSpeedKph !== undefined && snapshot.current.windSpeedKph !== null 
      ? Math.round(snapshot.current.windSpeedKph) 
      : 0;
    
    const widgetData: WidgetWeatherData = {
      cityName: cityName || 'æœªçŸ¥åŸå¸‚',
      temperature: Math.round(snapshot.current.temperatureC),
      temperatureUnit: 'Â°C',
      condition: snapshot.current.condition.description || 'æœªçŸ¥',
      iconCode: snapshot.current.condition.iconCode || 'sun',
      themeKey: snapshot.current.condition.themeKey || 'sunny',
      humidity: humidity,
      windSpeed: windSpeed,
      updateTime: WidgetHelper.formatUpdateTime(now),
      timestamp: now,
      hourlyForecast: hourlyForecast
    };
    
    console.info(`[WidgetHelper] âœ… Widget data created - humidity: ${widgetData.humidity}%, windSpeed: ${widgetData.windSpeed} km/h, hourly: ${widgetData.hourlyForecast.length}`);
    
    return widgetData;
  }

  /**
   * ä» ISO æ—¥æœŸå­—ç¬¦ä¸²ä¸­æå–æ—¶é—´å­—ç¬¦ä¸²ï¼ˆHH:mmï¼‰
   * 
   * @param isoString ISO æ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²
   * @returns æ—¶é—´å­—ç¬¦ä¸²ï¼Œå¦‚ "14:00"
   */
  private static extractTimeFromIso(isoString: string): string {
    if (!isoString) {
      return '--:--';
    }
    
    try {
      const date = new Date(isoString);
      const hours = date.getHours();
      const minutes = date.getMinutes();
      
      const hoursStr = hours < 10 ? `0${hours}` : `${hours}`;
      const minutesStr = minutes < 10 ? `0${minutes}` : `${minutes}`;
      
      return `${hoursStr}:${minutesStr}`;
    } catch (error) {
      console.error('[WidgetHelper] Failed to parse ISO time:', error);
      return '--:--';
    }
  }

  /**
   * è·å–é»˜è®¤çš„ Widget æ•°æ®ï¼ˆç”¨äºå›é€€åœºæ™¯ï¼‰
   * å½“æ²¡æœ‰ç¼“å­˜æ•°æ®å¯ç”¨æ—¶ä½¿ç”¨
   * 
   * @returns åŒ…å«å ä½ç¬¦å€¼çš„é»˜è®¤ WidgetWeatherData
   * Requirements: 8.1, 8.2
   */
  static getDefaultWidgetData(): WidgetWeatherData {
    return {
      cityName: 'ç‚¹å‡»åˆ·æ–°',
      temperature: 0,
      temperatureUnit: 'Â°C',
      condition: 'æ•°æ®åŠ è½½ä¸­',
      iconCode: 'sun',
      themeKey: 'sunny',
      humidity: 0,
      windSpeed: 0,
      updateTime: '--:-- æ›´æ–°',
      timestamp: 0,
      hourlyForecast: []
    };
  }
}

import { DebugLogger, LogData } from './DebugLogger';
import { BackgroundMode } from '../constants/ThemeConstants';

export interface FeatureStatus {
  name: string;
  enabled: boolean;
  reason: string;
  details?: LogData;
}

export class FeatureChecker {
  private static instance: FeatureChecker | null = null;
  private logger: DebugLogger = DebugLogger.getInstance();

  static getInstance(): FeatureChecker {
    if (FeatureChecker.instance === null) {
      FeatureChecker.instance = new FeatureChecker();
    }
    return FeatureChecker.instance;
  }

  private constructor() {
    this.logger.info('FeatureChecker', 'ğŸ” åŠŸèƒ½æ£€æŸ¥å™¨å·²åˆå§‹åŒ–');
  }

  /**
   * æ£€æŸ¥æ‰€æœ‰åŠŸèƒ½çŠ¶æ€
   */
  checkAllFeatures(): FeatureStatus[] {
    this.logger.info('FeatureChecker', 'ğŸš€ å¼€å§‹å…¨é¢åŠŸèƒ½æ£€æŸ¥');
    
    const features: FeatureStatus[] = [];
    
    // æ£€æŸ¥èƒŒæ™¯æ¨¡å¼åŠŸèƒ½
    features.push(this.checkBackgroundModeFeature());
    
    // æ£€æŸ¥è§†é¢‘èµ„æºåŠŸèƒ½
    features.push(this.checkVideoResourceFeature());
    
    // æ£€æŸ¥åŠ¨ç”»èµ„æºåŠŸèƒ½
    features.push(this.checkAnimatedResourceFeature());
    
    // æ£€æŸ¥è°ƒè¯•å·¥å…·åŠŸèƒ½
    features.push(this.checkDebugToolsFeature());
    
    // æ£€æŸ¥AppStorageåŠŸèƒ½
    features.push(this.checkAppStorageFeature());
    
    // æ£€æŸ¥ç»„ä»¶æ¸²æŸ“åŠŸèƒ½
    features.push(this.checkComponentRenderFeature());
    
    const summaryData: LogData = {
      'totalFeatures': features.length,
      'enabledFeatures': features.filter(f => f.enabled).length,
      'disabledFeatures': features.filter(f => !f.enabled).length
    };
    this.logger.info('FeatureChecker', 'âœ… åŠŸèƒ½æ£€æŸ¥å®Œæˆ', summaryData);
    
    return features;
  }

  private checkBackgroundModeFeature(): FeatureStatus {
    try {
      const currentMode: BackgroundMode = AppStorage.get<BackgroundMode>('backgroundMode') ?? BackgroundMode.GRADIENT;
      const isDevelopment: boolean = AppStorage.get<boolean>('isDevelopment') ?? false;
      
      const debugData: LogData = {
        'currentMode': String(currentMode),
        'isDevelopment': isDevelopment,
        'hasAppStorage': true
      };
      this.logger.debug('FeatureChecker', 'ğŸ¬ æ£€æŸ¥èƒŒæ™¯æ¨¡å¼åŠŸèƒ½', debugData);
      
      const details: LogData = {
        'currentMode': String(currentMode),
        'isDevelopment': isDevelopment,
        'supportedModes': ['VIDEO', 'ANIMATED_IMAGE', 'GRADIENT']
      };
      
      const result: FeatureStatus = {
        name: 'èƒŒæ™¯æ¨¡å¼åˆ‡æ¢',
        enabled: true,
        reason: 'åŠŸèƒ½æ­£å¸¸',
        details: details
      };
      return result;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      this.logger.error('FeatureChecker', 'âŒ èƒŒæ™¯æ¨¡å¼åŠŸèƒ½æ£€æŸ¥å¤±è´¥', error instanceof Error ? error : undefined);
      
      const errorDetails: LogData = {
        'errorMessage': errorMsg
      };
      
      const result: FeatureStatus = {
        name: 'èƒŒæ™¯æ¨¡å¼åˆ‡æ¢',
        enabled: false,
        reason: 'åŠŸèƒ½å¼‚å¸¸',
        details: errorDetails
      };
      return result;
    }
  }

  private checkVideoResourceFeature(): FeatureStatus {
    try {
      // æ£€æŸ¥è§†é¢‘èµ„æºè·¯å¾„
      const videoResources: string[] = [
        'rawfile/weather/sunny_day.mp4',
        'rawfile/weather/sunny_night.mp4',
        'rawfile/weather/rainy_day.mp4',
        'rawfile/weather/rainy_night.mp4',
        'rawfile/weather/snow_day.mp4',
        'rawfile/weather/snow_night.mp4'
      ];
      
      const debugData: LogData = {
        'resourceCount': videoResources.length,
        'resources': videoResources.join(', ')
      };
      this.logger.debug('FeatureChecker', 'ğŸ¥ æ£€æŸ¥è§†é¢‘èµ„æºåŠŸèƒ½', debugData);
      
      const details: LogData = {
        'videoResources': videoResources,
        'resourceCount': videoResources.length
      };
      
      const result: FeatureStatus = {
        name: 'è§†é¢‘èµ„æºæ’­æ”¾',
        enabled: true,
        reason: 'èµ„æºè·¯å¾„é…ç½®æ­£ç¡®',
        details: details
      };
      return result;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      this.logger.error('FeatureChecker', 'âŒ è§†é¢‘èµ„æºåŠŸèƒ½æ£€æŸ¥å¤±è´¥', error instanceof Error ? error : undefined);
      
      const errorDetails: LogData = {
        'errorMessage': errorMsg
      };
      
      const result: FeatureStatus = {
        name: 'è§†é¢‘èµ„æºæ’­æ”¾',
        enabled: false,
        reason: 'èµ„æºæ£€æŸ¥å¤±è´¥',
        details: errorDetails
      };
      return result;
    }
  }

  private checkAnimatedResourceFeature(): FeatureStatus {
    try {
      // æ£€æŸ¥WebPåŠ¨ç”»èµ„æºè·¯å¾„
      const animatedResources: string[] = [
        'rawfile/weather/sunny.webp',
        'rawfile/weather/rainy.webp',
        'rawfile/weather/snow.webp',
        'rawfile/weather/night.webp'
      ];
      
      const debugData: LogData = {
        'resourceCount': animatedResources.length,
        'resources': animatedResources.join(', ')
      };
      this.logger.debug('FeatureChecker', 'ğŸï¸ æ£€æŸ¥åŠ¨ç”»èµ„æºåŠŸèƒ½', debugData);
      
      const details: LogData = {
        'animatedResources': animatedResources,
        'resourceCount': animatedResources.length
      };
      
      const result: FeatureStatus = {
        name: 'WebPåŠ¨ç”»æ’­æ”¾',
        enabled: true,
        reason: 'èµ„æºè·¯å¾„é…ç½®æ­£ç¡®',
        details: details
      };
      return result;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      this.logger.error('FeatureChecker', 'âŒ åŠ¨ç”»èµ„æºåŠŸèƒ½æ£€æŸ¥å¤±è´¥', error instanceof Error ? error : undefined);
      
      const errorDetails: LogData = {
        'errorMessage': errorMsg
      };
      
      const result: FeatureStatus = {
        name: 'WebPåŠ¨ç”»æ’­æ”¾',
        enabled: false,
        reason: 'èµ„æºæ£€æŸ¥å¤±è´¥',
        details: errorDetails
      };
      return result;
    }
  }

  private checkDebugToolsFeature(): FeatureStatus {
    try {
      const isDevelopment: boolean = AppStorage.get<boolean>('isDevelopment') ?? false;
      
      const tools: string[] = [
        'PerformanceOverlay',
        'ResourceStatusOverlay', 
        'DatabaseInspector',
        'ChartPerformanceMonitor',
        'ThemeDebugPanel',
        'ResourceValidator',
        'LogViewer'
      ];
      
      const debugData: LogData = {
        'isDevelopment': isDevelopment,
        'hasConsole': true,
        'hasAppStorage': true
      };
      this.logger.debug('FeatureChecker', 'ğŸ› ï¸ æ£€æŸ¥è°ƒè¯•å·¥å…·åŠŸèƒ½', debugData);
      
      const details: LogData = {
        'isDevelopment': isDevelopment,
        'availableTools': tools
      };
      
      const result: FeatureStatus = {
        name: 'è°ƒè¯•å·¥å…·é¢æ¿',
        enabled: isDevelopment,
        reason: isDevelopment ? 'å¼€å‘æ¨¡å¼å·²å¯ç”¨' : 'éå¼€å‘æ¨¡å¼',
        details: details
      };
      return result;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      this.logger.error('FeatureChecker', 'âŒ è°ƒè¯•å·¥å…·åŠŸèƒ½æ£€æŸ¥å¤±è´¥', error instanceof Error ? error : undefined);
      
      const errorDetails: LogData = {
        'errorMessage': errorMsg
      };
      
      const result: FeatureStatus = {
        name: 'è°ƒè¯•å·¥å…·é¢æ¿',
        enabled: false,
        reason: 'åŠŸèƒ½å¼‚å¸¸',
        details: errorDetails
      };
      return result;
    }
  }

  private checkAppStorageFeature(): FeatureStatus {
    try {
      // æµ‹è¯•AppStorageè¯»å†™
      const testKey: string = 'featureChecker_test';
      const testValue: string = 'test_value_' + Date.now().toString();
      
      AppStorage.setOrCreate(testKey, testValue);
      const retrievedValue: string = AppStorage.get<string>(testKey) ?? '';
      
      const isWorking: boolean = retrievedValue === testValue;
      
      const debugData: LogData = {
        'testKey': testKey,
        'testValue': testValue,
        'retrievedValue': retrievedValue,
        'isWorking': isWorking
      };
      this.logger.debug('FeatureChecker', 'ğŸ’¾ æ£€æŸ¥AppStorageåŠŸèƒ½', debugData);
      
      const details: LogData = {
        'testKey': testKey,
        'testValue': testValue,
        'retrievedValue': retrievedValue,
        'isWorking': isWorking
      };
      
      const result: FeatureStatus = {
        name: 'AppStorageçŠ¶æ€ç®¡ç†',
        enabled: isWorking,
        reason: isWorking ? 'è¯»å†™æ­£å¸¸' : 'è¯»å†™å¼‚å¸¸',
        details: details
      };
      return result;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      this.logger.error('FeatureChecker', 'âŒ AppStorageåŠŸèƒ½æ£€æŸ¥å¤±è´¥', error instanceof Error ? error : undefined);
      
      const errorDetails: LogData = {
        'errorMessage': errorMsg
      };
      
      const result: FeatureStatus = {
        name: 'AppStorageçŠ¶æ€ç®¡ç†',
        enabled: false,
        reason: 'åŠŸèƒ½å¼‚å¸¸',
        details: errorDetails
      };
      return result;
    }
  }

  private checkComponentRenderFeature(): FeatureStatus {
    try {
      // æ£€æŸ¥ç»„ä»¶æ¸²æŸ“ç›¸å…³çš„åŸºç¡€åŠŸèƒ½ - ä½¿ç”¨typeofæ¥é¿å…"ç±»è¢«ç”¨ä½œå¯¹è±¡"çš„é”™è¯¯
      const hasStack: boolean = typeof Stack !== 'undefined';
      const hasColumn: boolean = typeof Column !== 'undefined';
      const hasRow: boolean = typeof Row !== 'undefined';
      const hasButton: boolean = typeof Button !== 'undefined';
      const hasText: boolean = typeof Text !== 'undefined';
      const hasVideo: boolean = typeof Video !== 'undefined';
      const hasImage: boolean = typeof Image !== 'undefined';
      
      const allComponentsAvailable: boolean = hasStack && hasColumn && hasRow && hasButton && hasText && hasVideo && hasImage;
      
      const debugData: LogData = {
        'hasStack': hasStack,
        'hasColumn': hasColumn,
        'hasRow': hasRow,
        'hasButton': hasButton,
        'hasText': hasText,
        'hasVideo': hasVideo,
        'hasImage': hasImage,
        'allComponentsAvailable': allComponentsAvailable
      };
      this.logger.debug('FeatureChecker', 'ğŸ§© æ£€æŸ¥ç»„ä»¶æ¸²æŸ“åŠŸèƒ½', debugData);
      
      const details: LogData = {
        'hasStack': hasStack,
        'hasColumn': hasColumn,
        'hasRow': hasRow,
        'hasButton': hasButton,
        'hasText': hasText,
        'hasVideo': hasVideo,
        'hasImage': hasImage
      };
      
      const result: FeatureStatus = {
        name: 'UIç»„ä»¶æ¸²æŸ“',
        enabled: allComponentsAvailable,
        reason: allComponentsAvailable ? 'æ‰€æœ‰ç»„ä»¶å¯ç”¨' : 'éƒ¨åˆ†ç»„ä»¶ç¼ºå¤±',
        details: details
      };
      return result;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      this.logger.error('FeatureChecker', 'âŒ ç»„ä»¶æ¸²æŸ“åŠŸèƒ½æ£€æŸ¥å¤±è´¥', error instanceof Error ? error : undefined);
      
      const errorDetails: LogData = {
        'errorMessage': errorMsg
      };
      
      const result: FeatureStatus = {
        name: 'UIç»„ä»¶æ¸²æŸ“',
        enabled: false,
        reason: 'åŠŸèƒ½å¼‚å¸¸',
        details: errorDetails
      };
      return result;
    }
  }
}

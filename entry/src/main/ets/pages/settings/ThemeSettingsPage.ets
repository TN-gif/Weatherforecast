import router from '@ohos.router';
import { ThemeManager, ThemeMode, ThemeConfig } from '../../common/theme/ThemeManager';
import { ThemedCard, ThemedText, ThemedButton, ThemedDivider } from '../../components/common/ThemedCard';
import { AppContextHolder } from '../../common/di/AppContextHolder';

@Entry
@Component
struct ThemeSettingsPage {
  @State private currentMode: ThemeMode = ThemeMode.AUTO;
  @State private isLoading: boolean = false;
  @StorageLink('currentTheme') private theme: ThemeConfig = this.getDefaultTheme();
  @StorageLink('isDarkMode') private isDarkMode: boolean = false;

  private themeManager: ThemeManager = ThemeManager.getInstance();

  aboutToAppear(): void {
    this.loadCurrentSettings();
  }

  private getDefaultTheme(): ThemeConfig {
    return {
      primaryColor: '#87CEEB',
      backgroundColor: '#F5F7FA',
      surfaceColor: '#FFFFFF',
      cardColor: 'rgba(255, 255, 255, 0.9)',
      textPrimaryColor: '#1A1A1A',
      textSecondaryColor: '#666666',
      textHintColor: '#999999',
      dividerColor: 'rgba(0, 0, 0, 0.1)',
      shadowColor: 'rgba(0, 0, 0, 0.1)',
      cardOpacity: 0.15,
      chartColor: '#2196F3',
      accentColor: '#4A90E2',
      errorColor: '#F44336',
      successColor: '#4CAF50',
      warningColor: '#FF9800'
    };
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      this.buildHeader();
      
      // ä¸»é¢˜é¢„è§ˆ
      this.buildThemePreview();
      
      // ä¸»é¢˜é€‰é¡¹
      this.buildThemeOptions();
      
      // ä¸»é¢˜è¯´æ˜
      this.buildThemeDescription();
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.theme.backgroundColor)
    .animation({
      duration: 300,
      curve: Curve.EaseInOut
    });
  }

  @Builder
  private buildHeader(): void {
    Row() {
      Button() {
        Image($r('app.media.startIcon'))
          .width(24)
          .height(24)
          .fillColor(this.theme.textPrimaryColor);
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back();
      });

      ThemedText({
        text: 'ä¸»é¢˜è®¾ç½®',
        fontSize: 20,
        fontWeight: FontWeight.Bold,
        textType: 'primary'
      })
        .layoutWeight(1)
        .textAlign(TextAlign.Center);

      // å ä½ç¬¦ä¿æŒå±…ä¸­
      Column()
        .width(40)
        .height(40);
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(this.theme.surfaceColor)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
    .shadow({
      radius: 4,
      color: this.theme.shadowColor,
      offsetY: 2
    });
  }

  @Builder
  private buildThemePreview(): void {
    ThemedCard({
      margin: 16,
      children: () => {
        Column() {
          Row() {
            ThemedText({
              text: 'ä¸»é¢˜é¢„è§ˆ',
              fontSize: 18,
              fontWeight: FontWeight.Medium,
              textType: 'primary'
            });
            
            Blank();
            
            Text(this.isDarkMode ? 'ğŸŒ™' : 'â˜€ï¸')
              .fontSize(24);
          }
          .width('100%')
          .margin({ bottom: 16 });

          // é¢„è§ˆå¡ç‰‡
          Column() {
            Row() {
              Column() {
                ThemedText({
                  text: 'åŒ—äº¬',
                  fontSize: 16,
                  fontWeight: FontWeight.Medium,
                  textType: 'primary'
                });
                
                ThemedText({
                  text: 'æ™´å¤©',
                  fontSize: 12,
                  textType: 'secondary',
                  margin: { top: 2 }
                });
              }
              .alignItems(HorizontalAlign.Start);
              
              Blank();
              
              ThemedText({
                text: '24Â°',
                fontSize: 32,
                fontWeight: FontWeight.Bold,
                textType: 'primary'
              });
            }
            .width('100%')
            .padding(16)
            .backgroundColor(this.theme.cardColor)
            .borderRadius(12)
            .backdropBlur(10);
          }
          .width('100%');
        }
      }
    });
  }

  @Builder
  private buildThemeOptions(): void {
    ThemedCard({
      margin: { left: 16, right: 16, bottom: 16 },
      children: () => {
        Column() {
          ThemedText({
            text: 'ä¸»é¢˜æ¨¡å¼',
            fontSize: 18,
            fontWeight: FontWeight.Medium,
            textType: 'primary',
            margin: { bottom: 16 }
          });

          // è‡ªåŠ¨æ¨¡å¼
          this.buildThemeOption(
            ThemeMode.AUTO,
            'è·Ÿéšç³»ç»Ÿ',
            'æ ¹æ®æ—¶é—´è‡ªåŠ¨åˆ‡æ¢æµ…è‰²å’Œæ·±è‰²ä¸»é¢˜',
            'ğŸ”„'
          );

          ThemedDivider({ margin: { top: 12, bottom: 12 } });

          // æµ…è‰²æ¨¡å¼
          this.buildThemeOption(
            ThemeMode.LIGHT,
            'æµ…è‰²æ¨¡å¼',
            'é€‚åˆç™½å¤©ä½¿ç”¨ï¼Œæä¾›æ¸…æ™°çš„é˜…è¯»ä½“éªŒ',
            'â˜€ï¸'
          );

          ThemedDivider({ margin: { top: 12, bottom: 12 } });

          // æ·±è‰²æ¨¡å¼
          this.buildThemeOption(
            ThemeMode.DARK,
            'æ·±è‰²æ¨¡å¼',
            'é€‚åˆå¤œé—´ä½¿ç”¨ï¼Œå‡å°‘çœ¼éƒ¨ç–²åŠ³',
            'ğŸŒ™'
          );
        }
      }
    });
  }

  @Builder
  private buildThemeOption(mode: ThemeMode, title: string, description: string, icon: string): void {
    Row() {
      Text(icon)
        .fontSize(24)
        .margin({ right: 12 });
      
      Column() {
        ThemedText({
          text: title,
          fontSize: 16,
          fontWeight: FontWeight.Medium,
          textType: 'primary'
        })
          .alignSelf(ItemAlign.Start);
        
        ThemedText({
          text: description,
          fontSize: 12,
          textType: 'secondary',
          margin: { top: 4 }
        })
          .alignSelf(ItemAlign.Start);
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start);
      
      Radio({ value: mode, group: 'themeGroup' })
        .checked(this.currentMode === mode)
        .onChange((isChecked: boolean) => {
          if (isChecked) {
            this.selectThemeMode(mode);
          }
        });
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      this.selectThemeMode(mode);
    });
  }

  @Builder
  private buildThemeDescription(): void {
    ThemedCard({
      margin: { left: 16, right: 16, bottom: 16 },
      children: () => {
        Column() {
          Row() {
            Text('ğŸ’¡')
              .fontSize(20)
              .margin({ right: 8 });
            
            ThemedText({
              text: 'ä¸»é¢˜å»ºè®®',
              fontSize: 16,
              fontWeight: FontWeight.Medium,
              textType: 'primary'
            });
          }
          .margin({ bottom: 12 });

          ThemedText({
            text: this.themeManager.getThemeSuggestion(),
            fontSize: 14,
            textType: 'secondary'
          });

          if (this.currentMode === ThemeMode.AUTO) {
            ThemedDivider({ margin: { top: 12, bottom: 12 } });
            
            ThemedText({
              text: 'è‡ªåŠ¨åˆ‡æ¢æ—¶é—´ï¼š',
              fontSize: 14,
              fontWeight: FontWeight.Medium,
              textType: 'primary',
              margin: { bottom: 8 }
            });
            
            ThemedText({
              text: 'â€¢ æµ…è‰²æ¨¡å¼ï¼š06:00 - 18:00\nâ€¢ æ·±è‰²æ¨¡å¼ï¼š18:00 - 06:00',
              fontSize: 12,
              textType: 'secondary'
            });
          }
        }
      }
    });
  }

  private async loadCurrentSettings(): Promise<void> {
    try {
      this.currentMode = this.themeManager.getCurrentMode();
    } catch (error) {
      console.error('[ThemeSettingsPage] Failed to load settings:', error);
    }
  }

  private async selectThemeMode(mode: ThemeMode): Promise<void> {
    if (this.currentMode === mode || this.isLoading) {
      return;
    }

    try {
      this.isLoading = true;
      this.currentMode = mode;
      
      // åº”ç”¨ä¸»é¢˜
      await this.themeManager.setThemeMode(mode);
      
      console.info(`[ThemeSettingsPage] Theme mode changed to: ${mode}`);
    } catch (error) {
      console.error('[ThemeSettingsPage] Failed to change theme:', error);
      // æ¢å¤åŸæ¥çš„é€‰æ‹©
      this.currentMode = this.themeManager.getCurrentMode();
    } finally {
      this.isLoading = false;
    }
  }
}

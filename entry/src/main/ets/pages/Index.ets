import { WeatherHomePage } from './home/WeatherHomePage';

@Entry
@Component
struct Index {
  @State private refreshTrigger: number = 0;
  @State private forceGpsCityIndex: number = -1;

  onPageShow(): void {
    console.info('[Index] ========== é¡µé¢æ˜¾ç¤º (onPageShow) ==========');
    
    // æ£€æŸ¥AppStorageä¸­çš„åˆ·æ–°ä¿¡å·
    const needRefresh = AppStorage.get<boolean>('needRefreshWeather');
    const newCityId = AppStorage.get<string>('newAddedCityId');
    
    // ğŸ”§ æ£€æŸ¥æ˜¯å¦ä»Widgetç‚¹å‡»è¿›å…¥ï¼Œéœ€è¦å¼ºåˆ¶è·³è½¬åˆ°GPSåŸå¸‚
    const forceGpsCity = AppStorage.get<boolean>('forceGpsCityNavigation');
    
    console.info(`[Index] ğŸ“¦ AppStorageåˆ·æ–°ä¿¡å·: needRefresh=${needRefresh}, newCityId=${newCityId}, forceGpsCity=${forceGpsCity}`);
    
    if (forceGpsCity) {
      console.info('[Index] ğŸ¯ æ£€æµ‹åˆ°Widgetè·³è½¬ä¿¡å·ï¼Œå¼ºåˆ¶è·³è½¬åˆ°GPSåŸå¸‚ï¼ˆç´¢å¼•0ï¼‰');
      // æ¸…é™¤æ ‡å¿—
      AppStorage.setOrCreate('forceGpsCityNavigation', false);
      // è®¾ç½®è·³è½¬åˆ°GPSåŸå¸‚ï¼ˆç´¢å¼•0ï¼‰
      this.forceGpsCityIndex = 0;
      // è§¦å‘åˆ·æ–°
      this.refreshTrigger = Date.now();
    } else if (needRefresh) {
      console.info('[Index] ğŸ”„ æ£€æµ‹åˆ°åˆ·æ–°ä¿¡å·ï¼Œè§¦å‘WeatherHomePageåˆ·æ–°');
      // è§¦å‘å­ç»„ä»¶åˆ·æ–°
      this.refreshTrigger = Date.now();
    }
  }

  build() {
    Stack() {
      WeatherHomePage({ 
        refreshTrigger: this.refreshTrigger,
        forceGpsCityIndex: this.forceGpsCityIndex
      });
    }
    .width('100%')
    .height('100%');
  }
}

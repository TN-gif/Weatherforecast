import router from '@ohos.router';
import { City, CitySource, WeatherSnapshot } from '../../data/models/WeatherModels';
import { CityRepository } from '../../data/repository/CityRepository';
import { CitySearchService, CitySearchResult } from '../../data/services/CitySearchService';
import { ErrorToast, ErrorMessage, ErrorHandler } from '../../components/common/ErrorToast';
import { AppContextHolder } from '../../common/di/AppContextHolder';
import { DesignSystem } from '../../common/theme/DesignSystem';
import { ThemeConstants } from '../../common/constants/ThemeConstants';
import { WeatherCacheStorage } from '../../data/storage/WeatherCacheStorage';

// è·¯ç”±å‚æ•°æ¥å£
interface RouterParams {
  openSearchMode?: boolean;
}

// åŸå¸‚ä¸å¤©æ°”æ•°æ®çš„ç»„åˆ
interface CityWeatherInfo {
  city: City;
  snapshot: WeatherSnapshot | null;
  videoPath: string;
  isNight: boolean;
}

@Entry
@Component
struct CityManagementPage {
  @State private cities: City[] = [];
  @State private cityWeatherInfos: CityWeatherInfo[] = [];
  @State private isLoading: boolean = true;
  @State private isSearchMode: boolean = false;
  @State private currentError: ErrorMessage | null = null;
  @State private isAddingCity: boolean = false;
  @State private isDragging: boolean = false;
  @State private dragIndex: number = -1;

  private cityRepository: CityRepository = CityRepository.getInstance();
  private searchService: CitySearchService = CitySearchService.getInstance();
  private weatherCache: WeatherCacheStorage = WeatherCacheStorage.getInstance();

  aboutToAppear(): void {
    console.info('[CityManagementPage] ========== åŸå¸‚ç®¡ç†é¡µé¢æ˜¾ç¤º ==========');
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç›´æ¥æ‰“å¼€æœç´¢æ¨¡å¼
    const params = router.getParams() as RouterParams | undefined;
    if (params && params.openSearchMode === true) {
      console.info('[CityManagementPage] ğŸ“ ä»è·¯ç”±å‚æ•°æ£€æµ‹åˆ°éœ€è¦æ‰“å¼€æœç´¢æ¨¡å¼');
      this.isSearchMode = true;
    }
    
    this.loadCitiesWithWeather();
  }

  build() {
    Stack() {
      // çº¯ç™½èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#F5F7FA')

      // å†…å®¹å±‚
      Column() {
        // å¤´éƒ¨å¯¼èˆªæ 
        this.buildHeader()

        // æœç´¢åŒºåŸŸï¼ˆæœç´¢æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
        if (this.isSearchMode) {
          this.buildSearchSection()
        }

        // åŸå¸‚åˆ—è¡¨
        if (this.isLoading) {
          this.buildLoading()
        } else {
          this.buildCityList()
        }
      }
      .width('100%')
      .height('100%')

      // é”™è¯¯æç¤º
      ErrorToast({ errorMessage: $currentError })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  private buildHeader(): void {
    Row() {
      // è¿”å›æŒ‰é’®
      Button() {
        Image(DesignSystem.IconResources.BACK)
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(44)
      .height(44)
      .backgroundColor(Color.Transparent)
      .type(ButtonType.Circle)
      .onClick(() => {
        router.back();
      })

      // æ ‡é¢˜
      Text('åŸå¸‚ç®¡ç†')
        .fontSize(20)
        .fontWeight(DesignSystem.FontWeight.SEMIBOLD)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // æœç´¢/å…³é—­æŒ‰é’®
      Button() {
        Image(this.isSearchMode ? DesignSystem.IconResources.CLOSE : DesignSystem.IconResources.ADD)
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(44)
      .height(44)
      .backgroundColor(Color.Transparent)
      .type(ButtonType.Circle)
      .onClick(() => {
        this.toggleSearchMode();
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: DesignSystem.Spacing.M, right: DesignSystem.Spacing.M, top: DesignSystem.Spacing.S })
    .backgroundColor('#FFFFFF')
  }

  @Builder
  private buildSearchSection(): void {
    Column() {
      this.buildLightSearchBar()
      this.buildPopularCities()
    }
    .width('100%')
    .padding(DesignSystem.Spacing.M)
    .backgroundColor('#FFFFFF')
    .margin({ top: 1 })
    .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: -20 } })
    .transition({ type: TransitionType.Delete, opacity: 0, translate: { y: -20 } })
  }

  @Builder
  private buildLightSearchBar(): void {
    Row() {
      Image(DesignSystem.IconResources.SEARCH)
        .width(20)
        .height(20)
        .fillColor('#999999')
        .margin({ right: 12 })

      TextInput({ placeholder: 'æœç´¢åŸå¸‚åç§°...' })
        .layoutWeight(1)
        .backgroundColor(Color.Transparent)
        .border({ width: 0 })
        .fontSize(16)
        .fontColor('#333333')
        .placeholderColor('#999999')
        .onChange((value: string) => {
          this.onSearchTextChange(value);
        })
    }
    .width('100%')
    .height(48)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#F0F0F5')
    .borderRadius(24)
    .alignItems(VerticalAlign.Center)
  }

  @State private searchText: string = '';
  @State private searchResults: CitySearchResult[] = [];
  @State private isSearching: boolean = false;
  private searchTimeoutId: number = -1;

  private onSearchTextChange(value: string): void {
    this.searchText = value;
    
    if (this.searchTimeoutId !== -1) {
      clearTimeout(this.searchTimeoutId);
    }

    if (value.length < 2) {
      this.searchResults = [];
      return;
    }

    this.searchTimeoutId = setTimeout(() => {
      this.performSearch(value);
    }, 300);
  }

  private async performSearch(keyword: string): Promise<void> {
    this.isSearching = true;
    try {
      const results = await this.searchService.searchCities(keyword);
      this.searchResults = results;
    } catch (error) {
      console.error('[CityManagementPage] Search failed:', error);
    } finally {
      this.isSearching = false;
    }
  }

  @Builder
  private buildPopularCities(): void {
    Column() {
      if (this.searchResults.length > 0) {
        Text('æœç´¢ç»“æœ')
          .fontSize(14)
          .fontWeight(DesignSystem.FontWeight.MEDIUM)
          .fontColor('#666666')
          .margin({ top: DesignSystem.Spacing.M, bottom: DesignSystem.Spacing.S })
          .alignSelf(ItemAlign.Start)

        List() {
          ForEach(this.searchResults, (result: CitySearchResult) => {
            ListItem() {
              Row() {
                Column() {
                  Text(this.getSearchResultDisplayName(result))
                    .fontSize(16)
                    .fontColor('#333333')
                    .fontWeight(DesignSystem.FontWeight.MEDIUM)
                  Text(this.getSearchResultSubtitle(result))
                    .fontSize(13)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)

                Image(DesignSystem.IconResources.ADD)
                  .width(20)
                  .height(20)
                  .fillColor('#007AFF')
              }
              .width('100%')
              .height(56)
              .padding({ left: 16, right: 16 })
              .onClick(() => {
                this.addCity(result);
              })
            }
          }, (result: CitySearchResult) => result.id)
        }
        .divider({ strokeWidth: 1, color: '#F0F0F0' })
        .constraintSize({ maxHeight: 200 })
      } else {
        Text('çƒ­é—¨åŸå¸‚')
          .fontSize(14)
          .fontWeight(DesignSystem.FontWeight.MEDIUM)
          .fontColor('#666666')
          .margin({ top: DesignSystem.Spacing.L, bottom: DesignSystem.Spacing.S })
          .alignSelf(ItemAlign.Start)

        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
          ForEach(this.searchService.getPopularCities(), (city: CitySearchResult) => {
            Text(city.name)
              .fontSize(14)
              .fontColor('#333333')
              .textAlign(TextAlign.Center)
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .backgroundColor('#F0F0F5')
              .borderRadius(20)
              .margin({ right: 8, bottom: 8 })
              .onClick(() => {
                this.addCity(city);
              })
          }, (city: CitySearchResult) => city.id)
        }
        .width('100%')
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  private buildLoading(): void {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#666666')
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  private buildCityList(): void {
    List({ space: DesignSystem.Spacing.M }) {
      ForEach(this.cityWeatherInfos, (info: CityWeatherInfo, index: number) => {
        ListItem() {
          this.buildCityCard(info, index)
        }
        .swipeAction({
          end: this.buildDeleteButton(info.city, index)
        })
      }, (info: CityWeatherInfo) => info.city.id)
    }
    .width('100%')
    .layoutWeight(1)
    .padding({
      left: DesignSystem.Spacing.M,
      right: DesignSystem.Spacing.M,
      top: DesignSystem.Spacing.M,
      bottom: DesignSystem.Spacing.XXL
    })
    .scrollBar(BarState.Off)
    .onItemDragStart((event: ItemDragInfo, itemIndex: number) => {
      console.info(`[CityManagementPage] ğŸ¯ å¼€å§‹æ‹–åŠ¨: index=${itemIndex}`);
      this.isDragging = true;
      this.dragIndex = itemIndex;
      return this.buildDragPreview(this.cityWeatherInfos[itemIndex].city);
    })
    .onItemDrop((event: ItemDragInfo, itemIndex: number, insertIndex: number, isSuccess: boolean) => {
      console.info(`[CityManagementPage] ğŸ“ æ‹–åŠ¨ç»“æŸ: from=${itemIndex}, to=${insertIndex}, success=${isSuccess}`);
      if (isSuccess && itemIndex !== insertIndex) {
        this.reorderCities(itemIndex, insertIndex);
      }
      this.isDragging = false;
      this.dragIndex = -1;
    })
  }

  @Builder
  private buildDragPreview(city: City): void {
    Row() {
      Text(this.getCityDisplayName(city))
        .fontSize(18)
        .fontColor('#FFFFFF')
        .fontWeight(DesignSystem.FontWeight.MEDIUM)
    }
    .width(200)
    .height(60)
    .padding(DesignSystem.Spacing.M)
    .backgroundColor('rgba(0, 122, 255, 0.9)')
    .borderRadius(16)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  private buildCityCard(info: CityWeatherInfo, index: number): void {
    Stack() {
      // èƒŒæ™¯è§†é¢‘å±‚ - ä¼˜åŒ–ï¼šé™ä½è§†é¢‘è´¨é‡è®¾ç½®ä»¥æå‡æ€§èƒ½
      Video({ src: $rawfile(info.videoPath) })
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)
        .autoPlay(true)
        .loop(true)
        .muted(true)
        .controls(false)
        .borderRadius(20)

      // é®ç½©å±‚ - ç»Ÿä¸€ä½¿ç”¨æ·±è‰²é®ç½©ï¼Œç¡®ä¿ç™½è‰²æ–‡å­—å¯è¯»
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor(info.isNight ? 'rgba(0, 0, 0, 0.30)' : 'rgba(0, 0, 0, 0.25)')
        .borderRadius(20)

      // å†…å®¹å±‚
      Row() {
        // å·¦ä¾§ï¼šåŸå¸‚ä¿¡æ¯
        Column() {
          Row() {
            Text(this.getCityDisplayName(info.city))
              .fontSize(22)
              .fontColor('#FFFFFF')
              .fontWeight(DesignSystem.FontWeight.SEMIBOLD)
              .textShadow({ radius: 4, color: 'rgba(0,0,0,0.35)', offsetX: 0, offsetY: 1 })

            // å®šä½å›¾æ ‡
            if (info.city.source === CitySource.AUTO) {
              Image(DesignSystem.IconResources.LOCATION_PIN)
                .width(16)
                .height(16)
                .fillColor('#FFFFFF')
                .margin({ left: 6 })
            }
          }

          // æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯
          if (info.snapshot) {
            Text(`${Math.round(info.snapshot.current.temperatureC)}Â° ${info.snapshot.current.condition.description}`)
              .fontSize(14)
              .fontColor('rgba(255, 255, 255, 0.90)')
              .margin({ top: 4 })
              .textShadow({ radius: 3, color: 'rgba(0,0,0,0.25)', offsetX: 0, offsetY: 1 })
          } else {
            Text(this.getCitySubtitle(info.city))
              .fontSize(13)
              .fontColor('rgba(255, 255, 255, 0.80)')
              .margin({ top: 4 })
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        // å³ä¾§ï¼šæ‹–åŠ¨æ‰‹æŸ„
        if (index > 0) {
          Image(DesignSystem.IconResources.REORDER)
            .width(24)
            .height(24)
            .fillColor('rgba(255, 255, 255, 0.70)')
        }
      }
      .width('100%')
      .height('100%')
      .padding({ left: DesignSystem.Spacing.L, right: DesignSystem.Spacing.L })
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .height(100)
    .borderRadius(20)
    .clip(true)
    .shadow({
      radius: 12,
      color: 'rgba(0, 0, 0, 0.15)',
      offsetY: 4,
      offsetX: 0
    })
    .opacity(this.isDragging && this.dragIndex === index ? 0.5 : 1)
    .onClick(() => {
      // ç‚¹å‡»å¡ç‰‡è·³è½¬åˆ°å¯¹åº”åŸå¸‚çš„å¤©æ°”é¡µé¢
      this.navigateToCityWeather(index);
    })
  }

  @Builder
  private buildDeleteButton(city: City, index: number): void {
    if (index === 0) {
      Column()
        .width(0)
        .height(0)
    } else {
      Button() {
        Image(DesignSystem.IconResources.CLOSE)
          .width(24)
          .height(24)
          .fillColor('#FFFFFF')
      }
      .width(70)
      .height(90)
      .backgroundColor('#FF3B30')
      .borderRadius(16)
      .margin({ left: 8 })
      .onClick(() => {
        this.deleteCity(city, index);
      })
    }
  }

  // ========== å¯¼èˆªæ–¹æ³• ==========

  /**
   * ç‚¹å‡»åŸå¸‚å¡ç‰‡ï¼Œè·³è½¬åˆ°ä¸»é¡µå¹¶åˆ‡æ¢åˆ°å¯¹åº”åŸå¸‚
   */
  private navigateToCityWeather(cityIndex: number): void {
    console.info(`[CityManagementPage] ğŸ  ç‚¹å‡»åŸå¸‚å¡ç‰‡ï¼Œè·³è½¬åˆ°åŸå¸‚ç´¢å¼•: ${cityIndex}`);
    
    // è®¾ç½®è¦è·³è½¬çš„åŸå¸‚ç´¢å¼•
    AppStorage.setOrCreate('navigateToCityIndex', cityIndex);
    AppStorage.setOrCreate('needRefreshWeather', true);
    
    // è¿”å›ä¸»é¡µ
    router.back();
  }

  // ========== è¾…åŠ©æ–¹æ³• ==========

  private getVideoPathForCityWeather(city: City, snapshot: WeatherSnapshot | null): string {
    let weatherThemeKey = 'sunny';
    
    if (snapshot && snapshot.current && snapshot.current.condition) {
      weatherThemeKey = snapshot.current.condition.themeKey || 'sunny';
    } else if (city.videoTheme) {
      weatherThemeKey = city.videoTheme;
    }
    
    const isNight = this.isNightTimeForCity(city, snapshot);
    const theme = ThemeConstants.getThemeWithTimeAware(weatherThemeKey, isNight);
    let videoPath = theme.videoResource || 'rawfile/weather/sunny_day.mp4';
    
    if (videoPath.startsWith('rawfile/')) {
      videoPath = videoPath.substring(8);
    }
    
    console.info(`[CityManagementPage] ğŸ¬ åŸå¸‚ ${city.name} è§†é¢‘è·¯å¾„: ${videoPath} (å¤©æ°”: ${weatherThemeKey}, å¤œé—´: ${isNight})`);
    
    return videoPath;
  }

  private isNightTimeForCity(city: City, snapshot: WeatherSnapshot | null): boolean {
    let timezoneOffsetMinutes = 0;
    
    if (city.timeZoneOffsetMinutes !== undefined && city.timeZoneOffsetMinutes !== 0) {
      timezoneOffsetMinutes = city.timeZoneOffsetMinutes;
    } else if (snapshot && snapshot.timezoneOffsetMinutes !== undefined && snapshot.timezoneOffsetMinutes !== 0) {
      timezoneOffsetMinutes = snapshot.timezoneOffsetMinutes;
    } else if (city.coordinates) {
      const lon = city.coordinates.longitude;
      if (lon >= 73 && lon <= 135) {
        timezoneOffsetMinutes = 480;
      } else {
        timezoneOffsetMinutes = Math.round(lon / 15) * 60;
      }
    }
    
    const now = new Date();
    const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
    const cityLocalTime = new Date(utcTime + (timezoneOffsetMinutes * 60000));
    const localHours = cityLocalTime.getHours();
    
    return localHours >= 18 || localHours <= 6;
  }

  /**
   * è·å–æœç´¢ç»“æœçš„æ˜¾ç¤ºåç§°ï¼ˆå¤§å­—éƒ¨åˆ†ï¼‰
   * 
   * @param result æœç´¢ç»“æœ
   * @returns æ˜¾ç¤ºåç§°
   */
  private getSearchResultDisplayName(result: CitySearchResult): string {
    const name = result.name;
    
    // å¦‚æœæ²¡æœ‰é€—å·ï¼Œç›´æ¥è¿”å›
    if (!name.includes(',')) {
      return name;
    }
    
    // åˆ†å‰²åŸå¸‚åç§°ï¼Œåªè¿”å›ç¬¬ä¸€éƒ¨åˆ†
    const parts = name.split(',').map(part => part.trim());
    return parts[0];
  }

  /**
   * è·å–æœç´¢ç»“æœçš„å‰¯æ ‡é¢˜ï¼ˆå°å­—éƒ¨åˆ†ï¼‰
   * 
   * @param result æœç´¢ç»“æœ
   * @returns å‰¯æ ‡é¢˜
   */
  private getSearchResultSubtitle(result: CitySearchResult): string {
    const name = result.name;
    
    // å¦‚æœæ²¡æœ‰é€—å·ï¼Œæ˜¾ç¤ºå›½å®¶
    if (!name.includes(',')) {
      return result.country;
    }
    
    // åˆ†å‰²åŸå¸‚åç§°
    const parts = name.split(',').map(part => part.trim());
    
    // å¦‚æœåªæœ‰2éƒ¨åˆ†
    if (parts.length === 2) {
      // å¦‚æœç¬¬äºŒéƒ¨åˆ†æ˜¯"ä¸­å›½"æˆ–"China"ï¼Œä¸æ˜¾ç¤ºï¼ˆé¿å…å†—ä½™ï¼‰
      if (parts[1] === 'ä¸­å›½' || parts[1] === 'China') {
        return '';
      }
      // å¦åˆ™æ˜¾ç¤ºç¬¬äºŒéƒ¨åˆ†
      return parts[1];
    }
    
    // å¦‚æœæœ‰3éƒ¨åˆ†ï¼ˆå¦‚"è·¯å—åŒº, å”å±±å¸‚, æ²³åŒ—çœ"ï¼‰
    if (parts.length === 3) {
      // å¯¹äºä¸­å›½åŸå¸‚ï¼Œæ˜¾ç¤º"çœ å¸‚"çš„æ ¼å¼
      if (result.country === 'ä¸­å›½' || result.country === 'China') {
        return `${parts[2]} ${parts[1]}`;
      }
      // å¯¹äºå›½é™…åŸå¸‚ï¼Œæ˜¾ç¤º"å·/çœ, å›½å®¶"
      return `${parts[1]}, ${parts[2]}`;
    }
    
    // å¦‚æœæœ‰æ›´å¤šéƒ¨åˆ†ï¼Œæ˜¾ç¤ºåé¢çš„éƒ¨åˆ†
    return parts.slice(1).join(', ');
  }

  /**
   * è·å–åŸå¸‚æ˜¾ç¤ºåç§°ï¼ˆå¤§å­—éƒ¨åˆ†ï¼‰
   * 
   * æ™ºèƒ½å¤„ç†åŸå¸‚åç§°æ˜¾ç¤ºï¼š
   * - å¯¹äºä¸­å›½åŸå¸‚ï¼Œæ˜¾ç¤ºåŸå¸‚åç§°çš„ä¸»è¦éƒ¨åˆ†
   * - å¯¹äºå›½é™…åŸå¸‚ï¼Œæ˜¾ç¤ºåŸå¸‚åç§°
   * 
   * ä¾‹å¦‚ï¼š
   * - "å”å±±, æ²³åŒ—çœ" â†’ "å”å±±"
   * - "è·¯å—åŒº, å”å±±å¸‚, æ²³åŒ—çœ" â†’ "è·¯å—åŒº"
   * - "åŒ—äº¬, ä¸­å›½" â†’ "åŒ—äº¬"
   * 
   * @param city åŸå¸‚å¯¹è±¡
   * @returns åŸå¸‚æ˜¾ç¤ºåç§°
   */
  private getCityDisplayName(city: City): string {
    const name = city.name;
    
    // å¦‚æœæ²¡æœ‰é€—å·ï¼Œç›´æ¥è¿”å›
    if (!name.includes(',')) {
      return name;
    }
    
    // åˆ†å‰²åŸå¸‚åç§°ï¼Œåªè¿”å›ç¬¬ä¸€éƒ¨åˆ†
    const parts = name.split(',').map(part => part.trim());
    return parts[0];
  }

  /**
   * è·å–åŸå¸‚å‰¯æ ‡é¢˜ï¼ˆå°å­—éƒ¨åˆ†ï¼‰
   * 
   * æ˜¾ç¤ºå®Œæ•´çš„è¡Œæ”¿åŒºåˆ’ä¿¡æ¯æˆ–ä½ç½®æ ‡è¯†ï¼š
   * - å®šä½åŸå¸‚ï¼šæ˜¾ç¤º"å½“å‰ä½ç½®"
   * - ä¸­å›½åŸå¸‚ï¼šæ˜¾ç¤º"çœ å¸‚"æ ¼å¼ï¼ˆå¦‚"æ²³åŒ—çœ å”å±±å¸‚"ï¼‰
   * - å›½é™…åŸå¸‚ï¼šæ˜¾ç¤º"å·/çœ, å›½å®¶"
   * 
   * ä¾‹å¦‚ï¼š
   * - GPSå®šä½ â†’ "å½“å‰ä½ç½®"
   * - "å”å±±, æ²³åŒ—çœ" â†’ "æ²³åŒ—çœ"
   * - "è·¯å—åŒº, å”å±±å¸‚, æ²³åŒ—çœ" â†’ "æ²³åŒ—çœ å”å±±å¸‚"
   * - "åŒ—äº¬, ä¸­å›½" â†’ ""ï¼ˆä¸æ˜¾ç¤ºå›½å®¶ï¼‰
   * - "Manhattan, New York, United States" â†’ "New York, United States"
   * 
   * @param city åŸå¸‚å¯¹è±¡
   * @returns åŸå¸‚å‰¯æ ‡é¢˜
   */
  private getCitySubtitle(city: City): string {
    // å®šä½åŸå¸‚æ˜¾ç¤º"å½“å‰ä½ç½®"
    if (city.source === CitySource.AUTO) {
      return 'å½“å‰ä½ç½®';
    }
    
    const name = city.name;
    
    // å¦‚æœæ²¡æœ‰é€—å·ï¼Œå°è¯•æ˜¾ç¤ºå›½å®¶
    if (!name.includes(',')) {
      return city.country || '';
    }
    
    // åˆ†å‰²åŸå¸‚åç§°
    const parts = name.split(',').map(part => part.trim());
    
    // å¦‚æœåªæœ‰2éƒ¨åˆ†
    if (parts.length === 2) {
      // å¦‚æœç¬¬äºŒéƒ¨åˆ†æ˜¯"ä¸­å›½"æˆ–"China"ï¼Œä¸æ˜¾ç¤ºï¼ˆé¿å…å†—ä½™ï¼‰
      if (parts[1] === 'ä¸­å›½' || parts[1] === 'China') {
        return '';
      }
      // å¦åˆ™æ˜¾ç¤ºç¬¬äºŒéƒ¨åˆ†ï¼ˆå¦‚å›½å®¶åï¼‰
      return parts[1];
    }
    
    // å¦‚æœæœ‰3éƒ¨åˆ†ï¼ˆå¦‚"è·¯å—åŒº, å”å±±å¸‚, æ²³åŒ—çœ"ï¼‰
    if (parts.length === 3) {
      // å¯¹äºä¸­å›½åŸå¸‚ï¼Œæ˜¾ç¤º"çœ å¸‚"çš„æ ¼å¼
      if (city.country === 'ä¸­å›½' || city.country === 'China') {
        return `${parts[2]} ${parts[1]}`;
      }
      // å¯¹äºå›½é™…åŸå¸‚ï¼Œæ˜¾ç¤º"å·/çœ, å›½å®¶"
      return `${parts[1]}, ${parts[2]}`;
    }
    
    // å¦‚æœæœ‰æ›´å¤šéƒ¨åˆ†ï¼Œæ˜¾ç¤ºåé¢çš„éƒ¨åˆ†
    return parts.slice(1).join(', ');
  }

  private async reorderCities(fromIndex: number, toIndex: number): Promise<void> {
    console.info(`[CityManagementPage] ğŸ”„ é‡æ–°æ’åºåŸå¸‚: ${fromIndex} -> ${toIndex}`);
    
    if (fromIndex === 0 || toIndex === 0) {
      console.warn('[CityManagementPage] âš ï¸ ä¸å…è®¸ç§»åŠ¨å®šä½åŸå¸‚');
      this.currentError = ErrorHandler.createWarningMessage('å®šä½åŸå¸‚æ— æ³•ç§»åŠ¨');
      return;
    }

    try {
      const newInfos = [...this.cityWeatherInfos];
      const movedInfo = newInfos.splice(fromIndex, 1)[0];
      newInfos.splice(toIndex, 0, movedInfo);
      this.cityWeatherInfos = newInfos;
      
      const newCities = newInfos.map(info => info.city);
      this.cities = newCities;
      await this.cityRepository.updateCities(newCities);
      
      AppStorage.setOrCreate('needRefreshWeather', true);
      AppStorage.setOrCreate('cityOrderChanged', true);
      
      console.info('[CityManagementPage] âœ… åŸå¸‚é¡ºåºå·²æ›´æ–°');
    } catch (error) {
      console.error('[CityManagementPage] âŒ é‡æ–°æ’åºå¤±è´¥:', error);
      this.currentError = ErrorHandler.handle(error as Error, 'æ’åºå¤±è´¥');
      await this.loadCitiesWithWeather();
    }
  }

  // ========== æ•°æ®æ“ä½œæ–¹æ³• ==========

  private async loadCitiesWithWeather(): Promise<void> {
    try {
      console.info('[CityManagementPage] ğŸ”„ å¼€å§‹åŠ è½½åŸå¸‚åˆ—è¡¨å’Œå¤©æ°”æ•°æ®...');
      this.isLoading = true;

      const context = AppContextHolder.getContext();
      if (context) {
        await this.cityRepository.init(context);
        await this.weatherCache.init(context);
      }

      this.cities = await this.cityRepository.getAllCities();
      console.info(`[CityManagementPage] âœ… åŸå¸‚åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…± ${this.cities.length} ä¸ªåŸå¸‚`);

      const infos: CityWeatherInfo[] = [];
      for (const city of this.cities) {
        const snapshot = await this.weatherCache.loadSnapshot(city.id);
        const isNight = this.isNightTimeForCity(city, snapshot);
        const videoPath = this.getVideoPathForCityWeather(city, snapshot);
        const info: CityWeatherInfo = {
          city: city,
          snapshot: snapshot,
          videoPath: videoPath,
          isNight: isNight
        };
        infos.push(info);
        console.info(`[CityManagementPage]   - ${city.name}: ç¼“å­˜=${snapshot ? 'æœ‰' : 'æ— '}, å¤œé—´=${isNight}, è§†é¢‘=${videoPath}`);
      }
      this.cityWeatherInfos = infos;

      this.searchService.setExistingCities(this.cities.map(city => city.id));
    } catch (error) {
      console.error('[CityManagementPage] âŒ åŠ è½½åŸå¸‚å¤±è´¥:', error);
      this.currentError = ErrorHandler.handle(error as Error, 'åŠ è½½åŸå¸‚åˆ—è¡¨å¤±è´¥');
    } finally {
      this.isLoading = false;
    }
  }

  private async addCity(searchResult: CitySearchResult): Promise<void> {
    if (this.isAddingCity) {
      return;
    }

    console.info(`[CityManagementPage] â• å‡†å¤‡æ·»åŠ åŸå¸‚: ${searchResult.name}`);

    try {
      this.isAddingCity = true;
      const city = this.searchService.convertToCity(searchResult);

      await this.cityRepository.addCity(city);
      console.info(`[CityManagementPage] âœ… åŸå¸‚æ·»åŠ æˆåŠŸ: ${city.name}`);

      await this.loadCitiesWithWeather();
      this.isSearchMode = false;
      this.searchText = '';
      this.searchResults = [];

      this.currentError = ErrorHandler.createInfoMessage(`å·²æ·»åŠ  ${city.name}`);

      AppStorage.setOrCreate('needRefreshWeather', true);
      AppStorage.setOrCreate('newAddedCityId', city.id);

      setTimeout(() => {
        router.back();
      }, 300);
    } catch (error) {
      console.error('[CityManagementPage] âŒ æ·»åŠ åŸå¸‚å¤±è´¥:', error);
      this.currentError = ErrorHandler.handle(error as Error, 'æ·»åŠ åŸå¸‚å¤±è´¥');
    } finally {
      this.isAddingCity = false;
    }
  }

  private async deleteCity(city: City, index: number): Promise<void> {
    console.info(`[CityManagementPage] ğŸ—‘ï¸ è¯·æ±‚åˆ é™¤åŸå¸‚: ${city.name}`);

    if (index === 0) {
      this.currentError = ErrorHandler.createWarningMessage('æ— æ³•åˆ é™¤å½“å‰å®šä½åŸå¸‚');
      return;
    }

    try {
      await this.cityRepository.removeCity(city.id);
      console.info(`[CityManagementPage] âœ… åŸå¸‚åˆ é™¤æˆåŠŸ: ${city.name}`);

      await this.loadCitiesWithWeather();
      
      AppStorage.setOrCreate('needRefreshWeather', true);
      
      this.currentError = ErrorHandler.createInfoMessage(`å·²åˆ é™¤ ${city.name}`);
    } catch (error) {
      console.error('[CityManagementPage] âŒ åˆ é™¤åŸå¸‚å¤±è´¥:', error);
      this.currentError = ErrorHandler.handle(error as Error, 'åˆ é™¤åŸå¸‚å¤±è´¥');
    }
  }

  private toggleSearchMode(): void {
    this.isSearchMode = !this.isSearchMode;
    if (!this.isSearchMode) {
      this.searchText = '';
      this.searchResults = [];
    }
    console.info(`[CityManagementPage] ğŸ” åˆ‡æ¢æœç´¢æ¨¡å¼: ${this.isSearchMode ? 'å¼€å¯' : 'å…³é—­'}`);
  }
}

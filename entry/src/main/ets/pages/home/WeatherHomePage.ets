import type common from '@ohos.app.ability.common';
import { CityRepository } from '../../data/repository/CityRepository';
import { WeatherRepository } from '../../data/repository/WeatherRepository';
import { QWeatherService } from '../../data/services/QWeatherService';
import { OpenMeteoService } from '../../data/services/OpenMeteoService';
import { WeatherDataRouter } from '../../data/services/WeatherDataRouter';
import { MockWeatherRepository } from '../../mock/MockWeatherRepository';
import { WeatherController, CityWeatherState } from '../../viewmodel/WeatherController';
import { WeatherSnapshot, City, CitySource, AdviceItem, WeatherAlert } from '../../data/models/WeatherModels';
import { WeatherApiConstants } from '../../common/constants/WeatherApiConstants';
import { AppContextHolder } from '../../common/di/AppContextHolder';
import { AtmosphereBackground } from '../../components/background/AtmosphereBackground';
import { BackgroundMode } from '../../common/constants/ThemeConstants';
import { DebugLogger, LogData } from '../../common/utils/DebugLogger';
import { FeatureChecker, FeatureStatus } from '../../common/utils/FeatureChecker';
import { CityWeatherCard } from '../../components/cards/CityWeatherCard';
import { WeatherDetailGrid } from '../../components/cards/WeatherDetailGrid';
import { DailyForecastCard } from '../../components/cards/DailyForecastCard';
import { AdviceList } from '../../components/cards/AdviceList';
import { FormatHelper } from '../../common/utils/FormatHelper';
import { LocationService } from '../../data/services/LocationService';
import { AppPreferences } from '../../data/storage/AppPreferences';
import { RefreshState } from '../../data/models/WeatherModels';
import { ErrorToast, ErrorMessage, ErrorHandler } from '../../components/common/ErrorToast';
import { ShakeDetector } from '../../common/utils/ShakeDetector';
import { HourlyTrendChart } from '../../components/charts/HourlyTrendChart';
import { WeatherAlertCard } from '../../components/cards/WeatherAlertCard';
import { RainForecastCard } from '../../components/cards/RainForecastCard';
import { PriorityAdviceCard } from '../../components/cards/PriorityAdviceCard';
import { PerformanceOverlay } from '../../components/debug/PerformanceOverlay';
import { ResourceStatusOverlay } from '../../components/debug/ResourceStatusOverlay';
import { DatabaseInspector } from '../../components/debug/DatabaseInspector';
import { ChartPerformanceMonitor } from '../../components/debug/ChartPerformanceMonitor';
import { ThemeDebugPanel } from '../../components/debug/ThemeDebugPanel';
import { ResourceValidator } from '../../components/debug/ResourceValidator';
import { LogViewer } from '../../components/debug/LogViewer';
import { NetworkDiagnosis, DiagnosisResult } from '../../common/utils/NetworkDiagnosis';
import { NetworkDiagnosisDialog } from '../../components/diagnosis/NetworkDiagnosisDialog';
import { ResourceManager } from '../../common/utils/ResourceManager';
import { ThemeConstants } from '../../common/constants/ThemeConstants';
import { ThemeManager } from '../../common/theme/ThemeManager';
import router from '@ohos.router';
import { DesignSystem } from '../../common/theme/DesignSystem';
import { WeatherSkeleton } from '../../components/common/WeatherSkeleton';
import vibrator from '@ohos.vibrator';
import { BackgroundRefreshService } from '../../data/services/BackgroundRefreshService';
import { WidgetDataStorage, WidgetWeatherData } from '../../data/storage/WidgetDataStorage';
import { WidgetHelper } from '../../common/utils/WidgetHelper';
import formProvider from '@ohos.app.form.formProvider';
import formBindingData from '@ohos.app.form.formBindingData';

/**
 * Widgetè¡¨å•æ•°æ®æ¥å£ - ç”¨äºformBindingData.createFormBindingData
 * ä½¿ç”¨æ™®é€šå­—ç¬¦ä¸²æ ¼å¼ï¼ˆå‚è€ƒæ‹¼å›¾æ¸¸æˆæˆåŠŸå®ç°ï¼‰
 */
interface WidgetFormData {
  cityName: string;
  temperature: string;
  condition: string;
  iconCode: string;
  themeKey: string;
  updateTime: string;
  isStale: boolean;
  humidity: string;
  windSpeed: string;
  hourly0Time: string;
  hourly0Temp: string;
  hourly0Icon: string;
  hourly1Time: string;
  hourly1Temp: string;
  hourly1Icon: string;
  hourly2Time: string;
  hourly2Temp: string;
  hourly2Icon: string;
}

/**
 * å¤©æ°”åº”ç”¨ä¸»é¡µç»„ä»¶
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - å±•ç¤ºå¤šåŸå¸‚å¤©æ°”ä¿¡æ¯ï¼Œæ”¯æŒå·¦å³æ»‘åŠ¨åˆ‡æ¢åŸå¸‚
 * - è‡ªåŠ¨å®šä½å½“å‰ä½ç½®å¹¶è·å–å¤©æ°”æ•°æ®
 * - æ”¯æŒä¸‹æ‹‰åˆ·æ–°å’Œæ‘‡ä¸€æ‘‡åˆ·æ–°
 * - åŠ¨æ€ä¸»é¢˜åˆ‡æ¢ï¼ˆæ ¹æ®å¤©æ°”çŠ¶å†µå’Œæ˜¼å¤œæ—¶é—´ï¼‰
 * - åå°è‡ªåŠ¨åˆ·æ–°å¤©æ°”æ•°æ®
 * - æ¡Œé¢å¡ç‰‡æ•°æ®åŒæ­¥
 * 
 * æ€§èƒ½ä¼˜åŒ–ï¼š
 * - ä½¿ç”¨ dataVersion æœºåˆ¶å¼ºåˆ¶è§¦å‘ ForEach é‡æ–°æ¸²æŸ“
 * - ä¸ºæ¯ä¸ªåŸå¸‚ç»´æŠ¤ç‹¬ç«‹çš„ Scroller å®ä¾‹ï¼Œé¿å…æ»šåŠ¨ä½ç½®æ··ä¹±
 * - åå°åˆ·æ–°æœåŠ¡å®šæœŸæ›´æ–°æ•°æ®ï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´
 * 
 * @component
 */
@Component
export struct WeatherHomePage {
  // ==================== ç»„ä»¶å±æ€§ ====================
  // å¤–éƒ¨ä¼ å…¥å±æ€§
  @Prop @Watch('onRefreshTriggerChange') refreshTrigger: number = 0;
  @Prop @Watch('onForceGpsCityIndexChange') forceGpsCityIndex: number = -1;
  
  // ==================== æœåŠ¡å®ä¾‹ ====================
  private preferences: AppPreferences = new AppPreferences();
  private controller: WeatherController = new WeatherController(
    CityRepository.getInstance(),
    new WeatherRepository(
      new WeatherDataRouter(
        new OpenMeteoService(), // Updated to use OpenMeteoService
        new QWeatherService(WeatherApiConstants.QWEATHER_CONFIG)
      ),
      new MockWeatherRepository()
    ),
    LocationService.getInstance(),
    this.preferences
  );
  private shakeDetector: ShakeDetector = ShakeDetector.getInstance();
  private networkDiagnosis: NetworkDiagnosis = NetworkDiagnosis.getInstance();
  private logger: DebugLogger = DebugLogger.getInstance();
  private featureChecker: FeatureChecker = FeatureChecker.getInstance();
  private resourceManager: ResourceManager = ResourceManager.getInstance();
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private backgroundRefreshService: BackgroundRefreshService = BackgroundRefreshService.getInstance();
  
  // ==================== å“åº”å¼çŠ¶æ€ ====================
  // åŸå¸‚å’Œå¤©æ°”æ•°æ®
  @State private cityStates: CityWeatherState[] = [];
  /**
   * æ€§èƒ½ä¼˜åŒ–ï¼šæ•°æ®ç‰ˆæœ¬å·æœºåˆ¶
   * 
   * ä½œç”¨ï¼šå¼ºåˆ¶è§¦å‘ ForEach é‡æ–°æ¸²æŸ“æ‰€æœ‰åŸå¸‚å¡ç‰‡
   * 
   * åŸç†ï¼š
   * - ForEach ä½¿ç”¨ key æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
   * - å½“ dataVersion å˜åŒ–æ—¶ï¼Œæ‰€æœ‰åŸå¸‚çš„ key éƒ½ä¼šå˜åŒ–
   * - è¿™ä¼šå¼ºåˆ¶ ForEach é‡æ–°åˆ›å»ºæ‰€æœ‰å¡ç‰‡ç»„ä»¶
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - å¤©æ°”æ•°æ®åˆ·æ–°å®Œæˆå
   * - åŸå¸‚åˆ—è¡¨é¡ºåºå˜åŒ–å
   * - éœ€è¦ç¡®ä¿ UI å®Œå…¨åŒæ­¥æœ€æ–°æ•°æ®æ—¶
   * 
   * æ€§èƒ½å½±å“ï¼š
   * - ä¼šå¯¼è‡´æ‰€æœ‰å¡ç‰‡é‡æ–°åˆ›å»ºï¼Œæœ‰ä¸€å®šæ€§èƒ½å¼€é”€
   * - ä½†èƒ½ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å… UI æ˜¾ç¤ºæ—§æ•°æ®
   */
  @State private dataVersion: number = 0;
  @State private activeIndex: number = 0;
  
  // UI çŠ¶æ€
  @State private isLoading: boolean = true;
  @State private isRefreshing: boolean = false;
  @State private refreshState: RefreshState = RefreshState.IDLE;
  @State private errorMessage: string = '';
  @State private currentError: ErrorMessage | null = null;
  
  // ä¸»é¢˜å’Œæ˜¾ç¤º
  @StorageProp('themeKey') themeKey: string = 'sunny_day';
  
  // åŠŸèƒ½å¼€å…³
  @State private shakeEnabled: boolean = true;
  @State private showMenu: boolean = false;
  @State private showDiagnosisDialog: boolean = false;
  
  // å…¶ä»–çŠ¶æ€
  @State private scrollToTopTrigger: number = 0;
  @State private diagnosisResult: DiagnosisResult | undefined = undefined;
  
  // ==================== éå“åº”å¼å±æ€§ ====================
  private diagnosisDialogController?: CustomDialogController;
  /**
   * æ€§èƒ½ä¼˜åŒ–ï¼šåŸå¸‚æ»šåŠ¨å™¨å¤ç”¨ç­–ç•¥
   * 
   * ä½œç”¨ï¼šä¸ºæ¯ä¸ªåŸå¸‚ç»´æŠ¤ç‹¬ç«‹çš„ Scroller å®ä¾‹
   * 
   * ä¼˜åŠ¿ï¼š
   * 1. é¿å…æ»šåŠ¨ä½ç½®æ··ä¹±ï¼šåˆ‡æ¢åŸå¸‚æ—¶ï¼Œæ¯ä¸ªåŸå¸‚ä¿æŒè‡ªå·±çš„æ»šåŠ¨ä½ç½®
   * 2. æå‡ç”¨æˆ·ä½“éªŒï¼šè¿”å›ä¹‹å‰æŸ¥çœ‹çš„åŸå¸‚æ—¶ï¼Œæ»šåŠ¨ä½ç½®ä¿æŒä¸å˜
   * 3. å‡å°‘é‡æ–°æ¸²æŸ“ï¼šä¸éœ€è¦æ¯æ¬¡åˆ‡æ¢éƒ½é‡ç½®æ»šåŠ¨ä½ç½®
   * 
   * å®ç°ï¼š
   * - ä½¿ç”¨ Map å­˜å‚¨ï¼Œkey ä¸ºåŸå¸‚ ID
   * - é¦–æ¬¡è®¿é—®åŸå¸‚æ—¶åˆ›å»º Scroller å®ä¾‹
   * - åç»­è®¿é—®å¤ç”¨å·²åˆ›å»ºçš„å®ä¾‹
   * 
   * å†…å­˜å½±å“ï¼š
   * - æ¯ä¸ª Scroller å®ä¾‹å ç”¨å°‘é‡å†…å­˜
   * - å¯¹äºå¸¸è§çš„ 5-10 ä¸ªåŸå¸‚ï¼Œå†…å­˜å¼€é”€å¯å¿½ç•¥
   */
  private cityScrollers: Map<string, Scroller> = new Map();

  // ==================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ====================
  
  /**
   * ç›‘å¬åˆ·æ–°è§¦å‘å™¨å˜åŒ–
   * å½“å¤–éƒ¨ç»„ä»¶ï¼ˆå¦‚åŸå¸‚ç®¡ç†é¡µé¢ï¼‰è§¦å‘åˆ·æ–°æ—¶ï¼Œæ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨
   */
  onRefreshTriggerChange(): void {
    console.info(`[WeatherHomePage] ğŸ”„ refreshTriggerå˜åŒ–: ${this.refreshTrigger}`);
    if (this.refreshTrigger > 0) {
      this.handleExternalRefreshRequest();
    }
  }

  /**
   * ç›‘å¬å¼ºåˆ¶è·³è½¬åˆ°GPSåŸå¸‚çš„ç´¢å¼•å˜åŒ–
   * å¤„ç†ä»Widgetç‚¹å‡»è·³è½¬ï¼Œå¼ºåˆ¶åˆ‡æ¢åˆ°GPSå®šä½åŸå¸‚
   */
  onForceGpsCityIndexChange(): void {
    console.info(`[WeatherHomePage] ğŸ¯ forceGpsCityIndexå˜åŒ–: ${this.forceGpsCityIndex}`);
    if (this.forceGpsCityIndex >= 0 && this.forceGpsCityIndex < this.cityStates.length) {
      console.info(`[WeatherHomePage] ğŸ¯ å¼ºåˆ¶è·³è½¬åˆ°GPSåŸå¸‚ï¼Œç´¢å¼•: ${this.forceGpsCityIndex}`);
      this.activeIndex = this.forceGpsCityIndex;
      // æ›´æ–°ä¸»é¢˜
      this.updateThemeWithStates(this.cityStates, this.forceGpsCityIndex);
    }
  }

  // ==================== æ•°æ®åˆ·æ–°æ–¹æ³• ====================
  
  /**
   * å¤„ç†å¤–éƒ¨åˆ·æ–°è¯·æ±‚
   * 
   * å¤„ç†åœºæ™¯ï¼š
   * 1. ä»åŸå¸‚ç®¡ç†é¡µé¢è¿”å›ååˆ·æ–°
   * 2. ä»Widgetç‚¹å‡»è·³è½¬åˆ°æŒ‡å®šåŸå¸‚
   * 3. åŸå¸‚é¡ºåºå˜åŒ–åé‡æ–°åŠ è½½
   * 4. æ–°æ·»åŠ åŸå¸‚åè·³è½¬å¹¶åˆ·æ–°
   */
  private handleExternalRefreshRequest(): void {
    console.info('[WeatherHomePage] ========== å¤„ç†å¤–éƒ¨åˆ·æ–°è¯·æ±‚ ==========');
    
    // æ£€æŸ¥AppStorageä¸­çš„åˆ·æ–°ä¿¡å·
    const needRefresh = AppStorage.get<boolean>('needRefreshWeather');
    const newCityId = AppStorage.get<string>('newAddedCityId');
    const cityOrderChanged = AppStorage.get<boolean>('cityOrderChanged');
    const navigateToCityIndex = AppStorage.get<number>('navigateToCityIndex');
    
    console.info(`[WeatherHomePage] ğŸ“¦ AppStorageåˆ·æ–°ä¿¡å·: needRefresh=${needRefresh}, newCityId=${newCityId}, cityOrderChanged=${cityOrderChanged}, navigateToCityIndex=${navigateToCityIndex}`);
    
    // ğŸ”§ å…³é”®ä¿®å¤ï¼šå¤„ç†ä»Widgetç‚¹å‡»è·³è½¬çš„æƒ…å†µ
    // å½“forceGpsCityIndex >= 0æ—¶ï¼Œå¼ºåˆ¶è·³è½¬åˆ°GPSåŸå¸‚
    if (this.forceGpsCityIndex >= 0) {
      console.info(`[WeatherHomePage] ğŸ¯ æ£€æµ‹åˆ°Widgetè·³è½¬è¯·æ±‚ï¼Œå¼ºåˆ¶è·³è½¬åˆ°GPSåŸå¸‚ç´¢å¼•: ${this.forceGpsCityIndex}`);
      if (this.cityStates.length > 0 && this.forceGpsCityIndex < this.cityStates.length) {
        this.activeIndex = this.forceGpsCityIndex;
        this.updateThemeWithStates(this.cityStates, this.forceGpsCityIndex);
        console.info(`[WeatherHomePage] âœ… å·²è·³è½¬åˆ°GPSåŸå¸‚: ${this.cityStates[this.forceGpsCityIndex]?.city?.name}`);
      } else {
        console.info(`[WeatherHomePage] âš ï¸ åŸå¸‚åˆ—è¡¨ä¸ºç©ºæˆ–ç´¢å¼•æ— æ•ˆï¼Œè®¾ç½®activeIndexä¸º0`);
        this.activeIndex = 0;
      }
      // ä¸returnï¼Œç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ï¼ˆå¦‚æœæœ‰needRefreshçš„è¯ï¼‰
    }
    
    if (needRefresh) {
      console.info('[WeatherHomePage] ğŸ”„ æ£€æµ‹åˆ°åˆ·æ–°ä¿¡å·ï¼Œå‡†å¤‡åˆ·æ–°...');
      
      // æ¸…é™¤åˆ·æ–°ä¿¡å·
      AppStorage.setOrCreate('needRefreshWeather', false);
      AppStorage.setOrCreate('newAddedCityId', '');
      AppStorage.setOrCreate('cityOrderChanged', false);
      AppStorage.setOrCreate('navigateToCityIndex', -1);
      
      // ğŸ”§ å¤„ç†ä»åŸå¸‚ç®¡ç†é¡µé¢ç‚¹å‡»å¡ç‰‡è·³è½¬çš„æƒ…å†µ
      if (navigateToCityIndex !== undefined && navigateToCityIndex >= 0) {
        console.info(`[WeatherHomePage] ğŸ¯ ä»åŸå¸‚ç®¡ç†é¡µé¢è·³è½¬åˆ°åŸå¸‚ç´¢å¼•: ${navigateToCityIndex}`);
        if (navigateToCityIndex < this.cityStates.length) {
          this.activeIndex = navigateToCityIndex;
          this.updateThemeWithStates(this.cityStates, navigateToCityIndex);
        }
        return;
      }
      
      // ğŸ”§ å…³é”®ï¼šå¦‚æœåŸå¸‚é¡ºåºå˜åŒ–ï¼Œéœ€è¦é‡æ–°ä»å­˜å‚¨åŠ è½½åŸå¸‚åˆ—è¡¨
      if (cityOrderChanged) {
        console.info('[WeatherHomePage] ğŸ”„ æ£€æµ‹åˆ°åŸå¸‚é¡ºåºå˜åŒ–ï¼Œé‡æ–°åŠ è½½åŸå¸‚åˆ—è¡¨...');
        this.reloadCitiesFromStorage();
        return;
      }
      
      // å…ˆé‡æ–°åŠ è½½åŸå¸‚åˆ—è¡¨ï¼ˆåªæœ‰åŸå¸‚ä¿¡æ¯ï¼Œæ²¡æœ‰å¤©æ°”æ•°æ®ï¼‰
      const newCityStates = this.controller.getCityStates();
      console.info(`[WeatherHomePage] ğŸ“Š é‡æ–°åŠ è½½åŸå¸‚åˆ—è¡¨ï¼Œå…± ${newCityStates.length} ä¸ªåŸå¸‚`);
      newCityStates.forEach((state, index) => {
        console.info(`[WeatherHomePage]   ${index + 1}. ${state.city.name} (${state.city.id}), hasSnapshot: ${!!state.snapshot}`);
      });
      this.cityStates = newCityStates;
      this.dataVersion++; // å¢åŠ ç‰ˆæœ¬å·ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“
      
      // å¦‚æœæœ‰æ–°æ·»åŠ çš„åŸå¸‚IDï¼Œè·³è½¬åˆ°è¯¥åŸå¸‚
      let targetIndex = -1;
      if (newCityId && newCityId !== '') {
        console.info(`[WeatherHomePage] ğŸ¯ å‡†å¤‡è·³è½¬åˆ°æ–°æ·»åŠ çš„åŸå¸‚: ${newCityId}`);
        
        // æŸ¥æ‰¾åŸå¸‚ç´¢å¼•
        const cityIndex = this.cityStates.findIndex(state => state.city.id === newCityId);
        console.info(`[WeatherHomePage] ğŸ” æŸ¥æ‰¾åŸå¸‚ç´¢å¼•ç»“æœ: ${cityIndex}`);
        
        if (cityIndex >= 0) {
          targetIndex = cityIndex;
          this.activeIndex = cityIndex;
          console.info(`[WeatherHomePage] âœ… å·²è®¾ç½®æ´»åŠ¨ç´¢å¼•ä¸º: ${cityIndex}`);
        } else {
          console.warn(`[WeatherHomePage] âš ï¸ æœªæ‰¾åˆ°åŸå¸‚ID: ${newCityId}ï¼Œä½¿ç”¨æœ€åä¸€ä¸ªåŸå¸‚`);
          // æ–°æ·»åŠ çš„åŸå¸‚é€šå¸¸åœ¨åˆ—è¡¨æœ«å°¾
          if (this.cityStates.length > 0) {
            targetIndex = this.cityStates.length - 1;
            this.activeIndex = this.cityStates.length - 1;
            console.info(`[WeatherHomePage] âœ… å·²è®¾ç½®æ´»åŠ¨ç´¢å¼•ä¸ºæœ€åä¸€ä¸ª: ${this.activeIndex}`);
          }
        }
      }
      
      // å¼ºåˆ¶é‡ç½®åˆ·æ–°çŠ¶æ€ï¼Œç„¶ååˆ·æ–°å¤©æ°”æ•°æ®
      console.info('[WeatherHomePage] ğŸ”„ å¼ºåˆ¶é‡ç½®åˆ·æ–°çŠ¶æ€å¹¶å¼€å§‹åˆ·æ–°å¤©æ°”æ•°æ®...');
      this.isRefreshing = false;
      
      // å¼‚æ­¥åˆ·æ–°å¤©æ°”æ•°æ®ï¼Œåˆ·æ–°å®Œæˆåå†æ¬¡è®¾ç½®activeIndexç¡®ä¿è·³è½¬æ­£ç¡®
      this.refreshAndJumpToCity(targetIndex);
    }
  }

  /**
   * ä»å­˜å‚¨é‡æ–°åŠ è½½åŸå¸‚åˆ—è¡¨
   * 
   * ä½¿ç”¨åœºæ™¯ï¼šåŸå¸‚é¡ºåºåœ¨åŸå¸‚ç®¡ç†é¡µé¢è¢«ä¿®æ”¹åï¼Œéœ€è¦é‡æ–°åŠ è½½ä»¥åæ˜ æœ€æ–°é¡ºåº
   * 
   * æ­¥éª¤ï¼š
   * 1. é‡æ–°åˆå§‹åŒ–æ§åˆ¶å™¨ä»¥åŠ è½½æœ€æ–°çš„åŸå¸‚é¡ºåº
   * 2. è·å–æ–°çš„åŸå¸‚çŠ¶æ€åˆ—è¡¨
   * 3. æ›´æ–° UI å¹¶åˆ·æ–°å¤©æ°”æ•°æ®
   * 4. ä¿æŒå½“å‰ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
   */
  private async reloadCitiesFromStorage(): Promise<void> {
    console.info('[WeatherHomePage] ğŸ”„ ä»å­˜å‚¨é‡æ–°åŠ è½½åŸå¸‚åˆ—è¡¨...');
    try {
      // é‡æ–°åˆå§‹åŒ–æ§åˆ¶å™¨ä»¥åŠ è½½æœ€æ–°çš„åŸå¸‚é¡ºåº
      const context = AppContextHolder.getContext();
      if (context) {
        await this.controller.init(context);
      }
      
      // è·å–æ–°çš„åŸå¸‚çŠ¶æ€
      const newCityStates = this.controller.getCityStates();
      console.info(`[WeatherHomePage] ğŸ“Š é‡æ–°åŠ è½½ååŸå¸‚æ•°é‡: ${newCityStates.length}`);
      newCityStates.forEach((state, index) => {
        console.info(`[WeatherHomePage]   ${index + 1}. ${state.city.name}`);
      });
      
      this.cityStates = newCityStates;
      this.dataVersion++;
      
      // ä¿æŒå½“å‰ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
      if (this.activeIndex >= this.cityStates.length) {
        this.activeIndex = Math.max(0, this.cityStates.length - 1);
      }
      
      // åˆ·æ–°å¤©æ°”æ•°æ®
      await this.refresh(true);
      
      console.info('[WeatherHomePage] âœ… åŸå¸‚åˆ—è¡¨é‡æ–°åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('[WeatherHomePage] âŒ é‡æ–°åŠ è½½åŸå¸‚åˆ—è¡¨å¤±è´¥:', error);
    }
  }

  /**
   * åˆ·æ–°å¤©æ°”æ•°æ®å¹¶è·³è½¬åˆ°æŒ‡å®šåŸå¸‚
   * 
   * @param targetIndex ç›®æ ‡åŸå¸‚çš„ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºä¸è·³è½¬
   */
  private async refreshAndJumpToCity(targetIndex: number): Promise<void> {
    console.info(`[WeatherHomePage] ğŸ”„ å¼€å§‹åˆ·æ–°å¹¶è·³è½¬åˆ°åŸå¸‚ç´¢å¼•: ${targetIndex}`);
    
    try {
      await this.refresh(true);
      
      // åˆ·æ–°å®Œæˆåï¼Œç¡®ä¿è·³è½¬åˆ°ç›®æ ‡åŸå¸‚
      if (targetIndex >= 0 && targetIndex < this.cityStates.length) {
        console.info(`[WeatherHomePage] âœ… åˆ·æ–°å®Œæˆï¼Œç¡®è®¤è·³è½¬åˆ°åŸå¸‚ç´¢å¼•: ${targetIndex}`);
        this.activeIndex = targetIndex;
        
        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç›´æ¥ä¼ å‚çš„æ–¹å¼æ›´æ–°ä¸»é¢˜
        this.updateThemeWithStates(this.cityStates, targetIndex);
      }
    } catch (error) {
      console.error('[WeatherHomePage] âŒ åˆ·æ–°å¹¶è·³è½¬å¤±è´¥:', error);
    }
  }

  /**
   * ç»„ä»¶å³å°†å‡ºç°ç”Ÿå‘½å‘¨æœŸå›è°ƒ
   * 
   * æ‰§è¡Œæ“ä½œï¼š
   * 1. æ‰§è¡ŒåŠŸèƒ½æ£€æŸ¥ï¼ˆæ£€æµ‹è®¾å¤‡æ”¯æŒçš„åŠŸèƒ½ï¼‰
   * 2. è·å–åº”ç”¨ä¸Šä¸‹æ–‡
   * 3. å¯åŠ¨åº”ç”¨åˆå§‹åŒ–æµç¨‹
   * 4. åˆå§‹åŒ–æ‘‡ä¸€æ‘‡æ£€æµ‹
   */
  aboutToAppear(): void {
    const lifecycleData: LogData = {
      'cityStatesLength': this.cityStates.length,
      'isLoading': this.isLoading,
      'hasError': !!this.currentError
    };
    this.logger.lifecycle('WeatherHomePage', '========== é¡µé¢ç”Ÿå‘½å‘¨æœŸ: aboutToAppear ==========', lifecycleData);
    
    // æ‰§è¡ŒåŠŸèƒ½æ£€æŸ¥
    this.performFeatureCheck();
    
    const context: common.UIAbilityContext | null = AppContextHolder.getContext();
    if (context !== null) {
      this.logger.info('WeatherHomePage', 'âœ… Contextè·å–æˆåŠŸï¼Œå¼€å§‹å¯åŠ¨åº”ç”¨');
      this.bootstrap(context);
      this.initializeShakeDetection();
    } else {
      this.logger.error('WeatherHomePage', 'âŒ Contextè·å–å¤±è´¥ï¼Œæ— æ³•å¯åŠ¨');
      this.errorMessage = 'æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡';
      this.isLoading = false;
    }
  }

  /**
   * ç»„ä»¶å³å°†æ¶ˆå¤±ç”Ÿå‘½å‘¨æœŸå›è°ƒ
   * 
   * æ¸…ç†æ“ä½œï¼š
   * 1. åœæ­¢æ‘‡ä¸€æ‘‡æ£€æµ‹ï¼Œé‡Šæ”¾ä¼ æ„Ÿå™¨èµ„æº
   * 2. åœæ­¢åå°è‡ªåŠ¨åˆ·æ–°æœåŠ¡ï¼Œé¿å…å†…å­˜æ³„æ¼
   */
  aboutToDisappear(): void {
    this.logger.lifecycle('WeatherHomePage', '========== é¡µé¢ç”Ÿå‘½å‘¨æœŸ: aboutToDisappear ==========');
    // åœæ­¢æ‘‡ä¸€æ‘‡æ£€æµ‹
    this.shakeDetector.stopDetection(() => this.handleShakeRefresh());
    // åœæ­¢åå°åˆ·æ–°
    this.backgroundRefreshService.stopAutoRefresh();
  }

  /**
   * åº”ç”¨å¯åŠ¨åˆå§‹åŒ–æµç¨‹
   * 
   * åˆå§‹åŒ–æ­¥éª¤ï¼š
   * 1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
   * 2. åˆå§‹åŒ–èµ„æºç®¡ç†å™¨ï¼ˆåŠ è½½å›¾ç‰‡ã€è§†é¢‘ç­‰èµ„æºï¼‰
   * 3. åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨ï¼ˆè®¾ç½®é»˜è®¤ä¸»é¢˜ï¼‰
   * 4. åˆå§‹åŒ–æ§åˆ¶å™¨ï¼ˆåŒ…å«è‡ªåŠ¨å®šä½åŠŸèƒ½ï¼‰
   * 5. åŠ è½½èƒŒæ™¯æ¨¡å¼è®¾ç½®
   * 6. é¦–æ¬¡åŠ è½½å¤©æ°”æ•°æ®
   * 7. å¯åŠ¨åå°è‡ªåŠ¨åˆ·æ–°æœåŠ¡
   * 
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œç”¨äºè®¿é—®ç³»ç»ŸæœåŠ¡å’Œèµ„æº
   */
  private async bootstrap(context: common.UIAbilityContext): Promise<void> {
    try {
      console.info('[WeatherHomePage] ========== å¼€å§‹åº”ç”¨åˆå§‹åŒ–æµç¨‹ ==========');
      const startTime = Date.now();
      console.info(`[WeatherHomePage] ğŸ—ï¸ åº”ç”¨ä¸Šä¸‹æ–‡çŠ¶æ€: ${context ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}`);
      
      // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
      try {
        console.info('[WeatherHomePage] ğŸŒ æ£€æŸ¥ç½‘ç»œè¿é€šæ€§...');
        const testUrl = 'https://www.baidu.com';
        // å®é™…ç½‘ç»œæ£€æŸ¥é€»è¾‘...
      } catch (networkError) {
        console.warn('[WeatherHomePage] âŒ ç½‘ç»œè¿é€šæ€§æ£€æŸ¥å¤±è´¥:', networkError);
      }
      
      // åˆå§‹åŒ–èµ„æºç®¡ç†å™¨
      console.info('[WeatherHomePage] ğŸ¨ åˆå§‹åŒ–èµ„æºç®¡ç†å™¨...');
      await this.resourceManager.init(context);
      
      // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
      console.info('[WeatherHomePage] ğŸŒ™ åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨...');
      await this.themeManager.init();
      
      // åˆå§‹åŒ–æ§åˆ¶å™¨ï¼ˆåŒ…å«è‡ªåŠ¨å®šä½ï¼‰
      console.info('[WeatherHomePage] ğŸ® åˆå§‹åŒ–æ§åˆ¶å™¨...');
      await this.controller.init(context);
      
      // ğŸ”§ ä¿®å¤ï¼šä»æ§åˆ¶å™¨åŠ è½½åˆå§‹åŸå¸‚çŠ¶æ€
      const initialStates = this.controller.getCityStates();
      console.info(`[WeatherHomePage] ğŸ“Š åˆå§‹åŒ–ååŸå¸‚æ•°é‡: ${initialStates.length}`);
      initialStates.forEach((state, index) => {
        console.info(`[WeatherHomePage]   ${index + 1}. ${state.city.name} (${state.city.source})`);
      });
      
      // ğŸ”§ å…³é”®ä¿®å¤ï¼šåœ¨è°ƒç”¨refreshä¹‹å‰å…ˆèµ‹å€¼ç»™cityStates
      this.cityStates = initialStates;
      
      // è·å–èƒŒæ™¯æ¨¡å¼è®¾ç½®
      console.info('[WeatherHomePage] âš™ï¸ åŠ è½½èƒŒæ™¯æ¨¡å¼è®¾ç½®...');
      const backgroundMode: string = await this.preferences.getBackgroundMode();
      AppStorage.setOrCreate('backgroundMode', backgroundMode);
      console.info(`[WeatherHomePage] ğŸ¨ å½“å‰èƒŒæ™¯æ¨¡å¼: ${backgroundMode}`);
      
      // åŠ è½½å¤©æ°”æ•°æ®
      console.info('[WeatherHomePage] ğŸŒ¤ï¸ å¼€å§‹é¦–æ¬¡åŠ è½½å¤©æ°”æ•°æ®...');
      await this.refresh(false);
      
      /**
       * æ€§èƒ½ä¼˜åŒ–ï¼šåå°è‡ªåŠ¨åˆ·æ–°ç­–ç•¥
       * 
       * ä½œç”¨ï¼šå®šæœŸåœ¨åå°è‡ªåŠ¨åˆ·æ–°å¤©æ°”æ•°æ®ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
       * 
       * åˆ·æ–°ç­–ç•¥ï¼š
       * - åˆ·æ–°é—´éš”ï¼š30 åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
       * - é™é»˜åˆ·æ–°ï¼šä¸æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œä¸æ‰“æ–­ç”¨æˆ·æ“ä½œ
       * - æ™ºèƒ½æ›´æ–°ï¼šåªåœ¨æ•°æ®å˜åŒ–æ—¶æ›´æ–° UI
       * 
       * ä¼˜åŠ¿ï¼š
       * 1. æ•°æ®æ—¶æ•ˆæ€§ï¼šç¡®ä¿ç”¨æˆ·çœ‹åˆ°çš„å¤©æ°”æ•°æ®å§‹ç»ˆæ˜¯æœ€æ–°çš„
       * 2. ç”¨æˆ·ä½“éªŒï¼šæ— æ„ŸçŸ¥æ›´æ–°ï¼Œä¸æ‰“æ–­ç”¨æˆ·æµè§ˆ
       * 3. æ¡Œé¢å¡ç‰‡åŒæ­¥ï¼šè‡ªåŠ¨æ›´æ–°æ¡Œé¢å¡ç‰‡æ•°æ®
       * 
       * èµ„æºç®¡ç†ï¼š
       * - é¡µé¢æ¶ˆå¤±æ—¶è‡ªåŠ¨åœæ­¢åˆ·æ–°ï¼Œé¿å…å†…å­˜æ³„æ¼
       * - ä½¿ç”¨èŠ‚æµæœºåˆ¶ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
       */
      console.info('[WeatherHomePage] ğŸ”„ å¯åŠ¨åå°è‡ªåŠ¨åˆ·æ–°æœåŠ¡...');
      this.backgroundRefreshService.setController(this.controller, async (states) => {
        console.info('[WeatherHomePage] ğŸ”„ åå°åˆ·æ–°å®Œæˆï¼Œæ›´æ–°UI');
        const validStates = states.filter(state => state && state.city && state.city.id);
        this.cityStates = validStates;
        this.dataVersion++; // å¢åŠ ç‰ˆæœ¬å·ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“
        // ä¿®å¤ï¼šä½¿ç”¨ç›´æ¥ä¼ å‚çš„æ–¹å¼æ›´æ–°ä¸»é¢˜
        this.updateThemeWithStates(validStates, this.activeIndex);
        // ä¿å­˜å¤©æ°”æ•°æ®åˆ°Widgetå­˜å‚¨ï¼Œä¾›æ¡Œé¢å¡ç‰‡ä½¿ç”¨
        await this.saveWidgetData(validStates);
      });
      this.backgroundRefreshService.startAutoRefresh();
      
      console.info(`[WeatherHomePage] âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œæ€»è€—æ—¶: ${Date.now() - startTime}ms`);
    } catch (error) {
      console.error('[WeatherHomePage] âŒ Bootstrapåˆå§‹åŒ–å¤±è´¥:', error);
      this.currentError = ErrorHandler.handle(error as Error, 'åº”ç”¨åˆå§‹åŒ–å¤±è´¥');
      this.errorMessage = `åˆå§‹åŒ–å¤±è´¥: ${(error as Error).message}`;
      this.isLoading = false;
    }
  }

  /**
   * åˆ·æ–°å¤©æ°”æ•°æ®
   * 
   * åˆ·æ–°æµç¨‹ï¼š
   * 1. æ£€æŸ¥å¹¶é‡ç½®åˆ·æ–°çŠ¶æ€ï¼ˆé˜²æ­¢å¡æ­»ï¼‰
   * 2. è°ƒç”¨æ§åˆ¶å™¨åŠ è½½æ‰€æœ‰åŸå¸‚çš„å¤©æ°”æ•°æ®
   * 3. è¿‡æ»¤æ— æ•ˆçŠ¶æ€
   * 4. æ›´æ–° UI çŠ¶æ€å¹¶è§¦å‘é‡æ–°æ¸²æŸ“
   * 5. æ›´æ–°ä¸»é¢˜ï¼ˆæ ¹æ®å½“å‰åŸå¸‚å¤©æ°”ï¼‰
   * 6. ä¿å­˜æ•°æ®åˆ° Widget å­˜å‚¨
   * 
   * æ€§èƒ½ä¼˜åŒ–ï¼š
   * - ä½¿ç”¨ Promise.race æ·»åŠ  20 ç§’è¶…æ—¶ä¿æŠ¤
   * - å¢åŠ  dataVersion å¼ºåˆ¶è§¦å‘ ForEach é‡æ–°æ¸²æŸ“
   * 
   * @param force æ˜¯å¦å¼ºåˆ¶åˆ·æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
   */
  private async refresh(force: boolean): Promise<void> {
    console.info(`[WeatherHomePage] ========== refreshæ–¹æ³•è¢«è°ƒç”¨ ==========`);
    console.info(`[WeatherHomePage] ğŸ“Š å½“å‰isRefreshingçŠ¶æ€: ${this.isRefreshing}`);
    
    // å¦‚æœå·²ç»åœ¨åˆ·æ–°ä¸­ï¼Œå¼ºåˆ¶é‡ç½®çŠ¶æ€ï¼ˆé˜²æ­¢å¡æ­»ï¼‰
    if (this.isRefreshing) {
      console.warn(`[WeatherHomePage] âš ï¸ æ£€æµ‹åˆ°åˆ·æ–°çŠ¶æ€å¡ä½ï¼Œå¼ºåˆ¶é‡ç½®`);
      this.isRefreshing = false;
    }
    
    console.info(`[WeatherHomePage] ========== å¼€å§‹åˆ·æ–°å¤©æ°”æ•°æ® ==========`);
    console.info(`[WeatherHomePage] ğŸ”„ å¼ºåˆ¶åˆ·æ–°: ${force}`);
    console.info(`[WeatherHomePage] ğŸ“Š å½“å‰åŸå¸‚æ•°é‡: ${this.cityStates.length}`);
    console.info(`[WeatherHomePage] â° åˆ·æ–°å¼€å§‹æ—¶é—´: ${new Date().toISOString()}`);
    const startTime = Date.now();
    
    // æ˜¾ç¤ºå½“å‰åŸå¸‚çŠ¶æ€
    this.cityStates.forEach((state, index) => {
      console.debug(`[WeatherHomePage]   ${index + 1}. ${state.city.name} (ID: ${state.city.id})`);
    });
    
    this.isRefreshing = true;
    this.refreshState = RefreshState.REFRESHING;
    let refreshSucceeded: boolean = false;
    
    try {
      console.info('[WeatherHomePage] ğŸ“¡ è°ƒç”¨æ§åˆ¶å™¨åŠ è½½æ•°æ®...');
      const loadStartTime = Date.now();
      
      // ä½¿ç”¨Promise.raceæ·»åŠ è¶…æ—¶ä¿æŠ¤
      const loadPromise = this.controller.loadAll(force);
      const timeoutPromise = new Promise<CityWeatherState[]>((_, reject) => {
        setTimeout(() => {
          reject(new Error('å¤©æ°”æ•°æ®åŠ è½½è¶…æ—¶ï¼ˆ20ç§’ï¼‰'));
        }, 20000);
      });
      
      const states: CityWeatherState[] = await Promise.race([loadPromise, timeoutPromise]);
      
      console.info(`[WeatherHomePage] âœ… æ§åˆ¶å™¨è¿”å›æ•°æ®ï¼Œè€—æ—¶: ${Date.now() - loadStartTime}ms`);
      console.info(`[WeatherHomePage] âœ… æ•°æ®åŠ è½½å®Œæˆï¼Œå…± ${states.length} ä¸ªåŸå¸‚çŠ¶æ€`);
      
      // è¯¦ç»†è¾“å‡ºæ¯ä¸ªåŸå¸‚çš„å¤©æ°”æ•°æ®çŠ¶æ€
      states.forEach((state, index) => {
        const hasSnapshot = !!state.snapshot;
        const temp = hasSnapshot ? state.snapshot!.current.temperatureC : '--';
        const condition = hasSnapshot ? state.snapshot!.current.condition.description : 'æ— æ•°æ®';
        console.info(`[WeatherHomePage]   ${index + 1}. ${state.city.name}: ${temp}Â°C, ${condition}, hasSnapshot=${hasSnapshot}`);
      });
      
      // è¿‡æ»¤æ‰æ— æ•ˆçš„çŠ¶æ€
      const validStates = states.filter(state => state && state.city && state.city.id);
      console.info(`[WeatherHomePage] ğŸ§¹ è¿‡æ»¤åæœ‰æ•ˆçŠ¶æ€: ${validStates.length}`);
      
      // ğŸ”§ å…³é”®ä¿®å¤ï¼šå…ˆæ›´æ–°cityStatesï¼Œç„¶åå¢åŠ dataVersionè§¦å‘é‡æ–°æ¸²æŸ“
      this.cityStates = validStates;
      this.dataVersion++; // å¢åŠ ç‰ˆæœ¬å·ï¼Œå¼ºåˆ¶ForEaché‡æ–°æ¸²æŸ“æ‰€æœ‰å¡ç‰‡
      console.info(`[WeatherHomePage] âœ… cityStateså·²æ›´æ–°ï¼Œæ–°é•¿åº¦: ${this.cityStates.length}, dataVersion: ${this.dataVersion}`);
      
      // éªŒè¯èµ‹å€¼æ˜¯å¦æˆåŠŸ
      if (this.cityStates.length > 0) {
        const firstCity = this.cityStates[0];
        console.info(`[WeatherHomePage] ğŸ“Š éªŒè¯: ç¬¬ä¸€ä¸ªåŸå¸‚=${firstCity?.city?.name}, hasSnapshot=${!!firstCity?.snapshot}`);
      }
      
      this.errorMessage = '';
      
      // åªæœ‰å½“activeIndexè¶…å‡ºèŒƒå›´æ—¶æ‰é‡ç½®ï¼Œé¿å…è¦†ç›–ç”¨æˆ·è®¾ç½®çš„è·³è½¬ç›®æ ‡
      if (this.activeIndex >= validStates.length) {
        console.info(`[WeatherHomePage] ğŸ”„ æ´»åŠ¨ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œé‡ç½®: ${this.activeIndex} -> 0`);
        this.activeIndex = 0;
      } else {
        console.info(`[WeatherHomePage] ğŸ“Š ä¿æŒå½“å‰æ´»åŠ¨ç´¢å¼•: ${this.activeIndex}`);
      }
      
      // ğŸ”§ å…³é”®ä¿®å¤ï¼šåœ¨tryå—å†…ç«‹å³æ›´æ–°ä¸»é¢˜ï¼Œç¡®ä¿cityStateså·²ç»èµ‹å€¼
      console.info(`[WeatherHomePage] ğŸ¨ ç«‹å³æ›´æ–°ä¸»é¢˜ï¼ˆåœ¨tryå—å†…ï¼‰`);
      this.updateThemeWithStates(validStates, this.activeIndex);
      
      // ğŸ”§ ä¿å­˜å¤©æ°”æ•°æ®åˆ°Widgetå­˜å‚¨ï¼Œä¾›æ¡Œé¢å¡ç‰‡ä½¿ç”¨
      // Requirements: 3.1, 6.1
      await this.saveWidgetData(validStates);
      
      console.info(`[WeatherHomePage] âœ… åˆ·æ–°æµç¨‹æˆåŠŸå®Œæˆï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
      refreshSucceeded = true;
    } catch (error) {
      console.error('[WeatherHomePage] âŒ åˆ·æ–°å¤±è´¥:', error);
      console.error('[WeatherHomePage] âŒ é”™è¯¯è¯¦æƒ…:', (error as Error).message);
      this.currentError = ErrorHandler.createNetworkError('å¤©æ°”æ•°æ®åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      // ä¸è®¾ç½®errorMessageï¼Œé¿å…æ˜¾ç¤ºé”™è¯¯é¡µé¢
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
      this.refreshState = refreshSucceeded ? RefreshState.IDLE : RefreshState.ERROR;
      
      console.info(`[WeatherHomePage] ğŸ“Š åˆ·æ–°ç»“æŸï¼ŒisRefreshingå·²é‡ç½®ä¸º: ${this.isRefreshing}`);
      
      // æ³¨æ„ï¼šä¸»é¢˜æ›´æ–°å·²åœ¨tryå—ä¸­å®Œæˆï¼Œè¿™é‡Œä¸å†é‡å¤è°ƒç”¨
      // åªæœ‰åœ¨å¤±è´¥æ—¶æ‰ä½¿ç”¨é»˜è®¤ä¸»é¢˜
      if (!refreshSucceeded) {
        console.info(`[WeatherHomePage] âš ï¸ åˆ·æ–°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä¸»é¢˜`);
        this.updateTheme();
      }
      
      console.info(`[WeatherHomePage] âœ… åˆ·æ–°å®Œæˆï¼Œæ€»è€—æ—¶: ${Date.now() - startTime}ms`);
      console.info(`[WeatherHomePage] â° åˆ·æ–°ç»“æŸæ—¶é—´: ${new Date().toISOString()}`);
      console.info(`[WeatherHomePage] ğŸ“Š æœ€ç»ˆçŠ¶æ€: isRefreshing=${this.isRefreshing}, refreshState=${this.refreshState}`);
    }
  }

  /**
   * å¤„ç†ä¸‹æ‹‰åˆ·æ–°äº‹ä»¶
   * å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰åŸå¸‚çš„å¤©æ°”æ•°æ®
   */
  private async handleRefresh(): Promise<void> {
    await this.refresh(true);
  }

  // ==================== æ¡Œé¢å¡ç‰‡æ•°æ®åŒæ­¥æ–¹æ³• ====================
  
  /**
   * ä¿å­˜å¤©æ°”æ•°æ®åˆ°æ¡Œé¢å¡ç‰‡å­˜å‚¨
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å°†å¤©æ°”å¿«ç…§æ•°æ®è½¬æ¢ä¸ºæ¡Œé¢å¡ç‰‡æ•°æ®æ ¼å¼
   * - æŒä¹…åŒ–åˆ° Preferences å­˜å‚¨
   * - ä¸»åŠ¨æ›´æ–°æ‰€æœ‰å·²æ³¨å†Œçš„æ¡Œé¢å¡ç‰‡
   * 
   * æ•°æ®é€‰æ‹©ç­–ç•¥ï¼š
   * 1. ä¼˜å…ˆä½¿ç”¨ GPS å®šä½åŸå¸‚ï¼ˆsource ä¸º AUTOï¼‰çš„æ•°æ®
   * 2. å¦‚æœæ²¡æœ‰ GPS åŸå¸‚ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•°æ®çš„åŸå¸‚
   * 
   * @param states åŸå¸‚å¤©æ°”çŠ¶æ€æ•°ç»„
   */
  private async saveWidgetData(states: CityWeatherState[]): Promise<void> {
    try {
      if (states.length === 0) {
        console.info('[WeatherHomePage] âš ï¸ No city states available for widget, skipping save');
        return;
      }
      
      // ğŸ”§ å…³é”®ä¿®å¤ï¼šå§‹ç»ˆä½¿ç”¨GPSå®šä½åŸå¸‚ï¼ˆAUTO sourceï¼‰çš„æ•°æ®
      // GPSå®šä½åŸå¸‚é€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªåŸå¸‚ï¼Œæˆ–è€…æŸ¥æ‰¾sourceä¸ºAUTOçš„åŸå¸‚
      let gpsState: CityWeatherState | null = null;
      
      // é¦–å…ˆæŸ¥æ‰¾AUTOç±»å‹çš„åŸå¸‚ï¼ˆGPSå®šä½ï¼‰
      for (const state of states) {
        if (state.city.source === CitySource.AUTO && state.snapshot) {
          gpsState = state;
          console.info(`[WeatherHomePage] ğŸ“ Found GPS city: ${state.city.name}`);
          break;
        }
      }
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°AUTOåŸå¸‚ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•°æ®çš„åŸå¸‚
      if (!gpsState) {
        for (const state of states) {
          if (state.snapshot) {
            gpsState = state;
            console.info(`[WeatherHomePage] ğŸ“ Using first available city: ${state.city.name}`);
            break;
          }
        }
      }
      
      if (!gpsState || !gpsState.snapshot) {
        console.info('[WeatherHomePage] âš ï¸ No weather data available for widget, skipping save');
        return;
      }
      
      console.info(`[WeatherHomePage] ğŸ’¾ Saving widget data for GPS city: ${gpsState.city.name}`);
      console.info(`[WeatherHomePage] ğŸ“Š Snapshot data - humidity: ${gpsState.snapshot.current.humidity}, windSpeed: ${gpsState.snapshot.current.windSpeedKph}`);
      console.info(`[WeatherHomePage] ğŸ“Š Hourly forecast count: ${gpsState.snapshot.hourly?.length ?? 0}`);
      
      // Convert WeatherSnapshot to WidgetWeatherData using WidgetHelper
      const widgetData = WidgetHelper.convertToWidgetData(
        gpsState.snapshot,
        gpsState.city.name
      );
      
      console.info(`[WeatherHomePage] ğŸ“Š Widget data - humidity: ${widgetData.humidity}, windSpeed: ${widgetData.windSpeed}, hourly: ${widgetData.hourlyForecast.length}`);
      
      // Get application context
      const context = AppContextHolder.getContext();
      if (!context) {
        console.error('[WeatherHomePage] âŒ No context available for widget data save');
        return;
      }
      
      // Save to widget storage
      await WidgetDataStorage.saveForWidget(context, widgetData);
      
      console.info(`[WeatherHomePage] âœ… Widget data saved successfully for GPS city: ${gpsState.city.name}`);
      
      // ğŸ”§ å…³é”®ä¿®å¤ï¼šä¿å­˜æ•°æ®åä¸»åŠ¨æ›´æ–°æ‰€æœ‰Widget
      // è¿™è§£å†³äº†Widgetæ˜¾ç¤º"--"çš„é—®é¢˜ï¼Œå› ä¸ºä¹‹å‰åªä¿å­˜æ•°æ®ä½†æ²¡æœ‰é€šçŸ¥Widgetæ›´æ–°
      await this.updateAllWidgets(context, widgetData);
      
    } catch (error) {
      console.error('[WeatherHomePage] âŒ Failed to save widget data:', error);
      // Don't throw - widget data save failure shouldn't affect main app
    }
  }

  /**
   * ä¸»åŠ¨æ›´æ–°æ‰€æœ‰å·²æ³¨å†Œçš„æ¡Œé¢å¡ç‰‡
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ä»å­˜å‚¨ä¸­è·å–æ‰€æœ‰å·²æ³¨å†Œçš„å¡ç‰‡ ID
   * - æ„å»ºå¡ç‰‡æ•°æ®å¹¶è°ƒç”¨ç³»ç»Ÿ API æ›´æ–°æ¯ä¸ªå¡ç‰‡
   * - è‡ªåŠ¨æ¸…ç†å·²åˆ é™¤çš„æ— æ•ˆå¡ç‰‡
   * 
   * è§£å†³é—®é¢˜ï¼šç¡®ä¿æ¡Œé¢å¡ç‰‡åŠæ—¶æ˜¾ç¤ºæœ€æ–°å¤©æ°”æ•°æ®ï¼Œé¿å…æ˜¾ç¤º"--"å ä½ç¬¦
   * 
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡
   * @param widgetData è¦æ›´æ–°åˆ°å¡ç‰‡çš„å¤©æ°”æ•°æ®
   */
  private async updateAllWidgets(context: common.UIAbilityContext, widgetData: WidgetWeatherData): Promise<void> {
    try {
      // ä»å­˜å‚¨ä¸­è·å–æ‰€æœ‰å·²æ³¨å†Œçš„Widget Form ID
      const formIds = await WidgetDataStorage.loadFormIds(context);
      
      if (formIds.length === 0) {
        console.info('[WeatherHomePage] âš ï¸ No registered widgets to update');
        return;
      }
      
      console.info(`[WeatherHomePage] ğŸ”„ Updating ${formIds.length} widgets...`);
      
      // æ„å»ºFormBindingDataå¯¹è±¡ - ä½¿ç”¨WidgetFormDataæ¥å£
      const widgetFormData = this.buildWidgetFormData(widgetData);
      
      const formData = formBindingData.createFormBindingData(widgetFormData);
      
      // æ›´æ–°æ¯ä¸ªWidget
      for (const formId of formIds) {
        try {
          await formProvider.updateForm(formId, formData);
          console.info(`[WeatherHomePage] âœ… Widget ${formId} updated successfully`);
        } catch (updateError) {
          console.error(`[WeatherHomePage] âŒ Failed to update widget ${formId}:`, updateError);
          // å¦‚æœWidgetå·²è¢«åˆ é™¤ï¼Œä»å­˜å‚¨ä¸­ç§»é™¤
          const errorStr = String(updateError);
          if (errorStr.includes('not exist') || errorStr.includes('invalid')) {
            await WidgetDataStorage.removeFormId(context, formId);
            console.info(`[WeatherHomePage] ğŸ—‘ï¸ Removed invalid widget ${formId} from storage`);
          }
        }
      }
      
      console.info('[WeatherHomePage] âœ… All widgets update completed');
    } catch (error) {
      console.error('[WeatherHomePage] âŒ Failed to update widgets:', error);
    }
  }

  /**
   * æ„å»ºæ¡Œé¢å¡ç‰‡è¡¨å•æ•°æ®å¯¹è±¡
   * 
   * æ•°æ®æ ¼å¼ï¼šä½¿ç”¨æ™®é€šå­—ç¬¦ä¸²æ ¼å¼ï¼ˆå‚è€ƒæ‹¼å›¾æ¸¸æˆæˆåŠŸå®ç°ï¼‰
   * 
   * è½¬æ¢è§„åˆ™ï¼š
   * - æ¸©åº¦ï¼šæ·»åŠ  "Â°" ç¬¦å·
   * - æ¹¿åº¦ï¼šæ·»åŠ  "%" ç¬¦å·
   * - é£é€Ÿï¼šæ·»åŠ  " km/h" å•ä½
   * - æ—¶é—´ï¼šæ ¼å¼åŒ–ä¸º "HH:mm"
   * 
   * @param widgetData å¤©æ°”æ•°æ®
   * @returns å¡ç‰‡è¡¨å•æ•°æ®å¯¹è±¡
   */
  private buildWidgetFormData(widgetData: WidgetWeatherData): WidgetFormData {
    const formData: WidgetFormData = {
      cityName: widgetData.cityName,
      temperature: `${widgetData.temperature}Â°`,
      condition: widgetData.condition,
      iconCode: widgetData.iconCode,
      themeKey: widgetData.themeKey,
      updateTime: widgetData.updateTime,
      isStale: false,
      humidity: `${widgetData.humidity}%`,
      windSpeed: `${widgetData.windSpeed} km/h`,
      hourly0Time: widgetData.hourlyForecast.length > 0 ? widgetData.hourlyForecast[0].time : '--:--',
      hourly0Temp: widgetData.hourlyForecast.length > 0 ? `${widgetData.hourlyForecast[0].temperature}Â°` : '--Â°',
      hourly0Icon: widgetData.hourlyForecast.length > 0 ? widgetData.hourlyForecast[0].iconCode : 'sun',
      hourly1Time: widgetData.hourlyForecast.length > 1 ? widgetData.hourlyForecast[1].time : '--:--',
      hourly1Temp: widgetData.hourlyForecast.length > 1 ? `${widgetData.hourlyForecast[1].temperature}Â°` : '--Â°',
      hourly1Icon: widgetData.hourlyForecast.length > 1 ? widgetData.hourlyForecast[1].iconCode : 'sun',
      hourly2Time: widgetData.hourlyForecast.length > 2 ? widgetData.hourlyForecast[2].time : '--:--',
      hourly2Temp: widgetData.hourlyForecast.length > 2 ? `${widgetData.hourlyForecast[2].temperature}Â°` : '--Â°',
      hourly2Icon: widgetData.hourlyForecast.length > 2 ? widgetData.hourlyForecast[2].iconCode : 'sun'
    };
    return formData;
  }

  // ==================== äº¤äº’åŠŸèƒ½æ–¹æ³• ====================
  
  /**
   * åˆå§‹åŒ–æ‘‡ä¸€æ‘‡æ£€æµ‹åŠŸèƒ½
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¯åŠ¨åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨ç›‘å¬
   * - æ£€æµ‹è®¾å¤‡æ‘‡åŠ¨æ‰‹åŠ¿
   * - è§¦å‘å¤©æ°”æ•°æ®åˆ·æ–°
   * 
   * å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼ˆè®¾å¤‡ä¸æ”¯æŒæˆ–æƒé™ä¸è¶³ï¼‰ï¼Œè‡ªåŠ¨ç¦ç”¨è¯¥åŠŸèƒ½
   */
  private initializeShakeDetection(): void {
    if (this.shakeEnabled) {
      const success = this.shakeDetector.startDetection(() => this.handleShakeRefresh());
      if (!success) {
        console.warn('[WeatherHomePage] Failed to initialize shake detection');
        this.shakeEnabled = false;
      }
    }
  }

  /**
   * å¤„ç†æ‘‡ä¸€æ‘‡åˆ·æ–°äº‹ä»¶
   * 
   * é˜²æŠ–å¤„ç†ï¼šå¦‚æœæ­£åœ¨åˆ·æ–°æˆ–åŠ è½½ä¸­ï¼Œå¿½ç•¥æœ¬æ¬¡æ‘‡åŠ¨
   * ç”¨æˆ·åé¦ˆï¼šå¯é€‰æ·»åŠ éœ‡åŠ¨åé¦ˆï¼ˆéœ€è¦éœ‡åŠ¨æƒé™ï¼‰
   */
  private async handleShakeRefresh(): Promise<void> {
    if (this.isRefreshing || this.isLoading) {
      console.debug('[WeatherHomePage] ğŸ“³ æ‘‡ä¸€æ‘‡è§¦å‘ï¼Œä½†æ­£åœ¨åˆ·æ–°ä¸­ï¼Œå¿½ç•¥');
      return;
    }
    
    console.info('[WeatherHomePage] ğŸ“³ æ‘‡ä¸€æ‘‡è§¦å‘åˆ·æ–°ï¼');
    
    // å¯é€‰ï¼šæ·»åŠ éœ‡åŠ¨åé¦ˆ
    try {
      // æ³¨æ„ï¼šéœ€è¦æ·»åŠ éœ‡åŠ¨æƒé™æ‰èƒ½ä½¿ç”¨
      // vibrator.startVibration({ type: 'time', duration: 200 });
      console.debug('[WeatherHomePage] ğŸ“³ è§¦å‘éœ‡åŠ¨åé¦ˆ');
    } catch (error) {
      // å¿½ç•¥éœ‡åŠ¨é”™è¯¯
    }
    
    await this.refresh(true);
  }

  // ==================== çŠ¶æ€è®¡ç®—å’Œå·¥å…·æ–¹æ³• ====================
  
  /**
   * è·å–å½“å‰æ´»åŠ¨åŸå¸‚çš„å¤©æ°”çŠ¶æ€
   * 
   * å®‰å…¨å¤„ç†ï¼š
   * - å¦‚æœåŸå¸‚åˆ—è¡¨ä¸ºç©ºï¼Œè¿”å› null
   * - å¦‚æœç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œä½¿ç”¨æœ€åä¸€ä¸ªåŸå¸‚
   * - éªŒè¯è¿”å›çš„çŠ¶æ€æ˜¯å¦æœ‰æ•ˆï¼ˆåŒ…å«åŸå¸‚ä¿¡æ¯å’Œ IDï¼‰
   * 
   * @returns å½“å‰åŸå¸‚çš„å¤©æ°”çŠ¶æ€ï¼Œå¦‚æœæ— æ•ˆåˆ™è¿”å› null
   */
  private get currentState(): CityWeatherState | null {
    console.debug(`[WeatherHomePage] currentState getter: cityStates.length=${this.cityStates.length}, activeIndex=${this.activeIndex}`);
    
    if (this.cityStates.length === 0) {
      console.debug(`[WeatherHomePage] currentState: åŸå¸‚åˆ—è¡¨ä¸ºç©ºï¼Œè¿”å›null`);
      return null;
    }
    const safeIndex: number = Math.min(this.activeIndex, this.cityStates.length - 1);
    const state = this.cityStates[safeIndex];
    
    console.debug(`[WeatherHomePage] currentState: safeIndex=${safeIndex}, stateå­˜åœ¨=${!!state}, cityå­˜åœ¨=${!!(state?.city)}, id=${state?.city?.id}`);
    
    // ç¡®ä¿è¿”å›çš„çŠ¶æ€æ˜¯æœ‰æ•ˆçš„
    if (state && state.city && state.city.id) {
      console.debug(`[WeatherHomePage] currentState: è¿”å›æœ‰æ•ˆçŠ¶æ€ ${state.city.name}, hasSnapshot=${!!state.snapshot}`);
      return state;
    }
    console.debug(`[WeatherHomePage] currentState: çŠ¶æ€æ— æ•ˆï¼Œè¿”å›null`);
    return null;
  }

  /**
   * æ›´æ–°åº”ç”¨ä¸»é¢˜
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ ¹æ®å½“å‰åŸå¸‚çš„å¤©æ°”çŠ¶å†µè§£æä¸»é¢˜
   * - è€ƒè™‘æ˜¼å¤œæ—¶é—´ï¼ˆç™½å¤©/å¤œé—´ï¼‰
   * - æ›´æ–°å…¨å±€ä¸»é¢˜çŠ¶æ€åˆ° AppStorage
   * 
   * å¼ºåˆ¶æ›´æ–°ï¼šå³ä½¿ä¸»é¢˜ç›¸åŒä¹Ÿä¼šæ›´æ–°ï¼Œç¡®ä¿èƒŒæ™¯è§†é¢‘æ­£ç¡®åˆ‡æ¢
   */
  private updateTheme(): void {
    console.info(`[WeatherHomePage] ğŸ¨ updateThemeè¢«è°ƒç”¨ï¼Œå½“å‰activeIndex: ${this.activeIndex}`);
    
    const newThemeKey = this.resolveThemeKey();
    console.info(`[WeatherHomePage] ğŸ¨ è§£æå‡ºçš„æ–°ä¸»é¢˜: ${newThemeKey}, å½“å‰ä¸»é¢˜: ${this.themeKey}`);
    
    // å¼ºåˆ¶æ›´æ–°ä¸»é¢˜ï¼ˆå³ä½¿ç›¸åŒä¹Ÿæ›´æ–°ï¼Œç¡®ä¿èƒŒæ™¯è§†é¢‘åˆ‡æ¢ï¼‰
    console.info(`[WeatherHomePage] ğŸ¨ æ›´æ–°AppStorageä¸»é¢˜: ${newThemeKey}`);
    AppStorage.setOrCreate('themeKey', newThemeKey);
  }

  /**
   * ç”ŸæˆåŸå¸‚å¡ç‰‡çš„å”¯ä¸€æ ‡è¯†ç¬¦
   * 
   * æ€§èƒ½ä¼˜åŒ–ï¼šåŒ…å«æ•°æ®ç‰ˆæœ¬å·ä»¥è§¦å‘ ForEach é‡æ–°æ¸²æŸ“
   * 
   * Key ç»„æˆï¼š
   * - åŸå¸‚ ID
   * - æ•°æ®ç‰ˆæœ¬å·ï¼ˆdataVersion å˜åŒ–æ—¶å¼ºåˆ¶é‡æ–°æ¸²æŸ“æ‰€æœ‰å¡ç‰‡ï¼‰
   * - å¤©æ°”å¿«ç…§æ ‡è¯†ï¼ˆæ¸©åº¦æˆ–æ— æ•°æ®æ ‡è®°ï¼‰
   * 
   * @param state åŸå¸‚å¤©æ°”çŠ¶æ€
   * @returns å”¯ä¸€æ ‡è¯†ç¬¦å­—ç¬¦ä¸²
   */
  private generateCityKey(state: CityWeatherState): string {
    if (!state || !state.city || !state.city.id) {
      return `city_${this.dataVersion}_${Math.random()}`;
    }
    // ä½¿ç”¨åŸå¸‚ID + æ•°æ®ç‰ˆæœ¬å· + snapshotå­˜åœ¨æ ‡è¯†ä½œä¸ºkey
    // å½“dataVersionå˜åŒ–æ—¶ï¼Œæ‰€æœ‰å¡ç‰‡éƒ½ä¼šé‡æ–°æ¸²æŸ“
    const snapshotKey = state.snapshot 
      ? `_v${this.dataVersion}_${Math.round(state.snapshot.current.temperatureC)}`
      : `_v${this.dataVersion}_nodata`;
    return `${state.city.id}${snapshotKey}`;
  }

  /**
   * ä½¿ç”¨æŒ‡å®šçš„åŸå¸‚çŠ¶æ€æ•°ç»„æ›´æ–°ä¸»é¢˜
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„çŠ¶æ€æ•°ç»„ï¼Œé¿å…å“åº”å¼å»¶è¿Ÿé—®é¢˜
   * - æ ¹æ®æŒ‡å®šç´¢å¼•çš„åŸå¸‚å¤©æ°”çŠ¶å†µå’Œæ˜¼å¤œæ—¶é—´æ›´æ–°ä¸»é¢˜
   * - åŒæ—¶è®¾ç½®å¤œé—´æ¨¡å¼æ ‡å¿—ä¾›å…¶ä»–ç»„ä»¶ä½¿ç”¨
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - æ•°æ®åˆ·æ–°å®Œæˆåç«‹å³æ›´æ–°ä¸»é¢˜
   * - åŸå¸‚åˆ‡æ¢æ—¶æ›´æ–°ä¸»é¢˜
   * 
   * @param states åŸå¸‚å¤©æ°”çŠ¶æ€æ•°ç»„
   * @param index è¦ä½¿ç”¨çš„åŸå¸‚ç´¢å¼•
   */
  private updateThemeWithStates(states: CityWeatherState[], index: number): void {
    console.info(`[WeatherHomePage] ğŸ¨ updateThemeWithStates: states.length=${states.length}, index=${index}`);
    
    // è·å–å½“å‰åŸå¸‚çŠ¶æ€ï¼Œç”¨äºåˆ¤æ–­å½“åœ°æ—¶é—´
    const currentCityState = (states.length > 0 && index >= 0 && index < states.length) ? states[index] : undefined;
    const isNight = this.isNightTime(currentCityState);
    console.info(`[WeatherHomePage] ğŸŒ™ åŸå¸‚å½“åœ°æ˜¯å¦å¤œé—´: ${isNight}`);
    
    if (states.length === 0 || index < 0 || index >= states.length) {
      console.info(`[WeatherHomePage] âš ï¸ æ— æœ‰æ•ˆçŠ¶æ€ï¼Œä½¿ç”¨é»˜è®¤ä¸»é¢˜sunny`);
      const defaultTheme = ThemeConstants.getThemeWithTimeAware('sunny', isNight).themeKey;
      AppStorage.setOrCreate('themeKey', defaultTheme);
      return;
    }
    
    const state = states[index];
    console.info(`[WeatherHomePage] ğŸ“Š å½“å‰åŸå¸‚çŠ¶æ€: ${state?.city?.name}, hasSnapshot=${!!state?.snapshot}`);
    
    if (!state || !state.snapshot) {
      console.info(`[WeatherHomePage] âš ï¸ åŸå¸‚æ— å¤©æ°”æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤ä¸»é¢˜sunny`);
      const defaultTheme = ThemeConstants.getThemeWithTimeAware('sunny', isNight).themeKey;
      AppStorage.setOrCreate('themeKey', defaultTheme);
      return;
    }
    
    const condition = state.snapshot.current.condition;
    console.info(`[WeatherHomePage] ğŸŒ¤ï¸ å½“å‰åŸå¸‚: ${state.city.name}, å¤©æ°”æ¡ä»¶themeKey: ${condition.themeKey}`);
    
    const newThemeKey = ThemeConstants.getThemeWithTimeAware(condition.themeKey, isNight).themeKey;
    console.info(`[WeatherHomePage] ğŸ¨ æœ€ç»ˆä¸»é¢˜: ${newThemeKey}`);
    
    AppStorage.setOrCreate('themeKey', newThemeKey);
    // ğŸ”§ åŒæ—¶è®¾ç½®å¤œé—´æ¨¡å¼æ ‡å¿—ï¼Œä¾›å¡ç‰‡ç»„ä»¶ä½¿ç”¨
    AppStorage.setOrCreate('isNightMode', isNight);
    console.info(`[WeatherHomePage] ğŸŒ™ è®¾ç½®isNightMode: ${isNight}`);
  }

  /**
   * è§£æå½“å‰åŸå¸‚çš„ä¸»é¢˜æ ‡è¯†ç¬¦
   * 
   * è§£æé€»è¾‘ï¼š
   * 1. è·å–å½“å‰æ´»åŠ¨åŸå¸‚çš„å¤©æ°”çŠ¶æ€
   * 2. åˆ¤æ–­åŸå¸‚å½“åœ°æ˜¯å¦ä¸ºå¤œé—´
   * 3. æ ¹æ®å¤©æ°”çŠ¶å†µå’Œæ˜¼å¤œæ—¶é—´è¿”å›å¯¹åº”ä¸»é¢˜
   * 4. å¦‚æœæ— å¤©æ°”æ•°æ®ï¼Œè¿”å›é»˜è®¤ä¸»é¢˜ï¼ˆsunnyï¼‰
   * 
   * @returns ä¸»é¢˜æ ‡è¯†ç¬¦ï¼ˆå¦‚ "sunny_day", "rainy_night"ï¼‰
   */
  private resolveThemeKey(): string {
    const currentState = this.currentState;
    console.info(`[WeatherHomePage] ğŸ“Š currentStateå­˜åœ¨: ${!!currentState}`);
    
    const isNight = this.isNightTime(currentState);
    console.info(`[WeatherHomePage] ğŸŒ™ åŸå¸‚å½“åœ°æ˜¯å¦å¤œé—´: ${isNight}`);
    
    if (!currentState || !currentState.snapshot) {
      console.info(`[WeatherHomePage] âš ï¸ æ— å¤©æ°”æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤ä¸»é¢˜sunny`);
      return ThemeConstants.getThemeWithTimeAware('sunny', isNight).themeKey;
    }

    const condition = currentState.snapshot.current.condition;
    console.info(`[WeatherHomePage] ğŸŒ¤ï¸ å½“å‰åŸå¸‚: ${currentState.city.name}, å¤©æ°”æ¡ä»¶themeKey: ${condition.themeKey}`);
    
    const result = ThemeConstants.getThemeWithTimeAware(condition.themeKey, isNight).themeKey;
    console.info(`[WeatherHomePage] ğŸ¨ æœ€ç»ˆä¸»é¢˜: ${result}`);
    return result;
  }

  /**
   * åˆ¤æ–­æŒ‡å®šåŸå¸‚æ˜¯å¦ä¸ºå¤œé—´
   * 
   * æ—¶åŒºå¤„ç†ä¼˜å…ˆçº§ï¼š
   * 1. ä¼˜å…ˆä½¿ç”¨ city.timeZoneOffsetMinutesï¼ˆæ›´å¯é ï¼‰
   * 2. å…¶æ¬¡ä½¿ç”¨ snapshot.timezoneOffsetMinutes
   * 3. æœ€åæ ¹æ®ç»åº¦ä¼°ç®—æ—¶åŒºï¼ˆä¸­å›½å¤§é™†ç»Ÿä¸€ä½¿ç”¨ UTC+8ï¼‰
   * 
   * å¤œé—´åˆ¤å®šï¼š18:00 - 06:00 ä¸ºå¤œé—´ï¼Œ07:00 - 17:59 ä¸ºç™½å¤©
   * 
   * @param cityState åŸå¸‚å¤©æ°”çŠ¶æ€ï¼ŒåŒ…å«æ—¶åŒºä¿¡æ¯
   * @returns true=å¤œé—´(18:00-06:00), false=ç™½å¤©(07:00-17:59)
   */
  private isNightTime(cityState?: CityWeatherState | null): boolean {
    // è·å–æ—¶åŒºåç§»é‡ï¼ˆåˆ†é’Ÿï¼‰
    let timezoneOffsetMinutes = 0;
    
    if (cityState) {
      console.debug(`[WeatherHomePage] ğŸ” è°ƒè¯•æ—¶åŒºæ•°æ®:`);
      console.debug(`  - cityStateå­˜åœ¨: ${!!cityState}`);
      console.debug(`  - snapshotå­˜åœ¨: ${!!cityState.snapshot}`);
      console.debug(`  - snapshot.timezoneOffsetMinutes: ${cityState.snapshot?.timezoneOffsetMinutes}`);
      console.debug(`  - cityå­˜åœ¨: ${!!cityState.city}`);
      console.debug(`  - city.timeZoneOffsetMinutes: ${cityState.city?.timeZoneOffsetMinutes}`);
      console.debug(`  - city.name: ${cityState.city?.name}`);
      
      // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ city ä¸­çš„æ—¶åŒºï¼ˆæ›´å¯é ï¼‰ï¼Œå› ä¸º snapshot çš„æ—¶åŒºå¯èƒ½ä¸º0
      // åªæœ‰å½“ city æ—¶åŒºä¸º0æˆ–æœªå®šä¹‰æ—¶ï¼Œæ‰ä½¿ç”¨ snapshot çš„æ—¶åŒº
      if (cityState.city && cityState.city.timeZoneOffsetMinutes !== undefined && cityState.city.timeZoneOffsetMinutes !== 0) {
        timezoneOffsetMinutes = cityState.city.timeZoneOffsetMinutes;
        console.debug(`  âœ… ä½¿ç”¨cityæ—¶åŒº: ${timezoneOffsetMinutes}åˆ†é’Ÿ`);
      } 
      // å…¶æ¬¡ä½¿ç”¨ snapshot ä¸­çš„æ—¶åŒºï¼ˆå¦‚æœé0ï¼‰
      else if (cityState.snapshot && cityState.snapshot.timezoneOffsetMinutes !== undefined && cityState.snapshot.timezoneOffsetMinutes !== 0) {
        timezoneOffsetMinutes = cityState.snapshot.timezoneOffsetMinutes;
        console.debug(`  âœ… ä½¿ç”¨snapshotæ—¶åŒº: ${timezoneOffsetMinutes}åˆ†é’Ÿ`);
      } 
      // æœ€åæ ¹æ®ç»åº¦ä¼°ç®—æ—¶åŒº
      else if (cityState.city && cityState.city.coordinates) {
        const lon = cityState.city.coordinates.longitude;
        // ä¸­å›½å¤§é™†èŒƒå›´ç»Ÿä¸€ä½¿ç”¨UTC+8
        if (lon >= 73 && lon <= 135) {
          timezoneOffsetMinutes = 480;
        } else {
          timezoneOffsetMinutes = Math.round(lon / 15) * 60;
        }
        console.debug(`  âœ… æ ¹æ®ç»åº¦ä¼°ç®—æ—¶åŒº: ${timezoneOffsetMinutes}åˆ†é’Ÿ`);
      } else {
        console.warn(`  âš ï¸ æœªæ‰¾åˆ°æ—¶åŒºæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼0`);
      }
    }
    
    // è·å–åŸå¸‚å½“åœ°æ—¶é—´
    const localHours = this.getCityLocalHours(timezoneOffsetMinutes);
    
    console.info(`[WeatherHomePage] ğŸ• æ—¶åŒºåç§»: ${timezoneOffsetMinutes}åˆ†é’Ÿ, å½“åœ°æ—¶é—´: ${localHours}:00`);
    
    // å¤œé—´åˆ¤å®šï¼š18:00 - 06:00
    return localHours >= 18 || localHours <= 6;
  }

  /**
   * è·å–åŸå¸‚å½“åœ°æ—¶é—´çš„å°æ—¶æ•°
   * 
   * è®¡ç®—æ­¥éª¤ï¼š
   * 1. è·å–å½“å‰ UTC æ—¶é—´æˆ³
   * 2. åŠ ä¸ŠåŸå¸‚æ—¶åŒºåç§»é‡
   * 3. è¿”å›å½“åœ°æ—¶é—´çš„å°æ—¶æ•°
   * 
   * @param timezoneOffsetMinutes åŸå¸‚æ—¶åŒºåç§»é‡ï¼ˆåˆ†é’Ÿï¼‰ï¼Œç›¸å¯¹äº UTC
   * @returns åŸå¸‚å½“åœ°æ—¶é—´çš„å°æ—¶æ•° (0-23)
   */
  private getCityLocalHours(timezoneOffsetMinutes: number): number {
    const now = new Date();
    
    // è·å–UTCæ—¶é—´æˆ³
    const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
    
    // åŠ ä¸ŠåŸå¸‚æ—¶åŒºåç§»ï¼Œå¾—åˆ°åŸå¸‚å½“åœ°æ—¶é—´
    const cityLocalTime = new Date(utcTime + (timezoneOffsetMinutes * 60000));
    
    return cityLocalTime.getHours();
  }

  // ==================== è¯Šæ–­å’Œè°ƒè¯•æ–¹æ³• ====================
  
  /**
   * æ‰§è¡Œè®¾å¤‡åŠŸèƒ½æ£€æŸ¥
   * 
   * æ£€æŸ¥é¡¹ç›®ï¼š
   * - å®šä½æœåŠ¡æ˜¯å¦å¯ç”¨
   * - ä¼ æ„Ÿå™¨ï¼ˆåŠ é€Ÿåº¦è®¡ï¼‰æ˜¯å¦å¯ç”¨
   * - ç½‘ç»œè¿æ¥æ˜¯å¦å¯ç”¨
   * - å…¶ä»–ç³»ç»ŸåŠŸèƒ½
   * 
   * æ£€æŸ¥ç»“æœä¼šè®°å½•åˆ°æ—¥å¿—ç³»ç»Ÿï¼Œç”¨äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥
   */
  private performFeatureCheck(): void {
    this.logger.info('WeatherHomePage', 'ğŸ” å¼€å§‹æ‰§è¡ŒåŠŸèƒ½æ£€æŸ¥');
    
    const features: FeatureStatus[] = this.featureChecker.checkAllFeatures();
    
    features.forEach((feature: FeatureStatus) => {
      const featureData: LogData = {
        'reason': feature.reason,
        'enabled': feature.enabled
      };
      this.logger.checkFeature('WeatherHomePage', feature.name, feature.enabled, featureData);
    });
    
    const enabledCount = features.filter(f => f.enabled).length;
    const totalCount = features.length;
    
    const enabledFeatureNames = features.filter(f => f.enabled).map(f => f.name).join(', ');
    const disabledFeatureNames = features.filter(f => !f.enabled).map(f => f.name).join(', ');
    
    const summaryData: LogData = {
      'enabledFeatures': enabledFeatureNames,
      'disabledFeatures': disabledFeatureNames,
      'enabledCount': enabledCount,
      'totalCount': totalCount
    };
    
    this.logger.info('WeatherHomePage', `ğŸ“Š åŠŸèƒ½æ£€æŸ¥å®Œæˆ: ${enabledCount}/${totalCount} ä¸ªåŠŸèƒ½å¯ç”¨`, summaryData);
  }

  // ==================== UI æ¸²æŸ“æ–¹æ³• (@Builder) ====================
  
  /**
   * æ¸²æŸ“èƒŒæ™¯æ¨¡å¼åˆ‡æ¢æŒ‰é’®ï¼ˆè°ƒè¯•ç”¨ï¼‰
   * 
   * æä¾›ä¸‰ç§èƒŒæ™¯æ¨¡å¼ï¼š
   * - è§†é¢‘èƒŒæ™¯ï¼šæ’­æ”¾å¤©æ°”ç›¸å…³çš„è§†é¢‘
   * - åŠ¨ç”»èƒŒæ™¯ï¼šæ˜¾ç¤º Lottie åŠ¨ç”»
   * - æ¸å˜èƒŒæ™¯ï¼šæ˜¾ç¤ºçº¯è‰²æ¸å˜
   */
  @Builder
  private renderBackgroundModeSwitch(): void {
    Row() {
      Button('è§†é¢‘èƒŒæ™¯')
        .onClick(() => {
          AppStorage.setOrCreate('backgroundMode', BackgroundMode.VIDEO);
          console.info('[WeatherHomePage] ğŸ¬ åˆ‡æ¢åˆ°è§†é¢‘èƒŒæ™¯æ¨¡å¼');
        })
        .fontSize(12)
        .height(32)
        .backgroundColor('rgba(76, 175, 80, 0.8)')
        .margin({ right: 8 });
      
      Button('åŠ¨ç”»èƒŒæ™¯')
        .onClick(() => {
          AppStorage.setOrCreate('backgroundMode', BackgroundMode.ANIMATED_IMAGE);
          console.info('[WeatherHomePage] ğŸï¸ åˆ‡æ¢åˆ°åŠ¨ç”»èƒŒæ™¯æ¨¡å¼');
        })
        .fontSize(12)
        .height(32)
        .backgroundColor('rgba(33, 150, 243, 0.8)')
        .margin({ right: 8 });
      
      Button('æ¸å˜èƒŒæ™¯')
        .onClick(() => {
          AppStorage.setOrCreate('backgroundMode', BackgroundMode.GRADIENT);
          console.info('[WeatherHomePage] ğŸŒˆ åˆ‡æ¢åˆ°æ¸å˜èƒŒæ™¯æ¨¡å¼');
        })
        .fontSize(12)
        .height(32)
        .backgroundColor('rgba(156, 39, 176, 0.8)');
    }
    .position({ x: 16, y: 100 })
    .zIndex(1000);
  }

  /**
   * æ„å»ºä¸»é¡µé¢ UI
   * 
   * å±‚æ¬¡ç»“æ„ï¼ˆä»åº•åˆ°é¡¶ï¼‰ï¼š
   * 1. åº•å±‚ï¼šåŠ¨æ€èƒŒæ™¯ï¼ˆè§†é¢‘/åŠ¨ç”»/æ¸å˜ï¼‰
   * 2. é®ç½©å±‚ï¼šæŸ”å’Œæ¸å˜é®ç½©ï¼Œæå‡æ–‡å­—å¯è¯»æ€§
   * 3. å†…å®¹å±‚ï¼šå¤©æ°”ä¿¡æ¯å±•ç¤º
   * 4. é¡¶å±‚ï¼šé”™è¯¯æç¤º Toast
   * 
   * çŠ¶æ€å¤„ç†ï¼š
   * - åŠ è½½ä¸­ï¼šæ˜¾ç¤ºéª¨æ¶å±
   * - é”™è¯¯ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å’Œé‡è¯•æŒ‰é’®
   * - æ­£å¸¸ï¼šæ˜¾ç¤ºå¤©æ°”å†…å®¹
   */
  build() {
    Stack() {
      // 1. åº•å±‚ï¼šèƒŒæ™¯è§†é¢‘
      AtmosphereBackground()

      // 2. é®ç½©å±‚ï¼šå•ä¸€å…¨å±æŸ”å’Œæ¸å˜ï¼ˆå¤šæ®µå¹³æ»‘è¿‡æ¸¡ï¼Œå½»åº•æ¶ˆé™¤35%é»‘æ¡ï¼‰
      Column()
        .width('100%')
        .height('100%')
        .linearGradient(DesignSystem.GRADIENT_OVERLAY_FULL)
        .hitTestBehavior(HitTestMode.None)

      // 3. ä¸Šå±‚ï¼šå†…å®¹å±‚
      if (this.isLoading) {
        WeatherSkeleton();
      } else if (this.errorMessage !== '') {
        this.renderError();
      } else {
        this.renderContent();
      }

      // Error Toast
      ErrorToast({ errorMessage: $currentError });
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ¸²æŸ“ä¸»è¦å†…å®¹åŒºåŸŸ
   * 
   * åŒ…å«ï¼š
   * - ä¸‹æ‹‰åˆ·æ–°ç»„ä»¶
   * - é¡µé¢å¤´éƒ¨ï¼ˆèœå•å’Œæ·»åŠ æŒ‰é’®ï¼‰
   * - é¡µé¢ä¸»ä½“ï¼ˆåŸå¸‚å¤©æ°”å¡ç‰‡ï¼‰
   */
  @Builder
  private renderContent(): void {
    Refresh({ refreshing: $$this.isRefreshing, builder: this.refreshBuilder }) {
      Column() {
        this.renderHeader();
        this.renderBody();
      }
      .width('100%')
      .height('100%')
    }
    .onRefreshing(() => {
      this.handleRefresh();
    })
  }

  /**
   * æ¸²æŸ“é¡µé¢å¤´éƒ¨
   * 
   * å¸ƒå±€ï¼š
   * - å·¦ä¾§ï¼šèœå•æŒ‰é’®ï¼ˆè·³è½¬åˆ°åŸå¸‚ç®¡ç†é¡µé¢ï¼‰
   * - å³ä¾§ï¼šæ·»åŠ æŒ‰é’®ï¼ˆç›´æ¥è·³è½¬åˆ°æœç´¢æ¨¡å¼æ·»åŠ åŸå¸‚ï¼‰
   */
  @Builder
  private renderHeader(): void {
    Row() {
      // Left: Menu Button - è·³è½¬åˆ°åŸå¸‚ç®¡ç†é¡µé¢
      this.IconButton(DesignSystem.IconResources.MENU, () => this.navigateToCityManagement());

      Blank();

      // Right: Add Button - ç›´æ¥è·³è½¬åˆ°æœç´¢æ¨¡å¼ï¼ˆæ·»åŠ åŸå¸‚ï¼‰
      this.IconButton(DesignSystem.IconResources.ADD, () => this.navigateToAddCity());
    }
    .width('100%')
    .padding({ 
      left: DesignSystem.Spacing.L, 
      right: DesignSystem.Spacing.L, 
      top: DesignSystem.Spacing.XL 
    })
  }

  /**
   * æ¸²æŸ“å›¾æ ‡æŒ‰é’®
   * 
   * ç‰¹æ€§ï¼š
   * - åœ†å½¢è§¦æ‘¸åŒºåŸŸï¼Œæå‡ç”¨æˆ·ä½“éªŒ
   * - ç™½è‰²å›¾æ ‡å¸¦é˜´å½±ï¼Œç¡®ä¿åœ¨å„ç§èƒŒæ™¯ä¸‹å¯è§
   * - ç‚¹å‡»æ—¶è§¦å‘éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœè®¾å¤‡æ”¯æŒï¼‰
   * 
   * @param iconRes å›¾æ ‡èµ„æº
   * @param action ç‚¹å‡»äº‹ä»¶å›è°ƒå‡½æ•°
   */
  @Builder
  private IconButton(iconRes: Resource, action: () => void): void {
    Button() {
      Image(iconRes)
        .width(24)
        .height(24)
        .fillColor(DesignSystem.Colors.WHITE)
        .shadow({ radius: 4, color: 'rgba(0,0,0,0.2)', offsetY: 2 })
    }
    .width(44)
    .height(44)
    .backgroundColor(Color.Transparent) // No background
    .type(ButtonType.Circle) // Ensure circle touch area
    .onClick(() => {
      try {
        vibrator.startVibration({ type: 'time', duration: 50 }, { id: 0, usage: 'touch' });
      } catch (e) {
        // Ignore if vibration not supported
      }
      action();
    })
  }

  /**
   * æ¸²æŸ“é¡µé¢ä¸»ä½“å†…å®¹
   * 
   * åŒ…å«åŸå¸‚å¤©æ°”å¡ç‰‡çš„ Swiper ç»„ä»¶
   */
  @Builder
  private renderBody(): void {
    Column() {
      this.renderSwiper();
    }
    .width('100%')
    .layoutWeight(1)
  }

  /**
   * è·å–é«˜ä¼˜å…ˆçº§å»ºè®®åˆ—è¡¨
   * 
   * @param advice å®Œæ•´å»ºè®®åˆ—è¡¨
   * @returns ä¼˜å…ˆçº§ <= 2 çš„å»ºè®®é¡¹
   */
  private getPriorityAdviceList(advice: AdviceItem[]): AdviceItem[] {
    return advice.filter((item: AdviceItem) => item.priority <= 2);
  }

  /**
   * è·å–æ™®é€šä¼˜å…ˆçº§å»ºè®®åˆ—è¡¨
   * 
   * @param advice å®Œæ•´å»ºè®®åˆ—è¡¨
   * @returns ä¼˜å…ˆçº§ > 2 çš„å»ºè®®é¡¹
   */
  private getOtherAdviceList(advice: AdviceItem[]): AdviceItem[] {
    return advice.filter((item: AdviceItem) => item.priority > 2);
  }

  /**
   * æ¸²æŸ“é«˜ä¼˜å…ˆçº§å»ºè®®å¡ç‰‡
   * 
   * @param adviceList é«˜ä¼˜å…ˆçº§å»ºè®®åˆ—è¡¨
   */
  @Builder
  private renderPriorityAdvice(adviceList: AdviceItem[]): void {
    if (adviceList && adviceList.length > 0) {
      Column({ space: DesignSystem.Spacing.M }) {
        this.SectionTitle('é‡è¦æç¤º');
        ForEach(adviceList, (advice: AdviceItem) => {
          PriorityAdviceCard({ advice: advice });
        }, (advice: AdviceItem) => advice.id);
      }
    } else {
      Blank();
    }
  }

  /**
   * æ¸²æŸ“åŸå¸‚åˆ‡æ¢ Swiper ç»„ä»¶
   * 
   * åŠŸèƒ½ï¼š
   * - å·¦å³æ»‘åŠ¨åˆ‡æ¢åŸå¸‚
   * - è‡ªåŠ¨æ›´æ–°ä¸»é¢˜å’ŒèƒŒæ™¯
   * - åˆ‡æ¢æ—¶æ»šåŠ¨åˆ°é¡¶éƒ¨
   * - åº•éƒ¨æ˜¾ç¤ºè‡ªå®šä¹‰æŒ‡ç¤ºå™¨
   * 
   * æ€§èƒ½ä¼˜åŒ–ï¼š
   * - ä½¿ç”¨ generateCityKey ç”Ÿæˆå”¯ä¸€ keyï¼Œé…åˆ dataVersion å¼ºåˆ¶é‡æ–°æ¸²æŸ“
   * - ä¸ºæ¯ä¸ªåŸå¸‚ç»´æŠ¤ç‹¬ç«‹çš„ Scroller å®ä¾‹
   */
  @Builder
  private renderSwiper(): void {
    if (this.cityStates.length === 0) {
      Column() {
        // City Name (Left)
        Text(this.getDisplayCityName(this.currentState?.city?.name))
          .fontSize(24)
          .fontWeight(DesignSystem.FontWeight.BOLD)
          .fontColor(DesignSystem.Colors.WHITE);
        Button('æ·»åŠ åŸå¸‚')
          .onClick(() => this.navigateToCityManagement())
          .margin({ top: 16 });
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center);
    } else {
      Swiper() {
        ForEach(this.cityStates.filter(state => state && state.city && state.city.id), (state: CityWeatherState, index: number) => {
          this.renderCityScrollContent(state, index);
        }, (state: CityWeatherState) => this.generateCityKey(state));
      }
      .loop(false)
      .vertical(false)
      .index(this.activeIndex)
      .indicator(false)
      .onChange((index: number) => {
        console.info(`[WeatherHomePage] ğŸ”„ åˆ‡æ¢åŸå¸‚: ${this.activeIndex} -> ${index}`);
        this.activeIndex = index;
        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç›´æ¥ä¼ å‚çš„æ–¹å¼æ›´æ–°ä¸»é¢˜ï¼Œç¡®ä¿è·å–æ­£ç¡®çš„åŸå¸‚å¤©æ°”æ•°æ®
        this.updateThemeWithStates(this.cityStates, index);
        
        // å¼ºåˆ¶æ»šåŠ¨åˆ°é¡¶éƒ¨
        const currentCity = this.cityStates[index];
        if (currentCity && currentCity.city && currentCity.city.id) {
          const scroller = this.getScrollerForCity(currentCity.city.id);
          console.info(`[WeatherHomePage] ğŸ“œ å¼ºåˆ¶æ»šåŠ¨åˆ°é¡¶éƒ¨: ${currentCity.city.name}`);
          scroller.scrollTo({ xOffset: 0, yOffset: 0, animation: false });
        }
      })
      .curve(Curve.EaseInOut)
      .duration(300) // ä½¿ç”¨ç»Ÿä¸€åŠ¨æ•ˆæ—¶é•¿
      .width('100%')
      .height('100%');

      // Custom Indicator
      Row({ space: 8 }) {
        ForEach(this.cityStates.filter(state => state && state.city && state.city.id), (state: CityWeatherState, index: number) => {
          Column()
            .width(this.isIndexActive(index) ? 8 : 6)
            .height(this.isIndexActive(index) ? 8 : 6)
            .backgroundColor(this.isIndexActive(index) ? DesignSystem.Colors.WHITE : 'rgba(255,255,255,0.4)')
            .borderRadius(4)
            .animation({ duration: 300, curve: Curve.EaseOut }); // Add animation to indicator
        }, (state: CityWeatherState) => `indicator_${state?.city?.id || Math.random()}`);
      }
      .margin({ top: 0 })
      .position({ x: '50%', y: '95%' })
      .translate({ x: '-50%' });
    }
  }

  /**
   * æ¸²æŸ“å•ä¸ªåŸå¸‚çš„æ»šåŠ¨å†…å®¹
   * 
   * å†…å®¹ç»“æ„ï¼š
   * 1. é¡¶éƒ¨ï¼šåŸå¸‚å¤©æ°”å¡ç‰‡ï¼ˆæ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€åŸå¸‚åï¼‰
   * 2. ä¸­éƒ¨ï¼šå„ç±»å¤©æ°”ä¿¡æ¯å¡ç‰‡
   *    - å¤©æ°”é¢„è­¦ï¼ˆå¦‚æœ‰ï¼‰
   *    - é™é›¨é¢„æµ‹ï¼ˆå¦‚æœ‰ï¼‰
   *    - é‡è¦å»ºè®®ï¼ˆå¦‚æœ‰ï¼‰
   *    - 24å°æ—¶é¢„æŠ¥
   *    - 7å¤©é¢„æŠ¥
   *    - å¤©æ°”è¯¦æƒ…ç½‘æ ¼
   * 3. åº•éƒ¨ï¼šç•™ç™½åŒºåŸŸ
   * 
   * @param state åŸå¸‚å¤©æ°”çŠ¶æ€
   * @param cityIndex åŸå¸‚ç´¢å¼•ï¼ˆæœªä½¿ç”¨ï¼Œä¿ç•™ç”¨äºæ‰©å±•ï¼‰
   */
  @Builder
  private renderCityScrollContent(state: CityWeatherState, cityIndex: number): void {
    // è°ƒè¯•æ—¥å¿— - åœ¨Builderå¤–éƒ¨æ— æ³•æ·»åŠ ï¼Œä½†å¯ä»¥é€šè¿‡æ–¹æ³•è°ƒç”¨
    Scroll(this.getScrollerForCity(state.city.id)) {
      Column() {
        // Top Area
        CityWeatherCard({ 
          cityState: state, 
          isActive: this.isStateActive(state) 
        });
        
        // Bottom Area
        Column({ space: DesignSystem.Spacing.M }) {
          // Weather Alert Section - é«˜ä¼˜å…ˆçº§
          if (state.snapshot && state.snapshot.alerts && state.snapshot.alerts.length > 0) {
            ForEach(state.snapshot.alerts, (alert: WeatherAlert) => {
              WeatherAlertCard({ alert: alert });
            }, (alert: WeatherAlert) => alert.id);
          }

          // Rain Forecast Section - é™é›¨é¢„æµ‹
          if (state.snapshot && state.snapshot.rainForecast && state.snapshot.rainForecast.length > 0) {
            RainForecastCard({ rainData: state.snapshot.rainForecast });
          }

          // Priority Advice Section - é‡è¦å»ºè®®
          if (state.snapshot && state.snapshot.advice && state.snapshot.advice.length > 0) {
            this.renderPriorityAdvice(this.getPriorityAdviceList(state.snapshot.advice));
          }

          // Hourly Forecast Section
          if (state.snapshot && state.snapshot.hourly.length > 0) {
            this.SectionTitle('24å°æ—¶é¢„æŠ¥');
            HourlyTrendChart({ hourlyData: state.snapshot.hourly });
          }

          // Daily Forecast Section
          if (state.snapshot && state.snapshot.daily.length > 0) {
            this.SectionTitle('7å¤©é¢„æŠ¥');
            DailyForecastCard({ dailyData: state.snapshot.daily });
          }
          
          // Details Grid Section
          if (state.snapshot) {
            this.SectionTitle('å½“å‰å¤©æ°”è¯¦æƒ…');
            WeatherDetailGrid({
              humidity: FormatHelper.formatHumidity(state.snapshot.current.humidity),
              aqi: FormatHelper.formatAqi(state.snapshot.current.aqi),
              wind: FormatHelper.formatWind(state.snapshot.current.windSpeedKph, state.snapshot.current.windDirection),
              feelsLike: FormatHelper.formatTemperature(state.snapshot.current.feelsLikeC),
              pressure: `${state.snapshot.current.pressureHpa}hPa`,
              visibilityInfo: `${state.snapshot.current.visibilityKm}`,
              uvIndex: `${state.snapshot.current.uvIndex}`,
              sunrise: state.snapshot.current.sunrise,
              sunset: state.snapshot.current.sunset
            });
          }

          // å·²åˆ é™¤"æ›´å¤šå»ºè®®"éƒ¨åˆ†
          
          Blank().height(100); // åº•éƒ¨ç•™ç™½
        }
        .padding({ left: DesignSystem.Spacing.M, right: DesignSystem.Spacing.M })
      }
      .width('100%')
      .constraintSize({ minHeight: '100%' })
    }
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
    .width('100%')
    .height('100%')
  }

  /**
   * æ¸²æŸ“ç« èŠ‚æ ‡é¢˜
   * 
   * æ ·å¼ï¼š
   * - ä¸»æ ‡é¢˜ï¼š18pxï¼ŒåŠç²—ä½“
   * - å‰¯æ ‡é¢˜ï¼š12pxï¼Œç»†ä½“ï¼ˆå¯é€‰ï¼‰
   * 
   * @param title ä¸»æ ‡é¢˜æ–‡æœ¬
   * @param subtitle å‰¯æ ‡é¢˜æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
   */
  @Builder
  private SectionTitle(title: string, subtitle: string = ''): void {
    Column() {
      Text(title)
        .fontSize(18)
        .fontWeight(DesignSystem.FONT_WEIGHT_SEMIBOLD)
        .fontFamily(DesignSystem.FONT_FAMILY_PRIMARY)
        .fontColor(DesignSystem.COLOR_TEXT_PRIMARY)
        .margin({ bottom: subtitle ? 4 : 0 });
      
      if (subtitle) {
        Text(subtitle)
          .fontSize(12)
          .fontWeight(DesignSystem.FONT_WEIGHT_LIGHT)
          .fontFamily(DesignSystem.FONT_FAMILY_PRIMARY)
          .fontColor(DesignSystem.COLOR_TEXT_SECONDARY);
      }
    }
    .alignItems(HorizontalAlign.Start)
    .width('100%')
    .margin({ top: DesignSystem.SPACING_L, bottom: DesignSystem.SPACING_S, left: 4 })
  }

  /**
   * æ¸²æŸ“é”™è¯¯é¡µé¢
   * 
   * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å’Œé‡è¯•æŒ‰é’®
   */
  @Builder
  private renderError(): void {
    Column() {
      Text(this.errorMessage)
        .fontSize(18)
        .fontColor('#FFB2B2')
        .margin({ bottom: 16 });
      Button('é‡è¯•')
        .onClick(() => this.refresh(true));
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center);
  }

  /**
   * æ¸²æŸ“ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨
   * 
   * æ˜¾ç¤ºåŠ è½½åŠ¨ç”»å’Œ"åˆ·æ–°ä¸­..."æ–‡æœ¬
   */
  @Builder
  private refreshBuilder(): void {
    Row() {
      LoadingProgress()
        .width(24)
        .height(24)
        .color(DesignSystem.Colors.WHITE);
      Text('åˆ·æ–°ä¸­...')
        .fontSize(14)
        .fontColor(DesignSystem.Colors.WHITE_70)
        .margin({ left: DesignSystem.Spacing.S });
    }
    .width('100%')
    .height(60)
    .justifyContent(FlexAlign.Center)
  }

  // ==================== UI è¾…åŠ©æ–¹æ³• ====================
  
  /**
   * åˆ¤æ–­æŒ‡å®šåŸå¸‚çŠ¶æ€æ˜¯å¦ä¸ºå½“å‰æ´»åŠ¨çŠ¶æ€
   * 
   * @param state è¦åˆ¤æ–­çš„åŸå¸‚çŠ¶æ€
   * @returns true è¡¨ç¤ºæ˜¯å½“å‰æ´»åŠ¨åŸå¸‚
   */
  private isStateActive(state: CityWeatherState): boolean {
    if (!this.currentState || !state?.city?.id || !this.currentState?.city?.id) {
      return false;
    }
    return state.city.id === this.currentState.city.id;
  }

  /**
   * åˆ¤æ–­æŒ‡å®šç´¢å¼•æ˜¯å¦ä¸ºå½“å‰æ´»åŠ¨ç´¢å¼•
   * 
   * @param index è¦åˆ¤æ–­çš„ç´¢å¼•
   * @returns true è¡¨ç¤ºæ˜¯å½“å‰æ´»åŠ¨ç´¢å¼•
   */
  private isIndexActive(index: number): boolean {
    return index === this.activeIndex;
  }

  /**
   * è·å–ç”¨äºæ˜¾ç¤ºçš„åŸå¸‚åç§°
   * 
   * å¤„ç†ç‰¹æ®Šæƒ…å†µï¼š
   * - å¦‚æœåç§°ä¸ºç©ºï¼Œè¿”å› "Loading..."
   * - å¦‚æœåç§°çœ‹èµ·æ¥åƒåæ ‡ï¼ˆåŒ…å«æ•°å­—å’Œé€—å·ï¼‰ï¼Œè¿”å›é»˜è®¤åŸå¸‚å
   * 
   * @param name åŸå§‹åŸå¸‚åç§°
   * @returns ç”¨äºæ˜¾ç¤ºçš„åŸå¸‚åç§°
   */
  private getDisplayCityName(name: string | undefined): string {
    if (!name) return 'Loading...';
    // Simple check if name looks like coordinates (contains numbers and comma)
    if (name.match(/-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?/)) {
      return 'åŒ—äº¬å¸‚'; // Fallback/Mock as requested
    }
    return name;
  }

  // ==================== é«˜çº§åŠŸèƒ½æ–¹æ³• ====================
  
  /**
   * æ‰§è¡Œç½‘ç»œè¯Šæ–­
   * 
   * è¯Šæ–­é¡¹ç›®ï¼š
   * - ç½‘ç»œè¿æ¥çŠ¶æ€
   * - DNS è§£æé€Ÿåº¦
   * - API æœåŠ¡å™¨å¯è¾¾æ€§
   * - ç½‘ç»œå»¶è¿Ÿå’Œè´¨é‡è¯„åˆ†
   * 
   * è¯Šæ–­å®Œæˆåæ˜¾ç¤ºç»“æœå¯¹è¯æ¡†
   */
  private async performNetworkDiagnosis(): Promise<void> {
    try {
      console.info('[WeatherHomePage] Starting network diagnosis...');
      this.currentError = ErrorHandler.createInfoMessage('æ­£åœ¨è¿›è¡Œç½‘ç»œè¯Šæ–­...');
      
      const result = await this.networkDiagnosis.performFullDiagnosis();
      const score = this.networkDiagnosis.getNetworkQualityScore(result);
      
      // æ›´æ–°è¯Šæ–­ç»“æœ
      this.diagnosisResult = result;
      
      // é‡æ–°åˆ›å»ºå¯¹è¯æ¡†æ§åˆ¶å™¨
      this.diagnosisDialogController = new CustomDialogController({
        builder: NetworkDiagnosisDialog({
          diagnosisResult: this.diagnosisResult,
          networkScore: score,
          issues: this.networkDiagnosis.analyzeResults(result)
        }),
        autoCancel: true,
        alignment: DialogAlignment.Center
      });
      
      // æ˜¾ç¤ºè¯Šæ–­å¯¹è¯æ¡†
      if (this.diagnosisDialogController) {
        this.diagnosisDialogController.open();
      }
      
      this.currentError = ErrorHandler.createInfoMessage(`ç½‘ç»œè¯Šæ–­å®Œæˆ (è¯„åˆ†: ${score}/100)`);
      console.info('[WeatherHomePage] Network diagnosis completed:', result);
    } catch (error) {
      console.error('[WeatherHomePage] Network diagnosis failed:', error);
      this.currentError = ErrorHandler.handle(error as Error, 'ç½‘ç»œè¯Šæ–­å¤±è´¥');
    }
  }

  /**
   * å¼ºåˆ¶åˆ·æ–°å®šä½
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ¸…é™¤ç°æœ‰çš„è‡ªåŠ¨å®šä½åŸå¸‚
   * - å¼ºåˆ¶é‡æ–°è·å–å½“å‰ä½ç½®
   * - åˆ›å»ºæ–°çš„è‡ªåŠ¨å®šä½åŸå¸‚
   * - åˆ·æ–°å¤©æ°”æ•°æ®
   * 
   * ä½¿ç”¨åœºæ™¯ï¼šç”¨æˆ·ä½ç½®å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦æ›´æ–°å®šä½åŸå¸‚
   */
  private async forceLocationRefresh(): Promise<void> {
    try {
      console.info('[WeatherHomePage] ========== å¼ºåˆ¶å®šä½åˆ·æ–° ==========');
      this.currentError = ErrorHandler.createInfoMessage('æ­£åœ¨å¼ºåˆ¶åˆ·æ–°å®šä½...');
      
      // æ¸…é™¤ç°æœ‰çš„è‡ªåŠ¨å®šä½åŸå¸‚
      const cities = this.controller.getCityStates();
      const nonAutoCities = cities.filter(state => state.city.source !== CitySource.AUTO);
      console.info(`[WeatherHomePage] ğŸ—‘ï¸ æ¸…é™¤è‡ªåŠ¨å®šä½åŸå¸‚ï¼Œä¿ç•™ ${nonAutoCities.length} ä¸ªæ‰‹åŠ¨åŸå¸‚`);
      
      // å¼ºåˆ¶é‡æ–°è·å–ä½ç½®
      console.info('[WeatherHomePage] ğŸ¯ å¼€å§‹å¼ºåˆ¶å®šä½...');
      const coordinates = await LocationService.getInstance().getCurrentLocation();
      console.info(`[WeatherHomePage] âœ… å¼ºåˆ¶å®šä½æˆåŠŸ: ${coordinates.latitude}, ${coordinates.longitude}`);
      
      // è·å–åŸå¸‚åç§°
      const cityName = await LocationService.getInstance().getCityNameFromCoordinates(coordinates);
      console.info(`[WeatherHomePage] ğŸ™ï¸ åŸå¸‚åç§°: ${cityName}`);
      
      // åˆ›å»ºæ–°çš„è‡ªåŠ¨å®šä½åŸå¸‚
      const newAutoCity = new City(
        `auto_${Math.round(coordinates.latitude * 1000)}_${Math.round(coordinates.longitude * 1000)}`,
        cityName,
        'Auto',
        coordinates,
        CitySource.AUTO,
        'sunny',
        0
      );
      
      console.info(`[WeatherHomePage] ğŸ“ æ–°å»ºè‡ªåŠ¨åŸå¸‚: ${newAutoCity.name} (${newAutoCity.id})`);
      
      // æ›´æ–°åŸå¸‚åˆ—è¡¨
      const updatedCities = [newAutoCity, ...nonAutoCities.map(state => state.city)];
      await CityRepository.getInstance().updateCities(updatedCities);
      
      // åˆ·æ–°ç•Œé¢
      await this.refresh(true);
      
      this.currentError = ErrorHandler.createInfoMessage(`å®šä½åˆ·æ–°å®Œæˆ: ${cityName}`);
      console.info('[WeatherHomePage] ========== å¼ºåˆ¶å®šä½åˆ·æ–°å®Œæˆ ==========');
    } catch (error) {
      console.error('[WeatherHomePage] å¼ºåˆ¶å®šä½åˆ·æ–°å¤±è´¥:', error);
      this.currentError = ErrorHandler.handle(error as Error, 'å¼ºåˆ¶å®šä½åˆ·æ–°å¤±è´¥');
    }
  }

  /**
   * åˆ·æ–°å½“å‰ä½ç½®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - è·å–å½“å‰åæ ‡å’ŒåŸå¸‚åç§°
   * - å¦‚æœå·²æœ‰è‡ªåŠ¨å®šä½åŸå¸‚ï¼Œæ›´æ–°å…¶ä¿¡æ¯
   * - å¦‚æœæ²¡æœ‰è‡ªåŠ¨å®šä½åŸå¸‚ï¼Œæ·»åŠ æ–°åŸå¸‚
   * - åˆ·æ–°å¤©æ°”æ•°æ®
   */
  private async refreshCurrentLocation(): Promise<void> {
    try {
      console.info('[WeatherHomePage] Refreshing current location...');
      this.currentError = ErrorHandler.createInfoMessage('æ­£åœ¨è·å–å½“å‰ä½ç½®...');
      
      // è·å–å½“å‰åæ ‡
      const coordinates = await LocationService.getInstance().getCurrentLocation();
      console.info(`[WeatherHomePage] Got coordinates: ${coordinates.latitude}, ${coordinates.longitude}`);
      
      // è·å–åŸå¸‚åç§°
      const cityName = await LocationService.getInstance().getCityNameFromCoordinates(coordinates);
      console.info(`[WeatherHomePage] Got city name: ${cityName}`);
      
      // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰è‡ªåŠ¨å®šä½çš„åŸå¸‚
      const cities = this.controller.getCityStates();
      const autoCity = cities.find(state => state.city.source === CitySource.AUTO);
      
      if (autoCity) {
        // æ›´æ–°ç°æœ‰çš„è‡ªåŠ¨å®šä½åŸå¸‚
        const updatedCity = new City(
          autoCity.city.id,
          cityName,
          'Auto',
          coordinates,
          CitySource.AUTO,
          autoCity.city.videoTheme,
          autoCity.city.timeZoneOffsetMinutes
        );
        
        // æ›´æ–°åŸå¸‚åˆ—è¡¨
        const updatedCities = cities.map(state => 
          state.city.source === CitySource.AUTO ? updatedCity : state.city
        );
        
        await CityRepository.getInstance().updateCities(updatedCities);
        
        // åˆ·æ–°å¤©æ°”æ•°æ®
        await this.refresh(true);
        
        this.currentError = ErrorHandler.createInfoMessage(`ä½ç½®å·²æ›´æ–°ä¸º: ${cityName}`);
      } else {
        // æ·»åŠ æ–°çš„è‡ªåŠ¨å®šä½åŸå¸‚
        const newAutoCity = new City(
          `auto_${Math.round(coordinates.latitude * 1000)}_${Math.round(coordinates.longitude * 1000)}`,
          cityName,
          'Auto',
          coordinates,
          CitySource.AUTO,
          'sunny',
          0
        );
        
        await CityRepository.getInstance().addCity(newAutoCity);
        await this.refresh(true);
        
        this.currentError = ErrorHandler.createInfoMessage(`å·²æ·»åŠ å½“å‰ä½ç½®: ${cityName}`);
      }
      
      console.info(`[WeatherHomePage] Location refresh completed: ${cityName}`);
    } catch (error) {
      console.error('[WeatherHomePage] Location refresh failed:', error);
      this.currentError = ErrorHandler.handle(error as Error, 'è·å–å½“å‰ä½ç½®å¤±è´¥');
    }
  }

  // ==================== å¯¼èˆªæ–¹æ³• ====================
  
  /**
   * å¯¼èˆªåˆ°åŸå¸‚ç®¡ç†é¡µé¢
   * 
   * ç”¨æˆ·å¯ä»¥åœ¨åŸå¸‚ç®¡ç†é¡µé¢ï¼š
   * - æŸ¥çœ‹æ‰€æœ‰å·²æ·»åŠ çš„åŸå¸‚
   * - åˆ é™¤åŸå¸‚
   * - è°ƒæ•´åŸå¸‚é¡ºåº
   * - æœç´¢å¹¶æ·»åŠ æ–°åŸå¸‚
   */
  private navigateToCityManagement(): void {
    try {
      console.info('[WeatherHomePage] Navigating to city management...');
      router.push({
        url: 'pages/management/CityManagementPage'
      });
      console.info('[WeatherHomePage] Navigation to city management successful');
    } catch (error) {
      console.error('[WeatherHomePage] Navigation failed:', error);
      this.currentError = ErrorHandler.handle(error instanceof Error ? error : new Error(String(error)), 'Failed to navigate');
    }
  }

  /**
   * å¯¼èˆªåˆ°æ·»åŠ åŸå¸‚é¡µé¢ï¼ˆæœç´¢æ¨¡å¼ï¼‰
   * 
   * ç›´æ¥æ‰“å¼€åŸå¸‚ç®¡ç†é¡µé¢çš„æœç´¢æ¨¡å¼ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿæ·»åŠ åŸå¸‚
   */
  private navigateToAddCity(): void {
    try {
      console.info('[WeatherHomePage] Navigating to add city (search mode)...');
      router.push({
        url: 'pages/management/CityManagementPage',
        params: { openSearchMode: true }
      });
      console.info('[WeatherHomePage] Navigation to add city successful');
    } catch (error) {
      console.error('[WeatherHomePage] Navigation failed:', error);
      this.currentError = ErrorHandler.handle(error instanceof Error ? error : new Error(String(error)), 'Failed to navigate');
    }
  }

  /**
   * è·å–æŒ‡å®šåŸå¸‚çš„ Scroller å®ä¾‹
   * 
   * æ€§èƒ½ä¼˜åŒ–ï¼šä¸ºæ¯ä¸ªåŸå¸‚ç»´æŠ¤ç‹¬ç«‹çš„ Scroller å®ä¾‹
   * - é¿å…åŸå¸‚åˆ‡æ¢æ—¶æ»šåŠ¨ä½ç½®æ··ä¹±
   * - ä¿æŒæ¯ä¸ªåŸå¸‚çš„æ»šåŠ¨çŠ¶æ€
   * 
   * @param cityId åŸå¸‚ ID
   * @returns è¯¥åŸå¸‚çš„ Scroller å®ä¾‹
   */
  private getScrollerForCity(cityId: string): Scroller {
    if (!this.cityScrollers.has(cityId)) {
      this.cityScrollers.set(cityId, new Scroller());
      console.debug(`[WeatherHomePage] ğŸ“œ åˆ›å»ºæ–°çš„Scrollerå®ä¾‹: ${cityId}`);
    }
    return this.cityScrollers.get(cityId)!;
  }

}

# Implementation Plan

- [x] 1. Set up widget infrastructure and data storage
  - [x] 1.1 Create WidgetDataStorage class for cross-process data sharing
    - Create `entry/src/main/ets/data/storage/WidgetDataStorage.ets`
    - Implement saveForWidget() method to persist weather data to Preferences
    - Implement loadForWidget() method to read weather data from Preferences
    - Implement form ID management methods (addFormId, removeFormId, loadFormIds, saveFormIds)
    - Use application-level context for cross-process accessibility
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3_
  - [ ]* 1.2 Write property tests for WidgetDataStorage
    - **Property 5: Dual storage persistence**
    - **Property 6: Form ID management - add**
    - **Property 7: Form ID management - remove**
    - **Property 8: Data parsing robustness**
    - **Validates: Requirements 6.1, 6.3, 6.4, 7.1, 7.2**

- [x] 2. Create WidgetHelper utility class
  - [x] 2.1 Implement WidgetHelper with theme and icon mapping functions
    - Create `entry/src/main/ets/common/utils/WidgetHelper.ets`
    - Implement getGradientByTheme() for weather theme to gradient color mapping
    - Implement getIconResource() for icon code to Resource mapping with fallback
    - Implement formatUpdateTime() for timestamp formatting
    - Implement isDataStale() for 30-minute staleness check
    - Implement convertToWidgetData() to transform WeatherSnapshot to WidgetWeatherData
    - _Requirements: 1.4, 3.4, 5.2, 8.3_
  - [ ]* 2.2 Write property tests for WidgetHelper
    - **Property 2: Icon mapping consistency**
    - **Property 3: Theme gradient mapping**
    - **Property 4: Data staleness detection**
    - **Validates: Requirements 1.4, 3.4, 5.2, 8.3**

- [x] 3. Implement 2×2 Weather Widget UI
  - [x] 3.1 Create WeatherWidget2x2 component
    - Create `entry/src/main/ets/widget/pages/WeatherWidget2x2.ets`
    - Implement compact layout with city name, temperature, condition, and icon
    - Apply gradient background based on themeKey using WidgetHelper
    - Use DesignSystem colors and typography for consistent styling
    - Add glass-morphism effect with rounded corners
    - Implement click handler to launch main application
    - Show staleness indicator when data is older than 30 minutes
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 4.1, 5.1, 5.2, 5.3, 5.4_

- [x] 4. Implement 4×4 Weather Widget UI
  - [x] 4.1 Create WeatherWidget4x4 component
    - Create `entry/src/main/ets/widget/pages/WeatherWidget4x4.ets`
    - Implement extended layout with all 2×2 content plus humidity, wind speed
    - Add 3-hour forecast preview section
    - Apply gradient background based on themeKey
    - Use DesignSystem colors and typography
    - Implement click handler to launch main application
    - Add refresh button with form event handling
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.2, 4.1, 4.2, 5.1, 5.2, 5.3, 5.4_
  - [ ]* 4.2 Write property test for widget data structure
    - **Property 9: Widget dimension data structure**
    - **Validates: Requirements 2.1, 2.2**

- [x] 5. Update EntryFormAbility for widget lifecycle management
  - [x] 5.1 Enhance EntryFormAbility with data loading and form ID management
    - Update `entry/src/main/ets/entryformability/EntryFormAbility.ets`
    - Implement onAddForm() to load weather data and save form ID
    - Implement onUpdateForm() to refresh widget with latest cached data
    - Implement onRemoveForm() to clean up form ID from storage
    - Implement onFormEvent() to handle refresh button clicks
    - Add buildFormData() helper to construct FormBindingData for each dimension
    - Handle error cases with fallback UI data
    - _Requirements: 3.2, 3.3, 7.1, 7.2, 8.1, 8.2_
  - [ ]* 5.2 Write property test for data completeness
    - **Property 1: Widget data completeness**
    - **Validates: Requirements 1.1, 1.2, 1.3, 1.5**

- [x] 6. Integrate widget updates with main application
  - [x] 6.1 Update EntryAbility to trigger widget updates on background
    - Modify `entry/src/main/ets/entryability/EntryAbility.ets`
    - Add updateAllWidgets() method to update all registered widgets
    - Call updateAllWidgets() in onBackground() lifecycle
    - Read form IDs from WidgetDataStorage and update each widget
    - _Requirements: 3.1, 7.3_
  - [x] 6.2 Update WeatherHomePage to save widget data on weather refresh
    - Modify weather data save logic to also call WidgetDataStorage.saveForWidget()
    - Convert WeatherSnapshot to WidgetWeatherData using WidgetHelper
    - Ensure data is saved before application enters background
    - _Requirements: 3.1, 6.1_

- [x] 7. Update configuration files
  - [x] 7.1 Update module.json5 to register FormExtensionAbility
    - Add extensionAbilities entry for EntryFormAbility
    - Configure form metadata reference
    - _Requirements: 2.1, 2.2_
  - [x] 7.2 Update form_config.json with correct widget paths
    - Verify src paths point to new widget files
    - Ensure updateDuration and scheduledUpdateTime are configured
    - _Requirements: 3.2_
  - [x] 7.3 Add widget description strings to string.json
    - Add widget_desc_2x2 and widget_desc_4x4 string resources
    - _Requirements: 2.1, 2.2_

- [ ] 8. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 9. Final integration and cleanup
  - [x] 9.1 Verify old WeatherCard.ets file is removed (confirmed not present)
    - No old `entry/src/main/ets/widget/pages/WeatherCard.ets` file exists
  - [x] 9.2 Verify end-to-end widget functionality
    - Test adding 2×2 widget and verify data display
    - Test adding 4×4 widget and verify extended data
    - Test app background transition and widget update
    - Test widget click to launch app
    - _Requirements: All_

- [ ] 10. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

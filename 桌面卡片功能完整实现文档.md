# æ‹¼å›¾æ¸¸æˆæ¡Œé¢å¡ç‰‡åŠŸèƒ½å®Œæ•´å®ç°æ–‡æ¡£

> **é¡¹ç›®åç§°**: æ‹¼å›¾æ¸¸æˆ (Puzzle Game)  
> **å¼€å‘å¹³å°**: HarmonyOS  
> **å¼€å‘è¯­è¨€**: ArkTS  
> **åŠŸèƒ½æ¨¡å—**: æœåŠ¡å¡ç‰‡ (Service Widget)  
> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
> **æœ€åæ›´æ–°**: 2025å¹´11æœˆ

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [æ ¸å¿ƒå®ç°](#æ ¸å¿ƒå®ç°)
4. [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)
5. [å®Œæ•´ä»£ç å®ç°](#å®Œæ•´ä»£ç å®ç°)
6. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½éœ€æ±‚

æ‹¼å›¾æ¸¸æˆçš„æ¡Œé¢å¡ç‰‡åŠŸèƒ½å®ç°äº†ä»¥ä¸‹æ ¸å¿ƒéœ€æ±‚ï¼š

#### æ— æ¸¸æˆçŠ¶æ€
- æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"æŒ‰é’®
- ç‚¹å‡»åå¯åŠ¨åº”ç”¨å¹¶è·³è½¬åˆ°ä¸»é¢˜é€‰æ‹©é¡µé¢

#### æœ‰æ¸¸æˆè¿›è¡Œä¸­
- æ˜¾ç¤ºæ¸¸æˆè¿›åº¦ä¿¡æ¯ï¼š
  - æ¸¸æˆæ¨¡å¼ï¼ˆäº¤æ¢/æ»‘åŠ¨ï¼‰
  - éš¾åº¦ç­‰çº§ï¼ˆ3Ã—3ã€4Ã—4ã€5Ã—5ï¼‰
  - å½“å‰æ­¥æ•°
  - å·²ç”¨æ—¶é—´
- æä¾›ä¸¤ä¸ªæ“ä½œæŒ‰é’®ï¼š
  - **ç»§ç»­**ï¼šç›´æ¥è·³è½¬åˆ°æ¸¸æˆé¡µé¢ç»§ç»­æ¸¸æˆ
  - **ä¸»é¢˜**ï¼šè·³è½¬åˆ°ä¸»é¢˜é€‰æ‹©é¡µé¢å¼€å§‹æ–°æ¸¸æˆ

#### å®æ—¶æ›´æ–°ç‰¹æ€§
- **é›¶å»¶è¿ŸåŒæ­¥**ï¼šæ¸¸æˆè¿›è¡Œä¸­æŒ‰Homeé”®ï¼Œå¡ç‰‡ç«‹å³æ˜¾ç¤ºæœ€æ–°è¿›åº¦
- **æ•°æ®æŒä¹…åŒ–**ï¼šåº”ç”¨å…³é—­åé‡æ–°æ‰“å¼€ï¼Œå¡ç‰‡ä»ä¿ç•™æ¸¸æˆçŠ¶æ€
- **æ™ºèƒ½æ¸…ç†**ï¼šæ¸¸æˆå®Œæˆæˆ–åº”ç”¨è¢«é”€æ¯æ—¶ï¼Œå¡ç‰‡è‡ªåŠ¨æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"


### 1.2 æŠ€æœ¯æŒ‘æˆ˜

åœ¨å®ç°è¿‡ç¨‹ä¸­é‡åˆ°å¹¶è§£å†³äº†ä»¥ä¸‹æ ¸å¿ƒæŠ€æœ¯æŒ‘æˆ˜ï¼š

#### æŒ‘æˆ˜1ï¼šè·¨è¿›ç¨‹æ•°æ®å…±äº«
- **é—®é¢˜**ï¼šService Widgetè¿è¡Œåœ¨ç‹¬ç«‹çš„FormAbilityè¿›ç¨‹ï¼Œæ¸¸æˆè¿è¡Œåœ¨UIAbilityè¿›ç¨‹
- **éš¾ç‚¹**ï¼šAppStorageæ˜¯è¿›ç¨‹å†…å­˜å‚¨ï¼Œæ— æ³•è·¨è¿›ç¨‹è®¿é—®
- **è§£å†³**ï¼šåŒé‡ä¿å­˜æœºåˆ¶ï¼ˆAppStorage + Preferencesï¼‰

#### æŒ‘æˆ˜2ï¼šæ•°æ®åŒæ­¥æ—¶åºé—®é¢˜
- **é—®é¢˜**ï¼šEntryAbility.onBackground()å¯èƒ½åœ¨GamePageä¿å­˜æ•°æ®ä¹‹å‰è§¦å‘
- **éš¾ç‚¹**ï¼šå¯¼è‡´å¡ç‰‡è¯»å–åˆ°æ—§æ•°æ®
- **è§£å†³**ï¼šå®æ—¶ä¿å­˜ç­–ç•¥ï¼Œæ¯æ¬¡ç§»åŠ¨æ–¹å—ç«‹å³ä¿å­˜åˆ°AppStorage

#### æŒ‘æˆ˜3ï¼šå¡ç‰‡IDç®¡ç†
- **é—®é¢˜**ï¼šå¦‚ä½•çŸ¥é“æ¡Œé¢ä¸Šæœ‰å“ªäº›å¡ç‰‡éœ€è¦æ›´æ–°
- **éš¾ç‚¹**ï¼šFormAbilityå’ŒEntryAbilityéœ€è¦å…±äº«å¡ç‰‡IDåˆ—è¡¨
- **è§£å†³**ï¼šä½¿ç”¨åº”ç”¨çº§åˆ«çš„Preferenceså­˜å‚¨å¡ç‰‡ID

#### æŒ‘æˆ˜4ï¼šåº”ç”¨é”€æ¯åçš„æ•°æ®æ¸…ç†
- **é—®é¢˜**ï¼šåº”ç”¨è¢«å¼ºåˆ¶å…³é—­åï¼Œå¡ç‰‡ä»æ˜¾ç¤ºæ—§çš„æ¸¸æˆçŠ¶æ€
- **éš¾ç‚¹**ï¼šonDestroy()ä¸ä¸€å®šä¼šè¢«è°ƒç”¨
- **è§£å†³**ï¼šå®šæ—¶åˆ·æ–°æœºåˆ¶ + æ—¶é—´æˆ³è¿‡æœŸæ£€æµ‹

---

## æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¡Œé¢å¡ç‰‡ç³»ç»Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  WidgetCard  â”‚ â—„â”€â”€â”€â”€â”€â”€ â”‚ FormAbility  â”‚                  â”‚
â”‚  â”‚   (UIå±‚)     â”‚         â”‚  (å¡ç‰‡è¿›ç¨‹)   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                   â”‚                          â”‚
â”‚                                   â”‚ è¯»å–                     â”‚
â”‚                                   â–¼                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                          â”‚  Preferences   â”‚                  â”‚
â”‚                          â”‚  (æŒä¹…åŒ–å­˜å‚¨)   â”‚                  â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                   â–²                          â”‚
â”‚                                   â”‚ å†™å…¥                     â”‚
â”‚                                   â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   GamePage   â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚ EntryAbility â”‚                  â”‚
â”‚  â”‚  (æ¸¸æˆé¡µé¢)   â”‚         â”‚ (ä¸»åº”ç”¨è¿›ç¨‹)  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                                                    â”‚
â”‚         â”‚ å®æ—¶ä¿å­˜                                           â”‚
â”‚         â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  AppStorage  â”‚  â—„â”€â”€â”€ ä¼˜å…ˆè¯»å–ï¼ˆé›¶å»¶è¿Ÿï¼‰                   â”‚
â”‚  â”‚  (å†…å­˜å­˜å‚¨)   â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 2.2 æ•°æ®æµå‘

#### æ¸¸æˆè¿›è¡Œä¸­ï¼ˆä¿å­˜æ•°æ®ï¼‰

```
ç”¨æˆ·ç§»åŠ¨æ–¹å—
    â†“
GamePage.moveTile() / swapTiles()
    â†“
saveCurrentGameState()
    â”œâ”€â–º AppStorage.setOrCreate('currentGameState', gameState)  âš¡ åŒæ­¥ï¼Œé›¶å»¶è¿Ÿ
    â””â”€â–º GameStorage.saveGameState(gameState)                   ğŸ’¾ å¼‚æ­¥ï¼ŒæŒä¹…åŒ–
```

#### åˆ‡æ¢åˆ°åå°ï¼ˆæ›´æ–°å¡ç‰‡ï¼‰

```
ç”¨æˆ·æŒ‰Homeé”®
    â†“
EntryAbility.onBackground()
    â†“
updateAllForms()
    â”œâ”€â–º è¯»å–å¡ç‰‡IDåˆ—è¡¨ï¼ˆPreferencesï¼‰
    â”œâ”€â–º ä¼˜å…ˆä» AppStorage è¯»å–æ¸¸æˆçŠ¶æ€ âš¡ æœ€æ–°æ•°æ®
    â”‚   â””â”€â–º Fallback: ä» Preferences è¯»å– ğŸ’¾ åº”ç”¨é‡å¯å
    â”œâ”€â–º æ„å»ºå¡ç‰‡æ•°æ®ï¼ˆFormDataContentï¼‰
    â””â”€â–º formProvider.updateForm() æ›´æ–°æ‰€æœ‰å¡ç‰‡
```

#### ä»å¡ç‰‡å¯åŠ¨åº”ç”¨

```
ç”¨æˆ·ç‚¹å‡»å¡ç‰‡æŒ‰é’®
    â†“
postCardAction({ action: 'router', params: { targetPage: 'xxx' } })
    â†“
EntryAbility.onNewWant()
    â”œâ”€â–º ä¿å­˜ç›®æ ‡é¡µé¢åˆ° AppStorage
    â””â”€â–º è®¾ç½®æ—¶é—´æˆ³è§¦å‘æ›´æ–°
    â†“
GamePage.onPageShow()
    â†“
checkWidgetNavigation()
    â””â”€â–º router.pushUrl() è·³è½¬åˆ°ç›®æ ‡é¡µé¢
```

### 2.3 æ ¸å¿ƒç»„ä»¶è¯´æ˜

| ç»„ä»¶åç§° | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|---------|---------|------|
| **WidgetCard** | `widget/pages/WidgetCard.ets` | å¡ç‰‡UIå¸ƒå±€ï¼Œæ˜¾ç¤ºæ¸¸æˆä¿¡æ¯å’ŒæŒ‰é’® |
| **PuzzleFormAbility** | `formability/PuzzleFormAbility.ets` | å¡ç‰‡ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¡ç‰‡IDä¿å­˜/åˆ é™¤ |
| **GameStorage** | `utils/GameStorage.ets` | æ•°æ®æŒä¹…åŒ–å·¥å…·ï¼ŒPreferencesè¯»å†™ |
| **EntryAbility** | `entryability/EntryAbility.ets` | åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¡ç‰‡æ›´æ–°è§¦å‘ |
| **GamePage** | `pages/GamePage.ets` | æ¸¸æˆé¡µé¢ï¼Œå®æ—¶ä¿å­˜æ¸¸æˆçŠ¶æ€ |

---

## æ ¸å¿ƒå®ç°

### 3.1 åŒé‡ä¿å­˜æœºåˆ¶

è¿™æ˜¯æ•´ä¸ªå¡ç‰‡åŠŸèƒ½çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œè§£å†³äº†è·¨è¿›ç¨‹æ•°æ®å…±äº«å’Œæ—¶åºé—®é¢˜ã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦åŒé‡ä¿å­˜ï¼Ÿ

| å­˜å‚¨æ–¹å¼ | è¯»å†™é€Ÿåº¦ | è·¨è¿›ç¨‹ | æŒä¹…åŒ– | é€‚ç”¨åœºæ™¯ |
|---------|---------|--------|--------|---------|
| **AppStorage** | åŒæ­¥(é›¶å»¶è¿Ÿ) | âŒ å¦ | âŒ å¦ | âœ… å®æ—¶çŠ¶æ€åŒæ­¥ |
| **Preferences** | å¼‚æ­¥(æœ‰å»¶è¿Ÿ) | âœ… æ˜¯ | âœ… æ˜¯ | âœ… æŒä¹…åŒ–å¤‡ä»½ |

**æ ¸å¿ƒæ€æƒ³**ï¼š
- AppStorageï¼šå¿«é€ŸåŒæ­¥ï¼Œç¡®ä¿EntryAbility.onBackground()èƒ½ç«‹å³è¯»å–åˆ°æœ€æ–°æ•°æ®
- Preferencesï¼šæŒä¹…åŒ–å¤‡ä»½ï¼Œç¡®ä¿åº”ç”¨é‡å¯åèƒ½æ¢å¤æ¸¸æˆçŠ¶æ€


#### å®ç°ä»£ç 

**GamePage.ets - å®æ—¶ä¿å­˜æ¸¸æˆçŠ¶æ€**

```typescript
/**
 * å®æ—¶ä¿å­˜å½“å‰æ¸¸æˆçŠ¶æ€
 * ğŸ”¥ å¼ºç¡¬æ‰‹æ®µï¼šåŒæ—¶ä¿å­˜åˆ° AppStorageï¼ˆå†…å­˜ï¼Œç«‹å³ç”Ÿæ•ˆï¼‰å’Œ preferencesï¼ˆæŒä¹…åŒ–ï¼Œå¼‚æ­¥ï¼‰
 */
private saveCurrentGameState(): void {
  if (this.isPlaying && (this.moveCount > 0 || this.timeElapsed > 0)) {
    // æ„å»ºæ¸¸æˆçŠ¶æ€å¯¹è±¡
    const gameState: SavedGameState = {
      gameMode: this.gameMode,
      gridSize: this.gridSize,
      moveCount: this.moveCount,
      timeElapsed: this.timeElapsed,
      isPlaying: this.isPlaying,
      timestamp: Date.now()  // ğŸ”¥ æ·»åŠ æ—¶é—´æˆ³ï¼Œç”¨äºè¿‡æœŸæ£€æµ‹
    };
    
    // ğŸ”¥ å…³é”®1ï¼šç«‹å³åŒæ­¥åˆ° AppStorageï¼ˆå†…å­˜ï¼Œé›¶å»¶è¿Ÿï¼‰
    AppStorage.setOrCreate('currentGameState', gameState);
    console.info('[GamePage] âš¡ AppStorageå·²æ›´æ–°: æ­¥æ•°=' + this.moveCount + ', ç”¨æ—¶=' + this.timeElapsed);
    
    // ğŸ”¥ å…³é”®2ï¼šå¼‚æ­¥ä¿å­˜åˆ° preferencesï¼ˆæŒä¹…åŒ–å¤‡ä»½ï¼‰
    GameStorage.saveGameState(gameState);
  }
}

// æ¯æ¬¡ç§»åŠ¨æ–¹å—æ—¶è°ƒç”¨
private moveTile(index: number): void {
  // ... ç§»åŠ¨é€»è¾‘ ...
  this.moveCount++;
  
  // ğŸ”¥ ç«‹å³ä¿å­˜çŠ¶æ€
  this.saveCurrentGameState();
}

// å®šæ—¶å™¨æ¯ç§’è°ƒç”¨
private startTimer(): void {
  this.isPlaying = true;
  this.timerInterval = setInterval(() => {
    if (this.isPlaying) {
      this.timeElapsed++;
      // æ¯ç§’ä¿å­˜ä¸€æ¬¡çŠ¶æ€ï¼Œç¡®ä¿æ—¶é—´ä¹Ÿèƒ½å®æ—¶åŒæ­¥åˆ°å¡ç‰‡
      this.saveCurrentGameState();
    }
  }, 1000);
}

// é¡µé¢é”€æ¯æ—¶ä¿å­˜
aboutToDisappear() {
  this.saveCurrentGameState();
  // ... æ¸…ç†èµ„æº ...
}
```

**EntryAbility.ets - ä¼˜å…ˆè¯»å–AppStorage**

```typescript
/**
 * æ›´æ–°æ‰€æœ‰æœåŠ¡å¡ç‰‡
 * ğŸ”¥ å¼ºç¡¬æ‰‹æ®µï¼šä¼˜å…ˆä» AppStorageï¼ˆå†…å­˜ï¼‰è¯»å–å®æ—¶çŠ¶æ€ï¼Œfallback åˆ° preferences
 */
private async updateAllForms(): Promise<void> {
  try {
    hilog.info(DOMAIN, TAG, '========== ğŸ”„ å¼€å§‹æ›´æ–°æ‰€æœ‰å¡ç‰‡ ==========');
    
    // è¯»å–å¡ç‰‡IDåˆ—è¡¨
    const appContext = this.context.getApplicationContext();
    const dataPreferences = await preferences.getPreferences(appContext, 'formIds');
    const formIdsStr = await dataPreferences.get('ids', '[]') as string;
    const formIds: Array<string> = JSON.parse(formIdsStr);
    
    hilog.info(DOMAIN, TAG, `ğŸ“‹ è¯»å–åˆ° ${formIds.length} ä¸ªå¡ç‰‡ID`);
    
    if (formIds.length === 0) {
      hilog.warn(DOMAIN, TAG, 'âš ï¸ æ²¡æœ‰å·²æ·»åŠ çš„å¡ç‰‡ï¼Œè·³è¿‡æ›´æ–°');
      return;
    }
    
    // ğŸ”¥ å…³é”®ï¼šä¼˜å…ˆä» AppStorage è¯»å–å®æ—¶çŠ¶æ€ï¼ˆé›¶å»¶è¿Ÿï¼‰
    let gameState: SavedGameState | null = AppStorage.get<SavedGameState>('currentGameState') || null;
    
    if (gameState) {
      hilog.info(DOMAIN, TAG, 'âš¡ ä» AppStorage è¯»å–åˆ°å®æ—¶æ¸¸æˆçŠ¶æ€');
      hilog.info(DOMAIN, TAG, `   - æ¨¡å¼: ${gameState.gameMode}`);
      hilog.info(DOMAIN, TAG, `   - æ­¥æ•°: ${gameState.moveCount}`);
      hilog.info(DOMAIN, TAG, `   - ç”¨æ—¶: ${gameState.timeElapsed}ç§’`);
    } else {
      // Fallback: ä» preferences è¯»å–æŒä¹…åŒ–çŠ¶æ€
      hilog.info(DOMAIN, TAG, 'ğŸ’¾ AppStorageæ— æ•°æ®ï¼Œä» preferences è¯»å–...');
      gameState = await GameStorage.loadGameState();
    }
    
    // æ„å»ºå¡ç‰‡æ•°æ®
    let formData: FormDataContent;
    
    if (gameState && gameState.isPlaying) {
      // æœ‰è¿›è¡Œä¸­çš„æ¸¸æˆ
      const minutes = Math.floor(gameState.timeElapsed / 60);
      const seconds = gameState.timeElapsed % 60;
      const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      const gameModeChinese = gameState.gameMode === 'swap' ? 'äº¤æ¢' : 'æ»‘åŠ¨';
      
      formData = {
        title: 'æ‹¼å›¾æ¸¸æˆ',
        gameMode: gameModeChinese,
        gridSize: `${gameState.gridSize}Ã—${gameState.gridSize}`,
        moveCount: gameState.moveCount,
        timeElapsed: timeStr,
        hasActiveGame: true
      };
    } else {
      // æ— æ¸¸æˆæˆ–æ¸¸æˆæœªè¿›è¡Œä¸­
      formData = {
        title: 'æ‹¼å›¾æ¸¸æˆ',
        gameMode: 'äº¤æ¢',
        gridSize: '3Ã—3',
        moveCount: 0,
        timeElapsed: '00:00',
        hasActiveGame: false
      };
    }
    
    // æ›´æ–°æ‰€æœ‰å¡ç‰‡
    for (const formId of formIds) {
      try {
        await formProvider.updateForm(formId, formBindingData.createFormBindingData(formData));
        hilog.info(DOMAIN, TAG, `âœ… å¡ç‰‡ ${formId} æ›´æ–°æˆåŠŸ`);
      } catch (error) {
        hilog.error(DOMAIN, TAG, `âŒ å¡ç‰‡ ${formId} æ›´æ–°å¤±è´¥`);
      }
    }
    
    hilog.info(DOMAIN, TAG, '========== âœ… æ‰€æœ‰å¡ç‰‡æ›´æ–°å®Œæˆ ==========');
  } catch (error) {
    hilog.error(DOMAIN, TAG, 'âŒ æ›´æ–°å¡ç‰‡è¿‡ç¨‹å‡ºé”™');
  }
}

// åº”ç”¨åˆ‡æ¢åˆ°åå°æ—¶è§¦å‘
onBackground(): void {
  hilog.info(DOMAIN, TAG, '========== onBackground è§¦å‘ ==========');
  
  // ä¿å­˜éŸ³ä¹æ’­æ”¾ä½ç½®
  audioManager.savePlaybackPosition();
  
  // ğŸ”¥ å…³é”®ï¼šä¸»åŠ¨æ›´æ–°æ‰€æœ‰å¡ç‰‡ï¼Œå®ç°å®æ—¶åŒæ­¥
  this.updateAllForms();
}
```


### 3.2 å¡ç‰‡IDç®¡ç†

ä¸ºäº†æ›´æ–°æ¡Œé¢ä¸Šçš„æ‰€æœ‰å¡ç‰‡ï¼Œéœ€è¦çŸ¥é“æœ‰å“ªäº›å¡ç‰‡å­˜åœ¨ã€‚é€šè¿‡åœ¨FormAbilityçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¿å­˜/åˆ é™¤å¡ç‰‡IDæ¥å®ç°ã€‚

**PuzzleFormAbility.ets - å¡ç‰‡IDç®¡ç†**

```typescript
export default class PuzzleFormAbility extends FormExtensionAbility {
  /**
   * åˆ›å»ºå¡ç‰‡æ—¶è°ƒç”¨
   */
  onAddForm(want: Want): formBindingData.FormBindingData {
    hilog.info(DOMAIN, TAG, '========== onAddForm è°ƒç”¨ ==========');
    
    // è·å–å¡ç‰‡ID
    const formId: string = (want.parameters?.['ohos.extra.param.key.form_identity'] as string) || '';
    hilog.info(DOMAIN, TAG, 'è·å–åˆ°çš„å¡ç‰‡ID: %{public}s', formId);
    
    if (formId) {
      // ğŸ”¥ ç«‹å³ä¿å­˜å¡ç‰‡ID
      this.saveFormId(formId);
    }
    
    // å‡†å¤‡å¡ç‰‡æ•°æ®
    const formData: FormDataContent = {
      title: 'æ‹¼å›¾æ¸¸æˆ',
      gameMode: 'äº¤æ¢',
      gridSize: '3Ã—3',
      moveCount: 0,
      timeElapsed: '00:00',
      hasActiveGame: false
    };

    // å¼‚æ­¥åŠ è½½æ¸¸æˆçŠ¶æ€å¹¶æ›´æ–°å¡ç‰‡
    this.loadGameStateAsync(formId);

    return formBindingData.createFormBindingData(formData);
  }

  /**
   * ä¿å­˜å¡ç‰‡IDåˆ°æŒä¹…åŒ–å­˜å‚¨
   */
  private async saveFormId(formId: string): Promise<void> {
    try {
      // ğŸ”¥ å…³é”®ï¼šä½¿ç”¨åº”ç”¨çº§åˆ«çš„ contextï¼Œç¡®ä¿ä¸ EntryAbility å…±äº«åŒä¸€å­˜å‚¨
      const appContext = this.context.getApplicationContext();
      const dataPreferences = await preferences.getPreferences(appContext, 'formIds');
      
      // è¯»å–ç°æœ‰çš„å¡ç‰‡IDåˆ—è¡¨
      const formIdsStr = await dataPreferences.get('ids', '[]') as string;
      const formIds: Array<string> = JSON.parse(formIdsStr);
      
      // æ·»åŠ æ–°IDï¼ˆé¿å…é‡å¤ï¼‰
      if (!formIds.includes(formId)) {
        formIds.push(formId);
        await dataPreferences.put('ids', JSON.stringify(formIds));
        await dataPreferences.flush();
        hilog.info(DOMAIN, TAG, 'âœ… å¡ç‰‡IDå·²ä¿å­˜: %{public}s æ€»æ•°: %{public}d', formId, formIds.length);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'âŒ ä¿å­˜å¡ç‰‡IDå¤±è´¥');
    }
  }

  /**
   * åˆ é™¤å¡ç‰‡æ—¶è°ƒç”¨
   */
  onRemoveForm(formId: string): void {
    hilog.info(DOMAIN, TAG, '========== onRemoveForm è°ƒç”¨ ==========');
    hilog.info(DOMAIN, TAG, 'åˆ é™¤å¡ç‰‡ID: %{public}s', formId);
    
    // ä»æŒä¹…åŒ–å­˜å‚¨ç§»é™¤å¡ç‰‡ID
    this.removeFormId(formId);
  }

  /**
   * ä»æŒä¹…åŒ–å­˜å‚¨ç§»é™¤å¡ç‰‡ID
   */
  private async removeFormId(formId: string): Promise<void> {
    try {
      const appContext = this.context.getApplicationContext();
      const dataPreferences = await preferences.getPreferences(appContext, 'formIds');
      
      // è¯»å–ç°æœ‰çš„å¡ç‰‡IDåˆ—è¡¨
      const formIdsStr = await dataPreferences.get('ids', '[]') as string;
      const formIds: Array<string> = JSON.parse(formIdsStr);
      
      // ç§»é™¤ID
      const index = formIds.indexOf(formId);
      if (index > -1) {
        formIds.splice(index, 1);
        await dataPreferences.put('ids', JSON.stringify(formIds));
        await dataPreferences.flush();
        hilog.info(DOMAIN, TAG, 'âœ… å¡ç‰‡IDå·²ç§»é™¤: %{public}s å‰©ä½™: %{public}d', formId, formIds.length);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'âŒ ç§»é™¤å¡ç‰‡IDå¤±è´¥');
    }
  }
}
```


### 3.3 å¡ç‰‡UIå®ç°

**WidgetCard.ets - å¡ç‰‡å¸ƒå±€**

```typescript
@Entry(LocalStorage.getShared())
@Component
struct WidgetCard {
  // ä»formDataæ¥æ”¶æ•°æ®
  @LocalStorageProp('title') title: string = 'æ‹¼å›¾æ¸¸æˆ';
  @LocalStorageProp('gameMode') gameMode: string = 'äº¤æ¢æ¨¡å¼';
  @LocalStorageProp('gridSize') gridSize: string = '3Ã—3';
  @LocalStorageProp('moveCount') moveCount: number = 0;
  @LocalStorageProp('timeElapsed') timeElapsed: string = '00:00';
  @LocalStorageProp('hasActiveGame') hasActiveGame: boolean = false;

  // å¯åŠ¨åº”ç”¨å¹¶è·³è½¬åˆ°æŒ‡å®šé¡µé¢
  private launchApp(targetPage: string): void {
    postCardAction(this, {
      action: 'router',
      abilityName: 'EntryAbility',
      params: {
        targetPage: targetPage
      }
    });
  }

  build() {
    Column({ space: 10 }) {
      // æ ‡é¢˜æ 
      Row() {
        Text(this.title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#000000')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12 })

      if (this.hasActiveGame) {
        // æœ‰è¿›è¡Œä¸­çš„æ¸¸æˆ
        Column({ space: 8 }) {
          // æ¸¸æˆä¿¡æ¯
          Row({ space: 14 }) {
            Column({ space: 3 }) {
              Text('æ¨¡å¼')
                .fontSize(10)
                .fontColor('#666666')
              Text(this.gameMode)
                .fontSize(12)
                .fontColor('#000000')
                .fontWeight(FontWeight.Bold)
            }

            Column({ space: 3 }) {
              Text('éš¾åº¦')
                .fontSize(10)
                .fontColor('#666666')
              Text(this.gridSize)
                .fontSize(12)
                .fontColor('#000000')
                .fontWeight(FontWeight.Bold)
            }
          }
          .width('100%')
          .padding({ left: 16, right: 16 })

          // è¿›åº¦ä¿¡æ¯
          Row({ space: 14 }) {
            Row({ space: 4 }) {
              Text('ç”¨æ—¶:')
                .fontSize(12)
                .fontColor('#666666')
              Text(this.timeElapsed)
                .fontSize(12)
                .fontColor('#000000')
            }

            Row({ space: 4 }) {
              Text('æ­¥æ•°:')
                .fontSize(12)
                .fontColor('#666666')
              Text(`${this.moveCount}`)
                .fontSize(12)
                .fontColor('#000000')
            }
          }
          .width('100%')
          .padding({ left: 16, right: 16 })

          // æŒ‰é’®ç»„
          Row({ space: 8 }) {
            Button('ç»§ç»­')
              .width('45%')
              .height(36)
              .fontSize(13)
              .backgroundColor('#000000')
              .fontColor('#FFFFFF')
              .onClick(() => {
                this.launchApp('pages/GamePage');  // ç»§ç»­æ¸¸æˆ
              })
            
            Button('ä¸»é¢˜')
              .width('45%')
              .height(36)
              .fontSize(13)
              .backgroundColor('#FFFFFF')
              .fontColor('#000000')
              .onClick(() => {
                this.launchApp('pages/ThemeSelectionPage');  // é€‰æ‹©ä¸»é¢˜
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
      } else {
        // æ— è¿›è¡Œä¸­çš„æ¸¸æˆ
        Column({ space: 10 }) {
          Text('æš‚æ— è¿›è¡Œä¸­çš„æ¸¸æˆ')
            .fontSize(12)
            .fontColor('#666666')

          Button('å¼€å§‹æ–°æ¸¸æˆ')
            .width('88%')
            .height(36)
            .fontSize(13)
            .backgroundColor('#000000')
            .fontColor('#FFFFFF')
            .onClick(() => {
              this.launchApp('pages/ThemeSelectionPage');
            })
        }
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
    .border({ width: 3, color: '#000000' })
    .borderRadius(12)
  }
}
```


### 3.4 ä»å¡ç‰‡å¯åŠ¨åº”ç”¨

å½“ç”¨æˆ·ç‚¹å‡»å¡ç‰‡ä¸Šçš„æŒ‰é’®æ—¶ï¼Œéœ€è¦å¯åŠ¨åº”ç”¨å¹¶è·³è½¬åˆ°æŒ‡å®šé¡µé¢ã€‚

**EntryAbility.ets - å¤„ç†å¡ç‰‡å¯åŠ¨**

```typescript
/**
 * å¤„ç†å·²è¿è¡Œåº”ç”¨è¢«å¡ç‰‡å†æ¬¡å”¤èµ·çš„æƒ…å†µ
 */
onNewWant(want: Want, launchParam: AbilityConstant.LaunchParam): void {
  hilog.info(DOMAIN, TAG, '========== onNewWant è§¦å‘ ==========');
  
  if (want.parameters) {
    const targetPage = want.parameters['targetPage'] as string;
    if (targetPage) {
      hilog.info(DOMAIN, TAG, 'ğŸ¯ å¡ç‰‡å”¤èµ·åº”ç”¨ï¼Œç›®æ ‡é¡µé¢: %{public}s', targetPage);
      
      // ğŸ”¥ å…³é”®ï¼šä¿å­˜åˆ° AppStorageï¼Œè®©å½“å‰é¡µé¢å“åº”è·³è½¬
      AppStorage.setOrCreate('widgetTargetPage', targetPage);
      AppStorage.setOrCreate('widgetTargetPageTimestamp', Date.now());  // æ·»åŠ æ—¶é—´æˆ³ç¡®ä¿è§¦å‘æ›´æ–°
      
      hilog.info(DOMAIN, TAG, 'âœ… ç›®æ ‡é¡µé¢å·²ä¿å­˜åˆ° AppStorage');
    }
  }
}

/**
 * é¦–æ¬¡å¯åŠ¨æ—¶å¤„ç†å¡ç‰‡è·³è½¬
 */
onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
  // æ£€æŸ¥æ˜¯å¦ä»å¡ç‰‡å¯åŠ¨
  if (want.parameters) {
    const targetPage = want.parameters['targetPage'] as string;
    if (targetPage) {
      this.targetPage = targetPage;
      hilog.info(DOMAIN, TAG, 'ä»å¡ç‰‡å¯åŠ¨ï¼Œç›®æ ‡é¡µé¢: %{public}s', targetPage);
    }
  }
  
  // ä¿å­˜contextåˆ°AppStorage
  AppStorage.setOrCreate('context', this.context);
  GameStorage.setContext(this.context);
}

async onWindowStageCreate(windowStage: window.WindowStage): Promise<void> {
  // åˆå§‹åŒ–å±å¹•çŠ¶æ€ç®¡ç†å™¨
  const screenManager = ScreenStateManager.getInstance();
  await screenManager.init(windowStage);
  
  // åŠ è½½ç›®æ ‡é¡µé¢ï¼ˆæ”¯æŒä»å¡ç‰‡å¯åŠ¨è·³è½¬ï¼‰
  hilog.info(DOMAIN, TAG, 'å‡†å¤‡åŠ è½½é¡µé¢: %{public}s', this.targetPage);
  windowStage.loadContent(this.targetPage, (err) => {
    if (err.code) {
      hilog.error(DOMAIN, TAG, 'é¡µé¢åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°é»˜è®¤é¡µé¢');
      windowStage.loadContent('pages/EntryPage');
    } else {
      hilog.info(DOMAIN, TAG, 'âœ… é¡µé¢åŠ è½½æˆåŠŸ');
    }
    // é‡ç½®ç›®æ ‡é¡µé¢ä¸ºé»˜è®¤å€¼
    this.targetPage = 'pages/EntryPage';
  });
}
```

**GamePage.ets - å“åº”å¡ç‰‡è·³è½¬**

```typescript
@Entry
@Component
struct GamePage {
  // ğŸ”¥ å¡ç‰‡è·³è½¬ç›‘å¬
  @StorageProp('widgetTargetPage') widgetTargetPage: string = '';
  @StorageProp('widgetTargetPageTimestamp') widgetTargetPageTimestamp: number = 0;
  private lastProcessedTimestamp: number = 0;  // è®°å½•å·²å¤„ç†çš„è·³è½¬è¯·æ±‚

  // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥å¡ç‰‡è·³è½¬
  onPageShow() {
    console.info('[GamePage] ğŸ“º é¡µé¢æ˜¾ç¤ºï¼Œæ£€æŸ¥å¡ç‰‡è·³è½¬è¯·æ±‚...');
    this.checkWidgetNavigation();
    
    // ç¡®ä¿éŸ³ä¹æ’­æ”¾
    audioManager.resumeBGM();
  }
  
  /**
   * æ£€æŸ¥å¹¶å¤„ç†å¡ç‰‡è·³è½¬ï¼ˆå¸¦æ—¶é—´æˆ³æ ¡éªŒï¼‰
   */
  private checkWidgetNavigation(): void {
    // åªå¤„ç†æ–°çš„è·³è½¬è¯·æ±‚ï¼ˆé€šè¿‡æ—¶é—´æˆ³åˆ¤æ–­ï¼Œé¿å…é‡å¤è·³è½¬ï¼‰
    if (this.widgetTargetPage && 
        this.widgetTargetPageTimestamp > 0 && 
        this.widgetTargetPageTimestamp !== this.lastProcessedTimestamp) {
      
      console.info(`[GamePage] ğŸ¯ æ£€æµ‹åˆ°å¡ç‰‡è·³è½¬è¯·æ±‚:`);
      console.info(`[GamePage]   - ç›®æ ‡é¡µé¢: ${this.widgetTargetPage}`);
      console.info(`[GamePage]   - è¯·æ±‚æ—¶é—´æˆ³: ${this.widgetTargetPageTimestamp}`);
      
      // å¦‚æœç›®æ ‡é¡µé¢ä¸æ˜¯å½“å‰é¡µé¢ï¼Œåˆ™è·³è½¬
      if (this.widgetTargetPage !== 'pages/GamePage') {
        console.info(`[GamePage] ğŸš€ æ‰§è¡Œè·³è½¬åˆ°: ${this.widgetTargetPage}`);
        
        // ä¿å­˜ç›®æ ‡é¡µé¢åˆ°å±€éƒ¨å˜é‡
        const targetPageToNavigate = this.widgetTargetPage;
        
        // è®°å½•å·²å¤„ç†çš„æ—¶é—´æˆ³
        this.lastProcessedTimestamp = this.widgetTargetPageTimestamp;
        
        // æ¸…é™¤æ ‡è®°ï¼Œé¿å…é‡å¤è·³è½¬
        AppStorage.setOrCreate('widgetTargetPage', '');
        AppStorage.setOrCreate('widgetTargetPageTimestamp', 0);
        
        // æ‰§è¡Œè·³è½¬
        setTimeout(() => {
          router.pushUrl({
            url: targetPageToNavigate
          }).then(() => {
            console.info(`[GamePage] âœ… è·³è½¬æˆåŠŸ`);
          }).catch((err: Error) => {
            console.error(`[GamePage] âŒ è·³è½¬å¤±è´¥: ${err.message}`);
          });
        }, 100);
      } else {
        console.info(`[GamePage] â„¹ï¸ ç›®æ ‡é¡µé¢æ˜¯å½“å‰é¡µé¢ï¼Œå¿½ç•¥è·³è½¬`);
        // è®°å½•å·²å¤„ç†å¹¶æ¸…é™¤æ ‡è®°
        this.lastProcessedTimestamp = this.widgetTargetPageTimestamp;
        AppStorage.setOrCreate('widgetTargetPage', '');
        AppStorage.setOrCreate('widgetTargetPageTimestamp', 0);
      }
    }
  }
}
```


### 3.5 æ•°æ®æŒä¹…åŒ–å·¥å…·

**GameStorage.ets - å®Œæ•´å®ç°**

```typescript
import { preferences } from '@kit.ArkData';
import { common } from '@kit.AbilityKit';

/**
 * ä¿å­˜çš„æ¸¸æˆçŠ¶æ€æ¥å£
 */
export interface SavedGameState {
  gameMode: string;
  gridSize: number;
  moveCount: number;
  timeElapsed: number;
  isPlaying: boolean;
  timestamp?: number;  // ä¿å­˜æ—¶é—´æˆ³ï¼Œç”¨äºæ£€æµ‹è¿‡æœŸæ•°æ®
}

/**
 * æ¸¸æˆæ•°æ®æŒä¹…åŒ–å·¥å…·
 */
export class GameStorage {
  private static context: common.Context | null = null;
  private static readonly PREFERENCES_NAME = 'puzzle_game_prefs';
  private static readonly KEY_GAME_STATE = 'game_state';

  /**
   * è®¾ç½®ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒè·¨è¿›ç¨‹ï¼ˆå¦‚FormAbilityï¼‰æ˜¾å¼æ³¨å…¥
   */
  static setContext(context: common.Context): void {
    GameStorage.context = context;
  }

  /**
   * è·å–ä¸Šä¸‹æ–‡ï¼šä¼˜å…ˆè¿”å›æ˜¾å¼æ³¨å…¥ï¼Œå…¶æ¬¡å°è¯•ä»AppStorageè¯»å–
   */
  private static getContext(): common.Context {
    if (GameStorage.context) {
      return GameStorage.context;
    }
    const storedContext = AppStorage.get<common.UIAbilityContext>('context');
    if (storedContext) {
      GameStorage.context = storedContext;
      return storedContext;
    }
    throw new Error('Contextæœªåˆå§‹åŒ–ï¼Œè¯·åœ¨EntryAbilityä¸­ä¿å­˜contextæˆ–è°ƒç”¨GameStorage.setContext');
  }

  /**
   * ä¿å­˜æ¸¸æˆçŠ¶æ€
   */
  static async saveGameState(state: SavedGameState): Promise<void> {
    try {
      const context = GameStorage.getContext();
      const prefs = await preferences.getPreferences(context, GameStorage.PREFERENCES_NAME);
      await prefs.put(GameStorage.KEY_GAME_STATE, JSON.stringify(state));
      await prefs.flush();
      console.info('[GameStorage] âœ… æ¸¸æˆçŠ¶æ€å·²ä¿å­˜åˆ°Preferences');
    } catch (error) {
      console.error('[GameStorage] âŒ ä¿å­˜æ¸¸æˆçŠ¶æ€å¤±è´¥:', error);
    }
  }

  /**
   * è¯»å–æ¸¸æˆçŠ¶æ€
   */
  static async loadGameState(): Promise<SavedGameState | null> {
    try {
      const context = GameStorage.getContext();
      const prefs = await preferences.getPreferences(context, GameStorage.PREFERENCES_NAME);
      const stateStr = await prefs.get(GameStorage.KEY_GAME_STATE, '');
      
      if (stateStr) {
        return JSON.parse(stateStr as string) as SavedGameState;
      }
      return null;
    } catch (error) {
      console.error('[GameStorage] âŒ è¯»å–æ¸¸æˆçŠ¶æ€å¤±è´¥:', error);
      return null;
    }
  }

  /**
   * æ¸…é™¤æ¸¸æˆçŠ¶æ€
   */
  static async clearGameState(): Promise<void> {
    try {
      const context = GameStorage.getContext();
      const prefs = await preferences.getPreferences(context, GameStorage.PREFERENCES_NAME);
      await prefs.delete(GameStorage.KEY_GAME_STATE);
      await prefs.flush();
      console.info('[GameStorage] âœ… æ¸¸æˆçŠ¶æ€å·²æ¸…é™¤');
    } catch (error) {
      console.error('[GameStorage] âŒ æ¸…é™¤æ¸¸æˆçŠ¶æ€å¤±è´¥:', error);
    }
  }
}
```

---

## å…³é”®æŠ€æœ¯ç‚¹

### 4.1 æ—¶é—´æˆ³è¿‡æœŸæ£€æµ‹

ä¸ºäº†è§£å†³åº”ç”¨è¢«å¼ºåˆ¶å…³é—­åå¡ç‰‡ä»æ˜¾ç¤ºæ—§æ•°æ®çš„é—®é¢˜ï¼Œåœ¨æ¸¸æˆçŠ¶æ€ä¸­æ·»åŠ æ—¶é—´æˆ³ï¼ŒFormAbilityå®šæ—¶åˆ·æ–°æ—¶æ£€æµ‹æ•°æ®æ˜¯å¦è¿‡æœŸã€‚

**PuzzleFormAbility.ets - è¿‡æœŸæ£€æµ‹**

```typescript
/**
 * å¡ç‰‡æ›´æ–°æ—¶è°ƒç”¨ï¼ˆç³»ç»Ÿå®šæ—¶åˆ·æ–°ï¼Œé»˜è®¤5åˆ†é’Ÿï¼‰
 */
onUpdateForm(formId: string): void {
  hilog.info(DOMAIN, TAG, '========== onUpdateForm è§¦å‘ï¼ˆç³»ç»Ÿåˆ·æ–°ï¼‰==========');
  
  // ä½¿ç”¨å¸¦è¿‡æœŸæ£€æµ‹çš„åŠ è½½æ–¹æ³•
  this.loadGameStateWithCleanupCheck(formId);
}

/**
 * åŠ è½½æ¸¸æˆçŠ¶æ€å¹¶æ¸…ç†è¿‡æœŸæ•°æ®
 */
private async loadGameStateWithCleanupCheck(formId: string): Promise<void> {
  try {
    const gameState = await GameStorage.loadGameState();
    
    let formData: FormDataContent;
    
    if (gameState && gameState.isPlaying) {
      // æ£€æµ‹æ¸¸æˆæ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡8åˆ†é’Ÿæœªæ›´æ–°ï¼‰
      const savedTime = gameState.timestamp || 0;
      const currentTime = Date.now();
      const hoursSinceUpdate = (currentTime - savedTime) / (1000 * 60 * 60);
      
      if (savedTime > 0 && hoursSinceUpdate > 0.133) {  // 0.133 å°æ—¶ = 8 åˆ†é’Ÿ
        hilog.warn(DOMAIN, TAG, 'âš ï¸ æ¸¸æˆæ•°æ®è¿‡æœŸï¼ˆ%.1f å°æ—¶æœªæ›´æ–°ï¼‰ï¼Œæ¸…é™¤çŠ¶æ€', hoursSinceUpdate);
        
        // æ¸…é™¤è¿‡æœŸæ¸¸æˆçŠ¶æ€
        await GameStorage.clearGameState();
        
        // æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"
        formData = this.createDefaultFormData();
      } else {
        // æ¸¸æˆçŠ¶æ€æœ‰æ•ˆ
        formData = this.createFormDataFromGameState(gameState);
      }
    } else {
      formData = this.createDefaultFormData();
    }

    // æ›´æ–°å¡ç‰‡
    await formProvider.updateForm(formId, formBindingData.createFormBindingData(formData));
    hilog.info(DOMAIN, TAG, 'âœ… å¡ç‰‡æ›´æ–°æˆåŠŸ');
  } catch (error) {
    hilog.error(DOMAIN, TAG, 'âŒ æ›´æ–°å¡ç‰‡å¤±è´¥');
  }
}
```


### 4.2 åº”ç”¨é”€æ¯æ—¶çš„æ•°æ®æ¸…ç†

å½“åº”ç”¨è¢«å¼ºåˆ¶å…³é—­æ—¶ï¼Œéœ€è¦ç«‹å³æ¸…é™¤æ¸¸æˆçŠ¶æ€å¹¶æ›´æ–°å¡ç‰‡ã€‚

**EntryAbility.ets - onDestroyå¤„ç†**

```typescript
onDestroy(): void {
  hilog.info(DOMAIN, TAG, '========== ğŸ”´ onDestroy è§¦å‘ï¼ˆåº”ç”¨è¢«é”€æ¯ï¼‰==========');
  
  // ğŸ”¥ å…³é”®ï¼šåº”ç”¨è¢«é”€æ¯æ—¶ï¼Œç«‹å³æ›´æ–°å¡ç‰‡æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"
  this.updateAllFormsOnDestroy();
}

/**
 * åº”ç”¨é”€æ¯æ—¶æ›´æ–°æ‰€æœ‰å¡ç‰‡
 * ä½¿ç”¨ fire-and-forget æ¨¡å¼ï¼Œä¸ç­‰å¾…å®Œæˆ
 */
private updateAllFormsOnDestroy(): void {
  // ä½¿ç”¨å¼‚æ­¥ç«‹å³æ‰§è¡Œå‡½æ•°ï¼ˆä¸é˜»å¡ onDestroyï¼‰
  (async () => {
    try {
      hilog.info(DOMAIN, TAG, 'ğŸ”„ å¼€å§‹æ›´æ–°å¡ç‰‡ï¼ˆåº”ç”¨é”€æ¯ï¼‰');
      
      // ğŸ”¥ å…³é”®ç¬¬ä¸€æ­¥ï¼šæ¸…é™¤ preferences ä¸­çš„æ¸¸æˆçŠ¶æ€
      // é˜²æ­¢å®šæ—¶åˆ·æ–°æ—¶ FormAbility è¯»å–åˆ°æ—§æ•°æ®
      await GameStorage.clearGameState();
      hilog.info(DOMAIN, TAG, 'âœ… æ¸¸æˆçŠ¶æ€å·²æ¸…é™¤');
      
      // ç¬¬äºŒæ­¥ï¼šè¯»å–å¡ç‰‡ID
      const appContext = this.context.getApplicationContext();
      const dataPreferences = await preferences.getPreferences(appContext, 'formIds');
      const formIdsStr = await dataPreferences.get('ids', '[]') as string;
      const formIds: Array<string> = JSON.parse(formIdsStr);
      
      hilog.info(DOMAIN, TAG, `ğŸ“‹ è¯»å–åˆ° ${formIds.length} ä¸ªå¡ç‰‡`);
      
      if (formIds.length === 0) {
        return;
      }
      
      // ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º"å¼€å§‹æ–°æ¸¸æˆ"çš„å¡ç‰‡æ•°æ®
      const formData: FormDataContent = {
        title: 'æ‹¼å›¾æ¸¸æˆ',
        gameMode: 'äº¤æ¢',
        gridSize: '3Ã—3',
        moveCount: 0,
        timeElapsed: '00:00',
        hasActiveGame: false
      };
      
      // ç¬¬å››æ­¥ï¼šæ›´æ–°æ‰€æœ‰å¡ç‰‡
      for (const formId of formIds) {
        try {
          await formProvider.updateForm(formId, formBindingData.createFormBindingData(formData));
          hilog.info(DOMAIN, TAG, `âœ… å¡ç‰‡ ${formId} æ›´æ–°æˆåŠŸ`);
        } catch (error) {
          hilog.error(DOMAIN, TAG, `âŒ å¡ç‰‡ ${formId} æ›´æ–°å¤±è´¥`);
        }
      }
      
      hilog.info(DOMAIN, TAG, 'âœ… æ‰€æœ‰å¡ç‰‡æ›´æ–°å®Œæˆï¼ˆåº”ç”¨é”€æ¯ï¼‰');
    } catch (error) {
      hilog.error(DOMAIN, TAG, `âŒ onDestroy æ›´æ–°å¡ç‰‡å¤±è´¥`);
    }
  })();
}
```

### 4.3 å¡ç‰‡é…ç½®æ–‡ä»¶

**form_config.json - å¡ç‰‡é…ç½®**

```json
{
  "forms": [
    {
      "name": "PuzzleWidget",
      "description": "$string:widget_description",
      "src": "./ets/widget/pages/WidgetCard.ets",
      "uiSyntax": "arkts",
      "isDynamic": true,
      "window": {
        "designWidth": 720,
        "autoDesignWidth": true
      },
      "colorMode": "auto",
      "isDefault": true,
      "updateEnabled": true,
      "scheduledUpdateTime": "10:30",
      "updateDuration": 5,
      "defaultDimension": "2*2",
      "supportDimensions": [
        "2*2",
        "4*4"
      ]
    }
  ]
}
```

**é…ç½®è¯´æ˜**ï¼š
- `isDynamic: true` - åŠ¨æ€å¡ç‰‡ï¼Œæ”¯æŒæ•°æ®æ›´æ–°
- `updateEnabled: true` - å¯ç”¨å®šæ—¶æ›´æ–°
- `updateDuration: 5` - å®šæ—¶æ›´æ–°é—´éš”ï¼ˆ5åˆ†é’Ÿï¼‰
- `defaultDimension: "2*2"` - é»˜è®¤å°ºå¯¸
- `supportDimensions` - æ”¯æŒçš„å°ºå¯¸åˆ—è¡¨

---

## æµ‹è¯•éªŒè¯

### 5.1 æµ‹è¯•åœºæ™¯

#### åœºæ™¯1ï¼šé¦–æ¬¡æ·»åŠ å¡ç‰‡

**æ“ä½œæ­¥éª¤**ï¼š
1. é•¿æŒ‰åº”ç”¨å›¾æ ‡
2. é€‰æ‹©"æœåŠ¡å¡ç‰‡"
3. æ·»åŠ åˆ°æ¡Œé¢

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¡ç‰‡æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"æŒ‰é’®
- âœ… æ— æ¸¸æˆè¿›åº¦ä¿¡æ¯
- âœ… å¡ç‰‡IDå·²ä¿å­˜åˆ°Preferences

**éªŒè¯æ—¥å¿—**ï¼š
```
[FormAbility] ========== onAddForm è°ƒç”¨ ==========
[FormAbility] è·å–åˆ°çš„å¡ç‰‡ID: 123456789
[FormAbility] âœ… å¡ç‰‡IDå·²ä¿å­˜: 123456789 æ€»æ•°: 1
```


#### åœºæ™¯2ï¼šæ¸¸æˆè¿›è¡Œä¸­åˆ‡æ¢åå°ï¼ˆæ ¸å¿ƒæµ‹è¯•ï¼‰â­

**æ“ä½œæ­¥éª¤**ï¼š
1. å¯åŠ¨åº”ç”¨ï¼Œå¼€å§‹æ¸¸æˆ
2. ç§»åŠ¨æ–¹å—10æ¬¡
3. ç­‰å¾…30ç§’ï¼ˆè®¡æ—¶å™¨è¿è¡Œï¼‰
4. **æŒ‰Homeé”®** ğŸ”¥ å…³é”®æ—¶åˆ»ï¼
5. æŸ¥çœ‹æ¡Œé¢å¡ç‰‡

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¡ç‰‡**ç«‹å³æ˜¾ç¤º**æœ€æ–°çŠ¶æ€ï¼ˆé›¶å»¶è¿Ÿï¼‰
- âœ… æ˜¾ç¤º"ç»§ç»­"å’Œ"ä¸»é¢˜"ä¸¤ä¸ªæŒ‰é’®
- âœ… æ­¥æ•°æ˜¾ç¤ºï¼š10
- âœ… ç”¨æ—¶æ˜¾ç¤ºï¼š00:30
- âœ… æ¨¡å¼æ˜¾ç¤ºï¼šäº¤æ¢
- âœ… éš¾åº¦æ˜¾ç¤ºï¼š3Ã—3

**éªŒè¯æ—¥å¿—**ï¼š
```
[GamePage] âš¡ AppStorageå·²æ›´æ–°: æ­¥æ•°=10, ç”¨æ—¶=30
[EntryAbility] ========== onBackground è§¦å‘ ==========
[EntryAbility] ========== ğŸ”„ å¼€å§‹æ›´æ–°æ‰€æœ‰å¡ç‰‡ ==========
[EntryAbility] ğŸ“‹ è¯»å–åˆ° 1 ä¸ªå¡ç‰‡ID
[EntryAbility] âš¡ ä» AppStorage è¯»å–åˆ°å®æ—¶æ¸¸æˆçŠ¶æ€
[EntryAbility]    - æ¨¡å¼: swap
[EntryAbility]    - æ­¥æ•°: 10
[EntryAbility]    - ç”¨æ—¶: 30ç§’
[EntryAbility]    - è¿›è¡Œä¸­: true
[EntryAbility] ğŸ“Š å¡ç‰‡å°†æ˜¾ç¤º: ç»§ç»­æ¸¸æˆ / ä¸»é¢˜
[EntryAbility] âœ… å¡ç‰‡ 123456789 æ›´æ–°æˆåŠŸ
[EntryAbility] ========== âœ… æ‰€æœ‰å¡ç‰‡æ›´æ–°å®Œæˆ ==========
```

#### åœºæ™¯3ï¼šä»å¡ç‰‡ç»§ç»­æ¸¸æˆ

**æ“ä½œæ­¥éª¤**ï¼š
1. åœ¨åœºæ™¯2çš„åŸºç¡€ä¸Š
2. ç‚¹å‡»å¡ç‰‡çš„"ç»§ç»­"æŒ‰é’®

**é¢„æœŸç»“æœ**ï¼š
- âœ… åº”ç”¨å¯åŠ¨ï¼ˆå¦‚æœå·²å…³é—­ï¼‰æˆ–å›åˆ°å‰å°
- âœ… ç›´æ¥è¿›å…¥GamePage
- âœ… æ¸¸æˆçŠ¶æ€ä¿æŒï¼ˆæ­¥æ•°=10ï¼Œç”¨æ—¶=00:30ï¼‰
- âœ… å¯ä»¥ç»§ç»­æ¸¸æˆ

**éªŒè¯æ—¥å¿—**ï¼š
```
[EntryAbility] ========== onNewWant è§¦å‘ ==========
[EntryAbility] ğŸ¯ å¡ç‰‡å”¤èµ·åº”ç”¨ï¼Œç›®æ ‡é¡µé¢: pages/GamePage
[EntryAbility] âœ… ç›®æ ‡é¡µé¢å·²ä¿å­˜åˆ° AppStorage
[GamePage] ğŸ“º é¡µé¢æ˜¾ç¤ºï¼Œæ£€æŸ¥å¡ç‰‡è·³è½¬è¯·æ±‚...
[GamePage] â„¹ï¸ ç›®æ ‡é¡µé¢æ˜¯å½“å‰é¡µé¢ï¼Œå¿½ç•¥è·³è½¬
```

#### åœºæ™¯4ï¼šä»å¡ç‰‡é€‰æ‹©ä¸»é¢˜

**æ“ä½œæ­¥éª¤**ï¼š
1. åœ¨åœºæ™¯2çš„åŸºç¡€ä¸Š
2. ç‚¹å‡»å¡ç‰‡çš„"ä¸»é¢˜"æŒ‰é’®

**é¢„æœŸç»“æœ**ï¼š
- âœ… åº”ç”¨å¯åŠ¨
- âœ… è·³è½¬åˆ°ThemeSelectionPage
- âœ… å¯ä»¥å¼€å§‹æ–°æ¸¸æˆ

**éªŒè¯æ—¥å¿—**ï¼š
```
[EntryAbility] ========== onNewWant è§¦å‘ ==========
[EntryAbility] ğŸ¯ å¡ç‰‡å”¤èµ·åº”ç”¨ï¼Œç›®æ ‡é¡µé¢: pages/ThemeSelectionPage
[GamePage] ğŸ¯ æ£€æµ‹åˆ°å¡ç‰‡è·³è½¬è¯·æ±‚
[GamePage] ğŸš€ æ‰§è¡Œè·³è½¬åˆ°: pages/ThemeSelectionPage
[GamePage] âœ… è·³è½¬æˆåŠŸ
```

#### åœºæ™¯5ï¼šå®Œæˆæ¸¸æˆ

**æ“ä½œæ­¥éª¤**ï¼š
1. å®Œæˆæ‹¼å›¾
2. æŒ‰Homeé”®
3. æŸ¥çœ‹æ¡Œé¢å¡ç‰‡

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¡ç‰‡æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"ï¼ˆå› ä¸ºæ¸¸æˆå·²å®Œæˆï¼ŒisPlaying=falseï¼‰
- âœ… æ¸¸æˆçŠ¶æ€å·²æ¸…é™¤

**éªŒè¯æ—¥å¿—**ï¼š
```
[GamePage] ğŸ† æ¸¸æˆå®Œæˆï¼Œå·²æ¸…é™¤çŠ¶æ€
[EntryAbility] ========== onBackground è§¦å‘ ==========
[EntryAbility] âš¡ ä» AppStorage è¯»å–åˆ°å®æ—¶æ¸¸æˆçŠ¶æ€
[EntryAbility]    - è¿›è¡Œä¸­: false
[EntryAbility] ğŸ“Š å¡ç‰‡å°†æ˜¾ç¤º: å¼€å§‹æ–°æ¸¸æˆ
```

#### åœºæ™¯6ï¼šåº”ç”¨é‡å¯å

**æ“ä½œæ­¥éª¤**ï¼š
1. ç©æ¸¸æˆåˆ°ä¸€åŠï¼ˆæ­¥æ•°=5ï¼‰
2. æŒ‰Homeé”®
3. **æ€æ‰åº”ç”¨**ï¼ˆä»æœ€è¿‘ä»»åŠ¡æ¸…é™¤ï¼‰
4. æŸ¥çœ‹æ¡Œé¢å¡ç‰‡

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¡ç‰‡ä»**Preferences**è¯»å–çŠ¶æ€ï¼ˆå› ä¸ºAppStorageå·²æ¸…ç©ºï¼‰
- âœ… æ˜¾ç¤ºä¸Šæ¬¡æ¸¸æˆè¿›åº¦ï¼ˆæ­¥æ•°=5ï¼‰
- âœ… ç‚¹å‡»"ç»§ç»­"å¯ä»¥æ¢å¤æ¸¸æˆ

**éªŒè¯æ—¥å¿—**ï¼š
```
[FormAbility] ========== onUpdateForm è§¦å‘ï¼ˆç³»ç»Ÿåˆ·æ–°ï¼‰==========
[FormAbility] ğŸ’¾ ä» Preferences è¯»å–æ¸¸æˆçŠ¶æ€
[FormAbility] ğŸ“Š å¡ç‰‡æ˜¾ç¤º: ç»§ç»­æ¸¸æˆï¼ˆæ•°æ®æœ‰æ•ˆï¼‰
[FormAbility] âœ… å¡ç‰‡æ›´æ–°æˆåŠŸ
```

#### åœºæ™¯7ï¼šåº”ç”¨è¢«å¼ºåˆ¶å…³é—­

**æ“ä½œæ­¥éª¤**ï¼š
1. ç©æ¸¸æˆåˆ°ä¸€åŠ
2. æŒ‰Homeé”®
3. ä»ç³»ç»Ÿè®¾ç½®å¼ºåˆ¶åœæ­¢åº”ç”¨

**é¢„æœŸç»“æœ**ï¼š
- âœ… onDestroy()è¢«è°ƒç”¨
- âœ… æ¸¸æˆçŠ¶æ€è¢«æ¸…é™¤
- âœ… å¡ç‰‡æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"

**éªŒè¯æ—¥å¿—**ï¼š
```
[EntryAbility] ========== ğŸ”´ onDestroy è§¦å‘ï¼ˆåº”ç”¨è¢«é”€æ¯ï¼‰==========
[EntryAbility] ğŸ”„ å¼€å§‹æ›´æ–°å¡ç‰‡ï¼ˆåº”ç”¨é”€æ¯ï¼‰
[EntryAbility] âœ… æ¸¸æˆçŠ¶æ€å·²æ¸…é™¤
[EntryAbility] âœ… æ‰€æœ‰å¡ç‰‡æ›´æ–°å®Œæˆï¼ˆåº”ç”¨é”€æ¯ï¼‰
```


### 5.2 è°ƒè¯•æŠ€å·§

#### æŸ¥çœ‹AppStorageå†…å®¹

```typescript
// åœ¨ä»»ä½•é¡µé¢ä¸­æ·»åŠ 
const currentState = AppStorage.get<SavedGameState>('currentGameState');
console.info('[Debug] AppStorageå†…å®¹:', JSON.stringify(currentState));
```

#### æŸ¥çœ‹Preferenceså†…å®¹

```typescript
// åœ¨GameStorageä¸­æ·»åŠ è°ƒè¯•æ–¹æ³•
static async debugPrintAll(): Promise<void> {
  const gameState = await GameStorage.loadGameState();
  console.info('========== Preferenceså†…å®¹ ==========');
  console.info('æ¸¸æˆçŠ¶æ€:', JSON.stringify(gameState));
  console.info('=====================================');
}
```

#### æŸ¥çœ‹å¡ç‰‡IDåˆ—è¡¨

```typescript
// åœ¨EntryAbilityä¸­æ·»åŠ 
private async debugPrintFormIds(): Promise<void> {
  const appContext = this.context.getApplicationContext();
  const dataPreferences = await preferences.getPreferences(appContext, 'formIds');
  const formIdsStr = await dataPreferences.get('ids', '[]') as string;
  const formIds: Array<string> = JSON.parse(formIdsStr);
  console.info('========== å¡ç‰‡IDåˆ—è¡¨ ==========');
  console.info('æ€»æ•°:', formIds.length);
  console.info('IDåˆ—è¡¨:', formIds);
  console.info('================================');
}
```

#### è¿‡æ»¤æ—¥å¿—

ä½¿ç”¨hdcå‘½ä»¤è¿‡æ»¤å…³é”®æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹å¡ç‰‡ç›¸å…³æ—¥å¿—
hdc shell hilog | grep -E "EntryAbility|GamePage|FormAbility"

# æŸ¥çœ‹AppStorageæ“ä½œ
hdc shell hilog | grep "âš¡"

# æŸ¥çœ‹Preferencesæ“ä½œ
hdc shell hilog | grep "ğŸ’¾"

# æŸ¥çœ‹å¡ç‰‡æ›´æ–°
hdc shell hilog | grep "ğŸ”„"
```

---

## å¸¸è§é—®é¢˜

### 6.1 å¡ç‰‡ä¸æ›´æ–°

**é—®é¢˜æè¿°**ï¼šæ¸¸æˆè¿›è¡Œä¸­æŒ‰Homeé”®ï¼Œå¡ç‰‡ä»æ˜¾ç¤ºæ—§æ•°æ®æˆ–"å¼€å§‹æ–°æ¸¸æˆ"

**å¯èƒ½åŸå› **ï¼š
1. AppStorageä¿å­˜å¤±è´¥
2. EntryAbility.onBackground()æœªè§¦å‘
3. å¡ç‰‡IDæœªæ­£ç¡®ä¿å­˜

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`âš¡ AppStorageå·²æ›´æ–°`
2. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`onBackground è§¦å‘`
3. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`è¯»å–åˆ° X ä¸ªå¡ç‰‡ID`
4. ä½¿ç”¨è°ƒè¯•æ–¹æ³•æŸ¥çœ‹AppStorageå’ŒPreferenceså†…å®¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// ç¡®ä¿GamePageä¸­æ¯æ¬¡ç§»åŠ¨éƒ½è°ƒç”¨ä¿å­˜
private moveTile(index: number): void {
  // ... ç§»åŠ¨é€»è¾‘ ...
  this.moveCount++;
  
  // ğŸ”¥ å¿…é¡»è°ƒç”¨
  this.saveCurrentGameState();
}

// ç¡®ä¿EntryAbilityä¸­onBackgroundè°ƒç”¨æ›´æ–°
onBackground(): void {
  // ğŸ”¥ å¿…é¡»è°ƒç”¨
  this.updateAllForms();
}
```

### 6.2 ä»å¡ç‰‡å¯åŠ¨åº”ç”¨æ— æ³•è·³è½¬

**é—®é¢˜æè¿°**ï¼šç‚¹å‡»å¡ç‰‡æŒ‰é’®ï¼Œåº”ç”¨å¯åŠ¨ä½†åœç•™åœ¨EntryPage

**å¯èƒ½åŸå› **ï¼š
1. onNewWant()æœªæ­£ç¡®ä¿å­˜ç›®æ ‡é¡µé¢
2. GamePageæœªç›‘å¬widgetTargetPage
3. æ—¶é—´æˆ³æœªæ›´æ–°å¯¼è‡´ä¸è§¦å‘è·³è½¬

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`onNewWant è§¦å‘`
2. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`ç›®æ ‡é¡µé¢å·²ä¿å­˜åˆ° AppStorage`
3. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`æ£€æµ‹åˆ°å¡ç‰‡è·³è½¬è¯·æ±‚`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// EntryAbilityä¸­ç¡®ä¿ä¿å­˜æ—¶é—´æˆ³
onNewWant(want: Want, launchParam: AbilityConstant.LaunchParam): void {
  if (want.parameters) {
    const targetPage = want.parameters['targetPage'] as string;
    if (targetPage) {
      AppStorage.setOrCreate('widgetTargetPage', targetPage);
      // ğŸ”¥ å¿…é¡»è®¾ç½®æ—¶é—´æˆ³
      AppStorage.setOrCreate('widgetTargetPageTimestamp', Date.now());
    }
  }
}

// GamePageä¸­ç¡®ä¿ç›‘å¬
@StorageProp('widgetTargetPage') widgetTargetPage: string = '';
@StorageProp('widgetTargetPageTimestamp') widgetTargetPageTimestamp: number = 0;

// ç¡®ä¿onPageShowè°ƒç”¨æ£€æŸ¥
onPageShow() {
  this.checkWidgetNavigation();
}
```


### 6.3 åº”ç”¨é‡å¯åå¡ç‰‡ä¸æ˜¾ç¤ºæ¸¸æˆçŠ¶æ€

**é—®é¢˜æè¿°**ï¼šåº”ç”¨è¢«æ€æ‰åï¼Œå¡ç‰‡æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"è€Œä¸æ˜¯ä¸Šæ¬¡çš„æ¸¸æˆè¿›åº¦

**å¯èƒ½åŸå› **ï¼š
1. Preferencesä¿å­˜å¤±è´¥
2. FormAbilityè¯»å–Preferenceså¤±è´¥
3. æ•°æ®è¢«è¿‡æœŸæ£€æµ‹æ¸…é™¤

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`æ¸¸æˆçŠ¶æ€å·²ä¿å­˜åˆ°Preferences`
2. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`ä» Preferences è¯»å–æ¸¸æˆçŠ¶æ€`
3. æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦è¶…è¿‡8åˆ†é’Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// ç¡®ä¿GameStorageæ­£ç¡®åˆå§‹åŒ–
// EntryAbility.onCreate()
onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
  // ğŸ”¥ å¿…é¡»åˆå§‹åŒ–
  AppStorage.setOrCreate('context', this.context);
  GameStorage.setContext(this.context);
}

// FormAbilityä¸­ç¡®ä¿æ³¨å…¥context
private ensureStorageContext(): void {
  const appContext = this.context.getApplicationContext();
  GameStorage.setContext(appContext);
}
```

### 6.4 å¡ç‰‡IDä¸¢å¤±

**é—®é¢˜æè¿°**ï¼šæ·»åŠ å¡ç‰‡åï¼ŒEntryAbilityè¯»å–ä¸åˆ°å¡ç‰‡ID

**å¯èƒ½åŸå› **ï¼š
1. FormAbilityå’ŒEntryAbilityä½¿ç”¨äº†ä¸åŒçš„Preferenceså®ä¾‹
2. å¡ç‰‡IDä¿å­˜å¤±è´¥

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`å¡ç‰‡IDå·²ä¿å­˜`
2. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰`è¯»å–åˆ° X ä¸ªå¡ç‰‡ID`
3. ç¡®è®¤ä¸¤å¤„éƒ½ä½¿ç”¨äº†åº”ç”¨çº§åˆ«çš„context

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// ğŸ”¥ å…³é”®ï¼šä¸¤å¤„éƒ½å¿…é¡»ä½¿ç”¨åº”ç”¨çº§åˆ«çš„context
// FormAbility
private async saveFormId(formId: string): Promise<void> {
  const appContext = this.context.getApplicationContext();  // ğŸ”¥ åº”ç”¨çº§åˆ«
  const dataPreferences = await preferences.getPreferences(appContext, 'formIds');
  // ...
}

// EntryAbility
private async updateAllForms(): Promise<void> {
  const appContext = this.context.getApplicationContext();  // ğŸ”¥ åº”ç”¨çº§åˆ«
  const dataPreferences = await preferences.getPreferences(appContext, 'formIds');
  // ...
}
```

### 6.5 å¡ç‰‡æ˜¾ç¤ºè¿‡æœŸæ•°æ®

**é—®é¢˜æè¿°**ï¼šåº”ç”¨è¢«å¼ºåˆ¶å…³é—­å¾ˆä¹…åï¼Œå¡ç‰‡ä»æ˜¾ç¤ºæ—§çš„æ¸¸æˆè¿›åº¦

**å¯èƒ½åŸå› **ï¼š
1. onDestroy()æœªè¢«è°ƒç”¨
2. å®šæ—¶åˆ·æ–°æœªè§¦å‘è¿‡æœŸæ£€æµ‹

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// FormAbilityä¸­å®ç°è¿‡æœŸæ£€æµ‹
private async loadGameStateWithCleanupCheck(formId: string): Promise<void> {
  const gameState = await GameStorage.loadGameState();
  
  if (gameState && gameState.isPlaying) {
    const savedTime = gameState.timestamp || 0;
    const currentTime = Date.now();
    const hoursSinceUpdate = (currentTime - savedTime) / (1000 * 60 * 60);
    
    // ğŸ”¥ è¶…è¿‡8åˆ†é’Ÿè§†ä¸ºè¿‡æœŸ
    if (savedTime > 0 && hoursSinceUpdate > 0.133) {
      await GameStorage.clearGameState();
      formData = this.createDefaultFormData();
    } else {
      formData = this.createFormDataFromGameState(gameState);
    }
  }
}

// åœ¨onUpdateFormä¸­è°ƒç”¨
onUpdateForm(formId: string): void {
  this.loadGameStateWithCleanupCheck(formId);
}
```

---

## æ€»ç»“

### 7.1 æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹

1. **åŒé‡ä¿å­˜æœºåˆ¶**
   - AppStorageï¼šå®æ—¶åŒæ­¥ï¼Œé›¶å»¶è¿Ÿï¼Œè¿›ç¨‹å†…å…±äº«
   - Preferencesï¼šæŒä¹…åŒ–å¤‡ä»½ï¼Œè·¨è¿›ç¨‹è®¿é—®

2. **ä¼˜å…ˆçº§è¯»å–ç­–ç•¥**
   - ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šAppStorageï¼ˆè¿›ç¨‹å†…æœ€æ–°æ•°æ®ï¼‰
   - ç¬¬äºŒä¼˜å…ˆçº§ï¼šPreferencesï¼ˆåº”ç”¨é‡å¯åæ¢å¤ï¼‰

3. **å¡ç‰‡IDç®¡ç†**
   - FormAbilityç”Ÿå‘½å‘¨æœŸä¸­ä¿å­˜/åˆ é™¤
   - ä½¿ç”¨åº”ç”¨çº§åˆ«contextç¡®ä¿å…±äº«
   - EntryAbilityä¸­æ‰¹é‡æ›´æ–°

4. **æ—¶é—´æˆ³è¿‡æœŸæ£€æµ‹**
   - æ¯æ¬¡ä¿å­˜æ·»åŠ æ—¶é—´æˆ³
   - å®šæ—¶åˆ·æ–°æ—¶æ£€æµ‹æ˜¯å¦è¿‡æœŸ
   - è¶…è¿‡8åˆ†é’Ÿè‡ªåŠ¨æ¸…é™¤

5. **åº”ç”¨é”€æ¯å¤„ç†**
   - onDestroy()ä¸­æ¸…é™¤æ•°æ®
   - ä½¿ç”¨fire-and-forgetæ¨¡å¼
   - æ›´æ–°æ‰€æœ‰å¡ç‰‡æ˜¾ç¤º


### 7.2 å®ç°æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| **æ›´æ–°å»¶è¿Ÿ** | ä¸å®š(å¼‚æ­¥) | âœ… é›¶å»¶è¿Ÿ(åŒæ­¥) |
| **æ•°æ®å‡†ç¡®æ€§** | âŒ å¯èƒ½æ˜¾ç¤ºæ—§æ•°æ® | âœ… 100%æœ€æ–°æ•°æ® |
| **åº”ç”¨é‡å¯æ¢å¤** | âŒ æ— æ³•æ¢å¤ | âœ… å®Œæ•´æ¢å¤ |
| **å®æ—¶æ€§** | âŒ ä¸å®æ—¶ | âœ… å®æ—¶åŒæ­¥ |
| **è¿‡æœŸæ•°æ®æ¸…ç†** | âŒ æ— æœºåˆ¶ | âœ… è‡ªåŠ¨æ¸…ç† |
| **è·¨è¿›ç¨‹è®¿é—®** | âŒ ä¸æ”¯æŒ | âœ… å®Œç¾æ”¯æŒ |

### 7.3 æˆåŠŸæ ‡å¿—

å¦‚æœä»¥ä¸‹æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ï¼Œè¯´æ˜å¡ç‰‡åŠŸèƒ½å®ç°æˆåŠŸï¼š

1. âœ… æ¯æ¬¡ç§»åŠ¨æ–¹å—åï¼Œæ—¥å¿—æ˜¾ç¤º`âš¡ AppStorageå·²æ›´æ–°`
2. âœ… æŒ‰Homeé”®åï¼Œæ—¥å¿—æ˜¾ç¤º`âš¡ ä» AppStorage è¯»å–åˆ°å®æ—¶æ¸¸æˆçŠ¶æ€`
3. âœ… å¡ç‰‡æ˜¾ç¤ºæ­£ç¡®çš„æ­¥æ•°å’Œç”¨æ—¶ï¼ˆä¸æ¸¸æˆå†…ä¸€è‡´ï¼‰
4. âœ… ç‚¹å‡»"ç»§ç»­"èƒ½å›åˆ°æ¸¸æˆï¼ŒçŠ¶æ€å®Œæ•´ä¿ç•™
5. âœ… æ€æ‰åº”ç”¨é‡æ–°æ‰“å¼€ï¼Œä»èƒ½ä»Preferencesæ¢å¤çŠ¶æ€
6. âœ… åº”ç”¨è¢«å¼ºåˆ¶å…³é—­åï¼Œå¡ç‰‡æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"
7. âœ… å®Œæˆæ¸¸æˆåï¼Œå¡ç‰‡è‡ªåŠ¨æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"
8. âœ… ä»å¡ç‰‡å¯åŠ¨åº”ç”¨èƒ½æ­£ç¡®è·³è½¬åˆ°ç›®æ ‡é¡µé¢

### 7.4 æ ¸å¿ƒä¼˜åŠ¿

**å¯¹æ¯”ä¼ ç»Ÿæ–¹æ¡ˆ**ï¼š

| æ–¹æ¡ˆ | ä¿å­˜æ—¶æœº | è¯»å–å»¶è¿Ÿ | å¯é æ€§ | è·¨è¿›ç¨‹ |
|------|---------|---------|--------|--------|
| âŒ ä»…Preferences | é¡µé¢é”€æ¯æ—¶ | å¼‚æ­¥(å¯èƒ½å¤±è´¥) | ä½ | æ˜¯ |
| âŒ ä»…AppStorage | å®æ—¶ | é›¶å»¶è¿Ÿ | ä¸­ | å¦ |
| âœ… åŒé‡ä¿å­˜ | å®æ—¶ | **é›¶å»¶è¿Ÿ** | **é«˜** | **æ˜¯** |

**ä¸ºä»€ä¹ˆä¸€å®šæˆåŠŸ**ï¼š

1. **AppStorageæ˜¯åŒæ­¥çš„**ï¼šå†™å…¥åç«‹å³å¯è¯»ï¼Œæ— å»¶è¿Ÿ
2. **åœ¨åŒä¸€ä¸ªè¿›ç¨‹**ï¼šUIAbilityå†…çš„AppStorageå…¨å±€å…±äº«
3. **åŒé‡å¤‡ä»½**ï¼šå†…å­˜å¤±è´¥è¿˜æœ‰Preferenceså…œåº•
4. **å®æ—¶æ›´æ–°**ï¼šä¸ç­‰å¾…é¡µé¢é”€æ¯ï¼Œæ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½ä¿å­˜
5. **æ™ºèƒ½æ¸…ç†**ï¼šæ—¶é—´æˆ³è¿‡æœŸæ£€æµ‹ + onDestroyæ¸…ç†

---

## é™„å½•

### A. å®Œæ•´æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | å…³é”®ä»£ç  |
|---------|------|---------|
| `widget/pages/WidgetCard.ets` | å¡ç‰‡UI | æ˜¾ç¤ºæ¸¸æˆä¿¡æ¯å’ŒæŒ‰é’® |
| `formability/PuzzleFormAbility.ets` | å¡ç‰‡Ability | å¡ç‰‡ç”Ÿå‘½å‘¨æœŸç®¡ç† |
| `utils/GameStorage.ets` | æ•°æ®æŒä¹…åŒ– | Preferencesè¯»å†™ |
| `entryability/EntryAbility.ets` | åº”ç”¨Ability | å¡ç‰‡æ›´æ–°è§¦å‘ |
| `pages/GamePage.ets` | æ¸¸æˆé¡µé¢ | å®æ—¶ä¿å­˜çŠ¶æ€ |
| `resources/base/profile/form_config.json` | å¡ç‰‡é…ç½® | å¡ç‰‡å…ƒæ•°æ® |

### B. æ•°æ®ç»“æ„å®šä¹‰

```typescript
/**
 * ä¿å­˜çš„æ¸¸æˆçŠ¶æ€æ¥å£
 */
export interface SavedGameState {
  gameMode: string;        // æ¸¸æˆæ¨¡å¼ï¼š'swap' | 'huarong'
  gridSize: number;        // éš¾åº¦ï¼š3 | 4 | 5
  moveCount: number;       // æ­¥æ•°
  timeElapsed: number;     // ç”¨æ—¶ï¼ˆç§’ï¼‰
  isPlaying: boolean;      // æ˜¯å¦è¿›è¡Œä¸­
  timestamp?: number;      // ä¿å­˜æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
}

/**
 * å¡ç‰‡æ•°æ®æ¥å£
 */
interface FormDataContent {
  title: string;           // æ ‡é¢˜ï¼š"æ‹¼å›¾æ¸¸æˆ"
  gameMode: string;        // æ¨¡å¼ï¼š"äº¤æ¢" | "æ»‘åŠ¨"
  gridSize: string;        // éš¾åº¦ï¼š"3Ã—3" | "4Ã—4" | "5Ã—5"
  moveCount: number;       // æ­¥æ•°
  timeElapsed: string;     // ç”¨æ—¶ï¼š"MM:SS"
  hasActiveGame: boolean;  // æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„æ¸¸æˆ
}
```

### C. å…³é”®å¸¸é‡

```typescript
// Preferencesåç§°
const PREFERENCES_NAME = 'puzzle_game_prefs';
const FORM_IDS_PREFERENCES = 'formIds';

// å­˜å‚¨é”®
const KEY_GAME_STATE = 'game_state';
const KEY_FORM_IDS = 'ids';

// AppStorageé”®
const KEY_CURRENT_GAME_STATE = 'currentGameState';
const KEY_WIDGET_TARGET_PAGE = 'widgetTargetPage';
const KEY_WIDGET_TARGET_PAGE_TIMESTAMP = 'widgetTargetPageTimestamp';

// è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
const EXPIRY_TIME_MS = 8 * 60 * 1000;  // 8åˆ†é’Ÿ

// å®šæ—¶åˆ·æ–°é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
const UPDATE_DURATION = 5;  // 5åˆ†é’Ÿ
```

### D. æ—¥å¿—æ ‡è®°è¯´æ˜

| æ ‡è®° | å«ä¹‰ | ç¤ºä¾‹ |
|-----|------|------|
| âš¡ | AppStorageæ“ä½œ | `âš¡ AppStorageå·²æ›´æ–°` |
| ğŸ’¾ | Preferencesæ“ä½œ | `ğŸ’¾ ä» Preferences è¯»å–` |
| âœ… | æˆåŠŸ | `âœ… å¡ç‰‡æ›´æ–°æˆåŠŸ` |
| âŒ | å¤±è´¥ | `âŒ ä¿å­˜å¤±è´¥` |
| ğŸ“‹ | ä¿¡æ¯è¾“å‡º | `ğŸ“‹ è¯»å–åˆ° 1 ä¸ªå¡ç‰‡ID` |
| ğŸ”„ | æ›´æ–°æ“ä½œ | `ğŸ”„ å¼€å§‹æ›´æ–°æ‰€æœ‰å¡ç‰‡` |
| ğŸ¯ | è·³è½¬æ“ä½œ | `ğŸ¯ æ£€æµ‹åˆ°å¡ç‰‡è·³è½¬è¯·æ±‚` |
| ğŸš€ | æ‰§è¡Œæ“ä½œ | `ğŸš€ æ‰§è¡Œè·³è½¬` |
| âš ï¸ | è­¦å‘Š | `âš ï¸ æ•°æ®è¿‡æœŸ` |
| ğŸ”´ | é”€æ¯æ“ä½œ | `ğŸ”´ onDestroy è§¦å‘` |

---

## å‚è€ƒèµ„æ–™

1. [HarmonyOSæœåŠ¡å¡ç‰‡å¼€å‘æŒ‡å—](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/service-widget-overview-V5)
2. [AppStorageæ–‡æ¡£](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-appstorage-V5)
3. [Preferencesæ–‡æ¡£](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/data-persistence-by-preferences-V5)
4. [FormExtensionAbilityæ–‡æ¡£](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-app-form-formextensionability-V5)

---

**æ–‡æ¡£æ•´ç†æ—¥æœŸ**ï¼š2025å¹´11æœˆ27æ—¥  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**ä½œè€…**ï¼šKiro AI Assistant  
**é¡¹ç›®çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

---

## ç»“è¯­

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†æ‹¼å›¾æ¸¸æˆæ¡Œé¢å¡ç‰‡åŠŸèƒ½çš„å®Œæ•´å®ç°è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š

- æ ¸å¿ƒæŠ€æœ¯æ¶æ„ï¼ˆåŒé‡ä¿å­˜æœºåˆ¶ï¼‰
- å®Œæ•´ä»£ç å®ç°ï¼ˆ5ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼‰
- 7ä¸ªæµ‹è¯•åœºæ™¯éªŒè¯
- 5ä¸ªå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

è¿™å¥—æ–¹æ¡ˆä¸ä»…è§£å†³äº†è·¨è¿›ç¨‹æ•°æ®å…±äº«ã€æ—¶åºé—®é¢˜ã€æ•°æ®æŒä¹…åŒ–ç­‰æŠ€æœ¯éš¾é¢˜ï¼Œè¿˜å®ç°äº†**é›¶å»¶è¿Ÿçš„å®æ—¶åŒæ­¥**æ•ˆæœï¼Œä¸ºHarmonyOSæœåŠ¡å¡ç‰‡å¼€å‘æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„å‚è€ƒå®ç°ã€‚

å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©å¼€å‘è€…å¿«é€Ÿç†è§£å’Œå®ç°ç±»ä¼¼çš„å¡ç‰‡åŠŸèƒ½ï¼ğŸ‰

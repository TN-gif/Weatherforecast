# å¡ç‰‡åŠŸèƒ½å®ç°ä¸ä¿®å¤æ–¹æ¡ˆ

> **é¡¹ç›®**: æ‹¼å›¾æ¸¸æˆ (Puzzle)  
> **å¹³å°**: HarmonyOS  
> **åŠŸèƒ½**: Service Widget (æœåŠ¡å¡ç‰‡) å®æ—¶æ›´æ–°

---

## ç›®å½•

1. [å¡ç‰‡åŠŸèƒ½æ¦‚è¿°](#å¡ç‰‡åŠŸèƒ½æ¦‚è¿°)
2. [æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
3. [åŒé‡ä¿å­˜æœºåˆ¶å®ç°](#åŒé‡ä¿å­˜æœºåˆ¶å®ç°)
4. [å®Œæ•´å®ç°ç»†èŠ‚](#å®Œæ•´å®ç°ç»†èŠ‚)
5. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## å¡ç‰‡åŠŸèƒ½æ¦‚è¿°

### åŠŸèƒ½éœ€æ±‚

**æ¡Œé¢æœåŠ¡å¡ç‰‡æ˜¾ç¤º**:
- æ— æ¸¸æˆçŠ¶æ€: æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"æŒ‰é’®
- æœ‰æ¸¸æˆçŠ¶æ€: æ˜¾ç¤º"ç»§ç»­"å’Œ"é€‰æ‹©ä¸»é¢˜"æŒ‰é’® + æ¸¸æˆè¿›åº¦(æ­¥æ•°ã€ç”¨æ—¶)
- **å®æ—¶æ›´æ–°**: æ¸¸æˆè¿›è¡Œä¸­åˆ‡æ¢åˆ°åå°,å¡ç‰‡ç«‹å³æ˜¾ç¤ºæœ€æ–°è¿›åº¦

### æŠ€æœ¯æŒ‘æˆ˜

#### é—®é¢˜1: AppStorageè·¨è¿›ç¨‹é—®é¢˜

**é—®é¢˜æè¿°**:
- Service Widgetè¿è¡Œåœ¨ç‹¬ç«‹çš„FormAbilityè¿›ç¨‹
- æ¸¸æˆè¿è¡Œåœ¨UIAbilityè¿›ç¨‹
- AppStorageæ˜¯**è¿›ç¨‹å†…å­˜å‚¨**,ä¸èƒ½è·¨è¿›ç¨‹è®¿é—®

**é”™è¯¯å°è¯•**:
```typescript
// FormAbilityä¸­
const gameState = AppStorage.get<SavedGameState>('currentGameState');
// âŒ æ°¸è¿œè¿”å›null,å› ä¸ºæ˜¯ä¸åŒè¿›ç¨‹
```

---

#### é—®é¢˜2: FormInfoç±»å‹è®¿é—®é™åˆ¶

**é—®é¢˜æè¿°**:
- HarmonyOS SDKä¸­`FormInfo`ç±»å‹çš„å±æ€§åœ¨è¿è¡Œæ—¶æ— æ³•ç›´æ¥è®¿é—®
- å¯¼è‡´ç¼–è¯‘é”™è¯¯: `arkts-no-any-unknown`

**é”™è¯¯å°è¯•**:
```typescript
import { formInfo } from '@kit.FormKit';

const info = await formInfo.getFormsInfo();
const formId = info[0].formId;  // âŒ ç±»å‹é”™è¯¯
```

---

#### é—®é¢˜3: æ—¶åºé—®é¢˜

**é—®é¢˜æè¿°**:
- ä½¿ç”¨Preferences(å¼‚æ­¥å­˜å‚¨)
- `EntryAbility.onBackground()`å¯èƒ½åœ¨`GamePage.onPageHide()`**ä¹‹å‰**è§¦å‘
- å¯¼è‡´å¡ç‰‡è¯»å–åˆ°çš„æ˜¯æ—§æ•°æ®

**æ—¶åºé—®é¢˜ç¤ºä¾‹**:
```
ç”¨æˆ·æŒ‰Homeé”®
    â†“
1. EntryAbility.onBackground() è§¦å‘
   â†’ è¯»å–Preferences (æ—§æ•°æ®: æ­¥æ•°=5)
   â†’ æ›´æ–°å¡ç‰‡ (æ˜¾ç¤ºæ­¥æ•°=5)
    â†“
2. GamePage.onPageHide() è§¦å‘ (æ™šäº†!)
   â†’ ä¿å­˜Preferences (æ–°æ•°æ®: æ­¥æ•°=10)
   
ç»“æœ: å¡ç‰‡æ˜¾ç¤ºæ­¥æ•°=5,å®é™…åº”è¯¥æ˜¯10 âŒ
```

---

## æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### è§£å†³æ–¹æ¡ˆ: åŒé‡ä¿å­˜æœºåˆ¶

**æ ¸å¿ƒæ€æƒ³**:
1. **AppStorage**(å†…å­˜): åŒæ­¥ä¿å­˜,é›¶å»¶è¿Ÿ,è¿›ç¨‹å†…å…±äº«
2. **Preferences**(æŒä¹…åŒ–): å¼‚æ­¥ä¿å­˜,åº”ç”¨é‡å¯åæ¢å¤

**å·¥ä½œåŸç†**:
```
GamePageæ¯æ¬¡ç§»åŠ¨æ–¹å—:
    â†“
1. âœ… ç«‹å³åŒæ­¥ä¿å­˜åˆ° AppStorage (å†…å­˜,é›¶å»¶è¿Ÿ)
2. âœ… å¼‚æ­¥ä¿å­˜åˆ° Preferences (ç£ç›˜,å¤‡ä»½)
    â†“
ç”¨æˆ·æŒ‰Homeé”®:
    â†“
EntryAbility.onBackground():
    â†“
1. âœ… ä¼˜å…ˆä» AppStorage è¯»å– (æœ€æ–°æ•°æ®!)
2. âš ï¸ Fallback: ä» Preferences è¯»å– (åº”ç”¨é‡å¯å)
    â†“
3. âœ… æ›´æ–°æ‰€æœ‰å¡ç‰‡ (å®æ—¶åŒæ­¥!)
```

---

### æŠ€æœ¯å¯¹æ¯”

| å­˜å‚¨æ–¹å¼ | è¯»å†™é€Ÿåº¦ | è·¨è¿›ç¨‹ | æŒä¹…åŒ– | é€‚ç”¨åœºæ™¯ |
|---------|---------|--------|--------|---------|
| **AppStorage** | åŒæ­¥(é›¶å»¶è¿Ÿ) | âŒ å¦ | âŒ å¦ | âœ… å®æ—¶çŠ¶æ€åŒæ­¥ |
| **Preferences** | å¼‚æ­¥(æœ‰å»¶è¿Ÿ) | âœ… æ˜¯ | âœ… æ˜¯ | âœ… æŒä¹…åŒ–å¤‡ä»½ |

**å…³é”®ç†è§£**:
- AppStorage: å¿«ä½†ä¸æŒä¹…,è¿›ç¨‹å†…æœ‰æ•ˆ
- Preferences: æ…¢ä½†æŒä¹…,è·¨è¿›ç¨‹å¯è®¿é—®
- **ç»„åˆä½¿ç”¨**: å‘æŒ¥ä¸¤è€…ä¼˜åŠ¿

---

## åŒé‡ä¿å­˜æœºåˆ¶å®ç°

### æ­¥éª¤1: GamePageå®æ—¶ä¿å­˜

```typescript
// pages/GamePage.ets

import { GameStorage } from '../utils/GameStorage';

// âœ… æ¯æ¬¡ç§»åŠ¨æ–¹å—æ—¶è°ƒç”¨
private saveCurrentGameState(): void {
  if (!this.isPlaying || this.moveCount === 0) {
    return;
  }
  
  const gameState: SavedGameState = {
    gridSize: this.gridSize,
    gameMode: this.gameMode,
    moveCount: this.moveCount,
    timeElapsed: this.timeElapsed,
    imageResource: typeof this.imageResource === 'string' ? 
                   this.imageResource : '',
    isCustomImage: this.isCustomImage,
    tiles: this.tiles,
    emptyIndex: this.emptyIndex,
    isPlaying: true,
    lastSaved: Date.now()
  };
  
  // âœ… å…³é”®1: ç«‹å³åŒæ­¥åˆ° AppStorage (é›¶å»¶è¿Ÿ)
  AppStorage.setOrCreate('currentGameState', gameState);
  
  console.info('[GamePage] âš¡ AppStorageå·²æ›´æ–°:', 
    `æ­¥æ•°=${this.moveCount}, ç”¨æ—¶=${this.timeElapsed}ç§’`);
  
  // âœ… å…³é”®2: å¼‚æ­¥ä¿å­˜åˆ° Preferences (å¤‡ä»½)
  GameStorage.saveGameState(gameState)
    .catch(err => console.error('[GamePage] Preferencesä¿å­˜å¤±è´¥:', err));
}

// âœ… è§¦å‘æ—¶æœº
private moveTile(index: number): void {
  // ç§»åŠ¨æ–¹å—é€»è¾‘...
  this.moveCount++;
  
  // âœ… ç«‹å³ä¿å­˜
  this.saveCurrentGameState();
}

// âœ… é¡µé¢é”€æ¯æ—¶ä¹Ÿä¿å­˜
aboutToDisappear(): void {
  this.saveCurrentGameState();
  this.stopTimer();
}

// âœ… å®šæ—¶å™¨æ›´æ–°æ—¶ä¹Ÿä¿å­˜
private startTimer(): void {
  this.timerInterval = setInterval(() => {
    if (this.isPlaying) {
      this.timeElapsed++;
      this.saveCurrentGameState();  // âœ… æ¯ç§’ä¿å­˜
    }
  }, 1000);
}
```

---

### æ­¥éª¤2: EntryAbilityä¼˜å…ˆè¯»å–AppStorage

```typescript
// entryability/EntryAbility.ets

import { GameStorage } from '../utils/GameStorage';
import formProvider from '@ohos.app.form.formProvider';

async onBackground(): Promise<void> {
  console.info('[EntryAbility] ========== ğŸ”„ onBackground è§¦å‘ ==========');
  
  // âœ… ä¿å­˜æ‰€æœ‰å¡ç‰‡ID
  await this.saveAllFormIds();
  
  // âœ… æ›´æ–°æ‰€æœ‰å¡ç‰‡
  await this.updateAllForms();
}

private async updateAllForms(): Promise<void> {
  console.info('[EntryAbility] ========== ğŸ”„ å¼€å§‹æ›´æ–°æ‰€æœ‰å¡ç‰‡ ==========');
  
  // âœ… è¯»å–ä¿å­˜çš„å¡ç‰‡ID
  const formIds = await GameStorage.getAllFormIds();
  console.info(`[EntryAbility] ğŸ“‹ è¯»å–åˆ° ${formIds.length} ä¸ªå¡ç‰‡ID`);
  
  // âœ… å…³é”®1: ä¼˜å…ˆä» AppStorage è¯»å– (æœ€æ–°æ•°æ®!)
  let gameState = AppStorage.get<SavedGameState>('currentGameState') || null;
  
  if (gameState) {
    console.info('[EntryAbility] âš¡ ä» AppStorage è¯»å–åˆ°å®æ—¶æ¸¸æˆçŠ¶æ€');
    console.info(`[EntryAbility]    - æ¨¡å¼: ${gameState.gameMode}`);
    console.info(`[EntryAbility]    - æ­¥æ•°: ${gameState.moveCount}`);
    console.info(`[EntryAbility]    - ç”¨æ—¶: ${gameState.timeElapsed}ç§’`);
    console.info(`[EntryAbility]    - è¿›è¡Œä¸­: ${gameState.isPlaying}`);
  } else {
    // âœ… å…³é”®2: Fallback - ä» Preferences è¯»å– (åº”ç”¨é‡å¯å)
    console.info('[EntryAbility] ğŸ’¾ AppStorageæ— æ•°æ®,ä» Preferences è¯»å–...');
    gameState = await GameStorage.loadGameState();
    
    if (gameState) {
      console.info('[EntryAbility] ğŸ“¦ ä» Preferences è¯»å–åˆ°æ¸¸æˆçŠ¶æ€');
    } else {
      console.info('[EntryAbility] âŒ æ— æ¸¸æˆçŠ¶æ€');
    }
  }
  
  // âœ… æ„å»ºå¡ç‰‡æ•°æ®
  const hasActiveGame = gameState !== null && gameState.isPlaying === true;
  
  const formData = {
    "hasActiveGame": hasActiveGame,
    "moveCount": gameState?.moveCount || 0,
    "timeElapsed": gameState?.timeElapsed || 0,
    "formattedTime": this.formatTime(gameState?.timeElapsed || 0),
    "gridSize": gameState?.gridSize || 3
  };
  
  console.info('[EntryAbility] ğŸ“ å¡ç‰‡æ•°æ®:', JSON.stringify(formData));
  
  // âœ… æ›´æ–°æ‰€æœ‰å¡ç‰‡
  for (const formId of formIds) {
    try {
      await formProvider.updateForm(formId, formData);
      console.info(`[EntryAbility] âœ… å¡ç‰‡ ${formId} æ›´æ–°æˆåŠŸ`);
    } catch (error) {
      console.error(`[EntryAbility] âŒ å¡ç‰‡ ${formId} æ›´æ–°å¤±è´¥:`, error);
    }
  }
}

// âœ… åº”ç”¨å›åˆ°å‰å°æ—¶,ç¡®ä¿AppStorageæœ‰æœ€æ–°æ•°æ®
async onForeground(): Promise<void> {
  console.info('[EntryAbility] onForeground è§¦å‘');
  
  // å¦‚æœAppStorageä¸­æ²¡æœ‰æ•°æ®,ä»PreferencesåŠ è½½
  if (!AppStorage.has('currentGameState')) {
    const gameState = await GameStorage.loadGameState();
    if (gameState) {
      AppStorage.setOrCreate('currentGameState', gameState);
      console.info('[EntryAbility] âœ… ä»Preferencesæ¢å¤åˆ°AppStorage');
    }
  }
}
```

---

### æ­¥éª¤3: FormAbilityä¸­è·å–å¡ç‰‡ID

**é—®é¢˜**: å¦‚ä½•çŸ¥é“æ¡Œé¢ä¸Šæœ‰å“ªäº›å¡ç‰‡éœ€è¦æ›´æ–°?

**è§£å†³æ–¹æ¡ˆ**: åœ¨FormAbilityçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¿å­˜å¡ç‰‡ID

```typescript
// formability/PuzzleFormAbility.ets

import { GameStorage } from '../utils/GameStorage';

export default class PuzzleFormAbility extends FormExtensionAbility {
  // âœ… å¡ç‰‡åˆ›å»ºæ—¶
  async onAddForm(want: Want): Promise<formBindingData.FormBindingData> {
    console.info('[FormAbility] å¡ç‰‡åˆ›å»º');
    
    const formId = want.parameters?.['ohos.extra.param.key.form_identity'] as string;
    console.info('[FormAbility] å¡ç‰‡ID:', formId);
    
    // âœ… ä¿å­˜å¡ç‰‡ID
    if (formId) {
      await GameStorage.addFormId(formId);
    }
    
    // è¿”å›åˆå§‹æ•°æ®
    return formBindingData.createFormBindingData({
      hasActiveGame: false,
      moveCount: 0,
      timeElapsed: 0,
      formattedTime: '00:00',
      gridSize: 3
    });
  }
  
  // âœ… å¡ç‰‡åˆ é™¤æ—¶
  async onRemoveForm(formId: string): Promise<void> {
    console.info('[FormAbility] å¡ç‰‡åˆ é™¤:', formId);
    
    // âœ… ç§»é™¤å¡ç‰‡ID
    await GameStorage.removeFormId(formId);
  }
}
```

---

### æ­¥éª¤4: GameStorageå·¥å…·ç±»

```typescript
// utils/GameStorage.ets

import preferences from '@ohos.data.preferences';
import { common } from '@kit.AbilityKit';

export class GameStorage {
  private static preferencesStore: preferences.Preferences | null = null;
  private static readonly STORE_NAME = 'puzzle_game_storage';
  
  // âœ… åˆå§‹åŒ–
  static async init(context: common.UIAbilityContext): Promise<void> {
    if (!GameStorage.preferencesStore) {
      GameStorage.preferencesStore = await preferences.getPreferences(
        context, 
        GameStorage.STORE_NAME
      );
      console.info('[GameStorage] âœ… Preferencesåˆå§‹åŒ–æˆåŠŸ');
    }
  }
  
  // âœ… ä¿å­˜æ¸¸æˆçŠ¶æ€ (å¼‚æ­¥)
  static async saveGameState(state: SavedGameState): Promise<void> {
    if (!GameStorage.preferencesStore) {
      console.warn('[GameStorage] âš ï¸ Preferencesæœªåˆå§‹åŒ–');
      return;
    }
    
    try {
      const jsonStr = JSON.stringify(state);
      await GameStorage.preferencesStore.put('game_state', jsonStr);
      await GameStorage.preferencesStore.flush();
      
      console.info('[GameStorage] âœ… æ¸¸æˆçŠ¶æ€å·²ä¿å­˜åˆ°Preferences');
    } catch (error) {
      console.error('[GameStorage] âŒ ä¿å­˜å¤±è´¥:', error);
    }
  }
  
  // âœ… åŠ è½½æ¸¸æˆçŠ¶æ€ (å¼‚æ­¥)
  static async loadGameState(): Promise<SavedGameState | null> {
    if (!GameStorage.preferencesStore) {
      console.warn('[GameStorage] âš ï¸ Preferencesæœªåˆå§‹åŒ–');
      return null;
    }
    
    try {
      const jsonStr = await GameStorage.preferencesStore.get('game_state', '') as string;
      
      if (!jsonStr) {
        console.info('[GameStorage] ğŸ“­ æ— ä¿å­˜çš„æ¸¸æˆçŠ¶æ€');
        return null;
      }
      
      const state = JSON.parse(jsonStr) as SavedGameState;
      console.info('[GameStorage] âœ… æ¸¸æˆçŠ¶æ€å·²åŠ è½½');
      return state;
      
    } catch (error) {
      console.error('[GameStorage] âŒ åŠ è½½å¤±è´¥:', error);
      return null;
    }
  }
  
  // âœ… æ¸…é™¤æ¸¸æˆçŠ¶æ€
  static async clearGameState(): Promise<void> {
    if (!GameStorage.preferencesStore) {
      return;
    }
    
    try {
      await GameStorage.preferencesStore.delete('game_state');
      await GameStorage.preferencesStore.flush();
      
      // âœ… åŒæ—¶æ¸…é™¤AppStorage
      AppStorage.setOrCreate('currentGameState', null);
      
      console.info('[GameStorage] âœ… æ¸¸æˆçŠ¶æ€å·²æ¸…é™¤');
    } catch (error) {
      console.error('[GameStorage] âŒ æ¸…é™¤å¤±è´¥:', error);
    }
  }
  
  // âœ… ä¿å­˜å¡ç‰‡ID
  static async addFormId(formId: string): Promise<void> {
    if (!GameStorage.preferencesStore) {
      return;
    }
    
    try {
      const existingIds = await GameStorage.getAllFormIds();
      
      if (!existingIds.includes(formId)) {
        existingIds.push(formId);
        const jsonStr = JSON.stringify(existingIds);
        await GameStorage.preferencesStore.put('form_ids', jsonStr);
        await GameStorage.preferencesStore.flush();
        
        console.info('[GameStorage] âœ… å¡ç‰‡IDå·²ä¿å­˜:', formId);
      }
    } catch (error) {
      console.error('[GameStorage] âŒ ä¿å­˜å¡ç‰‡IDå¤±è´¥:', error);
    }
  }
  
  // âœ… ç§»é™¤å¡ç‰‡ID
  static async removeFormId(formId: string): Promise<void> {
    if (!GameStorage.preferencesStore) {
      return;
    }
    
    try {
      const existingIds = await GameStorage.getAllFormIds();
      const filteredIds = existingIds.filter(id => id !== formId);
      
      const jsonStr = JSON.stringify(filteredIds);
      await GameStorage.preferencesStore.put('form_ids', jsonStr);
      await GameStorage.preferencesStore.flush();
      
      console.info('[GameStorage] âœ… å¡ç‰‡IDå·²ç§»é™¤:', formId);
    } catch (error) {
      console.error('[GameStorage] âŒ ç§»é™¤å¡ç‰‡IDå¤±è´¥:', error);
    }
  }
  
  // âœ… è·å–æ‰€æœ‰å¡ç‰‡ID
  static async getAllFormIds(): Promise<string[]> {
    if (!GameStorage.preferencesStore) {
      return [];
    }
    
    try {
      const jsonStr = await GameStorage.preferencesStore.get('form_ids', '[]') as string;
      const ids = JSON.parse(jsonStr) as string[];
      
      console.info('[GameStorage] ğŸ“‹ è¯»å–åˆ°å¡ç‰‡ID:', ids.length, 'ä¸ª');
      return ids;
    } catch (error) {
      console.error('[GameStorage] âŒ è·å–å¡ç‰‡IDå¤±è´¥:', error);
      return [];
    }
  }
}
```

---

## å®Œæ•´å®ç°ç»†èŠ‚

### WidgetCard.ets - å¡ç‰‡UI

```typescript
// widget/pages/WidgetCard.ets

@Entry
@Component
struct WidgetCard {
  // âœ… ä»formDataæ¥æ”¶æ•°æ®
  @LocalStorageProp('hasActiveGame') hasActiveGame: boolean = false;
  @LocalStorageProp('moveCount') moveCount: number = 0;
  @LocalStorageProp('formattedTime') formattedTime: string = '00:00';
  @LocalStorageProp('gridSize') gridSize: number = 3;
  
  build() {
    Column() {
      // âœ… æ ‡é¢˜
      Text('æ‹¼å›¾æ¸¸æˆ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .margin({ bottom: 10 })
      
      if (this.hasActiveGame) {
        // âœ… æœ‰æ¸¸æˆè¿›è¡Œä¸­
        Column() {
          // æ¸¸æˆä¿¡æ¯
          Text(`éš¾åº¦: ${this.gridSize}Ã—${this.gridSize}`)
            .fontSize(14)
            .fontColor(Color.White)
            .margin({ bottom: 5 })
          
          Text(`æ­¥æ•°: ${this.moveCount}`)
            .fontSize(14)
            .fontColor(Color.White)
            .margin({ bottom: 5 })
          
          Text(`ç”¨æ—¶: ${this.formattedTime}`)
            .fontSize(14)
            .fontColor(Color.White)
            .margin({ bottom: 15 })
          
          // æŒ‰é’®ç»„
          Row() {
            Button('ç»§ç»­')
              .width(80)
              .height(35)
              .fontSize(14)
              .backgroundColor('#4CAF50')
              .onClick(() => {
                // âœ… å¯åŠ¨åº”ç”¨å¹¶è·³è½¬åˆ°GamePage
                postCardAction(this, {
                  action: 'router',
                  abilityName: 'EntryAbility',
                  params: {
                    action: 'continue'
                  }
                });
              })
            
            Button('é€‰æ‹©ä¸»é¢˜')
              .width(80)
              .height(35)
              .fontSize(14)
              .backgroundColor('#2196F3')
              .margin({ left: 10 })
              .onClick(() => {
                // âœ… å¯åŠ¨åº”ç”¨å¹¶è·³è½¬åˆ°ThemeSelectionPage
                postCardAction(this, {
                  action: 'router',
                  abilityName: 'EntryAbility',
                  params: {
                    action: 'theme'
                  }
                });
              })
          }
        }
        .alignItems(HorizontalAlign.Center)
        
      } else {
        // âœ… æ— æ¸¸æˆçŠ¶æ€
        Button('å¼€å§‹æ–°æ¸¸æˆ')
          .width(150)
          .height(40)
          .fontSize(16)
          .backgroundColor('#FF9800')
          .onClick(() => {
            // âœ… å¯åŠ¨åº”ç”¨
            postCardAction(this, {
              action: 'router',
              abilityName: 'EntryAbility',
              params: {
                action: 'start'
              }
            });
          })
      }
    }
    .width('100%')
    .height('100%')
    .padding(15)
    .backgroundColor('#333333')
    .borderRadius(15)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
}
```

---

### EntryAbilityä¸­å¤„ç†å¡ç‰‡å¯åŠ¨

```typescript
// entryability/EntryAbility.ets

onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
  console.info('[EntryAbility] onCreate');
  
  // âœ… åˆå§‹åŒ–GameStorage
  GameStorage.init(this.context);
  
  // âœ… æ£€æŸ¥æ˜¯å¦ä»å¡ç‰‡å¯åŠ¨
  const action = want.parameters?.['action'] as string;
  
  if (action) {
    console.info('[EntryAbility] ä»å¡ç‰‡å¯åŠ¨,action:', action);
    
    // ä¿å­˜action,åœ¨onWindowStageCreateä¸­ä½¿ç”¨
    AppStorage.setOrCreate('launchAction', action);
  }
}

async onWindowStageCreate(windowStage: window.WindowStage): Promise<void> {
  // âœ… å…ˆåˆå§‹åŒ–ScreenStateManager
  const screenManager = ScreenStateManager.getInstance();
  await screenManager.init(windowStage);
  
  // âœ… æ£€æŸ¥å¯åŠ¨action
  const launchAction = AppStorage.get<string>('launchAction') || '';
  
  if (launchAction === 'continue') {
    // âœ… ç»§ç»­æ¸¸æˆ â†’ è·³è½¬åˆ°GamePage
    windowStage.loadContent('pages/GamePage');
    
  } else if (launchAction === 'theme') {
    // âœ… é€‰æ‹©ä¸»é¢˜ â†’ è·³è½¬åˆ°ThemeSelectionPage
    windowStage.loadContent('pages/ThemeSelectionPage');
    
  } else {
    // âœ… é»˜è®¤ â†’ è·³è½¬åˆ°EntryPage
    windowStage.loadContent('pages/EntryPage');
  }
  
  // âœ… æ¸…é™¤action
  AppStorage.delete('launchAction');
}
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

#### åœºæ™¯1: é¦–æ¬¡ä½¿ç”¨(æ— æ¸¸æˆçŠ¶æ€)

**æ­¥éª¤**:
1. æ·»åŠ å¡ç‰‡åˆ°æ¡Œé¢
2. æ£€æŸ¥å¡ç‰‡æ˜¾ç¤º

**é¢„æœŸç»“æœ**:
- âœ… å¡ç‰‡æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"æŒ‰é’®
- âœ… æ— æ¸¸æˆè¿›åº¦ä¿¡æ¯

---

#### åœºæ™¯2: ç©æ¸¸æˆ(å®æ—¶æ›´æ–°)â­ æ ¸å¿ƒæµ‹è¯•

**æ­¥éª¤**:
1. å¼€å§‹æ¸¸æˆ
2. ç§»åŠ¨æ–¹å—5æ¬¡
3. ç­‰å¾…15ç§’(è®¡æ—¶å™¨)
4. **æŒ‰Homeé”®** ğŸ”¥ å…³é”®æ—¶åˆ»!
5. æŸ¥çœ‹æ¡Œé¢å¡ç‰‡

**é¢„æœŸç»“æœ**:
- âœ… å¡ç‰‡**ç«‹å³æ˜¾ç¤º**æœ€æ–°çŠ¶æ€
- âœ… æ˜¾ç¤º"ç»§ç»­"å’Œ"é€‰æ‹©ä¸»é¢˜"ä¸¤ä¸ªæŒ‰é’®
- âœ… æ­¥æ•°: 5
- âœ… ç”¨æ—¶: 00:15

**å…³é”®æ—¥å¿—**:
```
[GamePage] âš¡ AppStorageå·²æ›´æ–°: æ­¥æ•°=5, ç”¨æ—¶=15
[EntryAbility] âš¡ ä» AppStorage è¯»å–åˆ°å®æ—¶æ¸¸æˆçŠ¶æ€
[EntryAbility]    - æ­¥æ•°: 5
[EntryAbility]    - ç”¨æ—¶: 15ç§’
[EntryAbility] âœ… å¡ç‰‡æ›´æ–°æˆåŠŸ
```

---

#### åœºæ™¯3: ç‚¹å‡»"ç»§ç»­"

**æ­¥éª¤**:
1. åœ¨åœºæ™¯2çš„åŸºç¡€ä¸Š
2. ç‚¹å‡»å¡ç‰‡çš„"ç»§ç»­"æŒ‰é’®

**é¢„æœŸç»“æœ**:
- âœ… åº”ç”¨å¯åŠ¨
- âœ… ç›´æ¥è¿›å…¥GamePage
- âœ… æ¸¸æˆçŠ¶æ€ä¿æŒ(æ­¥æ•°=5,ç”¨æ—¶=00:15)

---

#### åœºæ™¯4: å®Œæˆæ¸¸æˆ

**æ­¥éª¤**:
1. å®Œæˆæ‹¼å›¾
2. æŒ‰Homeé”®
3. æŸ¥çœ‹æ¡Œé¢å¡ç‰‡

**é¢„æœŸç»“æœ**:
- âœ… å¡ç‰‡æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"(å› ä¸ºæ¸¸æˆå·²å®Œæˆ,isPlaying=false)

---

#### åœºæ™¯5: åº”ç”¨é‡å¯å

**æ­¥éª¤**:
1. ç©æ¸¸æˆåˆ°ä¸€åŠ(æ­¥æ•°=5)
2. æŒ‰Homeé”®
3. **æ€æ‰åº”ç”¨**(ä»æœ€è¿‘ä»»åŠ¡æ¸…é™¤)
4. ç‚¹å‡»å¡ç‰‡

**é¢„æœŸç»“æœ**:
- âœ… å¡ç‰‡ä»**Preferences**è¯»å–çŠ¶æ€(å› ä¸ºAppStorageå·²æ¸…ç©º)
- âœ… æ˜¾ç¤ºä¸Šæ¬¡æ¸¸æˆè¿›åº¦
- âœ… ç‚¹å‡»"ç»§ç»­"å¯ä»¥æ¢å¤æ¸¸æˆ

---

### è°ƒè¯•æŠ€å·§

#### æŸ¥çœ‹AppStorageå†…å®¹

```typescript
// åœ¨ä»»ä½•é¡µé¢ä¸­æ·»åŠ 
const currentState = AppStorage.get<SavedGameState>('currentGameState');
console.info('[Debug] AppStorageå†…å®¹:', JSON.stringify(currentState));
```

#### æŸ¥çœ‹Preferenceså†…å®¹

```typescript
// åœ¨GameStorageä¸­æ·»åŠ 
static async debugPrintAll(): Promise<void> {
  if (!GameStorage.preferencesStore) {
    return;
  }
  
  const gameState = await GameStorage.loadGameState();
  const formIds = await GameStorage.getAllFormIds();
  
  console.info('========== Preferenceså†…å®¹ ==========');
  console.info('æ¸¸æˆçŠ¶æ€:', JSON.stringify(gameState));
  console.info('å¡ç‰‡ID:', formIds);
  console.info('=====================================');
}
```

#### æŸ¥çœ‹å¡ç‰‡æ›´æ–°æ—¥å¿—

```
è¿‡æ»¤æ—¥å¿—:
hdc shell hilog | grep -E "EntryAbility|GamePage|FormAbility"

å…³é”®æ—¥å¿—æ ‡è®°:
âš¡ - AppStorageæ“ä½œ
ğŸ’¾ - Preferencesæ“ä½œ
âœ… - æˆåŠŸ
âŒ - å¤±è´¥
ğŸ“‹ - ä¿¡æ¯è¾“å‡º
```

---

## æ€»ç»“

### æ ¸å¿ƒæŠ€æœ¯

1. **åŒé‡ä¿å­˜æœºåˆ¶**
   - AppStorage: å®æ—¶åŒæ­¥,é›¶å»¶è¿Ÿ
   - Preferences: æŒä¹…åŒ–å¤‡ä»½

2. **ä¼˜å…ˆçº§è¯»å–**
   - ç¬¬ä¸€ä¼˜å…ˆçº§: AppStorage(è¿›ç¨‹å†…æœ€æ–°æ•°æ®)
   - ç¬¬äºŒä¼˜å…ˆçº§: Preferences(åº”ç”¨é‡å¯åæ¢å¤)

3. **å¡ç‰‡IDç®¡ç†**
   - FormAbilityç”Ÿå‘½å‘¨æœŸä¸­ä¿å­˜/ç§»é™¤
   - EntryAbilityä¸­æ‰¹é‡æ›´æ–°

### ä¿®å¤æ•ˆæœ

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| æ›´æ–°å»¶è¿Ÿ | ä¸å®š(å¼‚æ­¥) | âœ… é›¶å»¶è¿Ÿ(åŒæ­¥) |
| æ•°æ®å‡†ç¡®æ€§ | âŒ å¯èƒ½æ˜¾ç¤ºæ—§æ•°æ® | âœ… 100%æœ€æ–°æ•°æ® |
| åº”ç”¨é‡å¯æ¢å¤ | âŒ æ— æ³•æ¢å¤ | âœ… å®Œæ•´æ¢å¤ |
| å®æ—¶æ€§ | âŒ ä¸å®æ—¶ | âœ… å®æ—¶åŒæ­¥ |

### æˆåŠŸæ ‡å¿—

å¦‚æœä»¥ä¸‹æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³,è¯´æ˜ä¿®å¤æˆåŠŸ:

1. âœ… æ¯æ¬¡ç§»åŠ¨æ–¹å—å,æ—¥å¿—æ˜¾ç¤º`âš¡ AppStorageå·²æ›´æ–°`
2. âœ… æŒ‰Homeé”®å,æ—¥å¿—æ˜¾ç¤º`âš¡ ä» AppStorage è¯»å–åˆ°å®æ—¶æ¸¸æˆçŠ¶æ€`
3. âœ… å¡ç‰‡æ˜¾ç¤ºæ­£ç¡®çš„æ­¥æ•°å’Œç”¨æ—¶
4. âœ… ç‚¹å‡»"ç»§ç»­"èƒ½å›åˆ°æ¸¸æˆ,çŠ¶æ€å®Œæ•´ä¿ç•™
5. âœ… æ€æ‰åº”ç”¨é‡æ–°æ‰“å¼€,ä»èƒ½ä»Preferencesæ¢å¤çŠ¶æ€

---

### æ ¸å¿ƒä¼˜åŠ¿

**å¯¹æ¯”ä¹‹å‰çš„æ–¹æ¡ˆ**:

| æ–¹æ¡ˆ | ä¿å­˜æ—¶æœº | è¯»å–å»¶è¿Ÿ | å¯é æ€§ |
|------|---------|---------|--------|
| âŒ æ—§æ–¹æ¡ˆ | é¡µé¢é”€æ¯æ—¶ | å¼‚æ­¥(å¯èƒ½å¤±è´¥) | ä½ |
| âœ… æ–°æ–¹æ¡ˆ | æ¯æ¬¡ç§»åŠ¨æ—¶ | **é›¶å»¶è¿Ÿ**(å†…å­˜) | é«˜ |

**ä¸ºä»€ä¹ˆä¸€å®šæˆåŠŸ**:

1. **AppStorageæ˜¯åŒæ­¥çš„**: å†™å…¥åç«‹å³å¯è¯»,æ— å»¶è¿Ÿ
2. **åœ¨åŒä¸€ä¸ªè¿›ç¨‹**: UIAbilityå†…çš„AppStorageå…¨å±€å…±äº«
3. **åŒé‡å¤‡ä»½**: å†…å­˜å¤±è´¥è¿˜æœ‰Preferenceså…œåº•
4. **å®æ—¶æ›´æ–°**: ä¸ç­‰å¾…é¡µé¢é”€æ¯,æ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½ä¿å­˜

---

**æ–‡æ¡£æ•´ç†æ—¥æœŸ**: 2025å¹´11æœˆ8æ—¥  
**æ•´ç†ç‰ˆæœ¬**: v1.0  
**æ•´åˆæ–‡æ¡£**: åŒ…å«å¡ç‰‡å®æ—¶æ›´æ–°é—®é¢˜å®Œæ•´è§£å†³æ–¹æ¡ˆã€æµ‹è¯•æŒ‡å—ã€AppStorageåŒé‡ä¿å­˜ç­‰å¤šä¸ªæ–‡æ¡£å†…å®¹


# ç½‘ç»œä¸å›¾ç‰‡å¤„ç†è§£å†³æ–¹æ¡ˆ

> **é¡¹ç›®**: æ‹¼å›¾æ¸¸æˆ (Puzzle)  
> **å¹³å°**: HarmonyOS  
> **æ ¸å¿ƒåŠŸèƒ½**: ç½‘ç»œå›¾ç‰‡ä¸‹è½½ã€å›¾ç‰‡è£å‰ªã€æ‰€è§å³æ‰€å¾—

---

## ç›®å½•

1. [ç½‘ç»œå›¾ç‰‡æ˜¾ç¤ºå®Œæ•´è§£å†³æ–¹æ¡ˆ](#ç½‘ç»œå›¾ç‰‡æ˜¾ç¤ºå®Œæ•´è§£å†³æ–¹æ¡ˆ)
2. [ç½‘ç»œæ£€æŸ¥é—®é¢˜ä¿®å¤](#ç½‘ç»œæ£€æŸ¥é—®é¢˜ä¿®å¤)
3. [å›¾ç‰‡è£å‰ªä¸æ‰€è§å³æ‰€å¾—](#å›¾ç‰‡è£å‰ªä¸æ‰€è§å³æ‰€å¾—)
4. [å›½å†…å›¾ç‰‡APIé€‚é…æ–¹æ¡ˆ](#å›½å†…å›¾ç‰‡apié€‚é…æ–¹æ¡ˆ)

---

## ç½‘ç»œå›¾ç‰‡æ˜¾ç¤ºå®Œæ•´è§£å†³æ–¹æ¡ˆ

### é—®é¢˜æ¦‚è¿°

#### æ ¸å¿ƒé—®é¢˜
HarmonyOSçš„`Image`ç»„ä»¶**ä¸ç›´æ¥æ”¯æŒç½‘ç»œURL**,å¿…é¡»å…ˆå°†URLè½¬æ¢ä¸º`PixelMap`å¯¹è±¡ã€‚

**é”™è¯¯ç¤ºä¾‹**:
```typescript
// âŒ é”™è¯¯: Imageä¸èƒ½ç›´æ¥æ˜¾ç¤ºURL
Image('https://example.com/image.jpg')
```

**æ­£ç¡®ç¤ºä¾‹**:
```typescript
// âœ… æ­£ç¡®: å…ˆè½¬æ¢ä¸ºPixelMap
const pixelMap = await UriConverter.urlToPixelMap(url);
Image(pixelMap)
```

---

### å®Œæ•´å®ç°æ–¹æ¡ˆ

#### æ­¥éª¤1: åœ¨ImageSelectionPageé¢„åŠ è½½

**æ–°å¢çŠ¶æ€å˜é‡**:
```typescript
// pages/ImageSelectionPage.ets

@State isLoadingNetworkImage: boolean = false;          // åŠ è½½çŠ¶æ€
@State networkImageLoadError: string = '';              // é”™è¯¯ä¿¡æ¯
@State networkPixelMap: image.PixelMap | null = null;  // âœ… å­˜å‚¨PixelMap
```

**åŠ è½½ç½‘ç»œå›¾ç‰‡**:
```typescript
private async loadNetworkImage(url: string): Promise<void> {
  this.isLoadingNetworkImage = true;
  this.networkImageLoadError = '';
  
  try {
    console.info('[ImageSelectionPage] å¼€å§‹åŠ è½½ç½‘ç»œå›¾ç‰‡');
    console.info('[ImageSelectionPage] URL:', url);
    
    // âœ… å…³é”®: è½¬æ¢ä¸ºPixelMap
    const pixelMap = await UriConverter.urlToPixelMap(url, 3);
    
    // âœ… ä¿å­˜PixelMap
    this.networkPixelMap = pixelMap;
    this.isLoadingNetworkImage = false;
    
    console.info('[ImageSelectionPage] âœ… ç½‘ç»œå›¾ç‰‡åŠ è½½æˆåŠŸ');
  } catch (error) {
    this.isLoadingNetworkImage = false;
    const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
    this.networkImageLoadError = `åŠ è½½å¤±è´¥: ${errorMsg}`;
    
    console.error('[ImageSelectionPage] âŒ ç½‘ç»œå›¾ç‰‡åŠ è½½å¤±è´¥:', errorMsg);
    
    // âœ… æ™ºèƒ½è¯Šæ–­
    if (errorMsg.includes('403') || errorMsg.includes('ä»£ç†')) {
      console.error('[è¯Šæ–­] å¯èƒ½éœ€è¦é…ç½®ä»£ç†:');
      console.error('  - ç¡®ä¿Clash/V2RayNç­‰ä»£ç†è½¯ä»¶æ­£åœ¨è¿è¡Œ');
      console.error('  - åœ¨ä»£ç†è½¯ä»¶ä¸­å¼€å¯"Allow LAN"');
    }
  }
}
```

---

#### æ­¥éª¤2: æ˜¾ç¤ºåŠ è½½çŠ¶æ€

```typescript
// å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ
if (this.source === 'network') {
  if (this.isLoadingNetworkImage) {
    // âœ… åŠ è½½ä¸­
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)
        .color(Color.White)
      
      Text('åŠ è½½ä¸­...')
        .fontSize(20)
        .fontColor(Color.White)
        .margin({ top: 10 })
    }
    .width(imageSize.width)
    .height(imageSize.height)
    .justifyContent(FlexAlign.Center)
    .backgroundColor('rgba(0, 0, 0, 0.3)')
    .borderRadius(25)
    
  } else if (this.networkImageLoadError) {
    // âœ… åŠ è½½å¤±è´¥
    Column() {
      Text('åŠ è½½å¤±è´¥')
        .fontSize(24)
        .fontColor(Color.Red)
      
      Text(this.networkImageLoadError)
        .fontSize(16)
        .fontColor(Color.White)
        .margin({ top: 10 })
        .textAlign(TextAlign.Center)
      
      Text('æç¤º: å¯èƒ½éœ€è¦é…ç½®ä»£ç†')
        .fontSize(14)
        .fontColor(Color.Gray)
        .margin({ top: 10 })
      
      Button('é‡è¯•')
        .onClick(() => this.loadRandomNetworkImage())
    }
    .width(imageSize.width)
    .height(imageSize.height)
    .justifyContent(FlexAlign.Center)
    .backgroundColor('rgba(0, 0, 0, 0.5)')
    .borderRadius(25)
    .padding(20)
    
  } else if (this.networkPixelMap) {
    // âœ… æ˜¾ç¤ºæˆåŠŸåŠ è½½çš„PixelMap
    Image(this.networkPixelMap)
      .width(imageSize.width)
      .height(imageSize.height)
      .borderRadius(25)
      .objectFit(ImageFit.Cover)
      .shadow({
        radius: 25,
        color: 'rgba(0, 0, 0, 0.25)',
        offsetX: 4,
        offsetY: 4
      })
  }
}
```

---

#### æ­¥éª¤3: å¼€å§‹æ¸¸æˆå‰éªŒè¯

```typescript
async startGame() {
  // âœ… ç½‘ç»œå›¾ç‰‡éªŒè¯
  if (this.source === 'network') {
    if (!this.networkPixelMap) {
      promptAction.showToast({ 
        message: 'è¯·å…ˆåŠ è½½ç½‘ç»œå›¾ç‰‡', 
        duration: 2000 
      });
      return;
    }
    
    if (this.isLoadingNetworkImage) {
      promptAction.showToast({ 
        message: 'å›¾ç‰‡æ­£åœ¨åŠ è½½ä¸­,è¯·ç¨å€™', 
        duration: 2000 
      });
      return;
    }
  }
  
  // ç»§ç»­æ¸¸æˆæµç¨‹...
  router.pushUrl({
    url: 'pages/GamePage',
    params: {
      // ...
      isNetworkImage: this.source === 'network',
      imageResource: this.currentNetworkImageUrl
    }
  });
}
```

---

#### æ­¥éª¤4: GamePageä¸­å¤„ç†ç½‘ç»œå›¾ç‰‡

```typescript
// pages/GamePage.ets

private async initGame(): Promise<void> {
  try {
    let pixelMap: image.PixelMap;
    
    if (this.isNetworkImage && typeof this.imageResource === 'string') {
      console.info('[GamePage] åŠ è½½ç½‘ç»œå›¾ç‰‡:', this.imageResource);
      
      // âœ… å¦‚æœæœ‰ç¼“å­˜,ä½¿ç”¨ç¼“å­˜
      if (this.useCachedImage && ImageCache.has()) {
        console.info('[GamePage] âœ… ä½¿ç”¨ç¼“å­˜çš„ç½‘ç»œå›¾ç‰‡');
        pixelMap = ImageCache.get()!;
      } else {
        // âœ… å¦åˆ™é‡æ–°ä¸‹è½½
        console.info('[GamePage] é‡æ–°ä¸‹è½½ç½‘ç»œå›¾ç‰‡');
        pixelMap = await UriConverter.urlToPixelMap(this.imageResource);
      }
      
    } else {
      // å…¶ä»–å›¾ç‰‡ç±»å‹...
    }
    
    // åˆ‡å‰²å›¾ç‰‡å¹¶åˆå§‹åŒ–æ¸¸æˆ
    this.originalPixelMap = pixelMap;
    const tilesData = await ImageSlicer.sliceImage(pixelMap, this.gridSize);
    this.tiles = tilesData;
    
    // ...
  } catch (error) {
    console.error('[GamePage] âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
  }
}
```

---

### UriConverterå·¥å…·ç±»å¢å¼º

#### urlToPixelMapå®ç°

```typescript
// utils/UriConverter.ets

import http from '@ohos.net.http';
import image from '@ohos.multimedia.image';

export class UriConverter {
  /**
   * å°†ç½‘ç»œURLè½¬æ¢ä¸ºPixelMap
   * @param url å›¾ç‰‡URL
   * @param maxRetries æœ€å¤§é‡è¯•æ¬¡æ•°(é»˜è®¤3æ¬¡)
   * @returns PixelMapå¯¹è±¡
   */
  static async urlToPixelMap(url: string, maxRetries: number = 3): Promise<image.PixelMap> {
    console.info('[UriConverter] å¼€å§‹ä¸‹è½½ç½‘ç»œå›¾ç‰‡');
    console.info('[UriConverter] URL:', url);
    
    // âœ… HTTPè¯·æ±‚é…ç½®
    const httpRequest = http.createHttp();
    
    let lastError: Error | null = null;
    
    // âœ… é‡è¯•æœºåˆ¶
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        console.info(`[UriConverter] ç¬¬${attempt}æ¬¡å°è¯•ä¸‹è½½`);
        
        const response = await httpRequest.request(url, {
          method: http.RequestMethod.GET,
          header: {
            'User-Agent': 'HarmonyOS-PuzzleGame/1.0',
            'Accept': 'image/*'
          },
          connectTimeout: 15000,  // è¿æ¥è¶…æ—¶15ç§’
          readTimeout: 30000,     // è¯»å–è¶…æ—¶30ç§’
          expectDataType: http.HttpDataType.ARRAY_BUFFER
        });
        
        console.info('[UriConverter] HTTPå“åº”ç :', response.responseCode);
        
        // âœ… æ£€æŸ¥å“åº”ç 
        if (response.responseCode === 200) {
          const arrayBuffer = response.result as ArrayBuffer;
          
          // âœ… è½¬æ¢ä¸ºPixelMap
          const imageSource = image.createImageSource(arrayBuffer);
          const pixelMap = await imageSource.createPixelMap();
          
          console.info('[UriConverter] âœ… ä¸‹è½½æˆåŠŸ! å°è¯•æ¬¡æ•°:', attempt);
          
          httpRequest.destroy();
          return pixelMap;
          
        } else if (response.responseCode === 403) {
          throw new Error('è®¿é—®è¢«æ‹’ç»(403),å¯èƒ½éœ€è¦é…ç½®ä»£ç†');
        } else if (response.responseCode === 404) {
          throw new Error('å›¾ç‰‡ä¸å­˜åœ¨(404)');
        } else if (response.responseCode >= 500) {
          throw new Error(`æœåŠ¡å™¨é”™è¯¯(${response.responseCode})`);
        } else {
          throw new Error(`HTTPé”™è¯¯: ${response.responseCode}`);
        }
        
      } catch (error) {
        lastError = error;
        console.error(`[UriConverter] ç¬¬${attempt}æ¬¡å°è¯•å¤±è´¥:`, error.message);
        
        // âœ… æœ€åä¸€æ¬¡å¤±è´¥åˆ™ä¸å†é‡è¯•
        if (attempt === maxRetries) {
          break;
        }
        
        // âœ… æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨
        const delay = 1000 * Math.pow(2, attempt - 1) + Math.random() * 500;
        console.info(`[UriConverter] ${delay}msåé‡è¯•`);
        await UriConverter.sleep(delay);
      }
    }
    
    httpRequest.destroy();
    
    // âœ… æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
    const errorMsg = lastError?.message || 'ä¸‹è½½å¤±è´¥';
    console.error('[UriConverter] âŒ ä¸‹è½½æœ€ç»ˆå¤±è´¥:', errorMsg);
    throw new Error(errorMsg);
  }
  
  private static sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

**å…³é”®ç‰¹æ€§**:
1. **è‡ªåŠ¨é‡è¯•**: å¤±è´¥åè‡ªåŠ¨é‡è¯•3æ¬¡
2. **æŒ‡æ•°é€€é¿**: ç¬¬1æ¬¡ç­‰1ç§’,ç¬¬2æ¬¡ç­‰2ç§’,ç¬¬3æ¬¡ç­‰4ç§’
3. **éšæœºæŠ–åŠ¨**: é¿å…åŒæ—¶é‡è¯•é€ æˆæœåŠ¡å™¨å‹åŠ›
4. **è¶…æ—¶é…ç½®**: è¿æ¥15ç§’,è¯»å–30ç§’
5. **é”™è¯¯åˆ†ç±»**: åŒºåˆ†403/404/5xxä¸åŒé”™è¯¯

---

## ç½‘ç»œæ£€æŸ¥é—®é¢˜ä¿®å¤

### é—®é¢˜æè¿°

**ç°è±¡**:
- æ¨¡æ‹Ÿå™¨ç½‘ç»œæ­£å¸¸(èƒ½è®¿é—®ç™¾åº¦)
- åº”ç”¨æ˜¾ç¤º"ç½‘ç»œä¸å¯ç”¨"
- ç½‘ç»œå›¾ç‰‡åŠŸèƒ½å®Œå…¨æ— æ³•ä½¿ç”¨

**é”™è¯¯æ—¥å¿—**:
```
[NetworkHelper] æ£€æŸ¥ç½‘ç»œçŠ¶æ€å¤±è´¥: ExecHasDefaultNet ret 201
[ImageSelectionPage] âŒ ç½‘ç»œå›¾ç‰‡åŠ è½½å¤±è´¥: ç½‘ç»œä¸å¯ç”¨
```

---

### æ ¹æœ¬åŸå› 

**é—®é¢˜API**: `networkHelper.hasDefaultNet()`

åœ¨HarmonyOSæ¨¡æ‹Ÿå™¨çš„æŸäº›ç¯å¢ƒä¸­,è¿™ä¸ªAPIä¼šè¿”å›é”™è¯¯ç `201`,å³ä½¿ç½‘ç»œå®é™…ä¸Šæ˜¯å¯ç”¨çš„ã€‚

**è¯¯åˆ¤é€»è¾‘**:
```typescript
// âŒ é—®é¢˜ä»£ç 
const hasNetwork = await networkHelper.hasDefaultNet();
if (!hasNetwork) {
  throw new Error('ç½‘ç»œä¸å¯ç”¨');  // â† é˜»å¡åç»­æ“ä½œ
}
```

---

### è§£å†³æ–¹æ¡ˆ: ç§»é™¤é˜»å¡æ€§ç½‘ç»œæ£€æŸ¥

**ä¿®æ”¹å‰** (UriConverter.ets):
```typescript
// âŒ é˜»å¡æ€§ç½‘ç»œæ£€æŸ¥
const networkHelper = NetworkHelper.getInstance();
const hasNetwork = await networkHelper.hasNetwork();

if (!hasNetwork) {
  throw new Error('ç½‘ç»œä¸å¯ç”¨: è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');  // â† ç›´æ¥å¤±è´¥
}

// æ°¸è¿œæ‰§è¡Œä¸åˆ°è¿™é‡Œ...
const response = await http.request(url);
```

**ä¿®æ”¹å**:
```typescript
// âœ… éé˜»å¡æ€§ç½‘ç»œæ£€æŸ¥
const networkHelper = NetworkHelper.getInstance();

try {
  const networkInfo = await networkHelper.getNetworkInfo();
  console.info('[UriConverter] å½“å‰ç½‘ç»œ:', networkInfo.type, ', çŠ¶æ€:', networkInfo.status);
} catch (error) {
  // âš ï¸ ç½‘ç»œæ£€æŸ¥å¤±è´¥ä¸å½±å“åç»­æ“ä½œ
  console.warn('[UriConverter] âš ï¸ ç½‘ç»œæ£€æŸ¥å¤±è´¥(å¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨ç¯å¢ƒ),ç»§ç»­å°è¯•è¯·æ±‚');
}

// âœ… ç›´æ¥å°è¯•HTTPè¯·æ±‚,è®©è¯·æ±‚æœ¬èº«å†³å®šç½‘ç»œæ˜¯å¦å¯ç”¨
try {
  const response = await http.request(url);
  // è¯·æ±‚æˆåŠŸ â†’ ç½‘ç»œå®é™…ä¸Šæ˜¯å¯ç”¨çš„
} catch (error) {
  // è¯·æ±‚å¤±è´¥ â†’ çœŸæ­£çš„ç½‘ç»œé—®é¢˜æˆ–å…¶ä»–é”™è¯¯
  throw error;
}
```

**å…³é”®æ”¹è¿›**:
1. **ç§»é™¤é˜»å¡**: ä¸å†å› ä¸ºç½‘ç»œæ£€æŸ¥å¤±è´¥è€Œç›´æ¥ç»ˆæ­¢
2. **é™çº§ä¸ºè­¦å‘Š**: ç½‘ç»œæ£€æŸ¥å¤±è´¥ä»…è¾“å‡ºè­¦å‘Šæ—¥å¿—
3. **å®é™…éªŒè¯**: ç”¨HTTPè¯·æ±‚çš„æˆåŠŸ/å¤±è´¥ä½œä¸ºç½‘ç»œå¯ç”¨æ€§çš„çœŸå®ä¾æ®

---

### ä¿®å¤æ•ˆæœ

**ä¿®å¤å‰**:
```
[NetworkHelper] æ£€æŸ¥ç½‘ç»œçŠ¶æ€å¤±è´¥
[UriConverter] âŒ ç½‘ç»œä¸å¯ç”¨,ç»ˆæ­¢æ“ä½œ
[ImageSelectionPage] âŒ åŠ è½½å¤±è´¥
```

**ä¿®å¤å**:
```
[NetworkHelper] âš ï¸ ç½‘ç»œæ£€æŸ¥å¤±è´¥(å¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨ç¯å¢ƒ),ç»§ç»­å°è¯•è¯·æ±‚
[UriConverter] ç¬¬1æ¬¡å°è¯•ä¸‹è½½
[UriConverter] HTTPå“åº”ç : 200
[UriConverter] âœ… ä¸‹è½½æˆåŠŸ
[ImageSelectionPage] âœ… ç½‘ç»œå›¾ç‰‡åŠ è½½æˆåŠŸ
```

---

## å›¾ç‰‡è£å‰ªä¸æ‰€è§å³æ‰€å¾—

### é—®é¢˜èƒŒæ™¯

#### ç”¨æˆ·åé¦ˆ
> "å½“æˆ‘ç¡®å®šå¥½ç½‘ç»œéšæœºå¯¹åº”çš„å›¾ç‰‡,å¼€å§‹æ¸¸æˆå,ä¸ºä»€ä¹ˆå±•ç¤ºçš„å›¾ç‰‡å’Œæˆ‘å®é™…æ¸¸æˆçš„å›¾ç‰‡ä¸ä¸€è‡´å‘¢?ååˆ†æ˜æ˜¾çš„ä¸ä¸€è‡´!"

#### é—®é¢˜åˆ†æ

**æ ¹æœ¬åŸå› **:
1. ImageSelectionPageå±•ç¤ºçš„æ˜¯**åŸå§‹å›¾ç‰‡**(å¯èƒ½æ˜¯é•¿æ–¹å½¢,å¦‚1920Ã—1080)
2. GamePageçš„Gridå¼ºåˆ¶**æ­£æ–¹å½¢å¸ƒå±€**
3. é•¿æ–¹å½¢å›¾ç‰‡è¢«å¼ºåˆ¶å‹ç¼©åˆ°æ­£æ–¹å½¢,å¯¼è‡´å˜å½¢æˆ–åªæ˜¾ç¤ºä¸­å¿ƒåŒºåŸŸ

**ç¤ºä¾‹**:
```
é€‰æ‹©é¡µå±•ç¤º: å®Œæ•´çš„é£æ™¯ç…§(å¤©ç©º+å±±+æ¹–) - 1920Ã—1080
æ¸¸æˆé¡µæ˜¾ç¤º: åªæœ‰ä¸­å¿ƒåŒºåŸŸ(å±±+æ¹–) - 1080Ã—1080

ç»“æœ: âŒ ç”¨æˆ·å›°æƒ‘ - å›¾ç‰‡æ€ä¹ˆä¸ä¸€æ ·äº†?
```

---

### è§£å†³æ–¹æ¡ˆ: æ‰€è§å³æ‰€å¾— (WYSIWYG)

**æ ¸å¿ƒåŸåˆ™**: ç”¨æˆ·åœ¨é€‰æ‹©é¡µçœ‹åˆ°ä»€ä¹ˆ,æ¸¸æˆä¸­å°±ç©ä»€ä¹ˆã€‚

**å®ç°ç­–ç•¥**:
1. åœ¨ImageSelectionPageä¸­,å›¾ç‰‡åŠ è½½å®Œæˆå**ç«‹å³è£å‰ªä¸ºæ­£æ–¹å½¢**
2. å±•ç¤ºè£å‰ªåçš„æ­£æ–¹å½¢å›¾ç‰‡
3. å°†è£å‰ªåçš„å›¾ç‰‡ä¼ é€’ç»™GamePage

---

### å®ç°æ­¥éª¤

#### æ­¥éª¤1: åˆ›å»ºImageCropperå·¥å…·ç±»

```typescript
// utils/ImageCropper.ets

import image from '@ohos.multimedia.image';

export class ImageCropper {
  /**
   * å°†å›¾ç‰‡è£å‰ªä¸ºæ­£æ–¹å½¢(å–ä¸­å¿ƒåŒºåŸŸ)
   * @param pixelMap åŸå§‹å›¾ç‰‡
   * @returns è£å‰ªåçš„æ­£æ–¹å½¢å›¾ç‰‡
   */
  static async cropToSquare(pixelMap: image.PixelMap): Promise<image.PixelMap> {
    const imageInfo = await pixelMap.getImageInfo();
    const width = imageInfo.size.width;
    const height = imageInfo.size.height;
    
    console.info('[ImageCropper] åŸå§‹å›¾ç‰‡å°ºå¯¸:', `${width}Ã—${height}`);
    
    // âœ… å¦‚æœå·²ç»æ˜¯æ­£æ–¹å½¢,ç›´æ¥è¿”å›
    if (width === height) {
      console.info('[ImageCropper] å›¾ç‰‡å·²æ˜¯æ­£æ–¹å½¢,æ— éœ€è£å‰ª');
      return pixelMap;
    }
    
    // âœ… è®¡ç®—æ­£æ–¹å½¢è¾¹é•¿(å–è¾ƒå°å€¼)
    const squareSize = Math.min(width, height);
    
    // âœ… è®¡ç®—è£å‰ªèµ·å§‹ä½ç½®(ä¸­å¿ƒè£å‰ª)
    const offsetX = Math.floor((width - squareSize) / 2);
    const offsetY = Math.floor((height - squareSize) / 2);
    
    console.info('[ImageCropper] è£å‰ªåŒºåŸŸ:', `x=${offsetX}, y=${offsetY}, size=${squareSize}Ã—${squareSize}`);
    
    // âœ… è¯»å–ä¸­å¿ƒåŒºåŸŸçš„åƒç´ æ•°æ®
    const region: image.Region = {
      x: offsetX,
      y: offsetY,
      size: { width: squareSize, height: squareSize }
    };
    
    const bufferSize = squareSize * squareSize * 4;  // RGBA
    const buffer = new ArrayBuffer(bufferSize);
    
    await pixelMap.readPixels({
      pixels: buffer,
      offset: 0,
      stride: squareSize * 4,
      region: region
    });
    
    // âœ… åˆ›å»ºæ–°çš„æ­£æ–¹å½¢PixelMap
    const createOpts: image.InitializationOptions = {
      size: { width: squareSize, height: squareSize },
      pixelFormat: image.PixelMapFormat.RGBA_8888
    };
    
    const squarePixelMap = await image.createPixelMap(buffer, createOpts);
    
    console.info('[ImageCropper] âœ… è£å‰ªå®Œæˆ,ç”Ÿæˆæ­£æ–¹å½¢å›¾ç‰‡');
    
    return squarePixelMap;
  }
}
```

**è£å‰ªç¤ºä¾‹**:
```
åŸå§‹å›¾ç‰‡: 1920Ã—1080 (é•¿æ–¹å½¢)
          â†“
è£å‰ªåŒºåŸŸ: ä¸­å¿ƒçš„ 1080Ã—1080
èµ·å§‹ä½ç½®: offsetX = (1920-1080)/2 = 420, offsetY = 0
          â†“
è£å‰ªå:   1080Ã—1080 (æ­£æ–¹å½¢) âœ…
```

---

#### æ­¥éª¤2: åˆ›å»ºImageCacheå·¥å…·ç±»

**èƒŒæ™¯**: HarmonyOSçš„è·¯ç”±å‚æ•°åªèƒ½ä¼ é€’å¯åºåˆ—åŒ–çš„æ•°æ®,æ— æ³•ç›´æ¥ä¼ é€’`PixelMap`å¯¹è±¡ã€‚

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨é™æ€å…¨å±€ç¼“å­˜ã€‚

```typescript
// utils/ImageCache.ets

import image from '@ohos.multimedia.image';

export class ImageCache {
  private static cachedPixelMap: image.PixelMap | null = null;
  
  /**
   * ç¼“å­˜å›¾ç‰‡
   */
  static set(pixelMap: image.PixelMap): void {
    // âœ… é‡Šæ”¾æ—§çš„ç¼“å­˜
    if (ImageCache.cachedPixelMap) {
      ImageCache.cachedPixelMap.release();
    }
    ImageCache.cachedPixelMap = pixelMap;
    console.info('[ImageCache] âœ… å›¾ç‰‡å·²ç¼“å­˜');
  }
  
  /**
   * è·å–ç¼“å­˜çš„å›¾ç‰‡
   */
  static get(): image.PixelMap | null {
    return ImageCache.cachedPixelMap;
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜
   */
  static has(): boolean {
    return ImageCache.cachedPixelMap !== null;
  }
  
  /**
   * æ¸…é™¤ç¼“å­˜
   */
  static clear(): void {
    if (ImageCache.cachedPixelMap) {
      ImageCache.cachedPixelMap.release();
      ImageCache.cachedPixelMap = null;
    }
    console.info('[ImageCache] âœ… ç¼“å­˜å·²æ¸…é™¤');
  }
}
```

---

#### æ­¥éª¤3: ä¿®æ”¹ImageSelectionPage

**åŠ è½½ç½‘ç»œå›¾ç‰‡åç«‹å³è£å‰ª**:
```typescript
// pages/ImageSelectionPage.ets

import { ImageCropper } from '../utils/ImageCropper';
import { ImageCache } from '../utils/ImageCache';

private async loadNetworkImage(url: string): Promise<void> {
  try {
    // âœ… ä¸‹è½½ç½‘ç»œå›¾ç‰‡
    const pixelMap = await UriConverter.urlToPixelMap(url, 3);
    console.info('[ImageSelectionPage] âœ… ç½‘ç»œå›¾ç‰‡ä¸‹è½½æˆåŠŸ');
    
    // âœ… ğŸ†• è£å‰ªä¸ºæ­£æ–¹å½¢
    console.info('[ImageSelectionPage] å¼€å§‹è£å‰ªå›¾ç‰‡ä¸ºæ­£æ–¹å½¢...');
    const squarePixelMap = await ImageCropper.cropToSquare(pixelMap);
    console.info('[ImageSelectionPage] âœ… å›¾ç‰‡è£å‰ªå®Œæˆ');
    
    // âœ… å±•ç¤ºè£å‰ªåçš„æ­£æ–¹å½¢å›¾ç‰‡
    this.networkPixelMap = squarePixelMap;
    this.isLoadingNetworkImage = false;
    
  } catch (error) {
    // é”™è¯¯å¤„ç†...
  }
}
```

**å¼€å§‹æ¸¸æˆå‰ç¼“å­˜è£å‰ªåçš„å›¾ç‰‡**:
```typescript
async startGame() {
  let useCachedImage = false;
  
  if (this.source === 'network') {
    // âœ… ç¼“å­˜å·²è£å‰ªçš„ç½‘ç»œå›¾ç‰‡
    ImageCache.set(this.networkPixelMap!);
    console.info('[ImageSelectionPage] âœ… ç½‘ç»œå›¾ç‰‡å·²ç¼“å­˜(å·²è£å‰ªä¸ºæ­£æ–¹å½¢)');
    useCachedImage = true;
    
  } else if (this.source === 'gallery') {
    // âœ… ç›¸å†Œå›¾ç‰‡ä¹Ÿè£å‰ª
    const pixelMap = await UriConverter.uriToPixelMap(this.customUri);
    const squarePixelMap = await ImageCropper.cropToSquare(pixelMap);
    ImageCache.set(squarePixelMap);
    console.info('[ImageSelectionPage] âœ… ç›¸å†Œå›¾ç‰‡å·²ç¼“å­˜(å·²è£å‰ªä¸ºæ­£æ–¹å½¢)');
    useCachedImage = true;
  }
  
  // âœ… è·³è½¬åˆ°æ¸¸æˆé¡µé¢,å¸¦ä¸Šç¼“å­˜æ ‡è®°
  router.pushUrl({
    url: 'pages/GamePage',
    params: {
      // ...å…¶ä»–å‚æ•°
      useCachedImage: useCachedImage  // ğŸ†• å‘Šè¯‰GamePageä½¿ç”¨ç¼“å­˜
    }
  });
}
```

---

#### æ­¥éª¤4: ä¿®æ”¹GamePage

**ä¼˜å…ˆä½¿ç”¨ç¼“å­˜çš„è£å‰ªåå›¾ç‰‡**:
```typescript
// pages/GamePage.ets

import { ImageCache } from '../utils/ImageCache';

interface GamePageParams {
  // ...å…¶ä»–å‚æ•°
  useCachedImage?: boolean;  // ğŸ†• æ˜¯å¦ä½¿ç”¨ç¼“å­˜çš„è£å‰ªåå›¾ç‰‡
}

private async initGame(): Promise<void> {
  try {
    let pixelMap: image.PixelMap;
    
    // âœ… ğŸ†• ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦ä½¿ç”¨ç¼“å­˜çš„è£å‰ªåå›¾ç‰‡
    if (this.useCachedImage && ImageCache.has()) {
      console.info('[GamePage] âœ… ä½¿ç”¨ç¼“å­˜çš„è£å‰ªåå›¾ç‰‡(æ‰€è§å³æ‰€å¾—)');
      pixelMap = ImageCache.get()!;
      
    } else if (this.isNetworkImage && typeof this.imageResource === 'string') {
      // ç½‘ç»œå›¾ç‰‡(é™çº§æ–¹æ¡ˆ)
      pixelMap = await UriConverter.urlToPixelMap(this.imageResource);
      
    } else {
      // å…¶ä»–å›¾ç‰‡...
    }
    
    this.originalPixelMap = pixelMap;
    
    // âœ… åˆ‡å‰²å›¾ç‰‡(ç°åœ¨æ˜¯æ­£æ–¹å½¢äº†,åˆ‡å‰²å‡ºæ¥çš„tileä¹Ÿæ˜¯æ­£æ–¹å½¢)
    const tilesData = await ImageSlicer.sliceImage(pixelMap, this.gridSize);
    this.tiles = tilesData;
    // ...
    
  } catch (error) {
    console.error('[GamePage] âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
  }
}
```

---

### å·¥ä½œæµç¨‹

```
1. ImageSelectionPage - ç”¨æˆ·é€‰æ‹©ç½‘ç»œå›¾ç‰‡
   â†“
2. ä¸‹è½½å›¾ç‰‡ (1920Ã—1080)
   [UriConverter.urlToPixelMap()]
   â†“
3. ğŸ†• è£å‰ªä¸ºæ­£æ–¹å½¢ (1080Ã—1080)
   [ImageCropper.cropToSquare()]
   â†“
4. å±•ç¤ºè£å‰ªåçš„å›¾ç‰‡
   ç”¨æˆ·çœ‹åˆ°: æ­£æ–¹å½¢å›¾ç‰‡(å¤©ç©º+å±±+æ¹–çš„ä¸­å¿ƒéƒ¨åˆ†)
   â†“
5. ç”¨æˆ·ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"
   â†“
6. ğŸ†• ç¼“å­˜è£å‰ªåçš„å›¾ç‰‡
   [ImageCache.set(squarePixelMap)]
   â†“
7. è·³è½¬åˆ° GamePage
   å‚æ•°: useCachedImage: true
   â†“
8. GamePage - åˆå§‹åŒ–æ¸¸æˆ
   â†“
9. ğŸ†• ä»ç¼“å­˜è·å–å›¾ç‰‡ (1080Ã—1080)
   [ImageCache.get()]
   â†“
10. åˆ‡å‰²å›¾ç‰‡ 3Ã—3
    æ¯ä¸ª tile: 360Ã—360 (æ­£æ–¹å½¢)
    [ImageSlicer.sliceImage()]
    â†“
11. æ˜¾ç¤ºæ‹¼å›¾æ¸¸æˆ
    ç”¨æˆ·çœ‹åˆ°: å’Œé€‰æ‹©é¡µå®Œå…¨ä¸€æ ·çš„å›¾ç‰‡ âœ…
```

---

### å¯¹æ¯”æ•ˆæœ

**ä¿®æ”¹å‰(æœ‰é—®é¢˜)**:
```
é€‰æ‹©é¡µæ˜¾ç¤º: 1920Ã—1080 å®Œæ•´å›¾ç‰‡(é•¿æ–¹å½¢)
æ¸¸æˆé¡µæ˜¾ç¤º: 1080Ã—1080 ä¸­å¿ƒåŒºåŸŸ(æ­£æ–¹å½¢)
ç»“æœ: âŒ ä¸ä¸€è‡´!
```

**ä¿®æ”¹å(å®Œç¾)**:
```
é€‰æ‹©é¡µæ˜¾ç¤º: 1080Ã—1080 ä¸­å¿ƒåŒºåŸŸ(æ­£æ–¹å½¢) âœ…
æ¸¸æˆé¡µæ˜¾ç¤º: 1080Ã—1080 ä¸­å¿ƒåŒºåŸŸ(æ­£æ–¹å½¢) âœ…
ç»“æœ: âœ… æ‰€è§å³æ‰€å¾—!
```

---

## å›½å†…å›¾ç‰‡APIé€‚é…æ–¹æ¡ˆ

### é—®é¢˜åˆ†æ

**Unsplashé—®é¢˜**:
- âŒ åœ¨ä¸­å›½å¤§é™†è¢«å¢™,æ— æ³•è®¿é—®
- âŒ éœ€è¦é…ç½®ä»£ç†,æ¨¡æ‹Ÿå™¨ä»£ç†é…ç½®å¤æ‚
- âŒ è®¿é—®é€Ÿåº¦æ…¢

**è§£å†³æ€è·¯**: åˆ‡æ¢åˆ°å›½å†…å…è´¹å›¾ç‰‡API

---

### æ¨èçš„å›½å†…å…è´¹å›¾ç‰‡API

#### 1. å¿…åº”æ¯æ—¥å£çº¸API (â­â­â­â­â­ å¼ºçƒˆæ¨è)

**ç‰¹ç‚¹**:
- âœ… å®Œå…¨å…è´¹,æ— éœ€å¯†é’¥
- âœ… é«˜è´¨é‡å£çº¸(1920Ã—1080)
- âœ… å›½å†…è®¿é—®ç¨³å®šå¿«é€Ÿ
- âœ… æ¯æ—¥æ›´æ–°

**APIåœ°å€**:
```
https://api.dujin.org/bing/1920.php
```

---

#### 2. å°æ­ªAPI - é«˜æ¸…å£çº¸ (â­â­â­â­)

**ç‰¹ç‚¹**:
- âœ… å®Œå…¨å…è´¹
- âœ… å¤šç§åˆ†ç±»(é£æ™¯ã€åŠ¨æ¼«ç­‰)
- âœ… éšæœºè¿”å›
- âœ… å›½å†…ç¨³å®š

**APIåœ°å€**:
```typescript
// é£æ™¯å›¾ç‰‡
'https://api.ixiaowai.cn/gqapi/gqapi.php'

// äºŒæ¬¡å…ƒå›¾ç‰‡
'https://api.ixiaowai.cn/mcapi/mcapi.php'
```

---

#### 3. æå¤©API - éšæœºå›¾ç‰‡ (â­â­â­â­)

**ç‰¹ç‚¹**:
- âœ… å®Œå…¨å…è´¹
- âœ… å¤šä¸ªåˆ†ç±»
- âœ… è‡ªåŠ¨è·³è½¬åˆ°å›¾ç‰‡

**APIåœ°å€**:
```typescript
// é£æ™¯
'https://api.btstu.cn/sjbz/api.php?lx=fengjing'

// åŠ¨æ¼«
'https://api.btstu.cn/sjbz/api.php?lx=dongman'

// ç¾å¥³
'https://api.btstu.cn/sjbz/api.php?lx=meizi'
```

---

### å®æ–½æ–¹æ¡ˆ

#### æ›´æ–°ApiConstants

```typescript
// constants/ApiConstants.ets

export class ApiConstants {
  // âœ… å¿…åº”æ¯æ—¥å£çº¸API(æ¨è)
  static readonly BING_IMAGE_URL: string = 'https://api.dujin.org/bing/1920.php';
  
  // âœ… éšæœºå›¾ç‰‡APIåˆ—è¡¨
  static readonly RANDOM_IMAGE_APIS: string[] = [
    'https://api.dujin.org/bing/1920.php',           // å¿…åº”å£çº¸
    'https://api.ixiaowai.cn/gqapi/gqapi.php',       // é«˜æ¸…å£çº¸
    'https://api.ixiaowai.cn/mcapi/mcapi.php',       // äºŒæ¬¡å…ƒ
    'https://api.btstu.cn/sjbz/api.php?lx=fengjing', // é£æ™¯
    'https://api.btstu.cn/sjbz/api.php?lx=dongman',  // åŠ¨æ¼«
  ];
  
  // âœ… è·å–éšæœºAPI
  static getRandomImageUrl(): string {
    const timestamp = Date.now();
    const apis = ApiConstants.RANDOM_IMAGE_APIS;
    const randomIndex = Math.floor(Math.random() * apis.length);
    return `${apis[randomIndex]}?t=${timestamp}`;
  }
}
```

#### æ›´æ–°NetworkImageSelector

```typescript
// components/NetworkImageSelector.ets

getRandomImageUrl(): string {
  const timestamp = Date.now();
  
  switch (this.selectedCategory) {
    case 'random':
      return `https://api.dujin.org/bing/1920.php?t=${timestamp}`;
    
    case 'nature':
      return `https://api.btstu.cn/sjbz/api.php?lx=fengjing&t=${timestamp}`;
    
    case 'city':
      return `https://api.ixiaowai.cn/gqapi/gqapi.php?t=${timestamp}`;
    
    case 'animal':
      return `https://api.btstu.cn/sjbz/api.php?lx=dongman&t=${timestamp}`;
      
    default:
      return ApiConstants.BING_IMAGE_URL;
  }
}
```

---

### APIå¯¹æ¯”è¡¨

| API | å…è´¹ | ç¨³å®šæ€§ | è´¨é‡ | é€Ÿåº¦ | æ¨èåº¦ |
|-----|------|--------|------|------|--------|
| å¿…åº”å£çº¸ | âœ… | â­â­â­â­â­ | æé«˜ | å¿« | â­â­â­â­â­ |
| å°æ­ªAPI | âœ… | â­â­â­â­ | é«˜ | å¿« | â­â­â­â­ |
| æå¤©API | âœ… | â­â­â­â­ | ä¸­é«˜ | å¿« | â­â­â­â­ |
| Lorem Picsum | âœ… | â­â­â­â­ | ä¸­ | ä¸­ | â­â­â­ |
| Unsplash | âœ… | âŒè¢«å¢™ | æé«˜ | æ…¢ | âŒ |

---

### ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | Unsplash(å›½å¤–) | å›½å†…API |
|------|----------------|---------|
| è®¿é—®é€Ÿåº¦ | âŒ æ…¢(è¢«å¢™) | âœ… å¿« |
| ç¨³å®šæ€§ | âŒ ä¸ç¨³å®š | âœ… ç¨³å®š |
| éœ€è¦ä»£ç† | âœ… æ˜¯ | âŒ å¦ |
| å›¾ç‰‡è´¨é‡ | â­â­â­â­â­ | â­â­â­â­ |
| ä½¿ç”¨éš¾åº¦ | ç®€å• | ç®€å• |
| å…è´¹ | âœ… | âœ… |

---

## æ€»ç»“

### æ ¸å¿ƒä¿®å¤

1. **ç½‘ç»œå›¾ç‰‡æ˜¾ç¤º**
   - å®ç°PixelMapé¢„åŠ è½½æœºåˆ¶
   - å®Œæ•´çš„åŠ è½½çŠ¶æ€ç®¡ç†
   - æ™ºèƒ½é”™è¯¯è¯Šæ–­

2. **ç½‘ç»œæ£€æŸ¥ä¼˜åŒ–**
   - ç§»é™¤é˜»å¡æ€§ç½‘ç»œæ£€æŸ¥
   - ä½¿ç”¨HTTPè¯·æ±‚éªŒè¯ç½‘ç»œ
   - é¿å…æ¨¡æ‹Ÿå™¨ç¯å¢ƒè¯¯åˆ¤

3. **å›¾ç‰‡è£å‰ªä¸æ‰€è§å³æ‰€å¾—**
   - ä¸­å¿ƒè£å‰ªä¸ºæ­£æ–¹å½¢
   - ImageCacheå…¨å±€ç¼“å­˜
   - é€‰æ‹©é¡µå’Œæ¸¸æˆé¡µå®Œå…¨ä¸€è‡´

4. **å›½å†…APIé€‚é…**
   - å¿…åº”å£çº¸APIä¸ºé¦–é€‰
   - å¤šAPIè½®æ¢æé«˜å¯ç”¨æ€§
   - æ— éœ€ä»£ç†,ç›´æ¥è®¿é—®

### æŠ€æœ¯è¦ç‚¹

| åŠŸèƒ½ | å…³é”®æŠ€æœ¯ | æ ¸å¿ƒAPI |
|------|---------|---------|
| ç½‘ç»œå›¾ç‰‡ | PixelMapé¢„åŠ è½½ | `UriConverter.urlToPixelMap()` |
| å›¾ç‰‡è£å‰ª | ä¸­å¿ƒåŒºåŸŸè£å‰ª | `ImageCropper.cropToSquare()` |
| ç¼“å­˜ä¼ é€’ | é™æ€å…¨å±€ç¼“å­˜ | `ImageCache` |
| ç½‘ç»œæ£€æŸ¥ | éé˜»å¡éªŒè¯ | HTTPè¯·æ±‚æœ¬èº« |

### ç”¨æˆ·ä½“éªŒæå‡

âœ… **ç½‘ç»œå›¾ç‰‡åŠŸèƒ½å®Œå…¨å¯ç”¨**  
âœ… **æ‰€è§å³æ‰€å¾—,æ— å›¾ç‰‡å·®å¼‚**  
âœ… **æ— éœ€é…ç½®ä»£ç†,å¼€ç®±å³ç”¨**  
âœ… **å®Œæ•´çš„åŠ è½½çŠ¶æ€åé¦ˆ**  
âœ… **æ™ºèƒ½é”™è¯¯è¯Šæ–­å’Œé‡è¯•**

---

**æ–‡æ¡£æ•´ç†æ—¥æœŸ**: 2025å¹´11æœˆ8æ—¥  
**æ•´ç†ç‰ˆæœ¬**: v1.0  
**æ•´åˆæ–‡æ¡£**: åŒ…å«ç½‘ç»œé—®é¢˜å®Œæ•´ä¿®å¤ã€ç½‘ç»œå›¾ç‰‡æ˜¾ç¤ºä¿®å¤ã€ç½‘ç»œæ£€æŸ¥ä¿®å¤ã€å›¾ç‰‡è£å‰ªä¿®å¤ç­‰å¤šä¸ªæ–‡æ¡£å†…å®¹

